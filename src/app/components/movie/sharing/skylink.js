function fun(){
    alert("sky"),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).io=e()}}(function(){return function e(t,n,r){function i(o,s){if(!n[o]){if(!t[o]){var d="function"==typeof require&&require;if(!s&&d)return d(o,!0);if(a)return a(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return i(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var a="function"==typeof require&&require,o=0;o<r.length;o++)i(r[o]);return i}({1:[function(e,t,n){function r(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var n,r=i(e),a=r.source,c=r.id,l=r.path,p=d[c]&&l in d[c].nsps;return t.forceNew||t["force new connection"]||!1===t.multiplex||p?(s("ignoring socket cache for %s",a),n=o(a,t)):(d[c]||(s("new io instance for %s",a),d[c]=o(a,t)),n=d[c]),n.socket(r.path)}var i=e("./url"),a=e("socket.io-parser"),o=e("./manager"),s=e("debug")("socket.io-client");t.exports=n=r;var d=n.managers={};n.protocol=a.protocol,n.connect=r,n.Manager=e("./manager"),n.Socket=e("./socket")},{"./manager":2,"./socket":4,"./url":5,debug:14,"socket.io-parser":40}],2:[function(e,t,n){function r(e,t){if(!(this instanceof r))return new r(e,t);e&&"object"==typeof e&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.nsps={},this.subs=[],this.opts=t,this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(t.randomizationFactor||.5),this.backoff=new u({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this.readyState="closed",this.uri=e,this.connecting=[],this.lastPing=null,this.encoding=!1,this.packetBuffer=[],this.encoder=new s.Encoder,this.decoder=new s.Decoder,this.autoConnect=!1!==t.autoConnect,this.autoConnect&&this.open()}var i=e("engine.io-client"),a=e("./socket"),o=e("component-emitter"),s=e("socket.io-parser"),d=e("./on"),c=e("component-bind"),l=e("debug")("socket.io-client:manager"),p=e("indexof"),u=e("backo2"),f=Object.prototype.hasOwnProperty;t.exports=r,r.prototype.emitAll=function(){this.emit.apply(this,arguments);for(var e in this.nsps)f.call(this.nsps,e)&&this.nsps[e].emit.apply(this.nsps[e],arguments)},r.prototype.updateSocketIds=function(){for(var e in this.nsps)f.call(this.nsps,e)&&(this.nsps[e].id=this.engine.id)},o(r.prototype),r.prototype.reconnection=function(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection},r.prototype.reconnectionAttempts=function(e){return arguments.length?(this._reconnectionAttempts=e,this):this._reconnectionAttempts},r.prototype.reconnectionDelay=function(e){return arguments.length?(this._reconnectionDelay=e,this.backoff&&this.backoff.setMin(e),this):this._reconnectionDelay},r.prototype.randomizationFactor=function(e){return arguments.length?(this._randomizationFactor=e,this.backoff&&this.backoff.setJitter(e),this):this._randomizationFactor},r.prototype.reconnectionDelayMax=function(e){return arguments.length?(this._reconnectionDelayMax=e,this.backoff&&this.backoff.setMax(e),this):this._reconnectionDelayMax},r.prototype.timeout=function(e){return arguments.length?(this._timeout=e,this):this._timeout},r.prototype.maybeReconnectOnOpen=function(){!this.reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()},r.prototype.open=r.prototype.connect=function(e){if(l("readyState %s",this.readyState),~this.readyState.indexOf("open"))return this;l("opening %s",this.uri),this.engine=i(this.uri,this.opts);var t=this.engine,n=this;this.readyState="opening",this.skipReconnect=!1;var r=d(t,"open",function(){n.onopen(),e&&e()}),a=d(t,"error",function(t){if(l("connect_error"),n.cleanup(),n.readyState="closed",n.emitAll("connect_error",t),e){var r=new Error("Connection error");r.data=t,e(r)}else n.maybeReconnectOnOpen()});if(!1!==this._timeout){var o=this._timeout;l("connect attempt will timeout after %d",o);var s=setTimeout(function(){l("connect attempt timed out after %d",o),r.destroy(),t.close(),t.emit("error","timeout"),n.emitAll("connect_timeout",o)},o);this.subs.push({destroy:function(){clearTimeout(s)}})}return this.subs.push(r),this.subs.push(a),this},r.prototype.onopen=function(){l("open"),this.cleanup(),this.readyState="open",this.emit("open");var e=this.engine;this.subs.push(d(e,"data",c(this,"ondata"))),this.subs.push(d(e,"ping",c(this,"onping"))),this.subs.push(d(e,"pong",c(this,"onpong"))),this.subs.push(d(e,"error",c(this,"onerror"))),this.subs.push(d(e,"close",c(this,"onclose"))),this.subs.push(d(this.decoder,"decoded",c(this,"ondecoded")))},r.prototype.onping=function(){this.lastPing=new Date,this.emitAll("ping")},r.prototype.onpong=function(){this.emitAll("pong",new Date-this.lastPing)},r.prototype.ondata=function(e){this.decoder.add(e)},r.prototype.ondecoded=function(e){this.emit("packet",e)},r.prototype.onerror=function(e){l("error",e),this.emitAll("error",e)},r.prototype.socket=function(e){function t(){~p(r.connecting,n)||r.connecting.push(n)}var n=this.nsps[e];if(!n){n=new a(this,e),this.nsps[e]=n;var r=this;n.on("connecting",t),n.on("connect",function(){n.id=r.engine.id}),this.autoConnect&&t()}return n},r.prototype.destroy=function(e){var t=p(this.connecting,e);~t&&this.connecting.splice(t,1),this.connecting.length||this.close()},r.prototype.packet=function(e){l("writing packet %j",e);var t=this;t.encoding?t.packetBuffer.push(e):(t.encoding=!0,this.encoder.encode(e,function(n){for(var r=0;r<n.length;r++)t.engine.write(n[r],e.options);t.encoding=!1,t.processPacketQueue()}))},r.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var e=this.packetBuffer.shift();this.packet(e)}},r.prototype.cleanup=function(){l("cleanup");for(var e;e=this.subs.shift();)e.destroy();this.packetBuffer=[],this.encoding=!1,this.lastPing=null,this.decoder.destroy()},r.prototype.close=r.prototype.disconnect=function(){l("disconnect"),this.skipReconnect=!0,this.reconnecting=!1,"opening"==this.readyState&&this.cleanup(),this.backoff.reset(),this.readyState="closed",this.engine&&this.engine.close()},r.prototype.onclose=function(e){l("onclose"),this.cleanup(),this.backoff.reset(),this.readyState="closed",this.emit("close",e),this._reconnection&&!this.skipReconnect&&this.reconnect()},r.prototype.reconnect=function(){if(this.reconnecting||this.skipReconnect)return this;var e=this;if(this.backoff.attempts>=this._reconnectionAttempts)l("reconnect failed"),this.backoff.reset(),this.emitAll("reconnect_failed"),this.reconnecting=!1;else{var t=this.backoff.duration();l("will wait %dms before reconnect attempt",t),this.reconnecting=!0;var n=setTimeout(function(){e.skipReconnect||(l("attempting reconnect"),e.emitAll("reconnect_attempt",e.backoff.attempts),e.emitAll("reconnecting",e.backoff.attempts),e.skipReconnect||e.open(function(t){t?(l("reconnect attempt error"),e.reconnecting=!1,e.reconnect(),e.emitAll("reconnect_error",t.data)):(l("reconnect success"),e.onreconnect())}))},t);this.subs.push({destroy:function(){clearTimeout(n)}})}},r.prototype.onreconnect=function(){var e=this.backoff.attempts;this.reconnecting=!1,this.backoff.reset(),this.updateSocketIds(),this.emitAll("reconnect",e)}},{"./on":3,"./socket":4,backo2:8,"component-bind":11,"component-emitter":12,debug:14,"engine.io-client":16,indexof:32,"socket.io-parser":40}],3:[function(e,t,n){t.exports=function(e,t,n){return e.on(t,n),{destroy:function(){e.removeListener(t,n)}}}},{}],4:[function(e,t,n){function r(e,t){this.io=e,this.nsp=t,this.json=this,this.ids=0,this.acks={},this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0,this.io.autoConnect&&this.open()}var i=e("socket.io-parser"),a=e("component-emitter"),o=e("to-array"),s=e("./on"),d=e("component-bind"),c=e("debug")("socket.io-client:socket"),l=e("has-binary");t.exports=r;var p={connect:1,connect_error:1,connect_timeout:1,connecting:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1,ping:1,pong:1},u=a.prototype.emit;a(r.prototype),r.prototype.subEvents=function(){if(!this.subs){var e=this.io;this.subs=[s(e,"open",d(this,"onopen")),s(e,"packet",d(this,"onpacket")),s(e,"close",d(this,"onclose"))]}},r.prototype.open=r.prototype.connect=function(){return this.connected?this:(this.subEvents(),this.io.open(),"open"==this.io.readyState&&this.onopen(),this.emit("connecting"),this)},r.prototype.send=function(){var e=o(arguments);return e.unshift("message"),this.emit.apply(this,e),this},r.prototype.emit=function(e){if(p.hasOwnProperty(e))return u.apply(this,arguments),this;var t=o(arguments),n=i.EVENT;l(t)&&(n=i.BINARY_EVENT);var r={type:n,data:t};return r.options={},r.options.compress=!this.flags||!1!==this.flags.compress,"function"==typeof t[t.length-1]&&(c("emitting packet with ack id %d",this.ids),this.acks[this.ids]=t.pop(),r.id=this.ids++),this.connected?this.packet(r):this.sendBuffer.push(r),delete this.flags,this},r.prototype.packet=function(e){e.nsp=this.nsp,this.io.packet(e)},r.prototype.onopen=function(){c("transport is open - connecting"),"/"!=this.nsp&&this.packet({type:i.CONNECT})},r.prototype.onclose=function(e){c("close (%s)",e),this.connected=!1,this.disconnected=!0,delete this.id,this.emit("disconnect",e)},r.prototype.onpacket=function(e){if(e.nsp==this.nsp)switch(e.type){case i.CONNECT:this.onconnect();break;case i.EVENT:case i.BINARY_EVENT:this.onevent(e);break;case i.ACK:case i.BINARY_ACK:this.onack(e);break;case i.DISCONNECT:this.ondisconnect();break;case i.ERROR:this.emit("error",e.data)}},r.prototype.onevent=function(e){var t=e.data||[];c("emitting event %j",t),null!=e.id&&(c("attaching ack callback to event"),t.push(this.ack(e.id))),this.connected?u.apply(this,t):this.receiveBuffer.push(t)},r.prototype.ack=function(e){var t=this,n=!1;return function(){if(!n){n=!0;var r=o(arguments);c("sending ack %j",r);var a=l(r)?i.BINARY_ACK:i.ACK;t.packet({type:a,id:e,data:r})}}},r.prototype.onack=function(e){var t=this.acks[e.id];"function"==typeof t?(c("calling ack %s with %j",e.id,e.data),t.apply(this,e.data),delete this.acks[e.id]):c("bad ack %s",e.id)},r.prototype.onconnect=function(){this.connected=!0,this.disconnected=!1,this.emit("connect"),this.emitBuffered()},r.prototype.emitBuffered=function(){var e;for(e=0;e<this.receiveBuffer.length;e++)u.apply(this,this.receiveBuffer[e]);for(this.receiveBuffer=[],e=0;e<this.sendBuffer.length;e++)this.packet(this.sendBuffer[e]);this.sendBuffer=[]},r.prototype.ondisconnect=function(){c("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")},r.prototype.destroy=function(){if(this.subs){for(var e=0;e<this.subs.length;e++)this.subs[e].destroy();this.subs=null}this.io.destroy(this)},r.prototype.close=r.prototype.disconnect=function(){return this.connected&&(c("performing disconnect (%s)",this.nsp),this.packet({type:i.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this},r.prototype.compress=function(e){return this.flags=this.flags||{},this.flags.compress=e,this}},{"./on":3,"component-bind":11,"component-emitter":12,debug:14,"has-binary":30,"socket.io-parser":40,"to-array":43}],5:[function(e,t,n){(function(n){var r=e("parseuri"),i=e("debug")("socket.io-client:url");t.exports=function(e,t){var a=e,t=t||n.location;null==e&&(e=t.protocol+"//"+t.host),"string"==typeof e&&("/"==e.charAt(0)&&(e="/"==e.charAt(1)?t.protocol+e:t.host+e),/^(https?|wss?):\/\//.test(e)||(i("protocol-less url %s",e),e=void 0!==t?t.protocol+"//"+e:"https://"+e),i("parse %s",e),a=r(e)),a.port||(/^(http|ws)$/.test(a.protocol)?a.port="80":/^(http|ws)s$/.test(a.protocol)&&(a.port="443")),a.path=a.path||"/";var o=-1!==a.host.indexOf(":")?"["+a.host+"]":a.host;return a.id=a.protocol+"://"+o+":"+a.port,a.href=a.protocol+"://"+o+(t&&t.port==a.port?"":":"+a.port),a}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{debug:14,parseuri:38}],6:[function(e,t,n){function r(){}t.exports=function(e,t,n){function i(e,r){if(i.count<=0)throw new Error("after called too many times");--i.count,e?(a=!0,t(e),t=n):0!==i.count||a||t(null,r)}var a=!1;return n=n||r,i.count=e,0===e?t():i}},{}],7:[function(e,t,n){t.exports=function(e,t,n){var r=e.byteLength;if(t=t||0,n=n||r,e.slice)return e.slice(t,n);if(t<0&&(t+=r),n<0&&(n+=r),n>r&&(n=r),t>=r||t>=n||0===r)return new ArrayBuffer(0);for(var i=new Uint8Array(e),a=new Uint8Array(n-t),o=t,s=0;o<n;o++,s++)a[s]=i[o];return a.buffer}},{}],8:[function(e,t,n){function r(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}t.exports=r,r.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-n:e+n}return 0|Math.min(e,this.max)},r.prototype.reset=function(){this.attempts=0},r.prototype.setMin=function(e){this.ms=e},r.prototype.setMax=function(e){this.max=e},r.prototype.setJitter=function(e){this.jitter=e}},{}],9:[function(e,t,n){!function(){"use strict";for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=new Uint8Array(256),r=0;r<e.length;r++)t[e.charCodeAt(r)]=r;n.encode=function(t){var n,r=new Uint8Array(t),i=r.length,a="";for(n=0;n<i;n+=3)a+=e[r[n]>>2],a+=e[(3&r[n])<<4|r[n+1]>>4],a+=e[(15&r[n+1])<<2|r[n+2]>>6],a+=e[63&r[n+2]];return i%3==2?a=a.substring(0,a.length-1)+"=":i%3==1&&(a=a.substring(0,a.length-2)+"=="),a},n.decode=function(e){var n,r,i,a,o,s=.75*e.length,d=e.length,c=0;"="===e[e.length-1]&&(s--,"="===e[e.length-2]&&s--);var l=new ArrayBuffer(s),p=new Uint8Array(l);for(n=0;n<d;n+=4)r=t[e.charCodeAt(n)],i=t[e.charCodeAt(n+1)],a=t[e.charCodeAt(n+2)],o=t[e.charCodeAt(n+3)],p[c++]=r<<2|i>>4,p[c++]=(15&i)<<4|a>>2,p[c++]=(3&a)<<6|63&o;return l}}()},{}],10:[function(e,t,n){(function(e){function n(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.buffer instanceof ArrayBuffer){var r=n.buffer;if(n.byteLength!==r.byteLength){var i=new Uint8Array(n.byteLength);i.set(new Uint8Array(r,n.byteOffset,n.byteLength)),r=i.buffer}e[t]=r}}}function r(e,t){t=t||{};var r=new a;n(e);for(var i=0;i<e.length;i++)r.append(e[i]);return t.type?r.getBlob(t.type):r.getBlob()}function i(e,t){return n(e),new Blob(e,t||{})}var a=e.BlobBuilder||e.WebKitBlobBuilder||e.MSBlobBuilder||e.MozBlobBuilder,o=function(){try{return 2===new Blob(["hi"]).size}catch(e){return!1}}(),s=o&&function(){try{return 2===new Blob([new Uint8Array([1,2])]).size}catch(e){return!1}}(),d=a&&a.prototype.append&&a.prototype.getBlob;t.exports=o?s?e.Blob:i:d?r:void 0}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{}],11:[function(e,t,n){var r=[].slice;t.exports=function(e,t){if("string"==typeof t&&(t=e[t]),"function"!=typeof t)throw new Error("bind() requires a function");var n=r.call(arguments,2);return function(){return t.apply(e,n.concat(r.call(arguments)))}}},{}],12:[function(e,t,n){function r(e){if(e)return i(e)}function i(e){for(var t in r.prototype)e[t]=r.prototype[t];return e}t.exports=r,r.prototype.on=r.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},r.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},r.prototype.off=r.prototype.removeListener=r.prototype.removeAllListeners=r.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n=this._callbacks["$"+e];if(!n)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var r,i=0;i<n.length;i++)if((r=n[i])===t||r.fn===t){n.splice(i,1);break}return this},r.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks["$"+e];if(n)for(var r=0,i=(n=n.slice(0)).length;r<i;++r)n[r].apply(this,t);return this},r.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},r.prototype.hasListeners=function(e){return!!this.listeners(e).length}},{}],13:[function(e,t,n){t.exports=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}},{}],14:[function(e,t,n){function r(){var e;try{e=n.storage.debug}catch(e){}return e}(n=t.exports=e("./debug")).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},n.formatArgs=function(){var e=arguments,t=this.useColors;if(e[0]=(t?"%c":"")+this.namespace+(t?" %c":" ")+e[0]+(t?"%c ":" ")+"+"+n.humanize(this.diff),!t)return e;var r="color: "+this.color,i=0,a=0;return(e=[e[0],r,"color: inherit"].concat(Array.prototype.slice.call(e,1)))[0].replace(/%[a-z%]/g,function(e){"%%"!==e&&(i++,"%c"===e&&(a=i))}),e.splice(a,0,r),e},n.save=function(e){try{null==e?n.storage.removeItem("debug"):n.storage.debug=e}catch(e){}},n.load=r,n.useColors=function(){return"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31},n.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),n.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],n.formatters.j=function(e){return JSON.stringify(e)},n.enable(r())},{"./debug":15}],15:[function(e,t,n){function r(){return n.colors[a++%n.colors.length]}(n=t.exports=function(e){function t(){}function a(){var e=a,t=+new Date,o=t-(i||t);e.diff=o,e.prev=i,e.curr=t,i=t,null==e.useColors&&(e.useColors=n.useColors()),null==e.color&&e.useColors&&(e.color=r());var s=Array.prototype.slice.call(arguments);s[0]=n.coerce(s[0]),"string"!=typeof s[0]&&(s=["%o"].concat(s));var d=0;s[0]=s[0].replace(/%([a-z%])/g,function(t,r){if("%%"===t)return t;d++;var i=n.formatters[r];if("function"==typeof i){var a=s[d];t=i.call(e,a),s.splice(d,1),d--}return t}),"function"==typeof n.formatArgs&&(s=n.formatArgs.apply(e,s)),(a.log||n.log||console.log.bind(console)).apply(e,s)}t.enabled=!1,a.enabled=!0;var o=n.enabled(e)?a:t;return o.namespace=e,o}).coerce=function(e){return e instanceof Error?e.stack||e.message:e},n.disable=function(){n.enable("")},n.enable=function(e){n.save(e);for(var t=(e||"").split(/[\s,]+/),r=t.length,i=0;i<r;i++)t[i]&&("-"===(e=t[i].replace(/\*/g,".*?"))[0]?n.skips.push(new RegExp("^"+e.substr(1)+"$")):n.names.push(new RegExp("^"+e+"$")))},n.enabled=function(e){var t,r;for(t=0,r=n.skips.length;t<r;t++)if(n.skips[t].test(e))return!1;for(t=0,r=n.names.length;t<r;t++)if(n.names[t].test(e))return!0;return!1},n.humanize=e("ms"),n.names=[],n.skips=[],n.formatters={};var i,a=0},{ms:35}],16:[function(e,t,n){t.exports=e("./lib/")},{"./lib/":17}],17:[function(e,t,n){t.exports=e("./socket"),t.exports.parser=e("engine.io-parser")},{"./socket":18,"engine.io-parser":27}],18:[function(e,t,n){(function(n){function r(e,t){if(!(this instanceof r))return new r(e,t);t=t||{},e&&"object"==typeof e&&(t=e,e=null),e?(e=l(e),t.hostname=e.host,t.secure="https"==e.protocol||"wss"==e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=l(t.host).host),this.secure=null!=t.secure?t.secure:n.location&&"https:"==location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.agent=t.agent||!1,this.hostname=t.hostname||(n.location?location.hostname:"localhost"),this.port=t.port||(n.location&&location.port?location.port:this.secure?443:80),this.query=t.query||{},"string"==typeof this.query&&(this.query=u.decode(this.query)),this.upgrade=!1!==t.upgrade,this.path=(t.path||"/engine.io").replace(/\/$/,"")+"/",this.forceJSONP=!!t.forceJSONP,this.jsonp=!1!==t.jsonp,this.forceBase64=!!t.forceBase64,this.enablesXDR=!!t.enablesXDR,this.timestampParam=t.timestampParam||"t",this.timestampRequests=t.timestampRequests,this.transports=t.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.policyPort=t.policyPort||843,this.rememberUpgrade=t.rememberUpgrade||!1,this.binaryType=null,this.onlyBinaryUpgrades=t.onlyBinaryUpgrades,this.perMessageDeflate=!1!==t.perMessageDeflate&&(t.perMessageDeflate||{}),!0===this.perMessageDeflate&&(this.perMessageDeflate={}),this.perMessageDeflate&&null==this.perMessageDeflate.threshold&&(this.perMessageDeflate.threshold=1024),this.pfx=t.pfx||null,this.key=t.key||null,this.passphrase=t.passphrase||null,this.cert=t.cert||null,this.ca=t.ca||null,this.ciphers=t.ciphers||null,this.rejectUnauthorized=void 0===t.rejectUnauthorized||t.rejectUnauthorized;var i="object"==typeof n&&n;i.global===i&&t.extraHeaders&&Object.keys(t.extraHeaders).length>0&&(this.extraHeaders=t.extraHeaders),this.open()}function i(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}var a=e("./transports"),o=e("component-emitter"),s=e("debug")("engine.io-client:socket"),d=e("indexof"),c=e("engine.io-parser"),l=e("parseuri"),p=e("parsejson"),u=e("parseqs");t.exports=r,r.priorWebsocketSuccess=!1,o(r.prototype),r.protocol=c.protocol,r.Socket=r,r.Transport=e("./transport"),r.transports=e("./transports"),r.parser=e("engine.io-parser"),r.prototype.createTransport=function(e){s('creating transport "%s"',e);var t=i(this.query);return t.EIO=c.protocol,t.transport=e,this.id&&(t.sid=this.id),new a[e]({agent:this.agent,hostname:this.hostname,port:this.port,secure:this.secure,path:this.path,query:t,forceJSONP:this.forceJSONP,jsonp:this.jsonp,forceBase64:this.forceBase64,enablesXDR:this.enablesXDR,timestampRequests:this.timestampRequests,timestampParam:this.timestampParam,policyPort:this.policyPort,socket:this,pfx:this.pfx,key:this.key,passphrase:this.passphrase,cert:this.cert,ca:this.ca,ciphers:this.ciphers,rejectUnauthorized:this.rejectUnauthorized,perMessageDeflate:this.perMessageDeflate,extraHeaders:this.extraHeaders})},r.prototype.open=function(){var e;if(this.rememberUpgrade&&r.priorWebsocketSuccess&&-1!=this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length){var t=this;return void setTimeout(function(){t.emit("error","No transports available")},0)}e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return this.transports.shift(),void this.open()}e.open(),this.setTransport(e)},r.prototype.setTransport=function(e){s("setting transport %s",e.name);var t=this;this.transport&&(s("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=e,e.on("drain",function(){t.onDrain()}).on("packet",function(e){t.onPacket(e)}).on("error",function(e){t.onError(e)}).on("close",function(){t.onClose("transport close")})},r.prototype.probe=function(e){function t(){if(u.onlyBinaryUpgrades){var t=!this.supportsBinary&&u.transport.supportsBinary;p=p||t}p||(s('probe transport "%s" opened',e),l.send([{type:"ping",data:"probe"}]),l.once("packet",function(t){if(!p)if("pong"==t.type&&"probe"==t.data){if(s('probe transport "%s" pong',e),u.upgrading=!0,u.emit("upgrading",l),!l)return;r.priorWebsocketSuccess="websocket"==l.name,s('pausing current transport "%s"',u.transport.name),u.transport.pause(function(){p||"closed"!=u.readyState&&(s("changing transport and sending upgrade packet"),c(),u.setTransport(l),l.send([{type:"upgrade"}]),u.emit("upgrade",l),l=null,u.upgrading=!1,u.flush())})}else{s('probe transport "%s" failed',e);var n=new Error("probe error");n.transport=l.name,u.emit("upgradeError",n)}}))}function n(){p||(p=!0,c(),l.close(),l=null)}function i(t){var r=new Error("probe error: "+t);r.transport=l.name,n(),s('probe transport "%s" failed because of error: %s',e,t),u.emit("upgradeError",r)}function a(){i("transport closed")}function o(){i("socket closed")}function d(e){l&&e.name!=l.name&&(s('"%s" works - aborting "%s"',e.name,l.name),n())}function c(){l.removeListener("open",t),l.removeListener("error",i),l.removeListener("close",a),u.removeListener("close",o),u.removeListener("upgrading",d)}s('probing transport "%s"',e);var l=this.createTransport(e,{probe:1}),p=!1,u=this;r.priorWebsocketSuccess=!1,l.once("open",t),l.once("error",i),l.once("close",a),this.once("close",o),this.once("upgrading",d),l.open()},r.prototype.onOpen=function(){if(s("socket open"),this.readyState="open",r.priorWebsocketSuccess="websocket"==this.transport.name,this.emit("open"),this.flush(),"open"==this.readyState&&this.upgrade&&this.transport.pause){s("starting upgrade probes");for(var e=0,t=this.upgrades.length;e<t;e++)this.probe(this.upgrades[e])}},r.prototype.onPacket=function(e){if("opening"==this.readyState||"open"==this.readyState)switch(s('socket receive: type "%s", data "%s"',e.type,e.data),this.emit("packet",e),this.emit("heartbeat"),e.type){case"open":this.onHandshake(p(e.data));break;case"pong":this.setPing(),this.emit("pong");break;case"error":var t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emit("data",e.data),this.emit("message",e.data)}else s('packet received with socket readyState "%s"',this.readyState)},r.prototype.onHandshake=function(e){this.emit("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.onOpen(),"closed"!=this.readyState&&(this.setPing(),this.removeListener("heartbeat",this.onHeartbeat),this.on("heartbeat",this.onHeartbeat))},r.prototype.onHeartbeat=function(e){clearTimeout(this.pingTimeoutTimer);var t=this;t.pingTimeoutTimer=setTimeout(function(){"closed"!=t.readyState&&t.onClose("ping timeout")},e||t.pingInterval+t.pingTimeout)},r.prototype.setPing=function(){var e=this;clearTimeout(e.pingIntervalTimer),e.pingIntervalTimer=setTimeout(function(){s("writing ping packet - expecting pong within %sms",e.pingTimeout),e.ping(),e.onHeartbeat(e.pingTimeout)},e.pingInterval)},r.prototype.ping=function(){var e=this;this.sendPacket("ping",function(){e.emit("ping")})},r.prototype.onDrain=function(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emit("drain"):this.flush()},r.prototype.flush=function(){"closed"!=this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(s("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))},r.prototype.write=r.prototype.send=function(e,t,n){return this.sendPacket("message",e,t,n),this},r.prototype.sendPacket=function(e,t,n,r){if("function"==typeof t&&(r=t,t=void 0),"function"==typeof n&&(r=n,n=null),"closing"!=this.readyState&&"closed"!=this.readyState){(n=n||{}).compress=!1!==n.compress;var i={type:e,data:t,options:n};this.emit("packetCreate",i),this.writeBuffer.push(i),r&&this.once("flush",r),this.flush()}},r.prototype.close=function(){function e(){r.onClose("forced close"),s("socket closing - telling transport to close"),r.transport.close()}function t(){r.removeListener("upgrade",t),r.removeListener("upgradeError",t),e()}function n(){r.once("upgrade",t),r.once("upgradeError",t)}if("opening"==this.readyState||"open"==this.readyState){this.readyState="closing";var r=this;this.writeBuffer.length?this.once("drain",function(){this.upgrading?n():e()}):this.upgrading?n():e()}return this},r.prototype.onError=function(e){s("socket error %j",e),r.priorWebsocketSuccess=!1,this.emit("error",e),this.onClose("transport error",e)},r.prototype.onClose=function(e,t){if("opening"==this.readyState||"open"==this.readyState||"closing"==this.readyState){s('socket close with reason: "%s"',e);var n=this;clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",e,t),n.writeBuffer=[],n.prevBufferLen=0}},r.prototype.filterUpgrades=function(e){for(var t=[],n=0,r=e.length;n<r;n++)~d(this.transports,e[n])&&t.push(e[n]);return t}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{"./transport":19,"./transports":20,"component-emitter":26,debug:14,"engine.io-parser":27,indexof:32,parsejson:36,parseqs:37,parseuri:38}],19:[function(e,t,n){function r(e){this.path=e.path,this.hostname=e.hostname,this.port=e.port,this.secure=e.secure,this.query=e.query,this.timestampParam=e.timestampParam,this.timestampRequests=e.timestampRequests,this.readyState="",this.agent=e.agent||!1,this.socket=e.socket,this.enablesXDR=e.enablesXDR,this.pfx=e.pfx,this.key=e.key,this.passphrase=e.passphrase,this.cert=e.cert,this.ca=e.ca,this.ciphers=e.ciphers,this.rejectUnauthorized=e.rejectUnauthorized,this.extraHeaders=e.extraHeaders}var i=e("engine.io-parser"),a=e("component-emitter");t.exports=r,a(r.prototype),r.prototype.onError=function(e,t){var n=new Error(e);return n.type="TransportError",n.description=t,this.emit("error",n),this},r.prototype.open=function(){return"closed"!=this.readyState&&""!=this.readyState||(this.readyState="opening",this.doOpen()),this},r.prototype.close=function(){return"opening"!=this.readyState&&"open"!=this.readyState||(this.doClose(),this.onClose()),this},r.prototype.send=function(e){if("open"!=this.readyState)throw new Error("Transport not open");this.write(e)},r.prototype.onOpen=function(){this.readyState="open",this.writable=!0,this.emit("open")},r.prototype.onData=function(e){var t=i.decodePacket(e,this.socket.binaryType);this.onPacket(t)},r.prototype.onPacket=function(e){this.emit("packet",e)},r.prototype.onClose=function(){this.readyState="closed",this.emit("close")}},{"component-emitter":26,"engine.io-parser":27}],20:[function(e,t,n){(function(t){var r=e("xmlhttprequest-ssl"),i=e("./polling-xhr"),a=e("./polling-jsonp"),o=e("./websocket");n.polling=function(e){var n=!1,o=!1,s=!1!==e.jsonp;if(t.location){var d="https:"==location.protocol,c=location.port;c||(c=d?443:80),n=e.hostname!=location.hostname||c!=e.port,o=e.secure!=d}if(e.xdomain=n,e.xscheme=o,"open"in new r(e)&&!e.forceJSONP)return new i(e);if(!s)throw new Error("JSONP disabled");return new a(e)},n.websocket=o}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{"./polling-jsonp":21,"./polling-xhr":22,"./websocket":24,"xmlhttprequest-ssl":25}],21:[function(e,t,n){(function(n){function r(){}function i(e){a.call(this,e),this.query=this.query||{},s||(n.___eio||(n.___eio=[]),s=n.___eio),this.index=s.length;var t=this;s.push(function(e){t.onData(e)}),this.query.j=this.index,n.document&&n.addEventListener&&n.addEventListener("beforeunload",function(){t.script&&(t.script.onerror=r)},!1)}var a=e("./polling"),o=e("component-inherit");t.exports=i;var s,d=/\n/g,c=/\\n/g;o(i,a),i.prototype.supportsBinary=!1,i.prototype.doClose=function(){this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),a.prototype.doClose.call(this)},i.prototype.doPoll=function(){var e=this,t=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),t.async=!0,t.src=this.uri(),t.onerror=function(t){e.onError("jsonp poll error",t)};var n=document.getElementsByTagName("script")[0];n?n.parentNode.insertBefore(t,n):(document.head||document.body).appendChild(t),this.script=t,"undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent)&&setTimeout(function(){var e=document.createElement("iframe");document.body.appendChild(e),document.body.removeChild(e)},100)},i.prototype.doWrite=function(e,t){function n(){r(),t()}function r(){if(i.iframe)try{i.form.removeChild(i.iframe)}catch(e){i.onError("jsonp polling iframe removal error",e)}try{var e='<iframe src="javascript:0" name="'+i.iframeId+'">';a=document.createElement(e)}catch(e){(a=document.createElement("iframe")).name=i.iframeId,a.src="javascript:0"}a.id=i.iframeId,i.form.appendChild(a),i.iframe=a}var i=this;if(!this.form){var a,o=document.createElement("form"),s=document.createElement("textarea"),l=this.iframeId="eio_iframe_"+this.index;o.className="socketio",o.style.position="absolute",o.style.top="-1000px",o.style.left="-1000px",o.target=l,o.method="POST",o.setAttribute("accept-charset","utf-8"),s.name="d",o.appendChild(s),document.body.appendChild(o),this.form=o,this.area=s}this.form.action=this.uri(),r(),e=e.replace(c,"\\\n"),this.area.value=e.replace(d,"\\n");try{this.form.submit()}catch(e){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"==i.iframe.readyState&&n()}:this.iframe.onload=n}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{"./polling":23,"component-inherit":13}],22:[function(e,t,n){(function(n){function r(){}function i(e){if(d.call(this,e),n.location){var t="https:"==location.protocol,r=location.port;r||(r=t?443:80),this.xd=e.hostname!=n.location.hostname||r!=e.port,this.xs=e.secure!=t}else this.extraHeaders=e.extraHeaders}function a(e){this.method=e.method||"GET",this.uri=e.uri,this.xd=!!e.xd,this.xs=!!e.xs,this.async=!1!==e.async,this.data=void 0!=e.data?e.data:null,this.agent=e.agent,this.isBinary=e.isBinary,this.supportsBinary=e.supportsBinary,this.enablesXDR=e.enablesXDR,this.pfx=e.pfx,this.key=e.key,this.passphrase=e.passphrase,this.cert=e.cert,this.ca=e.ca,this.ciphers=e.ciphers,this.rejectUnauthorized=e.rejectUnauthorized,this.extraHeaders=e.extraHeaders,this.create()}function o(){for(var e in a.requests)a.requests.hasOwnProperty(e)&&a.requests[e].abort()}var s=e("xmlhttprequest-ssl"),d=e("./polling"),c=e("component-emitter"),l=e("component-inherit"),p=e("debug")("engine.io-client:polling-xhr");t.exports=i,t.exports.Request=a,l(i,d),i.prototype.supportsBinary=!0,i.prototype.request=function(e){return e=e||{},e.uri=this.uri(),e.xd=this.xd,e.xs=this.xs,e.agent=this.agent||!1,e.supportsBinary=this.supportsBinary,e.enablesXDR=this.enablesXDR,e.pfx=this.pfx,e.key=this.key,e.passphrase=this.passphrase,e.cert=this.cert,e.ca=this.ca,e.ciphers=this.ciphers,e.rejectUnauthorized=this.rejectUnauthorized,e.extraHeaders=this.extraHeaders,new a(e)},i.prototype.doWrite=function(e,t){var n="string"!=typeof e&&void 0!==e,r=this.request({method:"POST",data:e,isBinary:n}),i=this;r.on("success",t),r.on("error",function(e){i.onError("xhr post error",e)}),this.sendXhr=r},i.prototype.doPoll=function(){p("xhr poll");var e=this.request(),t=this;e.on("data",function(e){t.onData(e)}),e.on("error",function(e){t.onError("xhr poll error",e)}),this.pollXhr=e},c(a.prototype),a.prototype.create=function(){var e={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};e.pfx=this.pfx,e.key=this.key,e.passphrase=this.passphrase,e.cert=this.cert,e.ca=this.ca,e.ciphers=this.ciphers,e.rejectUnauthorized=this.rejectUnauthorized;var t=this.xhr=new s(e),r=this;try{p("xhr open %s: %s",this.method,this.uri),t.open(this.method,this.uri,this.async);try{if(this.extraHeaders){t.setDisableHeaderCheck(!0);for(var i in this.extraHeaders)this.extraHeaders.hasOwnProperty(i)&&t.setRequestHeader(i,this.extraHeaders[i])}}catch(e){}if(this.supportsBinary&&(t.responseType="arraybuffer"),"POST"==this.method)try{this.isBinary?t.setRequestHeader("Content-type","application/octet-stream"):t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}"withCredentials"in t&&(t.withCredentials=!0),this.hasXDR()?(t.onload=function(){r.onLoad()},t.onerror=function(){r.onError(t.responseText)}):t.onreadystatechange=function(){4==t.readyState&&(200==t.status||1223==t.status?r.onLoad():setTimeout(function(){r.onError(t.status)},0))},p("xhr data %s",this.data),t.send(this.data)}catch(e){return void setTimeout(function(){r.onError(e)},0)}n.document&&(this.index=a.requestsCount++,a.requests[this.index]=this)},a.prototype.onSuccess=function(){this.emit("success"),this.cleanup()},a.prototype.onData=function(e){this.emit("data",e),this.onSuccess()},a.prototype.onError=function(e){this.emit("error",e),this.cleanup(!0)},a.prototype.cleanup=function(e){if(void 0!==this.xhr&&null!==this.xhr){if(this.hasXDR()?this.xhr.onload=this.xhr.onerror=r:this.xhr.onreadystatechange=r,e)try{this.xhr.abort()}catch(e){}n.document&&delete a.requests[this.index],this.xhr=null}},a.prototype.onLoad=function(){var e;try{var t;try{t=this.xhr.getResponseHeader("Content-Type").split(";")[0]}catch(e){}if("application/octet-stream"===t)e=this.xhr.response;else if(this.supportsBinary)try{e=String.fromCharCode.apply(null,new Uint8Array(this.xhr.response))}catch(t){for(var n=new Uint8Array(this.xhr.response),r=[],i=0,a=n.length;i<a;i++)r.push(n[i]);e=String.fromCharCode.apply(null,r)}else e=this.xhr.responseText}catch(e){this.onError(e)}null!=e&&this.onData(e)},a.prototype.hasXDR=function(){return void 0!==n.XDomainRequest&&!this.xs&&this.enablesXDR},a.prototype.abort=function(){this.cleanup()},n.document&&(a.requestsCount=0,a.requests={},n.attachEvent?n.attachEvent("onunload",o):n.addEventListener&&n.addEventListener("beforeunload",o,!1))}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{"./polling":23,"component-emitter":26,"component-inherit":13,debug:14,"xmlhttprequest-ssl":25}],23:[function(e,t,n){function r(e){var t=e&&e.forceBase64;l&&!t||(this.supportsBinary=!1),i.call(this,e)}var i=e("../transport"),a=e("parseqs"),o=e("engine.io-parser"),s=e("component-inherit"),d=e("yeast"),c=e("debug")("engine.io-client:polling");t.exports=r;var l=null!=new(e("xmlhttprequest-ssl"))({xdomain:!1}).responseType;s(r,i),r.prototype.name="polling",r.prototype.doOpen=function(){this.poll()},r.prototype.pause=function(e){function t(){c("paused"),n.readyState="paused",e()}var n=this;if(this.readyState="pausing",this.polling||!this.writable){var r=0;this.polling&&(c("we are currently polling - waiting to pause"),r++,this.once("pollComplete",function(){c("pre-pause polling complete"),--r||t()})),this.writable||(c("we are currently writing - waiting to pause"),r++,this.once("drain",function(){c("pre-pause writing complete"),--r||t()}))}else t()},r.prototype.poll=function(){c("polling"),this.polling=!0,this.doPoll(),this.emit("poll")},r.prototype.onData=function(e){var t=this;c("polling got data %s",e);o.decodePayload(e,this.socket.binaryType,function(e,n,r){if("opening"==t.readyState&&t.onOpen(),"close"==e.type)return t.onClose(),!1;t.onPacket(e)}),"closed"!=this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"==this.readyState?this.poll():c('ignoring poll - transport state "%s"',this.readyState))},r.prototype.doClose=function(){function e(){c("writing close packet"),t.write([{type:"close"}])}var t=this;"open"==this.readyState?(c("transport open - closing"),e()):(c("transport not open - deferring close"),this.once("open",e))},r.prototype.write=function(e){n=this;this.writable=!1;var t=function(){n.writable=!0,n.emit("drain")},n=this;o.encodePayload(e,this.supportsBinary,function(e){n.doWrite(e,t)})},r.prototype.uri=function(){var e=this.query||{},t=this.secure?"https":"http",n="";return!1!==this.timestampRequests&&(e[this.timestampParam]=d()),this.supportsBinary||e.sid||(e.b64=1),e=a.encode(e),this.port&&("https"==t&&443!=this.port||"http"==t&&80!=this.port)&&(n=":"+this.port),e.length&&(e="?"+e),t+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+n+this.path+e}},{"../transport":19,"component-inherit":13,debug:14,"engine.io-parser":27,parseqs:37,"xmlhttprequest-ssl":25,yeast:45}],24:[function(e,t,n){(function(n){function r(e){e&&e.forceBase64&&(this.supportsBinary=!1),this.perMessageDeflate=e.perMessageDeflate,i.call(this,e)}var i=e("../transport"),a=e("engine.io-parser"),o=e("parseqs"),s=e("component-inherit"),d=e("yeast"),c=e("debug")("engine.io-client:websocket"),l=n.WebSocket||n.MozWebSocket,p=l;if(!p&&"undefined"==typeof window)try{p=e("ws")}catch(e){}t.exports=r,s(r,i),r.prototype.name="websocket",r.prototype.supportsBinary=!0,r.prototype.doOpen=function(){if(this.check()){var e=this.uri(),t={agent:this.agent,perMessageDeflate:this.perMessageDeflate};t.pfx=this.pfx,t.key=this.key,t.passphrase=this.passphrase,t.cert=this.cert,t.ca=this.ca,t.ciphers=this.ciphers,t.rejectUnauthorized=this.rejectUnauthorized,this.extraHeaders&&(t.headers=this.extraHeaders),this.ws=l?new p(e):new p(e,void 0,t),void 0===this.ws.binaryType&&(this.supportsBinary=!1),this.ws.supports&&this.ws.supports.binary?(this.supportsBinary=!0,this.ws.binaryType="buffer"):this.ws.binaryType="arraybuffer",this.addEventListeners()}},r.prototype.addEventListeners=function(){var e=this;this.ws.onopen=function(){e.onOpen()},this.ws.onclose=function(){e.onClose()},this.ws.onmessage=function(t){e.onData(t.data)},this.ws.onerror=function(t){e.onError("websocket error",t)}},"undefined"!=typeof navigator&&/iPad|iPhone|iPod/i.test(navigator.userAgent)&&(r.prototype.onData=function(e){var t=this;setTimeout(function(){i.prototype.onData.call(t,e)},0)}),r.prototype.write=function(e){function t(){r.emit("flush"),setTimeout(function(){r.writable=!0,r.emit("drain")},0)}var r=this;this.writable=!1;for(var i=e.length,o=0,s=i;o<s;o++)!function(e){a.encodePacket(e,r.supportsBinary,function(a){if(!l){var o={};e.options&&(o.compress=e.options.compress),r.perMessageDeflate&&("string"==typeof a?n.Buffer.byteLength(a):a.length)<r.perMessageDeflate.threshold&&(o.compress=!1)}try{l?r.ws.send(a):r.ws.send(a,o)}catch(e){c("websocket closed before onclose event")}--i||t()})}(e[o])},r.prototype.onClose=function(){i.prototype.onClose.call(this)},r.prototype.doClose=function(){void 0!==this.ws&&this.ws.close()},r.prototype.uri=function(){var e=this.query||{},t=this.secure?"wss":"ws",n="";return this.port&&("wss"==t&&443!=this.port||"ws"==t&&80!=this.port)&&(n=":"+this.port),this.timestampRequests&&(e[this.timestampParam]=d()),this.supportsBinary||(e.b64=1),(e=o.encode(e)).length&&(e="?"+e),t+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+n+this.path+e},r.prototype.check=function(){return!(!p||"__initialize"in p&&this.name===r.prototype.name)}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{"../transport":19,"component-inherit":13,debug:14,"engine.io-parser":27,parseqs:37,ws:void 0,yeast:45}],25:[function(e,t,n){var r=e("has-cors");t.exports=function(e){var t=e.xdomain,n=e.xscheme,i=e.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!t||r))return new XMLHttpRequest}catch(e){}try{if("undefined"!=typeof XDomainRequest&&!n&&i)return new XDomainRequest}catch(e){}if(!t)try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}},{"has-cors":31}],26:[function(e,t,n){function r(e){if(e)return i(e)}function i(e){for(var t in r.prototype)e[t]=r.prototype[t];return e}t.exports=r,r.prototype.on=r.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},r.prototype.once=function(e,t){function n(){r.off(e,n),t.apply(this,arguments)}var r=this;return this._callbacks=this._callbacks||{},n.fn=t,this.on(e,n),this},r.prototype.off=r.prototype.removeListener=r.prototype.removeAllListeners=r.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n=this._callbacks[e];if(!n)return this;if(1==arguments.length)return delete this._callbacks[e],this;for(var r,i=0;i<n.length;i++)if((r=n[i])===t||r.fn===t){n.splice(i,1);break}return this},r.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks[e];if(n)for(var r=0,i=(n=n.slice(0)).length;r<i;++r)n[r].apply(this,t);return this},r.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},r.prototype.hasListeners=function(e){return!!this.listeners(e).length}},{}],27:[function(e,t,n){(function(t){function r(e,t){return t("b"+n.packets[e.type]+e.data.data)}function i(e,t,r){if(!t)return n.encodeBase64Packet(e,r);var i=e.data,a=new Uint8Array(i),o=new Uint8Array(1+i.byteLength);o[0]=_[e.type];for(var s=0;s<a.length;s++)o[s+1]=a[s];return r(o.buffer)}function a(e,t,r){if(!t)return n.encodeBase64Packet(e,r);var i=new FileReader;return i.onload=function(){e.data=i.result,n.encodePacket(e,t,!0,r)},i.readAsArrayBuffer(e.data)}function o(e,t,r){if(!t)return n.encodeBase64Packet(e,r);if(m)return a(e,t,r);var i=new Uint8Array(1);return i[0]=_[e.type],r(new C([i.buffer,e.data]))}function s(e,t,n){for(var r=new Array(e.length),i=u(e.length,n),a=0;a<e.length;a++)!function(e,n,i){t(n,function(t,n){r[e]=n,i(t,r)})}(a,e[a],i)}var d=e("./keys"),c=e("has-binary"),l=e("arraybuffer.slice"),p=e("base64-arraybuffer"),u=e("after"),f=e("utf8"),g=navigator.userAgent.match(/Android/i),h=/PhantomJS/i.test(navigator.userAgent),m=g||h;n.protocol=3;var _=n.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},S=d(_),v={type:"error",data:"parser error"},C=e("blob");n.encodePacket=function(e,n,a,s){"function"==typeof n&&(s=n,n=!1),"function"==typeof a&&(s=a,a=null);var d=void 0===e.data?void 0:e.data.buffer||e.data;if(t.ArrayBuffer&&d instanceof ArrayBuffer)return i(e,n,s);if(C&&d instanceof t.Blob)return o(e,n,s);if(d&&d.base64)return r(e,s);var c=_[e.type];return void 0!==e.data&&(c+=a?f.encode(String(e.data)):String(e.data)),s(""+c)},n.encodeBase64Packet=function(e,r){var i="b"+n.packets[e.type];if(C&&e.data instanceof t.Blob){var a=new FileReader;return a.onload=function(){var e=a.result.split(",")[1];r(i+e)},a.readAsDataURL(e.data)}var o;try{o=String.fromCharCode.apply(null,new Uint8Array(e.data))}catch(t){for(var s=new Uint8Array(e.data),d=new Array(s.length),c=0;c<s.length;c++)d[c]=s[c];o=String.fromCharCode.apply(null,d)}return i+=t.btoa(o),r(i)},n.decodePacket=function(e,t,r){if("string"==typeof e||void 0===e){if("b"==e.charAt(0))return n.decodeBase64Packet(e.substr(1),t);if(r)try{e=f.decode(e)}catch(e){return v}i=e.charAt(0);return Number(i)==i&&S[i]?e.length>1?{type:S[i],data:e.substring(1)}:{type:S[i]}:v}var i=new Uint8Array(e)[0],a=l(e,1);return C&&"blob"===t&&(a=new C([a])),{type:S[i],data:a}},n.decodeBase64Packet=function(e,n){var r=S[e.charAt(0)];if(!t.ArrayBuffer)return{type:r,data:{base64:!0,data:e.substr(1)}};var i=p.decode(e.substr(1));return"blob"===n&&C&&(i=new C([i])),{type:r,data:i}},n.encodePayload=function(e,t,r){function i(e){return e.length+":"+e}"function"==typeof t&&(r=t,t=null);var a=c(e);return t&&a?C&&!m?n.encodePayloadAsBlob(e,r):n.encodePayloadAsArrayBuffer(e,r):e.length?void s(e,function(e,r){n.encodePacket(e,!!a&&t,!0,function(e){r(null,i(e))})},function(e,t){return r(t.join(""))}):r("0:")},n.decodePayload=function(e,t,r){if("string"!=typeof e)return n.decodePayloadAsBinary(e,t,r);"function"==typeof t&&(r=t,t=null);var i;if(""==e)return r(v,0,1);for(var a,o,s="",d=0,c=e.length;d<c;d++){var l=e.charAt(d);if(":"!=l)s+=l;else{if(""==s||s!=(a=Number(s)))return r(v,0,1);if(o=e.substr(d+1,a),s!=o.length)return r(v,0,1);if(o.length){if(i=n.decodePacket(o,t,!0),v.type==i.type&&v.data==i.data)return r(v,0,1);if(!1===r(i,d+a,c))return}d+=a,s=""}}return""!=s?r(v,0,1):void 0},n.encodePayloadAsArrayBuffer=function(e,t){if(!e.length)return t(new ArrayBuffer(0));s(e,function(e,t){n.encodePacket(e,!0,!0,function(e){return t(null,e)})},function(e,n){var r=n.reduce(function(e,t){var n;return n="string"==typeof t?t.length:t.byteLength,e+n.toString().length+n+2},0),i=new Uint8Array(r),a=0;return n.forEach(function(e){var t="string"==typeof e,n=e;if(t){for(var r=new Uint8Array(e.length),o=0;o<e.length;o++)r[o]=e.charCodeAt(o);n=r.buffer}i[a++]=t?0:1;for(var s=n.byteLength.toString(),o=0;o<s.length;o++)i[a++]=parseInt(s[o]);i[a++]=255;for(var r=new Uint8Array(n),o=0;o<r.length;o++)i[a++]=r[o]}),t(i.buffer)})},n.encodePayloadAsBlob=function(e,t){s(e,function(e,t){n.encodePacket(e,!0,!0,function(e){var n=new Uint8Array(1);if(n[0]=1,"string"==typeof e){for(var r=new Uint8Array(e.length),i=0;i<e.length;i++)r[i]=e.charCodeAt(i);e=r.buffer,n[0]=0}for(var a=(e instanceof ArrayBuffer?e.byteLength:e.size).toString(),o=new Uint8Array(a.length+1),i=0;i<a.length;i++)o[i]=parseInt(a[i]);if(o[a.length]=255,C){var s=new C([n.buffer,o.buffer,e]);t(null,s)}})},function(e,n){return t(new C(n))})},n.decodePayloadAsBinary=function(e,t,r){"function"==typeof t&&(r=t,t=null);for(var i=e,a=[],o=!1;i.byteLength>0;){for(var s=new Uint8Array(i),d=0===s[0],c="",p=1;255!=s[p];p++){if(c.length>310){o=!0;break}c+=s[p]}if(o)return r(v,0,1);i=l(i,2+c.length),c=parseInt(c);var u=l(i,0,c);if(d)try{u=String.fromCharCode.apply(null,new Uint8Array(u))}catch(e){var f=new Uint8Array(u);u="";for(p=0;p<f.length;p++)u+=String.fromCharCode(f[p])}a.push(u),i=l(i,c)}var g=a.length;a.forEach(function(e,i){r(n.decodePacket(e,t,!0),i,g)})}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{"./keys":28,after:6,"arraybuffer.slice":7,"base64-arraybuffer":9,blob:10,"has-binary":29,utf8:44}],28:[function(e,t,n){t.exports=Object.keys||function(e){var t=[],n=Object.prototype.hasOwnProperty;for(var r in e)n.call(e,r)&&t.push(r);return t}},{}],29:[function(e,t,n){(function(n){var r=e("isarray");t.exports=function(e){function t(e){if(!e)return!1;if(n.Buffer&&n.Buffer.isBuffer(e)||n.ArrayBuffer&&e instanceof ArrayBuffer||n.Blob&&e instanceof Blob||n.File&&e instanceof File)return!0;if(r(e)){for(var i=0;i<e.length;i++)if(t(e[i]))return!0}else if(e&&"object"==typeof e){e.toJSON&&(e=e.toJSON());for(var a in e)if(Object.prototype.hasOwnProperty.call(e,a)&&t(e[a]))return!0}return!1}return t(e)}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{isarray:33}],30:[function(e,t,n){(function(n){var r=e("isarray");t.exports=function(e){function t(e){if(!e)return!1;if(n.Buffer&&n.Buffer.isBuffer&&n.Buffer.isBuffer(e)||n.ArrayBuffer&&e instanceof ArrayBuffer||n.Blob&&e instanceof Blob||n.File&&e instanceof File)return!0;if(r(e)){for(var i=0;i<e.length;i++)if(t(e[i]))return!0}else if(e&&"object"==typeof e){e.toJSON&&"function"==typeof e.toJSON&&(e=e.toJSON());for(var a in e)if(Object.prototype.hasOwnProperty.call(e,a)&&t(e[a]))return!0}return!1}return t(e)}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{isarray:33}],31:[function(e,t,n){try{t.exports="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(e){t.exports=!1}},{}],32:[function(e,t,n){var r=[].indexOf;t.exports=function(e,t){if(r)return e.indexOf(t);for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1}},{}],33:[function(e,t,n){t.exports=Array.isArray||function(e){return"[object Array]"==Object.prototype.toString.call(e)}},{}],34:[function(e,t,n){(function(e){(function(){function r(e,t){function n(e){if(n[e]!==m)return n[e];var r;if("bug-string-char-index"==e)r="a"!="a"[0];else if("json"==e)r=n("json-stringify")&&n("json-parse");else{var i,o='{"a":[1,true,false,null,"\\u0000\\b\\n\\f\\r\\t"]}';if("json-stringify"==e){var d=t.stringify,l="function"==typeof d&&v;if(l){(i=function(){return 1}).toJSON=i;try{l="0"===d(0)&&"0"===d(new a)&&'""'==d(new s)&&d(S)===m&&d(m)===m&&d()===m&&"1"===d(i)&&"[1]"==d([i])&&"[null]"==d([m])&&"null"==d(null)&&"[null,null,null]"==d([m,S,null])&&d({a:[i,!0,!1,null,"\0\b\n\f\r\t"]})==o&&"1"===d(null,i)&&"[\n 1,\n 2\n]"==d([1,2],null,1)&&'"-271821-04-20T00:00:00.000Z"'==d(new c(-864e13))&&'"+275760-09-13T00:00:00.000Z"'==d(new c(864e13))&&'"-000001-01-01T00:00:00.000Z"'==d(new c(-621987552e5))&&'"1969-12-31T23:59:59.999Z"'==d(new c(-1))}catch(e){l=!1}}r=l}if("json-parse"==e){var p=t.parse;if("function"==typeof p)try{if(0===p("0")&&!p(!1)){var u=5==(i=p(o)).a.length&&1===i.a[0];if(u){try{u=!p('"\t"')}catch(e){}if(u)try{u=1!==p("01")}catch(e){}if(u)try{u=1!==p("1.")}catch(e){}}}}catch(e){u=!1}r=u}}return n[e]=!!r}e||(e=o.Object()),t||(t=o.Object());var a=e.Number||o.Number,s=e.String||o.String,d=e.Object||o.Object,c=e.Date||o.Date,l=e.SyntaxError||o.SyntaxError,p=e.TypeError||o.TypeError,u=e.Math||o.Math,f=e.JSON||o.JSON;"object"==typeof f&&f&&(t.stringify=f.stringify,t.parse=f.parse);var g,h,m,_=d.prototype,S=_.toString,v=new c(-0xc782b5b800cec);try{v=-109252==v.getUTCFullYear()&&0===v.getUTCMonth()&&1===v.getUTCDate()&&10==v.getUTCHours()&&37==v.getUTCMinutes()&&6==v.getUTCSeconds()&&708==v.getUTCMilliseconds()}catch(e){}if(!n("json")){var C=n("bug-string-char-index");if(!v)var T=u.floor,y=[0,31,59,90,120,151,181,212,243,273,304,334],E=function(e,t){return y[t]+365*(e-1970)+T((e-1969+(t=+(t>1)))/4)-T((e-1901+t)/100)+T((e-1601+t)/400)};if((g=_.hasOwnProperty)||(g=function(e){var t,n={};return(n.__proto__=null,n.__proto__={toString:1},n).toString!=S?g=function(e){var t=this.__proto__,n=e in(this.__proto__=null,this);return this.__proto__=t,n}:(t=n.constructor,g=function(e){var n=(this.constructor||t).prototype;return e in this&&!(e in n&&this[e]===n[e])}),n=null,g.call(this,e)}),h=function(e,t){var n,r,a,o=0;(n=function(){this.valueOf=0}).prototype.valueOf=0,r=new n;for(a in r)g.call(r,a)&&o++;return n=r=null,o?h=2==o?function(e,t){var n,r={},i="[object Function]"==S.call(e);for(n in e)i&&"prototype"==n||g.call(r,n)||!(r[n]=1)||!g.call(e,n)||t(n)}:function(e,t){var n,r,i="[object Function]"==S.call(e);for(n in e)i&&"prototype"==n||!g.call(e,n)||(r="constructor"===n)||t(n);(r||g.call(e,n="constructor"))&&t(n)}:(r=["valueOf","toString","toLocaleString","propertyIsEnumerable","isPrototypeOf","hasOwnProperty","constructor"],h=function(e,t){var n,a,o="[object Function]"==S.call(e),s=!o&&"function"!=typeof e.constructor&&i[typeof e.hasOwnProperty]&&e.hasOwnProperty||g;for(n in e)o&&"prototype"==n||!s.call(e,n)||t(n);for(a=r.length;n=r[--a];s.call(e,n)&&t(n));}),h(e,t)},!n("json-stringify")){var R={92:"\\\\",34:'\\"',8:"\\b",12:"\\f",10:"\\n",13:"\\r",9:"\\t"},b=function(e,t){return("000000"+(t||0)).slice(-e)},A=function(e){for(var t='"',n=0,r=e.length,i=!C||r>10,a=i&&(C?e.split(""):e);n<r;n++){var o=e.charCodeAt(n);switch(o){case 8:case 9:case 10:case 12:case 13:case 34:case 92:t+=R[o];break;default:if(o<32){t+="\\u00"+b(2,o.toString(16));break}t+=i?a[n]:e.charAt(n)}}return t+'"'},P=function(e,t,n,r,i,a,o){var s,d,c,l,u,f,_,v,C,y,R,w,D,I,O,k;try{s=t[e]}catch(e){}if("object"==typeof s&&s)if("[object Date]"!=(d=S.call(s))||g.call(s,"toJSON"))"function"==typeof s.toJSON&&("[object Number]"!=d&&"[object String]"!=d&&"[object Array]"!=d||g.call(s,"toJSON"))&&(s=s.toJSON(e));else if(s>-1/0&&s<1/0){if(E){for(u=T(s/864e5),c=T(u/365.2425)+1970-1;E(c+1,0)<=u;c++);for(l=T((u-E(c,0))/30.42);E(c,l+1)<=u;l++);u=1+u-E(c,l),_=T((f=(s%864e5+864e5)%864e5)/36e5)%24,v=T(f/6e4)%60,C=T(f/1e3)%60,y=f%1e3}else c=s.getUTCFullYear(),l=s.getUTCMonth(),u=s.getUTCDate(),_=s.getUTCHours(),v=s.getUTCMinutes(),C=s.getUTCSeconds(),y=s.getUTCMilliseconds();s=(c<=0||c>=1e4?(c<0?"-":"+")+b(6,c<0?-c:c):b(4,c))+"-"+b(2,l+1)+"-"+b(2,u)+"T"+b(2,_)+":"+b(2,v)+":"+b(2,C)+"."+b(3,y)+"Z"}else s=null;if(n&&(s=n.call(t,e,s)),null===s)return"null";if("[object Boolean]"==(d=S.call(s)))return""+s;if("[object Number]"==d)return s>-1/0&&s<1/0?""+s:"null";if("[object String]"==d)return A(""+s);if("object"==typeof s){for(I=o.length;I--;)if(o[I]===s)throw p();if(o.push(s),R=[],O=a,a+=i,"[object Array]"==d){for(D=0,I=s.length;D<I;D++)w=P(D,s,n,r,i,a,o),R.push(w===m?"null":w);k=R.length?i?"[\n"+a+R.join(",\n"+a)+"\n"+O+"]":"["+R.join(",")+"]":"[]"}else h(r||s,function(e){var t=P(e,s,n,r,i,a,o);t!==m&&R.push(A(e)+":"+(i?" ":"")+t)}),k=R.length?i?"{\n"+a+R.join(",\n"+a)+"\n"+O+"}":"{"+R.join(",")+"}":"{}";return o.pop(),k}};t.stringify=function(e,t,n){var r,a,o,s;if(i[typeof t]&&t)if("[object Function]"==(s=S.call(t)))a=t;else if("[object Array]"==s){o={};for(var d,c=0,l=t.length;c<l;d=t[c++],("[object String]"==(s=S.call(d))||"[object Number]"==s)&&(o[d]=1));}if(n)if("[object Number]"==(s=S.call(n))){if((n-=n%1)>0)for(r="",n>10&&(n=10);r.length<n;r+=" ");}else"[object String]"==s&&(r=n.length<=10?n:n.slice(0,10));return P("",(d={},d[""]=e,d),a,o,r,"",[])}}if(!n("json-parse")){var w,D,I=s.fromCharCode,O={92:"\\",34:'"',47:"/",98:"\b",116:"\t",110:"\n",102:"\f",114:"\r"},k=function(){throw w=D=null,l()},N=function(){for(var e,t,n,r,i,a=D,o=a.length;w<o;)switch(i=a.charCodeAt(w)){case 9:case 10:case 13:case 32:w++;break;case 123:case 125:case 91:case 93:case 58:case 44:return e=C?a.charAt(w):a[w],w++,e;case 34:for(e="@",w++;w<o;)if((i=a.charCodeAt(w))<32)k();else if(92==i)switch(i=a.charCodeAt(++w)){case 92:case 34:case 47:case 98:case 116:case 110:case 102:case 114:e+=O[i],w++;break;case 117:for(t=++w,n=w+4;w<n;w++)(i=a.charCodeAt(w))>=48&&i<=57||i>=97&&i<=102||i>=65&&i<=70||k();e+=I("0x"+a.slice(t,w));break;default:k()}else{if(34==i)break;for(i=a.charCodeAt(w),t=w;i>=32&&92!=i&&34!=i;)i=a.charCodeAt(++w);e+=a.slice(t,w)}if(34==a.charCodeAt(w))return w++,e;k();default:if(t=w,45==i&&(r=!0,i=a.charCodeAt(++w)),i>=48&&i<=57){for(48==i&&(i=a.charCodeAt(w+1))>=48&&i<=57&&k(),r=!1;w<o&&(i=a.charCodeAt(w))>=48&&i<=57;w++);if(46==a.charCodeAt(w)){for(n=++w;n<o&&(i=a.charCodeAt(n))>=48&&i<=57;n++);n==w&&k(),w=n}if(101==(i=a.charCodeAt(w))||69==i){for(43!=(i=a.charCodeAt(++w))&&45!=i||w++,n=w;n<o&&(i=a.charCodeAt(n))>=48&&i<=57;n++);n==w&&k(),w=n}return+a.slice(t,w)}if(r&&k(),"true"==a.slice(w,w+4))return w+=4,!0;if("false"==a.slice(w,w+5))return w+=5,!1;if("null"==a.slice(w,w+4))return w+=4,null;k()}return"$"},M=function(e){var t,n;if("$"==e&&k(),"string"==typeof e){if("@"==(C?e.charAt(0):e[0]))return e.slice(1);if("["==e){for(t=[];"]"!=(e=N());n||(n=!0))n&&(","==e?"]"==(e=N())&&k():k()),","==e&&k(),t.push(M(e));return t}if("{"==e){for(t={};"}"!=(e=N());n||(n=!0))n&&(","==e?"}"==(e=N())&&k():k()),","!=e&&"string"==typeof e&&"@"==(C?e.charAt(0):e[0])&&":"==N()||k(),t[e.slice(1)]=M(N());return t}k()}return e},x=function(e,t,n){var r=L(e,t,n);r===m?delete e[t]:e[t]=r},L=function(e,t,n){var r,i=e[t];if("object"==typeof i&&i)if("[object Array]"==S.call(i))for(r=i.length;r--;)x(i,r,n);else h(i,function(e){x(i,e,n)});return n.call(e,t,i)};t.parse=function(e,t){var n,r;return w=0,D=""+e,n=M(N()),"$"!=N()&&k(),w=D=null,t&&"[object Function]"==S.call(t)?L((r={},r[""]=n,r),"",t):n}}}return t.runInContext=r,t}var i={function:!0,object:!0},a=i[typeof n]&&n&&!n.nodeType&&n,o=i[typeof window]&&window||this,s=a&&i[typeof t]&&t&&!t.nodeType&&"object"==typeof e&&e;if(!s||s.global!==s&&s.window!==s&&s.self!==s||(o=s),a)r(o,a);else{var d=o.JSON,c=o.JSON3,l=!1,p=r(o,o.JSON3={noConflict:function(){return l||(l=!0,o.JSON=d,o.JSON3=c,d=c=null),p}});o.JSON={parse:p.parse,stringify:p.stringify}}}).call(this)}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{}],35:[function(e,t,n){function r(e){if(!((e=""+e).length>1e4)){var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(t){var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return n*p;case"days":case"day":case"d":return n*l;case"hours":case"hour":case"hrs":case"hr":case"h":return n*c;case"minutes":case"minute":case"mins":case"min":case"m":return n*d;case"seconds":case"second":case"secs":case"sec":case"s":return n*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n}}}}function i(e){return e>=l?Math.round(e/l)+"d":e>=c?Math.round(e/c)+"h":e>=d?Math.round(e/d)+"m":e>=s?Math.round(e/s)+"s":e+"ms"}function a(e){return o(e,l,"day")||o(e,c,"hour")||o(e,d,"minute")||o(e,s,"second")||e+" ms"}function o(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}var s=1e3,d=60*s,c=60*d,l=24*c,p=365.25*l;t.exports=function(e,t){return t=t||{},"string"==typeof e?r(e):t.long?a(e):i(e)}},{}],36:[function(e,t,n){(function(e){var n=/^[\],:{}\s]*$/,r=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,i=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,a=/(?:^|:|,)(?:\s*\[)+/g,o=/^\s+/,s=/\s+$/;t.exports=function(t){return"string"==typeof t&&t?(t=t.replace(o,"").replace(s,""),e.JSON&&JSON.parse?JSON.parse(t):n.test(t.replace(r,"@").replace(i,"]").replace(a,""))?new Function("return "+t)():void 0):null}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{}],37:[function(e,t,n){n.encode=function(e){var t="";for(var n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t},n.decode=function(e){for(var t={},n=e.split("&"),r=0,i=n.length;r<i;r++){var a=n[r].split("=");t[decodeURIComponent(a[0])]=decodeURIComponent(a[1])}return t}},{}],38:[function(e,t,n){var r=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,i=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];t.exports=function(e){var t=e,n=e.indexOf("["),a=e.indexOf("]");-1!=n&&-1!=a&&(e=e.substring(0,n)+e.substring(n,a).replace(/:/g,";")+e.substring(a,e.length));for(var o=r.exec(e||""),s={},d=14;d--;)s[i[d]]=o[d]||"";return-1!=n&&-1!=a&&(s.source=t,s.host=s.host.substring(1,s.host.length-1).replace(/;/g,":"),s.authority=s.authority.replace("[","").replace("]","").replace(/;/g,":"),s.ipv6uri=!0),s}},{}],39:[function(e,t,n){(function(t){var r=e("isarray"),i=e("./is-buffer");n.deconstructPacket=function(e){function t(e){if(!e)return e;if(i(e)){var a={_placeholder:!0,num:n.length};return n.push(e),a}if(r(e)){for(var o=new Array(e.length),s=0;s<e.length;s++)o[s]=t(e[s]);return o}if("object"==typeof e&&!(e instanceof Date)){o={};for(var d in e)o[d]=t(e[d]);return o}return e}var n=[],a=e.data,o=e;return o.data=t(a),o.attachments=n.length,{packet:o,buffers:n}},n.reconstructPacket=function(e,t){function n(e){if(e&&e._placeholder)return t[e.num];if(r(e)){for(var i=0;i<e.length;i++)e[i]=n(e[i]);return e}if(e&&"object"==typeof e){for(var a in e)e[a]=n(e[a]);return e}return e}return e.data=n(e.data),e.attachments=void 0,e},n.removeBlobs=function(e,n){function a(e,d,c){if(!e)return e;if(t.Blob&&e instanceof Blob||t.File&&e instanceof File){o++;var l=new FileReader;l.onload=function(){c?c[d]=this.result:s=this.result,--o||n(s)},l.readAsArrayBuffer(e)}else if(r(e))for(var p=0;p<e.length;p++)a(e[p],p,e);else if(e&&"object"==typeof e&&!i(e))for(var u in e)a(e[u],u,e)}var o=0,s=e;a(s),o||n(s)}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{"./is-buffer":41,isarray:33}],40:[function(e,t,n){function r(){}function i(e){var t="",r=!1;return t+=e.type,n.BINARY_EVENT!=e.type&&n.BINARY_ACK!=e.type||(t+=e.attachments,t+="-"),e.nsp&&"/"!=e.nsp&&(r=!0,t+=e.nsp),null!=e.id&&(r&&(t+=",",r=!1),t+=e.id),null!=e.data&&(r&&(t+=","),t+=p.stringify(e.data)),l("encoded %j as %s",e,t),t}function a(e,t){f.removeBlobs(e,function(e){var n=f.deconstructPacket(e),r=i(n.packet),a=n.buffers;a.unshift(r),t(a)})}function o(){this.reconstructor=null}function s(e){var t={},r=0;if(t.type=Number(e.charAt(0)),null==n.types[t.type])return c();if(n.BINARY_EVENT==t.type||n.BINARY_ACK==t.type){for(var i="";"-"!=e.charAt(++r)&&(i+=e.charAt(r),r!=e.length););if(i!=Number(i)||"-"!=e.charAt(r))throw new Error("Illegal attachments");t.attachments=Number(i)}if("/"==e.charAt(r+1))for(t.nsp="";++r&&","!=(o=e.charAt(r))&&(t.nsp+=o,r!=e.length););else t.nsp="/";var a=e.charAt(r+1);if(""!==a&&Number(a)==a){for(t.id="";++r;){var o=e.charAt(r);if(null==o||Number(o)!=o){--r;break}if(t.id+=e.charAt(r),r==e.length)break}t.id=Number(t.id)}if(e.charAt(++r))try{t.data=p.parse(e.substr(r))}catch(e){return c()}return l("decoded %s as %j",e,t),t}function d(e){this.reconPack=e,this.buffers=[]}function c(e){return{type:n.ERROR,data:"parser error"}}var l=e("debug")("socket.io-parser"),p=e("json3"),u=(e("isarray"),e("component-emitter")),f=e("./binary"),g=e("./is-buffer");n.protocol=4,n.types=["CONNECT","DISCONNECT","EVENT","ACK","ERROR","BINARY_EVENT","BINARY_ACK"],n.CONNECT=0,n.DISCONNECT=1,n.EVENT=2,n.ACK=3,n.ERROR=4,n.BINARY_EVENT=5,n.BINARY_ACK=6,n.Encoder=r,n.Decoder=o,r.prototype.encode=function(e,t){l("encoding packet %j",e),n.BINARY_EVENT==e.type||n.BINARY_ACK==e.type?a(e,t):t([i(e)])},u(o.prototype),o.prototype.add=function(e){var t;if("string"==typeof e)t=s(e),n.BINARY_EVENT==t.type||n.BINARY_ACK==t.type?(this.reconstructor=new d(t),0===this.reconstructor.reconPack.attachments&&this.emit("decoded",t)):this.emit("decoded",t);else{if(!g(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");(t=this.reconstructor.takeBinaryData(e))&&(this.reconstructor=null,this.emit("decoded",t))}},o.prototype.destroy=function(){this.reconstructor&&this.reconstructor.finishedReconstruction()},d.prototype.takeBinaryData=function(e){if(this.buffers.push(e),this.buffers.length==this.reconPack.attachments){var t=f.reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null},d.prototype.finishedReconstruction=function(){this.reconPack=null,this.buffers=[]}},{"./binary":39,"./is-buffer":41,"component-emitter":42,debug:14,isarray:33,json3:34}],41:[function(e,t,n){(function(e){t.exports=function(t){return e.Buffer&&e.Buffer.isBuffer(t)||e.ArrayBuffer&&t instanceof ArrayBuffer}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{}],42:[function(e,t,n){arguments[4][26][0].apply(n,arguments)},{dup:26}],43:[function(e,t,n){t.exports=function(e,t){for(var n=[],r=(t=t||0)||0;r<e.length;r++)n[r-t]=e[r];return n}},{}],44:[function(e,t,n){(function(e){!function(r){function i(e){for(var t,n,r=[],i=0,a=e.length;i<a;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<a?56320==(64512&(n=e.charCodeAt(i++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),i--):r.push(t);return r}function a(e){for(var t,n=e.length,r=-1,i="";++r<n;)(t=e[r])>65535&&(i+=_((t-=65536)>>>10&1023|55296),t=56320|1023&t),i+=_(t);return i}function o(e){if(e>=55296&&e<=57343)throw Error("Lone surrogate U+"+e.toString(16).toUpperCase()+" is not a scalar value")}function s(e,t){return _(e>>t&63|128)}function d(e){if(0==(4294967168&e))return _(e);var t="";return 0==(4294965248&e)?t=_(e>>6&31|192):0==(4294901760&e)?(o(e),t=_(e>>12&15|224),t+=s(e,6)):0==(4292870144&e)&&(t=_(e>>18&7|240),t+=s(e,12),t+=s(e,6)),t+=_(63&e|128)}function c(){if(m>=h)throw Error("Invalid byte index");var e=255&g[m];if(m++,128==(192&e))return 63&e;throw Error("Invalid continuation byte")}function l(){var e,t,n,r,i;if(m>h)throw Error("Invalid byte index");if(m==h)return!1;if(e=255&g[m],m++,0==(128&e))return e;if(192==(224&e)){if((i=(31&e)<<6|(t=c()))>=128)return i;throw Error("Invalid continuation byte")}if(224==(240&e)){if(t=c(),n=c(),(i=(15&e)<<12|t<<6|n)>=2048)return o(i),i;throw Error("Invalid continuation byte")}if(240==(248&e)&&(t=c(),n=c(),r=c(),(i=(15&e)<<18|t<<12|n<<6|r)>=65536&&i<=1114111))return i;throw Error("Invalid UTF-8 detected")}var p="object"==typeof n&&n,u="object"==typeof t&&t&&t.exports==p&&t,f="object"==typeof e&&e;f.global!==f&&f.window!==f||(r=f);var g,h,m,_=String.fromCharCode,S={version:"2.0.0",encode:function(e){for(var t=i(e),n=t.length,r=-1,a="";++r<n;)a+=d(t[r]);return a},decode:function(e){g=i(e),h=g.length,m=0;for(var t,n=[];!1!==(t=l());)n.push(t);return a(n)}};if(p&&!p.nodeType)if(u)u.exports=S;else{var v={}.hasOwnProperty;for(var C in S)v.call(S,C)&&(p[C]=S[C])}else r.utf8=S}(this)}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{})},{}],45:[function(e,t,n){"use strict";function r(e){var t="";do{t=o[e%s]+t,e=Math.floor(e/s)}while(e>0);return t}function i(){var e=r(+new Date);return e!==a?(c=0,a=e):e+"."+r(c++)}for(var a,o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),s=64,d={},c=0,l=0;l<s;l++)d[o[l]]=l;i.encode=r,i.decode=function(e){var t=0;for(l=0;l<e.length;l++)t=t*s+d[e.charAt(l)];return t},t.exports=i},{}]},{},[1])(1)});var AdapterJS=AdapterJS||{};AdapterJS.options=AdapterJS.options||{},AdapterJS.options.getAllCams=!!AdapterJS.options.getAllCams,AdapterJS.options.hidePluginInstallPrompt=!!AdapterJS.options.hidePluginInstallPrompt,AdapterJS.options.forceSafariPlugin=!!AdapterJS.options.forceSafariPlugin,AdapterJS.VERSION="0.15.0",AdapterJS.onwebrtcready=AdapterJS.onwebrtcready||function(e){},AdapterJS._onwebrtcreadies=[],AdapterJS.webRTCReady=function(e){if("function"!=typeof e)throw new Error("Callback provided is not a function");var t=function(){"function"==typeof window.require&&"function"==typeof AdapterJS._defineMediaSourcePolyfill&&AdapterJS._defineMediaSourcePolyfill(),e(null!==AdapterJS.WebRTCPlugin.plugin)};!0===AdapterJS.onwebrtcreadyDone?t():AdapterJS._onwebrtcreadies.push(t)},AdapterJS.WebRTCPlugin=AdapterJS.WebRTCPlugin||{},AdapterJS.WebRTCPlugin.pluginInfo=AdapterJS.WebRTCPlugin.pluginInfo||{prefix:"Tem",plugName:"TemWebRTCPlugin",pluginId:"plugin0",type:"application/x-temwebrtcplugin",onload:"__TemWebRTCReady0",portalLink:"https://skylink.io/plugin/",downloadLink:null,companyName:"Temasys",downloadLinks:{mac:"https://bit.ly/webrtcpluginpkg",win:"https://bit.ly/webrtcpluginmsi"}},void 0!==AdapterJS.WebRTCPlugin.pluginInfo.downloadLinks&&null!==AdapterJS.WebRTCPlugin.pluginInfo.downloadLinks&&(navigator.platform.match(/^Mac/i)?AdapterJS.WebRTCPlugin.pluginInfo.downloadLink=AdapterJS.WebRTCPlugin.pluginInfo.downloadLinks.mac:navigator.platform.match(/^Win/i)&&(AdapterJS.WebRTCPlugin.pluginInfo.downloadLink=AdapterJS.WebRTCPlugin.pluginInfo.downloadLinks.win)),AdapterJS.WebRTCPlugin.TAGS={NONE:"none",AUDIO:"audio",VIDEO:"video"},AdapterJS.WebRTCPlugin.pageId=Math.random().toString(36).slice(2),AdapterJS.WebRTCPlugin.plugin=null,AdapterJS.WebRTCPlugin.setLogLevel=null,AdapterJS.WebRTCPlugin.defineWebRTCInterface=null,AdapterJS.WebRTCPlugin.isPluginInstalled=null,AdapterJS.WebRTCPlugin.pluginInjectionInterval=null,AdapterJS.WebRTCPlugin.injectPlugin=null,AdapterJS.WebRTCPlugin.PLUGIN_STATES={NONE:0,INITIALIZING:1,INJECTING:2,INJECTED:3,READY:4},AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.NONE,AdapterJS.onwebrtcreadyDone=!1,AdapterJS.WebRTCPlugin.PLUGIN_LOG_LEVELS={NONE:"NONE",ERROR:"ERROR",WARNING:"WARNING",INFO:"INFO",VERBOSE:"VERBOSE",SENSITIVE:"SENSITIVE"},AdapterJS.WebRTCPlugin.WaitForPluginReady=null,AdapterJS.WebRTCPlugin.callWhenPluginReady=null,__TemWebRTCReady0=function(){"interactive"===document.readyState||"complete"===document.readyState?(AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY,AdapterJS.maybeThroughWebRTCReady()):setTimeout(__TemWebRTCReady0,100)},AdapterJS.maybeThroughWebRTCReady=function(){AdapterJS.onwebrtcreadyDone||(AdapterJS.onwebrtcreadyDone=!0,AdapterJS._onwebrtcreadies.length?AdapterJS._onwebrtcreadies.forEach(function(e){"function"==typeof e&&e(null!==AdapterJS.WebRTCPlugin.plugin)}):"function"==typeof AdapterJS.onwebrtcready&&AdapterJS.onwebrtcready(null!==AdapterJS.WebRTCPlugin.plugin))},AdapterJS.TEXT={PLUGIN:{REQUIRE_INSTALLATION:"This website requires you to install a WebRTC-enabling plugin to work on this browser.",NOT_SUPPORTED:"Your browser does not support WebRTC.",BUTTON:"Install Now"},REFRESH:{REQUIRE_REFRESH:"Please refresh page",BUTTON:"Refresh Page"}},AdapterJS._iceConnectionStates={starting:"starting",checking:"checking",connected:"connected",completed:"connected",done:"completed",disconnected:"disconnected",failed:"failed",closed:"closed"},AdapterJS._iceConnectionFiredStates=[],AdapterJS.isDefined=null,AdapterJS.parseWebrtcDetectedBrowser=function(){var e=null;if(window.opr&&opr.addons||window.opera||navigator.userAgent.indexOf(" OPR/")>=0)e=navigator.userAgent.match(/OPR\/(\d+)/i)||[],webrtcDetectedBrowser="opera",webrtcDetectedVersion=parseInt(e[1]||"0",10),webrtcMinimumVersion=26,webrtcDetectedType="webkit",webrtcDetectedDCSupport="SCTP";else if(navigator.userAgent.match(/Bowser\/[0-9.]*/g)){e=navigator.userAgent.match(/Bowser\/[0-9.]*/g)||[];var t=parseInt((navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[])[2]||"0",10);webrtcDetectedBrowser="bowser",webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),webrtcMinimumVersion=0,webrtcDetectedType="webkit",webrtcDetectedDCSupport=t>30?"SCTP":"RTP"}else if(navigator.userAgent.indexOf("OPiOS")>0)e=navigator.userAgent.match(/OPiOS\/([0-9]+)\./),webrtcDetectedBrowser="opera",webrtcDetectedVersion=parseInt(e[1]||"0",10),webrtcMinimumVersion=0,webrtcDetectedType=null,webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("CriOS")>0)e=navigator.userAgent.match(/CriOS\/([0-9]+)\./)||[],webrtcDetectedBrowser="chrome",webrtcDetectedVersion=parseInt(e[1]||"0",10),webrtcMinimumVersion=0,webrtcDetectedType=null,webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("FxiOS")>0)e=navigator.userAgent.match(/FxiOS\/([0-9]+)\./)||[],webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(e[1]||"0",10),webrtcMinimumVersion=0,webrtcDetectedType=null,webrtcDetectedDCSupport=null;else if(document.documentMode)e=/\brv[ :]+(\d+)/g.exec(navigator.userAgent)||[],webrtcDetectedBrowser="IE",webrtcDetectedVersion=parseInt(e[1],10),webrtcMinimumVersion=9,webrtcDetectedType="plugin",webrtcDetectedDCSupport="SCTP",webrtcDetectedVersion||(e=/\bMSIE[ :]+(\d+)/g.exec(navigator.userAgent)||[],webrtcDetectedVersion=parseInt(e[1]||"0",10));else if(window.StyleMedia||navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))e=navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)||[],webrtcDetectedBrowser="edge",webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),webrtcMinimumVersion=13.10547,webrtcDetectedType="ms",webrtcDetectedDCSupport=null;else if("undefined"!=typeof InstallTrigger||navigator.userAgent.indexOf("irefox")>0)e=navigator.userAgent.match(/Firefox\/([0-9]+)\./)||[],webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(e[1]||"0",10),webrtcMinimumVersion=33,webrtcDetectedType="moz",webrtcDetectedDCSupport="SCTP";else if(window.chrome&&window.chrome.webstore||navigator.userAgent.indexOf("Chrom")>0)e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[],webrtcDetectedBrowser="chrome",webrtcDetectedVersion=parseInt(e[2]||"0",10),webrtcMinimumVersion=38,webrtcDetectedType="webkit",webrtcDetectedDCSupport=webrtcDetectedVersion>30?"SCTP":"RTP";else if(/constructor/i.test(window.HTMLElement)||"[object SafariRemoteNotification]"===(!window.safari||safari.pushNotification).toString()||navigator.userAgent.match(/AppleWebKit\/(\d+)\./)||navigator.userAgent.match(/Version\/(\d+).(\d+)/)){e=navigator.userAgent.match(/version\/(\d+)/i)||[],AppleWebKitBuild=navigator.userAgent.match(/AppleWebKit\/(\d+)/i)||[];var n=navigator.userAgent.match(/(iPhone|iPad)/gi),r=AppleWebKitBuild.length>=1&&AppleWebKitBuild[1]>=604;webrtcDetectedBrowser="safari",webrtcDetectedVersion=parseInt(e[1]||"0",10),webrtcMinimumVersion=7,webrtcDetectedType=n?r?"AppleWebKit":null:r&&!AdapterJS.options.forceSafariPlugin?"AppleWebKit":"plugin",webrtcDetectedDCSupport="SCTP"}AdapterJS.webrtcDetectedBrowser=window.webrtcDetectedBrowser=webrtcDetectedBrowser,AdapterJS.webrtcDetectedVersion=window.webrtcDetectedVersion=webrtcDetectedVersion,AdapterJS.webrtcMinimumVersion=window.webrtcMinimumVersion=webrtcMinimumVersion,AdapterJS.webrtcDetectedType=window.webrtcDetectedType=webrtcDetectedType,AdapterJS.webrtcDetectedDCSupport=window.webrtcDetectedDCSupport=webrtcDetectedDCSupport},AdapterJS.addEvent=function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent?e.attachEvent("on"+t,n):e[t]=n},AdapterJS.renderNotificationBar=function(e,t,n){if("interactive"===document.readyState||"complete"===document.readyState){var r=window,i=document.createElement("iframe");i.name="adapterjs-alert",i.style.position="fixed",i.style.top="-41px",i.style.left=0,i.style.right=0,i.style.width="100%",i.style.height="40px",i.style.backgroundColor="#ffffe1",i.style.border="none",i.style.borderBottom="1px solid #888888",i.style.zIndex="9999999","string"==typeof i.style.webkitTransition?i.style.webkitTransition="all .5s ease-out":"string"==typeof i.style.transition&&(i.style.transition="all .5s ease-out"),document.body.appendChild(i);var a=i.contentWindow?i.contentWindow:i.contentDocument.document?i.contentDocument.document:i.contentDocument;a.document.open(),a.document.write('<span style="display: inline-block; font-family: Helvetica, Arial,sans-serif; font-size: .9rem; padding: 4px; vertical-align: middle; cursor: default;">'+e+"</span>"),t&&"function"==typeof n?(a.document.write('<button id="okay">'+t+'</button><button id="cancel">Cancel</button>'),a.document.close(),AdapterJS.addEvent(a.document.getElementById("okay"),"click",function(e){e.preventDefault();try{e.cancelBubble=!0}catch(e){}n(e)}),AdapterJS.addEvent(a.document.getElementById("cancel"),"click",function(e){r.document.body.removeChild(i)})):a.document.close(),setTimeout(function(){"string"==typeof i.style.webkitTransform?i.style.webkitTransform="translateY(40px)":"string"==typeof i.style.transform?i.style.transform="translateY(40px)":i.style.top="0px"},300)}},webrtcDetectedType=null,checkMediaDataChannelSettings=function(e,t,n,r){if("function"==typeof n){var i=!0,a="firefox"===AdapterJS.webrtcDetectedBrowser,o="moz"===AdapterJS.webrtcDetectedType&&AdapterJS.webrtcDetectedVersion>30,s="firefox"===e;if(a&&s||o)try{delete r.mandatory.MozDontOfferDataChannel}catch(e){console.error("Failed deleting MozDontOfferDataChannel"),console.error(e)}else a&&!s&&(r.mandatory.MozDontOfferDataChannel=!0);if(!a)for(var d in r.mandatory)r.mandatory.hasOwnProperty(d)&&-1!==d.indexOf("Moz")&&delete r.mandatory[d];!a||s||o||(i=!1),n(i,r)}},checkIceConnectionState=function(e,t,n){"function"==typeof n?(e=e||"peer",AdapterJS._iceConnectionFiredStates[e]&&t!==AdapterJS._iceConnectionStates.disconnected&&t!==AdapterJS._iceConnectionStates.failed&&t!==AdapterJS._iceConnectionStates.closed||(AdapterJS._iceConnectionFiredStates[e]=[]),t=AdapterJS._iceConnectionStates[t],AdapterJS._iceConnectionFiredStates[e].indexOf(t)<0&&(AdapterJS._iceConnectionFiredStates[e].push(t),t===AdapterJS._iceConnectionStates.connected&&setTimeout(function(){AdapterJS._iceConnectionFiredStates[e].push(AdapterJS._iceConnectionStates.done),n(AdapterJS._iceConnectionStates.done)},1e3),n(t))):console.warn("No callback specified in checkIceConnectionState. Aborted.")},createIceServer=null,createIceServers=null,MediaStream="function"==typeof MediaStream?MediaStream:null,RTCPeerConnection="function"==typeof RTCPeerConnection?RTCPeerConnection:null,RTCSessionDescription="function"==typeof RTCSessionDescription?RTCSessionDescription:null,RTCIceCandidate="function"==typeof RTCIceCandidate?RTCIceCandidate:null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null,webrtcMinimumVersion=null,webrtcDetectedDCSupport=null,requestUserMedia=null,AdapterJS.parseWebrtcDetectedBrowser(),["webkit","moz","ms","AppleWebKit"].indexOf(AdapterJS.webrtcDetectedType)>-1?(navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)&&window.RTCPeerConnection&&(window.msRTCPeerConnection=window.RTCPeerConnection),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).adapter=e()}}(function(){return function e(t,n,r){function i(o,s){if(!n[o]){if(!t[o]){var d="function"==typeof require&&require;if(!s&&d)return d(o,!0);if(a)return a(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return i(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var a="function"==typeof require&&require,o=0;o<r.length;o++)i(r[o]);return i}({1:[function(e,t,n){"use strict";function r(e,t,n,r){var i=d.writeRtpDescription(e.kind,t);if(i+=d.writeIceParameters(e.iceGatherer.getLocalParameters()),i+=d.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),i+="a=mid:"+e.mid+"\r\n",e.direction?i+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?i+="a=sendrecv\r\n":e.rtpSender?i+="a=sendonly\r\n":e.rtpReceiver?i+="a=recvonly\r\n":i+="a=inactive\r\n",e.rtpSender){var a="msid:"+r.id+" "+e.rtpSender.track.id+"\r\n";i+="a="+a,i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,i+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+d.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+d.localCName+"\r\n"),i}function i(e,t){var n=!1;return(e=JSON.parse(JSON.stringify(e))).filter(function(e){if(e&&(e.urls||e.url)){var r=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var i="string"==typeof r;return i&&(r=[r]),r=r.filter(function(e){return 0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")&&!n?(n=!0,!0):0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp")}),delete e.url,e.urls=i?r[0]:r,!!r.length}return!1})}function a(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]},r=function(e,t){e=parseInt(e,10);for(var n=0;n<t.length;n++)if(t[n].payloadType===e||t[n].preferredPayloadType===e)return t[n]},i=function(e,t,n,i){var a=r(e.parameters.apt,n),o=r(t.parameters.apt,i);return a&&o&&a.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach(function(r){for(var a=0;a<t.codecs.length;a++){var o=t.codecs[a];if(r.name.toLowerCase()===o.name.toLowerCase()&&r.clockRate===o.clockRate){if("rtx"===r.name.toLowerCase()&&r.parameters&&o.parameters.apt&&!i(r,o,e.codecs,t.codecs))continue;(o=JSON.parse(JSON.stringify(o))).numChannels=Math.min(r.numChannels,o.numChannels),n.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter(function(e){for(var t=0;t<r.rtcpFeedback.length;t++)if(r.rtcpFeedback[t].type===e.type&&r.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}}),e.headerExtensions.forEach(function(e){for(var r=0;r<t.headerExtensions.length;r++){var i=t.headerExtensions[r];if(e.uri===i.uri){n.headerExtensions.push(i);break}}}),n}function o(e,t,n){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(n)}function s(e,t){e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type})||e.addRemoteCandidate(t)}var d=e("sdp");t.exports=function(e,t){var n=function(n){var r=this,a=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){r[e]=a[e].bind(a)}),this.onicecandidate=null,this.onaddstream=null,this.ontrack=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onicegatheringstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this.localDescription=null,this.remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",n=JSON.parse(JSON.stringify(n||{})),this.usingBundle="max-bundle"===n.bundlePolicy,"negotiate"===n.rtcpMuxPolicy){var o=new Error("rtcpMuxPolicy 'negotiate' is not supported");throw o.name="NotSupportedError",o}switch(n.rtcpMuxPolicy||(n.rtcpMuxPolicy="require"),n.iceTransportPolicy){case"all":case"relay":break;default:n.iceTransportPolicy="all"}switch(n.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:n.bundlePolicy="balanced"}if(n.iceServers=i(n.iceServers||[],t),this._iceGatherers=[],n.iceCandidatePoolSize)for(var s=n.iceCandidatePoolSize;s>0;s--)this._iceGatherers=new e.RTCIceGatherer({iceServers:n.iceServers,gatherPolicy:n.iceTransportPolicy});else n.iceCandidatePoolSize=0;this._config=n,this.transceivers=[],this._sdpSessionId=d.generateSessionId(),this._sdpSessionVersion=0};return n.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this.dispatchEvent(e),null!==this.onicegatheringstatechange&&this.onicegatheringstatechange(e)},n.prototype.getConfiguration=function(){return this._config},n.prototype.getLocalStreams=function(){return this.localStreams},n.prototype.getRemoteStreams=function(){return this.remoteStreams},n.prototype._createTransceiver=function(e){var t=this.transceivers.length>0,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,wantReceive:!0};if(this.usingBundle&&t)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else{var r=this._createIceAndDtlsTransports();n.iceTransport=r.iceTransport,n.dtlsTransport=r.dtlsTransport}return this.transceivers.push(n),n},n.prototype.addTrack=function(t,n){for(var r,i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==t.kind||(r=this.transceivers[i]);return r||(r=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(n)&&this.localStreams.push(n),r.track=t,r.stream=n,r.rtpSender=new e.RTCRtpSender(t,r.dtlsTransport),r.rtpSender},n.prototype.addStream=function(e){var n=this;if(t>=15025)e.getTracks().forEach(function(t){n.addTrack(t,e)});else{var r=e.clone();e.getTracks().forEach(function(e,t){var n=r.getTracks()[t];e.addEventListener("enabled",function(e){n.enabled=e.enabled})}),r.getTracks().forEach(function(e){n.addTrack(e,r)})}},n.prototype.removeStream=function(e){var t=this.localStreams.indexOf(e);t>-1&&(this.localStreams.splice(t,1),this._maybeFireNegotiationNeeded())},n.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},n.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},n.prototype._createIceGatherer=function(t,n){var r=this;if(n&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var i=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(i,"state",{value:"new",writable:!0}),this.transceivers[t].candidates=[],this.transceivers[t].bufferCandidates=function(e){var n=!e.candidate||0===Object.keys(e.candidate).length;i.state=n?"completed":"gathering",null!==r.transceivers[t].candidates&&r.transceivers[t].candidates.push(e.candidate)},i.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),i},n.prototype._gather=function(t,n){var r=this,i=this.transceivers[n].iceGatherer;if(!i.onlocalcandidate){var a=this.transceivers[n].candidates;this.transceivers[n].candidates=null,i.removeEventListener("localcandidate",this.transceivers[n].bufferCandidates),i.onlocalcandidate=function(e){if(!(r.usingBundle&&n>0)){var a=new Event("icecandidate");a.candidate={sdpMid:t,sdpMLineIndex:n};var o=e.candidate,s=!o||0===Object.keys(o).length;s?"new"!==i.state&&"gathering"!==i.state||(i.state="completed"):("new"===i.state&&(i.state="gathering"),o.component=1,a.candidate.candidate=d.writeCandidate(o));var c=d.splitSections(r.localDescription.sdp);c[a.candidate.sdpMLineIndex+1]+=s?"a=end-of-candidates\r\n":"a="+a.candidate.candidate+"\r\n",r.localDescription.sdp=c.join("");var l=r.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});"gathering"!==r.iceGatheringState&&(r.iceGatheringState="gathering",r._emitGatheringStateChange()),s||(r.dispatchEvent(a),null!==r.onicecandidate&&r.onicecandidate(a)),l&&(r.dispatchEvent(new Event("icecandidate")),null!==r.onicecandidate&&r.onicecandidate(new Event("icecandidate")),r.iceGatheringState="complete",r._emitGatheringStateChange())}},e.setTimeout(function(){a.forEach(function(e){var t=new Event("RTCIceGatherEvent");t.candidate=e,i.onlocalcandidate(t)})},0)}},n.prototype._createIceAndDtlsTransports=function(){var t=this,n=new e.RTCIceTransport(null);n.onicestatechange=function(){t._updateConnectionState()};var r=new e.RTCDtlsTransport(n);return r.ondtlsstatechange=function(){t._updateConnectionState()},r.onerror=function(){Object.defineProperty(r,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:n,dtlsTransport:r}},n.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var n=this.transceivers[e].iceTransport;n&&(delete n.onicestatechange,delete this.transceivers[e].iceTransport);var r=this.transceivers[e].dtlsTransport;r&&(delete r.ondtlsstatechange,delete r.onerror,delete this.transceivers[e].dtlsTransport)},n.prototype._transceive=function(e,n,r){var i=a(e.localCapabilities,e.remoteCapabilities);n&&e.rtpSender&&(i.encodings=e.sendEncodingParameters,i.rtcp={cname:d.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(i.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(i)),r&&e.rtpReceiver&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),i.encodings=e.recvEncodingParameters,i.rtcp={cname:e.rtcpParameters.cname,compound:e.rtcpParameters.compound},e.sendEncodingParameters.length&&(i.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(i))},n.prototype.setLocalDescription=function(e){var t=this,n=arguments;if(!o("setLocalDescription",e.type,this.signalingState))return new Promise(function(r,i){var a=new Error("Can not set remote "+e.type+" in state "+t.signalingState);a.name="InvalidStateError",n.length>2&&"function"==typeof n[2]&&n[2].apply(null,[a]),i(a)});var r,i;if("offer"===e.type)r=d.splitSections(e.sdp),i=r.shift(),r.forEach(function(e,n){var r=d.parseRtpParameters(e);t.transceivers[n].localCapabilities=r}),this.transceivers.forEach(function(e,n){t._gather(e.mid,n)});else if("answer"===e.type){r=d.splitSections(t.remoteDescription.sdp),i=r.shift();var s=d.matchPrefix(i,"a=ice-lite").length>0;r.forEach(function(e,n){var r=t.transceivers[n],o=r.iceGatherer,c=r.iceTransport,l=r.dtlsTransport,p=r.localCapabilities,u=r.remoteCapabilities;if(!d.isRejected(e)&&!r.isDatachannel){var f=d.getIceParameters(e,i),g=d.getDtlsParameters(e,i);s&&(g.role="server"),t.usingBundle&&0!==n||(t._gather(r.mid,n),"new"===c.state&&c.start(o,f,s?"controlling":"controlled"),"new"===l.state&&l.start(g));var h=a(p,u);t._transceive(r,h.codecs.length>0,!1)}})}switch(this.localDescription={type:e.type,sdp:e.sdp},e.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+e.type+'"')}var c=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1];return new Promise(function(e){c&&c.apply(null),e()})},n.prototype.setRemoteDescription=function(n){var r=this,i=arguments;if(!o("setRemoteDescription",n.type,this.signalingState))return new Promise(function(e,t){var a=new Error("Can not set remote "+n.type+" in state "+r.signalingState);a.name="InvalidStateError",i.length>2&&"function"==typeof i[2]&&i[2].apply(null,[a]),t(a)});var a={};this.remoteStreams.forEach(function(e){a[e.id]=e});var c=[],l=d.splitSections(n.sdp),p=l.shift(),u=d.matchPrefix(p,"a=ice-lite").length>0,f=d.matchPrefix(p,"a=group:BUNDLE ").length>0;this.usingBundle=f;var g=d.matchPrefix(p,"a=ice-options:")[0];switch(this.canTrickleIceCandidates=!!g&&g.substr(14).split(" ").indexOf("trickle")>=0,l.forEach(function(i,o){var l=d.splitLines(i),g=d.getKind(i),h=d.isRejected(i),m=l[0].substr(2).split(" ")[2],_=d.getDirection(i,p),S=d.parseMsid(i),v=d.getMid(i)||d.generateIdentifier();if("application"!==g||"DTLS/SCTP"!==m){var C,T,y,E,R,b,A,P,w,D,I,O=d.parseRtpParameters(i);h||(D=d.getIceParameters(i,p),(I=d.getDtlsParameters(i,p)).role="client"),A=d.parseRtpEncodingParameters(i);var k=d.parseRtcpParameters(i),N=d.matchPrefix(i,"a=end-of-candidates",p).length>0,M=d.matchPrefix(i,"a=candidate:").map(function(e){return d.parseCandidate(e)}).filter(function(e){return 1===e.component});if(("offer"===n.type||"answer"===n.type)&&!h&&f&&o>0&&r.transceivers[o]&&(r._disposeIceAndDtlsTransports(o),r.transceivers[o].iceGatherer=r.transceivers[0].iceGatherer,r.transceivers[o].iceTransport=r.transceivers[0].iceTransport,r.transceivers[o].dtlsTransport=r.transceivers[0].dtlsTransport,r.transceivers[o].rtpSender&&r.transceivers[o].rtpSender.setTransport(r.transceivers[0].dtlsTransport),r.transceivers[o].rtpReceiver&&r.transceivers[o].rtpReceiver.setTransport(r.transceivers[0].dtlsTransport)),"offer"!==n.type||h)"answer"!==n.type||h||(T=(C=r.transceivers[o]).iceGatherer,y=C.iceTransport,E=C.dtlsTransport,R=C.rtpReceiver,b=C.sendEncodingParameters,P=C.localCapabilities,r.transceivers[o].recvEncodingParameters=A,r.transceivers[o].remoteCapabilities=O,r.transceivers[o].rtcpParameters=k,M.length&&(!u&&!N||f&&0!==o||"new"!==y.state?M.forEach(function(e){s(C.iceTransport,e)}):y.setRemoteCandidates(M)),f&&0!==o||("new"===y.state&&y.start(T,D,"controlling"),"new"===E.state&&E.start(I)),r._transceive(C,"sendrecv"===_||"recvonly"===_,"sendrecv"===_||"sendonly"===_),!R||"sendrecv"!==_&&"sendonly"!==_?delete C.rtpReceiver:(w=R.track,S?(a[S.stream]||(a[S.stream]=new e.MediaStream),a[S.stream].addTrack(w),c.push([w,R,a[S.stream]])):(a.default||(a.default=new e.MediaStream),a.default.addTrack(w),c.push([w,R,a.default]))));else{if(C=r.transceivers[o]||r._createTransceiver(g),C.mid=v,C.iceGatherer||(C.iceGatherer=r._createIceGatherer(o,f)),M.length&&(!N||f&&0!==o||"new"!==C.iceTransport.state?M.forEach(function(e){s(C.iceTransport,e)}):C.iceTransport.setRemoteCandidates(M)),P=e.RTCRtpReceiver.getCapabilities(g),t<15019&&(P.codecs=P.codecs.filter(function(e){return"rtx"!==e.name})),b=[{ssrc:1001*(2*o+2)}],"sendrecv"===_||"sendonly"===_){var x=!C.rtpReceiver;if(R=C.rtpReceiver||new e.RTCRtpReceiver(C.dtlsTransport,g),x){var L;w=R.track,S?(a[S.stream]||(a[S.stream]=new e.MediaStream,Object.defineProperty(a[S.stream],"id",{get:function(){return S.stream}})),Object.defineProperty(w,"id",{get:function(){return S.track}}),L=a[S.stream]):(a.default||(a.default=new e.MediaStream),L=a.default),L.addTrack(w),c.push([w,R,L])}}C.localCapabilities=P,C.remoteCapabilities=O,C.rtpReceiver=R,C.rtcpParameters=k,C.sendEncodingParameters=b,C.recvEncodingParameters=A,r._transceive(r.transceivers[o],!1,"sendrecv"===_||"sendonly"===_)}}else r.transceivers[o]={mid:v,isDatachannel:!0}}),this.remoteDescription={type:n.type,sdp:n.sdp},n.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+n.type+'"')}return Object.keys(a).forEach(function(t){var n=a[t];if(n.getTracks().length){if(-1===r.remoteStreams.indexOf(n)){r.remoteStreams.push(n);var i=new Event("addstream");i.stream=n,e.setTimeout(function(){r.dispatchEvent(i),null!==r.onaddstream&&r.onaddstream(i)})}c.forEach(function(t){var i=t[0],a=t[1];if(n.id===t[2].id){var o=new Event("track");o.track=i,o.receiver=a,o.transceiver={receiver:a},o.streams=[n],e.setTimeout(function(){r.dispatchEvent(o),null!==r.ontrack&&r.ontrack(o)})}})}}),e.setTimeout(function(){r&&r.transceivers&&r.transceivers.forEach(function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))})},4e3),new Promise(function(e){i.length>1&&"function"==typeof i[1]&&i[1].apply(null),e()})},n.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._updateSignalingState("closed")},n.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this.dispatchEvent(t),null!==this.onsignalingstatechange&&this.onsignalingstatechange(t)},n.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout(function(){if(!1!==t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t.dispatchEvent(e),null!==t.onnegotiationneeded&&t.onnegotiationneeded(e)}},0))},n.prototype._updateConnectionState=function(){var e,t=this,n={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){n[e.iceTransport.state]++,n[e.dtlsTransport.state]++}),n.connected+=n.completed,e="new",n.failed>0?e="failed":n.connecting>0||n.checking>0?e="connecting":n.disconnected>0?e="disconnected":n.new>0?e="new":(n.connected>0||n.completed>0)&&(e="connected"),e!==t.iceConnectionState){t.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this.dispatchEvent(r),null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange(r)}},n.prototype.createOffer=function(){var n,i=this,a=arguments;1===arguments.length&&"function"!=typeof arguments[0]?n=arguments[0]:3===arguments.length&&(n=arguments[2]);var o=this.transceivers.filter(function(e){return"audio"===e.kind}).length,s=this.transceivers.filter(function(e){return"video"===e.kind}).length;if(n){if(n.mandatory||n.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==n.offerToReceiveAudio&&(o=!0===n.offerToReceiveAudio?1:!1===n.offerToReceiveAudio?0:n.offerToReceiveAudio),void 0!==n.offerToReceiveVideo&&(s=!0===n.offerToReceiveVideo?1:!1===n.offerToReceiveVideo?0:n.offerToReceiveVideo)}for(this.transceivers.forEach(function(e){"audio"===e.kind?--o<0&&(e.wantReceive=!1):"video"===e.kind&&--s<0&&(e.wantReceive=!1)});o>0||s>0;)o>0&&(this._createTransceiver("audio"),o--),s>0&&(this._createTransceiver("video"),s--);var c=d.writeSessionBoilerplate(this._sdpSessionId,this._sdpSessionVersion++);this.transceivers.forEach(function(n,r){var a=n.track,o=n.kind,s=d.generateIdentifier();n.mid=s,n.iceGatherer||(n.iceGatherer=i._createIceGatherer(r,i.usingBundle));var c=e.RTCRtpSender.getCapabilities(o);t<15019&&(c.codecs=c.codecs.filter(function(e){return"rtx"!==e.name})),c.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1")});var l=[{ssrc:1001*(2*r+1)}];a&&t>=15019&&"video"===o&&(l[0].rtx={ssrc:1001*(2*r+1)+1}),n.wantReceive&&(n.rtpReceiver=new e.RTCRtpReceiver(n.dtlsTransport,o)),n.localCapabilities=c,n.sendEncodingParameters=l}),"max-compat"!==this._config.bundlePolicy&&(c+="a=group:BUNDLE "+this.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),c+="a=ice-options:trickle\r\n",this.transceivers.forEach(function(e,t){c+=r(e,e.localCapabilities,"offer",e.stream),c+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===i.iceGatheringState||0!==t&&i.usingBundle||(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,c+="a="+d.writeCandidate(e)+"\r\n"}),"completed"===e.iceGatherer.state&&(c+="a=end-of-candidates\r\n"))});var l=new e.RTCSessionDescription({type:"offer",sdp:c});return new Promise(function(e){if(a.length>0&&"function"==typeof a[0])return a[0].apply(null,[l]),void e();e(l)})},n.prototype.createAnswer=function(){var n=arguments,i=d.writeSessionBoilerplate(this._sdpSessionId,this._sdpSessionVersion++);this.usingBundle&&(i+="a=group:BUNDLE "+this.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n");var o=d.splitSections(this.remoteDescription.sdp).length-1;this.transceivers.forEach(function(e,n){if(!(n+1>o))if(e.isDatachannel)i+="m=application 0 DTLS/SCTP 5000\r\nc=IN IP4 0.0.0.0\r\na=mid:"+e.mid+"\r\n";else{if(e.stream){var s;"audio"===e.kind?s=e.stream.getAudioTracks()[0]:"video"===e.kind&&(s=e.stream.getVideoTracks()[0]),s&&t>=15019&&"video"===e.kind&&(e.sendEncodingParameters[0].rtx={ssrc:1001*(2*n+2)+1})}var d=a(e.localCapabilities,e.remoteCapabilities);!d.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,i+=r(e,d,"answer",e.stream),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(i+="a=rtcp-rsize\r\n")}});var s=new e.RTCSessionDescription({type:"answer",sdp:i});return new Promise(function(e){if(n.length>0&&"function"==typeof n[0])return n[0].apply(null,[s]),void e();e(s)})},n.prototype.addIceCandidate=function(e){var t,n;if(e&&""!==e.candidate){if(!e.sdpMLineIndex&&!e.sdpMid)throw new TypeError("sdpMLineIndex or sdpMid required");if(this.remoteDescription){var r=e.sdpMLineIndex;if(e.sdpMid)for(var i=0;i<this.transceivers.length;i++)if(this.transceivers[i].mid===e.sdpMid){r=i;break}var a=this.transceivers[r];if(a){if(a.isDatachannel)return Promise.resolve();var o=Object.keys(e.candidate).length>0?d.parseCandidate(e.candidate):{};if("tcp"===o.protocol&&(0===o.port||9===o.port))return Promise.resolve();if(o.component&&1!==o.component)return Promise.resolve();(0===r||r>0&&a.iceTransport!==this.transceivers[0].iceTransport)&&a.iceTransport.addRemoteCandidate(o);var s=e.candidate.trim();0===s.indexOf("a=")&&(s=s.substr(2)),(n=d.splitSections(this.remoteDescription.sdp))[r+1]+="a="+(o.type?s:"end-of-candidates")+"\r\n",this.remoteDescription.sdp=n.join("")}else(t=new Error("Can not add ICE candidate")).name="OperationError"}else(t=new Error("Can not add ICE candidate without a remote description")).name="InvalidStateError"}else for(var c=0;c<this.transceivers.length&&(this.transceivers[c].isDatachannel||(this.transceivers[c].iceTransport.addRemoteCandidate({}),n=d.splitSections(this.remoteDescription.sdp),n[c+1]+="a=end-of-candidates\r\n",this.remoteDescription.sdp=n.join(""),!this.usingBundle));c++);var l=arguments;return new Promise(function(e,n){t?(l.length>2&&"function"==typeof l[2]&&l[2].apply(null,[t]),n(t)):(l.length>1&&"function"==typeof l[1]&&l[1].apply(null),e())})},n.prototype.getStats=function(){var e=[];this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(n){t[n]&&e.push(t[n].getStats())})});var t=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1],n=function(e){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};return new Promise(function(r){var i=new Map;Promise.all(e).then(function(e){e.forEach(function(e){Object.keys(e).forEach(function(t){e[t].type=n(e[t]),i.set(t,e[t])})}),t&&t.apply(null,i),r(i)})})},n}},{sdp:2}],2:[function(e,t,n){"use strict";var r={};r.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},r.localCName=r.generateIdentifier(),r.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},r.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},r.matchPrefix=function(e,t){return r.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},r.parseCandidate=function(e){for(var t,n={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]},r=8;r<t.length;r+=2)switch(t[r]){case"raddr":n.relatedAddress=t[r+1];break;case"rport":n.relatedPort=parseInt(t[r+1],10);break;case"tcptype":n.tcpType=t[r+1];break;case"ufrag":n.ufrag=t[r+1],n.usernameFragment=t[r+1];break;default:n[t[r]]=t[r+1]}return n},r.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),e.ufrag&&(t.push("ufrag"),t.push(e.ufrag)),"candidate:"+t.join(" ")},r.parseIceOptions=function(e){return e.substr(14).split(" ")},r.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.numChannels=3===t.length?parseInt(t[2],10):1,n},r.writeRtpMap=function(e){var t=e.payloadType;return void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType),"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==e.numChannels?"/"+e.numChannels:"")+"\r\n"},r.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},r.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},r.parseFmtp=function(e){for(var t,n={},r=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<r.length;i++)n[(t=r[i].trim().split("="))[0].trim()]=t[1];return n},r.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var r=[];Object.keys(e.parameters).forEach(function(t){r.push(t+"="+e.parameters[t])}),t+="a=fmtp:"+n+" "+r.join(";")+"\r\n"}return t},r.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},r.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},r.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},r=e.indexOf(":",t);return r>-1?(n.attribute=e.substr(t+1,r-t-1),n.value=e.substr(r+1)):n.attribute=e.substr(t+1),n},r.getMid=function(e){var t=r.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},r.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},r.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:r.matchPrefix(e+t,"a=fingerprint:").map(r.parseFingerprint)}},r.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},r.getIceParameters=function(e,t){var n=r.splitLines(e);return{usernameFragment:(n=n.concat(r.splitLines(t))).filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:n.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)}},r.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},r.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=r.splitLines(e)[0].split(" "),i=3;i<n.length;i++){var a=n[i],o=r.matchPrefix(e,"a=rtpmap:"+a+" ")[0];if(o){var s=r.parseRtpMap(o),d=r.matchPrefix(e,"a=fmtp:"+a+" ");switch(s.parameters=d.length?r.parseFmtp(d[0]):{},s.rtcpFeedback=r.matchPrefix(e,"a=rtcp-fb:"+a+" ").map(r.parseRtcpFb),t.codecs.push(s),s.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(s.name.toUpperCase())}}}return r.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(r.parseExtmap(e))}),t},r.writeRtpDescription=function(e,t){var n="";n+="m="+e+" ",n+=t.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){n+=r.writeRtpMap(e),n+=r.writeFmtp(e),n+=r.writeRtcpFb(e)});var i=0;return t.codecs.forEach(function(e){e.maxptime>i&&(i=e.maxptime)}),i>0&&(n+="a=maxptime:"+i+"\r\n"),n+="a=rtcp-mux\r\n",t.headerExtensions.forEach(function(e){n+=r.writeExtmap(e)}),n},r.parseRtpEncodingParameters=function(e){var t,n=[],i=r.parseRtpParameters(e),a=-1!==i.fecMechanisms.indexOf("RED"),o=-1!==i.fecMechanisms.indexOf("ULPFEC"),s=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),d=s.length>0&&s[0].ssrc,c=r.matchPrefix(e,"a=ssrc-group:FID").map(function(e){var t=e.split(" ");return t.shift(),t.map(function(e){return parseInt(e,10)})});c.length>0&&c[0].length>1&&c[0][0]===d&&(t=c[0][1]),i.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var r={ssrc:d,codecPayloadType:parseInt(e.parameters.apt,10),rtx:{ssrc:t}};n.push(r),a&&((r=JSON.parse(JSON.stringify(r))).fec={ssrc:t,mechanism:o?"red+ulpfec":"red"},n.push(r))}}),0===n.length&&d&&n.push({ssrc:d});var l=r.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,n.forEach(function(e){e.maxBitrate=l})),n},r.parseRtcpParameters=function(e){var t={},n=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];n&&(t.cname=n.value,t.ssrc=n.ssrc);var i=r.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=i.length>0,t.compound=0===i.length;var a=r.matchPrefix(e,"a=rtcp-mux");return t.mux=a.length>0,t},r.parseMsid=function(e){var t,n=r.matchPrefix(e,"a=msid:");if(1===n.length)return t=n[0].substr(7).split(" "),{stream:t[0],track:t[1]};var i=r.matchPrefix(e,"a=ssrc:").map(function(e){return r.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});return i.length>0?(t=i[0].value.split(" "),{stream:t[0],track:t[1]}):void 0},r.generateSessionId=function(){return Math.random().toString().substr(2,21)},r.writeSessionBoilerplate=function(e,t){var n=void 0!==t?t:2;return"v=0\r\no=thisisadapterortc "+(e||r.generateSessionId())+" "+n+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},r.writeMediaSection=function(e,t,n,i){var a=r.writeRtpDescription(e.kind,t);if(a+=r.writeIceParameters(e.iceGatherer.getLocalParameters()),a+=r.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),a+="a=mid:"+e.mid+"\r\n",e.direction?a+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?a+="a=sendrecv\r\n":e.rtpSender?a+="a=sendonly\r\n":e.rtpReceiver?a+="a=recvonly\r\n":a+="a=inactive\r\n",e.rtpSender){var o="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";a+="a="+o,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+r.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+r.localCName+"\r\n"),a},r.getDirection=function(e,t){for(var n=r.splitLines(e),i=0;i<n.length;i++)switch(n[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[i].substr(2)}return t?r.getDirection(t):"sendrecv"},r.getKind=function(e){return r.splitLines(e)[0].split(" ")[0].substr(2)},r.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.exports=r},{}],3:[function(e,t,n){(function(n){"use strict";var r=e("./adapter_factory.js");t.exports=r({window:n.window})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./adapter_factory.js":4}],4:[function(e,t,n){"use strict";t.exports=function(t,n){var r=t&&t.window,i={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0};for(var a in n)hasOwnProperty.call(n,a)&&(i[a]=n[a]);var o=e("./utils"),s=o.log,d=o.detectBrowser(r),c={browserDetails:d,extractVersion:o.extractVersion,disableLog:o.disableLog,disableWarnings:o.disableWarnings},l=e("./chrome/chrome_shim")||null,p=e("./edge/edge_shim")||null,u=e("./firefox/firefox_shim")||null,f=e("./safari/safari_shim")||null,g=e("./common_shim")||null;switch(d.browser){case"chrome":if(!l||!l.shimPeerConnection||!i.shimChrome)return s("Chrome shim is not included in this adapter release."),c;s("adapter.js shimming chrome."),c.browserShim=l,l.shimGetUserMedia(r),l.shimMediaStream(r),o.shimCreateObjectURL(r),l.shimSourceObject(r),l.shimPeerConnection(r),l.shimOnTrack(r),l.shimAddTrackRemoveTrack(r),l.shimGetSendersWithDtmf(r),g.shimRTCIceCandidate(r);break;case"firefox":if(!u||!u.shimPeerConnection||!i.shimFirefox)return s("Firefox shim is not included in this adapter release."),c;s("adapter.js shimming firefox."),c.browserShim=u,u.shimGetUserMedia(r),o.shimCreateObjectURL(r),u.shimSourceObject(r),u.shimPeerConnection(r),u.shimOnTrack(r),g.shimRTCIceCandidate(r);break;case"edge":if(!p||!p.shimPeerConnection||!i.shimEdge)return s("MS edge shim is not included in this adapter release."),c;s("adapter.js shimming edge."),c.browserShim=p,p.shimGetUserMedia(r),o.shimCreateObjectURL(r),p.shimPeerConnection(r),p.shimReplaceTrack(r);break;case"safari":if(!f||!i.shimSafari)return s("Safari shim is not included in this adapter release."),c;s("adapter.js shimming safari."),c.browserShim=f,o.shimCreateObjectURL(r),f.shimRTCIceServerUrls(r),f.shimCallbacksAPI(r),f.shimLocalStreamsAPI(r),f.shimRemoteStreamsAPI(r),f.shimTrackEventTransceiver(r),f.shimGetUserMedia(r),g.shimRTCIceCandidate(r);break;default:s("Unsupported browser!")}return c}},{"./chrome/chrome_shim":5,"./common_shim":7,"./edge/edge_shim":8,"./firefox/firefox_shim":10,"./safari/safari_shim":12,"./utils":13}],5:[function(e,t,n){"use strict";var r=e("../utils.js"),i=r.log,a={shimMediaStream:function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},shimOnTrack:function(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var n=this;return n._ontrackpoly||(n._ontrackpoly=function(t){t.stream.addEventListener("addtrack",function(r){var i;i=e.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find(function(e){return e.track&&e.track.id===r.track.id}):{track:r.track};var a=new Event("track");a.track=r.track,a.receiver=i,a.transceiver={receiver:i},a.streams=[t.stream],n.dispatchEvent(a)}),t.stream.getTracks().forEach(function(r){var i;i=e.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find(function(e){return e.track&&e.track.id===r.id}):{track:r};var a=new Event("track");a.track=r,a.receiver=i,a.transceiver={receiver:i},a.streams=[t.stream],n.dispatchEvent(a)})},n.addEventListener("addstream",n._ontrackpoly)),t.apply(n,arguments)}}},shimGetSendersWithDtmf:function(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){var i=this,a=n.apply(i,arguments);return a||(a=t(i,e),i._senders.push(a)),a};var r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;r.apply(t,arguments);var n=t._senders.indexOf(e);-1!==n&&t._senders.splice(n,1)}}var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var n=this;n._senders=n._senders||[],i.apply(n,[e]),e.getTracks().forEach(function(e){n._senders.push(t(n,e))})};var a=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._senders=t._senders||[],a.apply(t,[t._streams[e.id]||e]),e.getTracks().forEach(function(e){var n=t._senders.find(function(t){return t.track===e});n&&t._senders.splice(t._senders.indexOf(n),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var o=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=o.apply(e,[]);return t.forEach(function(t){t._pc=e}),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},shimSourceObject:function(e){var t=e&&e.URL;"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var n=this;this._srcObject=e,this.src&&t.revokeObjectURL(this.src),e?(this.src=t.createObjectURL(e),e.addEventListener("addtrack",function(){n.src&&t.revokeObjectURL(n.src),n.src=t.createObjectURL(e)}),e.addEventListener("removetrack",function(){n.src&&t.revokeObjectURL(n.src),n.src=t.createObjectURL(e)})):this.src=""}}))},shimAddTrackRemoveTrack:function(e){function t(e,t){var n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var r=e._reverseStreams[t],i=e._streams[r.id];n=n.replace(new RegExp(i.id,"g"),r.id)}),new RTCSessionDescription({type:t.type,sdp:n})}function n(e,t){var n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var r=e._reverseStreams[t],i=e._streams[r.id];n=n.replace(new RegExp(r.id,"g"),i.id)}),new RTCSessionDescription({type:t.type,sdp:n})}if(!e.RTCPeerConnection.prototype.addTrack){var r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=r.apply(this);return e._reverseStreams=e._reverseStreams||{},t.map(function(t){return e._reverseStreams[t.id]})};var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var n=this;if(n._streams=n._streams||{},n._reverseStreams=n._reverseStreams||{},t.getTracks().forEach(function(e){if(n.getSenders().find(function(t){return t.track===e}))throw new DOMException("Track already exists.","InvalidAccessError")}),!n._reverseStreams[t.id]){var r=new e.MediaStream(t.getTracks());n._streams[t.id]=r,n._reverseStreams[r.id]=t,t=r}i.apply(n,[t])};var a=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._streams=t._streams||{},t._reverseStreams=t._reverseStreams||{},a.apply(t,[t._streams[e.id]||e]),delete t._reverseStreams[t._streams[e.id]?t._streams[e.id].id:e.id],delete t._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){var r=this;if("closed"===r.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find(function(e){return e===t}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(r.getSenders().find(function(e){return e.track===t}))throw new DOMException("Track already exists.","InvalidAccessError");r._streams=r._streams||{},r._reverseStreams=r._reverseStreams||{};var a=r._streams[n.id];if(a)a.addTrack(t),Promise.resolve().then(function(){r.dispatchEvent(new Event("negotiationneeded"))});else{var o=new e.MediaStream([t]);r._streams[n.id]=o,r._reverseStreams[o.id]=n,r.addStream(o)}return r.getSenders().find(function(e){return e.track===t})},["createOffer","createAnswer"].forEach(function(n){var r=e.RTCPeerConnection.prototype[n];e.RTCPeerConnection.prototype[n]=function(){var e=this,n=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(e,[function(r){var i=t(e,r);n[0].apply(null,[i])},function(e){n[1]&&n[1].apply(null,e)},arguments[2]]):r.apply(e,arguments).then(function(n){return t(e,n)})}});var o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){var e=this;return arguments.length&&arguments[0].type?(arguments[0]=n(e,arguments[0]),o.apply(e,arguments)):o.apply(e,arguments)};var s=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=this,n=s.get.apply(this);return""===n.type?n:t(e,n)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;if("closed"===t.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===t))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");t._streams=t._streams||{};var n;Object.keys(t._streams).forEach(function(r){t._streams[r].getTracks().find(function(t){return e.track===t})&&(n=t._streams[r])}),n&&(1===n.getTracks().length?t.removeStream(n):n.removeTrack(e.track),t.dispatchEvent(new Event("negotiationneeded")))}}},shimPeerConnection:function(e){var t=r.detectBrowser(e);if(e.RTCPeerConnection){var n=e.RTCPeerConnection;e.RTCPeerConnection=function(e,t){if(e&&e.iceServers){for(var i=[],a=0;a<e.iceServers.length;a++){var o=e.iceServers[a];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(r.deprecated("RTCIceServer.url","RTCIceServer.urls"),(o=JSON.parse(JSON.stringify(o))).urls=o.url,i.push(o)):i.push(e.iceServers[a])}e.iceServers=i}return new n(e,t)},e.RTCPeerConnection.prototype=n.prototype,Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return n.generateCertificate}})}else e.RTCPeerConnection=function(t,n){return i("PeerConnection"),t&&t.iceTransportPolicy&&(t.iceTransports=t.iceTransportPolicy),new e.webkitRTCPeerConnection(t,n)},e.RTCPeerConnection.prototype=e.webkitRTCPeerConnection.prototype,e.webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.webkitRTCPeerConnection.generateCertificate}});var a=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,t,n){var r=this,i=arguments;if(arguments.length>0&&"function"==typeof e)return a.apply(this,arguments);if(0===a.length&&(0===arguments.length||"function"!=typeof arguments[0]))return a.apply(this,[]);var o=function(e){var t={};return e.result().forEach(function(e){var n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(t){n[t]=e.stat(t)}),t[n.id]=n}),t},s=function(e){return new Map(Object.keys(e).map(function(t){return[t,e[t]]}))};if(arguments.length>=2){return a.apply(this,[function(e){i[1](s(o(e)))},arguments[0]])}return new Promise(function(e,t){a.apply(r,[function(t){e(s(o(t)))},t])}).then(t,n)},t.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=arguments,t=this,r=new Promise(function(r,i){n.apply(t,[e[0],r,i])});return e.length<2?r:r.then(function(){e[1].apply(null,[])},function(t){e.length>=3&&e[2].apply(null,[t])})}}),t.version<52&&["createOffer","createAnswer"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var t=1===arguments.length?arguments[0]:void 0;return new Promise(function(r,i){n.apply(e,[r,i,t])})}return n.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}});var o=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?o.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}};t.exports={shimMediaStream:a.shimMediaStream,shimOnTrack:a.shimOnTrack,shimAddTrackRemoveTrack:a.shimAddTrackRemoveTrack,shimGetSendersWithDtmf:a.shimGetSendersWithDtmf,shimSourceObject:a.shimSourceObject,shimPeerConnection:a.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils.js":13,"./getusermedia":6}],6:[function(e,t,n){"use strict";var r=e("../utils.js"),i=r.log;t.exports=function(e){var t=r.detectBrowser(e),n=e&&e.navigator,a=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var r="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==r.ideal){t.optional=t.optional||[];var a={};"number"==typeof r.ideal?(a[i("min",n)]=r.ideal,t.optional.push(a),(a={})[i("max",n)]=r.ideal,t.optional.push(a)):(a[i("",n)]=r.ideal,t.optional.push(a))}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",n)]=r.exact):["min","max"].forEach(function(e){void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,n)]=r[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},o=function(e,r){if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){var o=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])};o((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),o(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=a(e.audio)}if(e&&"object"==typeof e.video){var s=e.video.facingMode;s=s&&("object"==typeof s?s:{ideal:s});var d=t.version<61;if(s&&("user"===s.exact||"environment"===s.exact||"user"===s.ideal||"environment"===s.ideal)&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||d)){delete e.video.facingMode;var c;if("environment"===s.exact||"environment"===s.ideal?c=["back","rear"]:"user"!==s.exact&&"user"!==s.ideal||(c=["front"]),c)return n.mediaDevices.enumerateDevices().then(function(t){var n=(t=t.filter(function(e){return"videoinput"===e.kind})).find(function(e){return c.some(function(t){return-1!==e.label.toLowerCase().indexOf(t)})});return!n&&t.length&&-1!==c.indexOf("back")&&(n=t[t.length-1]),n&&(e.video.deviceId=s.exact?{exact:n.deviceId}:{ideal:n.deviceId}),e.video=a(e.video),i("chrome: "+JSON.stringify(e)),r(e)})}e.video=a(e.video)}return i("chrome: "+JSON.stringify(e)),r(e)},s=function(e){return{name:{PermissionDeniedError:"NotAllowedError",InvalidStateError:"NotReadableError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotReadableError",MediaDeviceKillSwitchOn:"NotReadableError"}[e.name]||e.name,message:e.message,constraint:e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};n.getUserMedia=function(e,t,r){o(e,function(e){n.webkitGetUserMedia(e,t,function(e){r&&r(s(e))})})};var d=function(e){return new Promise(function(t,r){n.getUserMedia(e,t,r)})};if(n.mediaDevices||(n.mediaDevices={getUserMedia:d,enumerateDevices:function(){return new Promise(function(t){var n={audio:"audioinput",video:"videoinput"};return e.MediaStreamTrack.getSources(function(e){t(e.map(function(e){return{label:e.label,kind:n[e.kind],deviceId:e.id,groupId:""}}))})})},getSupportedConstraints:function(){return{deviceId:!0,echoCancellation:!0,facingMode:!0,frameRate:!0,height:!0,width:!0}}}),n.mediaDevices.getUserMedia){var c=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(e){return o(e,function(e){return c(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(e){return Promise.reject(s(e))})})}}else n.mediaDevices.getUserMedia=function(e){return d(e)};void 0===n.mediaDevices.addEventListener&&(n.mediaDevices.addEventListener=function(){i("Dummy mediaDevices.addEventListener called.")}),void 0===n.mediaDevices.removeEventListener&&(n.mediaDevices.removeEventListener=function(){i("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":13}],7:[function(e,t,n){"use strict";function r(e,t,n){if(e.RTCPeerConnection){var r=e.RTCPeerConnection.prototype,i=r.addEventListener;r.addEventListener=function(e,r){if(e!==t)return i.apply(this,arguments);var a=function(e){r(n(e))};return this._eventMap=this._eventMap||{},this._eventMap[r]=a,i.apply(this,[e,a])};var a=r.removeEventListener;r.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[n])return a.apply(this,arguments);var r=this._eventMap[n];return delete this._eventMap[n],a.apply(this,[e,r])},Object.defineProperty(r,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)}})}}var i=e("sdp");t.exports={shimRTCIceCandidate:function(e){if(!(e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){"object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2));var n=new t(e),r=i.parseCandidate(e.candidate),a=Object.assign(n,r);return a.toJSON=function(){return{candidate:a.candidate,sdpMid:a.sdpMid,sdpMLineIndex:a.sdpMLineIndex,usernameFragment:a.usernameFragment}},a},r(e,"icecandidate",function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t})}}}},{sdp:2}],8:[function(e,t,n){"use strict";var r=e("../utils"),i=e("rtcpeerconnection-shim");t.exports={shimGetUserMedia:e("./getusermedia"),shimPeerConnection:function(e){var t=r.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){var n=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){n.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})}!e.RTCRtpSender||"dtmf"in e.RTCRtpSender.prototype||Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCPeerConnection=i(e,t.version)},shimReplaceTrack:function(e){!e.RTCRtpSender||"replaceTrack"in e.RTCRtpSender.prototype||(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}}},{"../utils":13,"./getusermedia":9,"rtcpeerconnection-shim":1}],9:[function(e,t,n){"use strict";t.exports=function(e){var t=e&&e.navigator,n=function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}},r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch(function(e){return Promise.reject(n(e))})}}},{}],10:[function(e,t,n){"use strict";var r=e("../utils"),i={shimOnTrack:function(e){"object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var n=new Event("track");n.track=t,n.receiver={track:t},n.transceiver={receiver:n.receiver},n.streams=[e.stream],this.dispatchEvent(n)}.bind(this))}.bind(this))}}),"object"==typeof e&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},shimSourceObject:function(e){"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}}))},shimPeerConnection:function(e){var t=r.detectBrowser(e);if("object"==typeof e&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){e.RTCPeerConnection||(e.RTCPeerConnection=function(n,r){if(t.version<38&&n&&n.iceServers){for(var i=[],a=0;a<n.iceServers.length;a++){var o=n.iceServers[a];if(o.hasOwnProperty("urls"))for(var s=0;s<o.urls.length;s++){var d={url:o.urls[s]};0===o.urls[s].indexOf("turn")&&(d.username=o.username,d.credential=o.credential),i.push(d)}else i.push(n.iceServers[a])}n.iceServers=i}return new e.mozRTCPeerConnection(n,r)},e.RTCPeerConnection.prototype=e.mozRTCPeerConnection.prototype,e.mozRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.mozRTCPeerConnection.generateCertificate}}),e.RTCSessionDescription=e.mozRTCSessionDescription,e.RTCIceCandidate=e.mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}});var n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var i=function(e){var t=new Map;return Object.keys(e).forEach(function(n){t.set(n,e[n]),t[n]=e[n]}),t},a={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,n,r){return o.apply(this,[e||null]).then(function(e){if(t.version<48&&(e=i(e)),t.version<53&&!n)try{e.forEach(function(e){e.type=a[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach(function(t,n){e.set(n,Object.assign({},t,{type:a[t.type]||t.type}))})}return e}).then(n,r)}}}};t.exports={shimOnTrack:i.shimOnTrack,shimSourceObject:i.shimSourceObject,shimPeerConnection:i.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils":13,"./getusermedia":11}],11:[function(e,t,n){"use strict";var r=e("../utils"),i=r.log;t.exports=function(e){var t=r.detectBrowser(e),n=e&&e.navigator,a=e&&e.MediaStreamTrack,o=function(e){return{name:{InternalError:"NotReadableError",NotSupportedError:"TypeError",PermissionDeniedError:"NotAllowedError",SecurityError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},s=function(e,r,a){var s=function(e){if("object"!=typeof e||e.require)return e;var t=[];return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var r=e[n]="object"==typeof e[n]?e[n]:{ideal:e[n]};if(void 0===r.min&&void 0===r.max&&void 0===r.exact||t.push(n),void 0!==r.exact&&("number"==typeof r.exact?r.min=r.max=r.exact:e[n]=r.exact,delete r.exact),void 0!==r.ideal){e.advanced=e.advanced||[];var i={};"number"==typeof r.ideal?i[n]={min:r.ideal,max:r.ideal}:i[n]=r.ideal,e.advanced.push(i),delete r.ideal,Object.keys(r).length||delete e[n]}}}),t.length&&(e.require=t),e};return e=JSON.parse(JSON.stringify(e)),t.version<38&&(i("spec: "+JSON.stringify(e)),e.audio&&(e.audio=s(e.audio)),e.video&&(e.video=s(e.video)),i("ff37: "+JSON.stringify(e))),n.mozGetUserMedia(e,r,function(e){a(o(e))})};if(n.mediaDevices||(n.mediaDevices={getUserMedia:function(e){return new Promise(function(t,n){s(e,t,n)})},addEventListener:function(){},removeEventListener:function(){}}),n.mediaDevices.enumerateDevices=n.mediaDevices.enumerateDevices||function(){return new Promise(function(e){e([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])})},t.version<41){var d=n.mediaDevices.enumerateDevices.bind(n.mediaDevices);n.mediaDevices.enumerateDevices=function(){return d().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}if(t.version<49){var c=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(e){return c(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("The object can not be found here.","NotFoundError");return t},function(e){return Promise.reject(o(e))})}}if(!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){var l=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},p=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(e){return"object"==typeof e&&"object"==typeof e.audio&&(e=JSON.parse(JSON.stringify(e)),l(e.audio,"autoGainControl","mozAutoGainControl"),l(e.audio,"noiseSuppression","mozNoiseSuppression")),p(e)},a&&a.prototype.getSettings){var u=a.prototype.getSettings;a.prototype.getSettings=function(){var e=u.apply(this,arguments);return l(e,"mozAutoGainControl","autoGainControl"),l(e,"mozNoiseSuppression","noiseSuppression"),e}}if(a&&a.prototype.applyConstraints){var f=a.prototype.applyConstraints;a.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"==typeof e&&(e=JSON.parse(JSON.stringify(e)),l(e,"autoGainControl","mozAutoGainControl"),l(e,"noiseSuppression","mozNoiseSuppression")),f.apply(this,[e])}}}n.getUserMedia=function(e,i,a){if(t.version<44)return s(e,i,a);r.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(e).then(i,a)}}},{"../utils":13}],12:[function(e,t,n){"use strict";var r=e("../utils"),i={shimLocalStreamsAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),"getStreamById"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getStreamById=function(e){var t=null;return this._localStreams&&this._localStreams.forEach(function(n){n.id===e&&(t=n)}),this._remoteStreams&&this._remoteStreams.forEach(function(n){n.id===e&&(t=n)}),t}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),-1===this._localStreams.indexOf(e)&&this._localStreams.push(e);var n=this;e.getTracks().forEach(function(r){t.call(n,r,e)})},e.RTCPeerConnection.prototype.addTrack=function(e,n){n&&(this._localStreams?-1===this._localStreams.indexOf(n)&&this._localStreams.push(n):this._localStreams=[n]),t.call(this,e,n)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);var t=this._localStreams.indexOf(e);if(-1!==t){this._localStreams.splice(t,1);var n=this,r=e.getTracks();this.getSenders().forEach(function(e){-1!==r.indexOf(e.track)&&n.removeTrack(e)})}})}},shimRemoteStreamsAPI:function(e){"object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),"onaddstream"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(e){var t=e.streams[0];if(this._remoteStreams||(this._remoteStreams=[]),!(this._remoteStreams.indexOf(t)>=0)){this._remoteStreams.push(t);var n=new Event("addstream");n.stream=e.streams[0],this.dispatchEvent(n)}}.bind(this))}}))},shimCallbacksAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,n=t.createOffer,r=t.createAnswer,i=t.setLocalDescription,a=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){var r=arguments.length>=2?arguments[2]:arguments[0],i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){var n=arguments.length>=2?arguments[2]:arguments[0],i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i};var s=function(e,t,n){var r=i.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r};t.setLocalDescription=s,s=function(e,t,n){var r=a.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.setRemoteDescription=s,s=function(e,t,n){var r=o.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.addIceCandidate=s}},shimGetUserMedia:function(e){var t=e&&e.navigator;t.getUserMedia||(t.webkitGetUserMedia?t.getUserMedia=t.webkitGetUserMedia.bind(t):t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,r){t.mediaDevices.getUserMedia(e).then(n,r)}.bind(t)))},shimRTCIceServerUrls:function(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){for(var i=[],a=0;a<e.iceServers.length;a++){var o=e.iceServers[a];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(r.deprecated("RTCIceServer.url","RTCIceServer.urls"),(o=JSON.parse(JSON.stringify(o))).urls=o.url,delete o.url,i.push(o)):i.push(e.iceServers[a])}e.iceServers=i}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})},shimTrackEventTransceiver:function(e){"object"==typeof e&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}};t.exports={shimCallbacksAPI:i.shimCallbacksAPI,shimLocalStreamsAPI:i.shimLocalStreamsAPI,shimRemoteStreamsAPI:i.shimRemoteStreamsAPI,shimGetUserMedia:i.shimGetUserMedia,shimRTCIceServerUrls:i.shimRTCIceServerUrls,shimTrackEventTransceiver:i.shimTrackEventTransceiver}},{"../utils":13}],13:[function(e,t,n){"use strict";var r=!0,i=!0,a={disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(r=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},disableWarnings:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(i=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))},log:function(){if("object"==typeof window){if(r)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},deprecated:function(e,t){i&&console.warn(e+" is deprecated, please use "+t+" instead.")},extractVersion:function(e,t,n){var r=e.match(t);return r&&r.length>=n&&parseInt(r[n],10)},detectBrowser:function(e){var t=e&&e.navigator,n={};if(n.browser=null,n.version=null,void 0===e||!e.navigator)return n.browser="Not a browser.",n;if(t.mozGetUserMedia)n.browser="firefox",n.version=this.extractVersion(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia)if(e.webkitRTCPeerConnection)n.browser="chrome",n.version=this.extractVersion(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!t.userAgent.match(/Version\/(\d+).(\d+)/))return n.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",n;n.browser="safari",n.version=this.extractVersion(t.userAgent,/AppleWebKit\/(\d+)\./,1)}else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))n.browser="edge",n.version=this.extractVersion(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!t.mediaDevices||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return n.browser="Not a supported browser.",n;n.browser="safari",n.version=this.extractVersion(t.userAgent,/AppleWebKit\/(\d+)\./,1)}return n},shimCreateObjectURL:function(e){var t=e&&e.URL;if("object"==typeof e&&e.HTMLMediaElement&&"srcObject"in e.HTMLMediaElement.prototype&&t.createObjectURL&&t.revokeObjectURL){var n=t.createObjectURL.bind(t),r=t.revokeObjectURL.bind(t),i=new Map,o=0;t.createObjectURL=function(e){if("getTracks"in e){var t="polyblob:"+ ++o;return i.set(t,e),a.deprecated("URL.createObjectURL(stream)","elem.srcObject = stream"),t}return n(e)},t.revokeObjectURL=function(e){r(e),i.delete(e)};var s=Object.getOwnPropertyDescriptor(e.HTMLMediaElement.prototype,"src");Object.defineProperty(e.HTMLMediaElement.prototype,"src",{get:function(){return s.get.apply(this)},set:function(e){return this.srcObject=i.get(e)||null,s.set.apply(this,[e])}});var d=e.HTMLMediaElement.prototype.setAttribute;e.HTMLMediaElement.prototype.setAttribute=function(){return 2===arguments.length&&"src"===(""+arguments[0]).toLowerCase()&&(this.srcObject=i.get(arguments[1])||null),d.apply(this,arguments)}}}};t.exports={log:a.log,deprecated:a.deprecated,disableLog:a.disableLog,disableWarnings:a.disableWarnings,extractVersion:a.extractVersion,shimCreateObjectURL:a.shimCreateObjectURL,detectBrowser:a.detectBrowser.bind(a)}},{}]},{},[3])(3)}),navigator.mozGetUserMedia?(MediaStreamTrack.getSources=function(e){setTimeout(function(){e([{kind:"audio",id:"default",label:"",facing:""},{kind:"video",id:"default",label:"",facing:""}])},0)},attachMediaStream=function(e,t){return e.srcObject=t,e},reattachMediaStream=function(e,t){return e.srcObject=t.srcObject,e},createIceServer=function(e,t,n){console.warn("createIceServer is deprecated. It should be replaced with an application level implementation.");var r=null,i=e.split(":");if(0===i[0].indexOf("stun"))r={urls:[e]};else if(0===i[0].indexOf("turn"))if(AdapterJS.webrtcDetectedVersion<27){var a=e.split("?");1!==a.length&&0!==a[1].indexOf("transport=udp")||(r={urls:[a[0]],credential:n,username:t})}else r={urls:[e],credential:n,username:t};return r},createIceServers=function(e,t,n){console.warn("createIceServers is deprecated. It should be replaced with an application level implementation.");var r=[];for(i=0;i<e.length;i++){var a=createIceServer(e[i],t,n);null!==a&&r.push(a)}return r}):navigator.webkitGetUserMedia?(attachMediaStream=function(e,t){return AdapterJS.webrtcDetectedVersion>=43?e.srcObject=t:void 0!==e.src?e.src=URL.createObjectURL(t):console.error("Error attaching stream to element."),e},reattachMediaStream=function(e,t){return AdapterJS.webrtcDetectedVersion>=43?e.srcObject=t.srcObject:e.src=t.src,e},createIceServer=function(e,t,n){console.warn("createIceServer is deprecated. It should be replaced with an application level implementation.");var r=null,i=e.split(":");return 0===i[0].indexOf("stun")?r={url:e}:0===i[0].indexOf("turn")&&(r={url:e,credential:n,username:t}),r},createIceServers=function(e,t,n){console.warn("createIceServers is deprecated. It should be replaced with an application level implementation.");var r=[];if(AdapterJS.webrtcDetectedVersion>=34)r={urls:e,credential:n,username:t};else for(i=0;i<e.length;i++){var a=createIceServer(e[i],t,n);null!==a&&r.push(a)}return r}):"AppleWebKit"===AdapterJS.webrtcDetectedType?(attachMediaStream=function(e,t){return e.srcObject=t,e},reattachMediaStream=function(e,t){return e.srcObject=t.srcObject,e},navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&(navigator.getUserMedia=getUserMedia=function(e,t,n){navigator.mediaDevices.getUserMedia(e).then(t).catch(n)})):navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)&&(attachMediaStream=function(e,t){return e.srcObject=t,e},reattachMediaStream=function(e,t){return e.srcObject=t.srcObject,e}),attachMediaStream_base=attachMediaStream,"opera"===AdapterJS.webrtcDetectedBrowser&&(attachMediaStream_base=function(e,t){AdapterJS.webrtcDetectedVersion>38?e.srcObject=t:void 0!==e.src&&(e.src=URL.createObjectURL(t))}),attachMediaStream=function(e,t){return"chrome"!==AdapterJS.webrtcDetectedBrowser&&"opera"!==AdapterJS.webrtcDetectedBrowser||t?attachMediaStream_base(e,t):e.src="",e},reattachMediaStream_base=reattachMediaStream,reattachMediaStream=function(e,t){return reattachMediaStream_base(e,t),e},window.attachMediaStream=attachMediaStream,window.reattachMediaStream=reattachMediaStream,window.getUserMedia=function(e,t,n){navigator.getUserMedia(e,t,n)},AdapterJS.attachMediaStream=attachMediaStream,AdapterJS.reattachMediaStream=reattachMediaStream,AdapterJS.getUserMedia=getUserMedia,"undefined"==typeof Promise&&(requestUserMedia=null),AdapterJS.maybeThroughWebRTCReady()):("object"==typeof console&&"function"==typeof console.log||(console={}||console,console.log=function(e){},console.info=function(e){},console.error=function(e){},console.dir=function(e){},console.exception=function(e){},console.trace=function(e){},console.warn=function(e){},console.count=function(e){},console.debug=function(e){},console.count=function(e){},console.time=function(e){},console.timeEnd=function(e){},console.group=function(e){},console.groupCollapsed=function(e){},console.groupEnd=function(e){}),AdapterJS.WebRTCPlugin.WaitForPluginReady=function(){for(;AdapterJS.WebRTCPlugin.pluginState!==AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY;);},AdapterJS.WebRTCPlugin.callWhenPluginReady=function(e){if(AdapterJS.WebRTCPlugin.pluginState===AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY)e();else var t=setInterval(function(){AdapterJS.WebRTCPlugin.pluginState===AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY&&(clearInterval(t),e())},100)},AdapterJS.WebRTCPlugin.setLogLevel=function(e){AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){AdapterJS.WebRTCPlugin.plugin.setLogLevel(e)})},AdapterJS.WebRTCPlugin.injectPlugin=function(){if(("interactive"===document.readyState||"complete"===document.readyState)&&AdapterJS.WebRTCPlugin.pluginState===AdapterJS.WebRTCPlugin.PLUGIN_STATES.INITIALIZING){if(AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.INJECTING,"IE"===AdapterJS.webrtcDetectedBrowser&&AdapterJS.webrtcDetectedVersion<=10){var e=document.createDocumentFragment();for(AdapterJS.WebRTCPlugin.plugin=document.createElement("div"),AdapterJS.WebRTCPlugin.plugin.innerHTML='<object id="'+AdapterJS.WebRTCPlugin.pluginInfo.pluginId+'" type="'+AdapterJS.WebRTCPlugin.pluginInfo.type+'" width="1" height="1"><param name="pluginId" value="'+AdapterJS.WebRTCPlugin.pluginInfo.pluginId+'" /> <param name="windowless" value="false" /> <param name="pageId" value="'+AdapterJS.WebRTCPlugin.pageId+'" /> <param name="onload" value="'+AdapterJS.WebRTCPlugin.pluginInfo.onload+'" /><param name="tag" value="'+AdapterJS.WebRTCPlugin.TAGS.NONE+'" />'+(AdapterJS.options.getAllCams?'<param name="forceGetAllCams" value="True" />':"")+"</object>";AdapterJS.WebRTCPlugin.plugin.firstChild;)e.appendChild(AdapterJS.WebRTCPlugin.plugin.firstChild);document.body.appendChild(e),AdapterJS.WebRTCPlugin.plugin=document.getElementById(AdapterJS.WebRTCPlugin.pluginInfo.pluginId)}else AdapterJS.WebRTCPlugin.plugin=document.createElement("object"),AdapterJS.WebRTCPlugin.plugin.id=AdapterJS.WebRTCPlugin.pluginInfo.pluginId,"IE"===AdapterJS.webrtcDetectedBrowser?(AdapterJS.WebRTCPlugin.plugin.width="1px",AdapterJS.WebRTCPlugin.plugin.height="1px"):(AdapterJS.WebRTCPlugin.plugin.width="0px",AdapterJS.WebRTCPlugin.plugin.height="0px"),AdapterJS.WebRTCPlugin.plugin.type=AdapterJS.WebRTCPlugin.pluginInfo.type,AdapterJS.WebRTCPlugin.plugin.innerHTML='<param name="onload" value="'+AdapterJS.WebRTCPlugin.pluginInfo.onload+'"><param name="pluginId" value="'+AdapterJS.WebRTCPlugin.pluginInfo.pluginId+'"><param name="windowless" value="false" /> '+(AdapterJS.options.getAllCams?'<param name="forceGetAllCams" value="True" />':"")+'<param name="pageId" value="'+AdapterJS.WebRTCPlugin.pageId+'"><param name="tag" value="'+AdapterJS.WebRTCPlugin.TAGS.NONE+'" />',document.body.appendChild(AdapterJS.WebRTCPlugin.plugin);AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.INJECTED}},AdapterJS.WebRTCPlugin.isPluginInstalled=function(e,t,n,r,i){if("IE"!==AdapterJS.webrtcDetectedBrowser){for(var a=navigator.mimeTypes,o=0;o<a.length;o++)if(a[o].type.indexOf(n)>=0)return void r();i()}else{try{new ActiveXObject(e+"."+t)}catch(e){return void i()}r()}},AdapterJS.WebRTCPlugin.defineWebRTCInterface=function(){if(AdapterJS.WebRTCPlugin.pluginState!==AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY){AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.INITIALIZING,AdapterJS.isDefined=function(e){return null!==e&&void 0!==e},createIceServer=function(e,t,n){var r=null,i=e.split(":");return 0===i[0].indexOf("stun")?r={url:e,hasCredentials:!1}:0===i[0].indexOf("turn")&&(r={url:e,hasCredentials:!0,credential:n,username:t}),r},createIceServers=function(e,t,n){for(var r=[],i=0;i<e.length;++i)r.push(createIceServer(e[i],t,n));return r},RTCSessionDescription=function(e){return AdapterJS.WebRTCPlugin.WaitForPluginReady(),AdapterJS.WebRTCPlugin.plugin.ConstructSessionDescription(e.type,e.sdp)},MediaStream=function(e){return AdapterJS.WebRTCPlugin.WaitForPluginReady(),AdapterJS.WebRTCPlugin.plugin.MediaStream(e)},RTCPeerConnection=function(e,t){if(void 0!==e&&null!==e&&!Array.isArray(e.iceServers))throw new Error("Failed to construct 'RTCPeerConnection': Malformed RTCConfiguration");if(void 0!==t&&null!==t){var n=!1;if(n|="object"!=typeof t,n|=t.hasOwnProperty("mandatory")&&void 0!==t.mandatory&&null!==t.mandatory&&t.mandatory.constructor!==Object,n|=t.hasOwnProperty("optional")&&void 0!==t.optional&&null!==t.optional&&!Array.isArray(t.optional))throw new Error("Failed to construct 'RTCPeerConnection': Malformed constraints object")}AdapterJS.WebRTCPlugin.WaitForPluginReady();var r=null;if(e&&Array.isArray(e.iceServers)){r=e.iceServers;for(var i=0;i<r.length;i++)r[i].urls&&!r[i].url&&(r[i].url=r[i].urls),r[i].hasCredentials=AdapterJS.isDefined(r[i].username)&&AdapterJS.isDefined(r[i].credential)}if(AdapterJS.WebRTCPlugin.plugin.PEER_CONNECTION_VERSION&&AdapterJS.WebRTCPlugin.plugin.PEER_CONNECTION_VERSION>1)return r&&(e.iceServers=r),AdapterJS.WebRTCPlugin.plugin.PeerConnection(e);var a=t&&t.mandatory?t.mandatory:null,o=t&&t.optional?t.optional:null;return AdapterJS.WebRTCPlugin.plugin.PeerConnection(AdapterJS.WebRTCPlugin.pageId,r,a,o)},MediaStreamTrack=function(){},MediaStreamTrack.getSources=function(e){AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){AdapterJS.WebRTCPlugin.plugin.GetSources(e)})};var e=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n)if("string"!=typeof e[n]){var r="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if("sourceId"===i("",n)&&void 0!==r.exact&&(r.ideal=r.exact,r.exact=void 0),void 0!==r.ideal){t.optional=t.optional||[];var a={};"number"==typeof r.ideal?(a[i("min",n)]=r.ideal,t.optional.push(a),(a={})[i("max",n)]=r.ideal,t.optional.push(a)):(a[i("",n)]=r.ideal,t.optional.push(a))}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",n)]=r.exact):["min","max"].forEach(function(e){void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,n)]=r[e])})}else t[n]=e[n]}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t};getUserMedia=function(t,n,r){var i={};i.audio=!!t.audio&&e(t.audio),i.video=!!t.video&&e(t.video),AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){AdapterJS.WebRTCPlugin.plugin.getUserMedia(i,n,r)})},window.navigator.getUserMedia=getUserMedia,"undefined"!=typeof Promise&&(requestUserMedia=function(e){return new Promise(function(t,n){try{getUserMedia(e,t,n)}catch(e){n(e)}})},navigator.mediaDevices={getUserMedia:requestUserMedia,enumerateDevices:function(){return new Promise(function(e){var t={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(n){e(n.map(function(e){return{label:e.label,kind:t[e.kind],id:e.id,deviceId:e.id,groupId:""}}))})})}}),attachMediaStream=function(e,t){if(e&&e.parentNode){var n;null===t?n="":(void 0!==t.enableSoundTracks&&t.enableSoundTracks(!0),n=t.id);var r=0===e.id.length?Math.random().toString(36).slice(2):e.id,i=e.nodeName.toLowerCase();if("object"!==i){var a;switch(i){case"audio":a=AdapterJS.WebRTCPlugin.TAGS.AUDIO;break;case"video":a=AdapterJS.WebRTCPlugin.TAGS.VIDEO;break;default:a=AdapterJS.WebRTCPlugin.TAGS.NONE}var o=document.createDocumentFragment(),s=document.createElement("div"),d="";for(e.className?d='class="'+e.className+'" ':e.attributes&&e.attributes.class&&(d='class="'+e.attributes.class.value+'" '),s.innerHTML='<object id="'+r+'" '+d+'type="'+AdapterJS.WebRTCPlugin.pluginInfo.type+'"><param name="pluginId" value="'+r+'" /> <param name="pageId" value="'+AdapterJS.WebRTCPlugin.pageId+'" /> <param name="windowless" value="true" /> <param name="streamId" value="'+n+'" /> <param name="tag" value="'+a+'" /> </object>';s.firstChild;)o.appendChild(s.firstChild);var c="",l="";e.clientWidth||e.clientHeight?(l=e.clientWidth,c=e.clientHeight):(e.width||e.height)&&(l=e.width,c=e.height),e.parentNode.insertBefore(o,e),(o=document.getElementById(r)).width=l,o.height=c,e.parentNode.removeChild(e)}else{for(var p=e.children,u=0;u!==p.length;++u)if("streamId"===p[u].name){p[u].value=n;break}e.setStreamId(n)}var f=document.getElementById(r);return AdapterJS.forwardEventHandlers(f,e,Object.getPrototypeOf(e)),f}},reattachMediaStream=function(e,t){for(var n=null,r=t.children,i=0;i!==r.length;++i)if("streamId"===r[i].name){AdapterJS.WebRTCPlugin.WaitForPluginReady(),n=AdapterJS.WebRTCPlugin.plugin.getStreamWithId(AdapterJS.WebRTCPlugin.pageId,r[i].value);break}if(null!==n)return attachMediaStream(e,n);console.log("Could not find the stream associated with this element")},window.attachMediaStream=attachMediaStream,window.reattachMediaStream=reattachMediaStream,window.getUserMedia=getUserMedia,AdapterJS.attachMediaStream=attachMediaStream,AdapterJS.reattachMediaStream=reattachMediaStream,AdapterJS.getUserMedia=getUserMedia,AdapterJS.forwardEventHandlers=function(e,t,n){var r=Object.getOwnPropertyNames(n);for(var i in r)if(i){var a=r[i];"function"==typeof a.slice&&"on"===a.slice(0,2)&&"function"==typeof t[a]&&AdapterJS.addEvent(e,a.slice(2),t[a])}var o=Object.getPrototypeOf(n);o&&AdapterJS.forwardEventHandlers(e,t,o)},RTCIceCandidate=function(e){return e.sdpMid||(e.sdpMid=""),AdapterJS.WebRTCPlugin.WaitForPluginReady(),AdapterJS.WebRTCPlugin.plugin.ConstructIceCandidate(e.sdpMid,e.sdpMLineIndex,e.candidate)},AdapterJS.addEvent(document,"readystatechange",AdapterJS.WebRTCPlugin.injectPlugin),AdapterJS.WebRTCPlugin.injectPlugin()}else console.error("AdapterJS - WebRTC interface has already been defined")},AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCb=AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCb||function(){AdapterJS.addEvent(document,"readystatechange",AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCbPriv),AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCbPriv()},AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCbPriv=function(){if(!AdapterJS.options.hidePluginInstallPrompt){var e=AdapterJS.WebRTCPlugin.pluginInfo.downloadLink;if(e){var t;t=AdapterJS.WebRTCPlugin.pluginInfo.portalLink?'This website requires you to install the  <a href="'+AdapterJS.WebRTCPlugin.pluginInfo.portalLink+'" target="_blank">'+AdapterJS.WebRTCPlugin.pluginInfo.companyName+" WebRTC Plugin</a> to work on this browser.":AdapterJS.TEXT.PLUGIN.REQUIRE_INSTALLATION,AdapterJS.renderNotificationBar(t,AdapterJS.TEXT.PLUGIN.BUTTON,function(){window.open(e,"_top");var t=setInterval(function(){"IE"!==AdapterJS.webrtcDetectedBrowser&&navigator.plugins.refresh(!1),AdapterJS.WebRTCPlugin.isPluginInstalled(AdapterJS.WebRTCPlugin.pluginInfo.prefix,AdapterJS.WebRTCPlugin.pluginInfo.plugName,AdapterJS.WebRTCPlugin.pluginInfo.type,function(){clearInterval(t),AdapterJS.WebRTCPlugin.defineWebRTCInterface()},function(){})},500)})}else AdapterJS.renderNotificationBar(AdapterJS.TEXT.PLUGIN.NOT_SUPPORTED)}},AdapterJS.WebRTCPlugin.isPluginInstalled(AdapterJS.WebRTCPlugin.pluginInfo.prefix,AdapterJS.WebRTCPlugin.pluginInfo.plugName,AdapterJS.WebRTCPlugin.pluginInfo.type,AdapterJS.WebRTCPlugin.defineWebRTCInterface,AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCb)),"undefined"!=typeof exports&&(module.exports=AdapterJS),AdapterJS.TEXT.EXTENSION={REQUIRE_INSTALLATION_FF:"To enable screensharing you need to install the Skylink WebRTC tools Firefox Add-on.",REQUIRE_INSTALLATION_CHROME:"To enable screensharing you need to install the Skylink WebRTC tools Chrome Extension.",REQUIRE_REFRESH:"Please refresh this page after the Skylink WebRTC tools extension has been installed.",BUTTON_FF:"Install Now",BUTTON_CHROME:"Go to Chrome Web Store"},AdapterJS.extensionInfo=AdapterJS.extensionInfo||{chrome:{extensionId:"ljckddiekopnnjoeaiofddfhgnbdoafc",extensionLink:"https://chrome.google.com/webstore/detail/skylink-webrtc-tools/ljckddiekopnnjoeaiofddfhgnbdoafc",iframeLink:"https://cdn.temasys.com.sg/skylink/extensions/detectRTC.html"},firefox:{extensionLink:"https://addons.mozilla.org/en-US/firefox/addon/skylink-webrtc-tools/"},opera:{extensionId:null,extensionLink:null}},AdapterJS._mediaSourcePolyfillIsDefined=!1,AdapterJS._defineMediaSourcePolyfill=function(){if(!AdapterJS._mediaSourcePolyfillIsDefined){AdapterJS._mediaSourcePolyfillIsDefined=!0;var e=null,t=function(e){if(null===e||"object"!=typeof e)return e;var t=e.constructor();for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t},n=function(e,t,n){if(!e||"object"!=typeof e)throw new Error("GetUserMedia: (constraints, .., ..) argument required");if("function"!=typeof t)throw new Error("GetUserMedia: (.., successCb, ..) argument required");if("function"!=typeof n)throw new Error("GetUserMedia: (.., .., failureCb) argument required")};if("moz"===AdapterJS.webrtcDetectedType)e=window.navigator.getUserMedia,navigator.getUserMedia=function(r,i,a){if(n(r,i,a),r.video&&"object"==typeof r.video&&r.video.hasOwnProperty("mediaSource")){var o=t(r),s=["screen","window","application","browser","camera"],d=["NotAllowedError","PermissionDeniedError","SecurityError"];if(Array.isArray(o.video.mediaSource)){for(var c=0;c<o.video.mediaSource.length;){if(s.indexOf(o.video.mediaSource[c])>-1){o.video.mediaSource=o.video.mediaSource[c];break}c++}o.video.mediaSource="string"==typeof o.video.mediaSource?o.video.mediaSource:null}if(-1===s.indexOf(o.video.mediaSource))return void a(new Error('GetUserMedia: Only "screen" and "window" are supported as mediaSource constraints'));var l=setInterval(function(){"complete"===document.readyState&&(clearInterval(l),o.video.mozMediaSource=o.video.mediaSource,e(o,i,function(e){d.indexOf(e.name)>-1&&AdapterJS.webrtcDetectedVersion<52&&"https:"===window.parent.location.protocol?AdapterJS.renderNotificationBar(AdapterJS.TEXT.EXTENSION.REQUIRE_INSTALLATION_FF,AdapterJS.TEXT.EXTENSION.BUTTON_FF,function(e){window.open(AdapterJS.extensionInfo.firefox.extensionLink,"_blank"),e.target&&e.target.parentElement&&e.target.nextElementSibling&&e.target.nextElementSibling.click&&e.target.nextElementSibling.click(),AdapterJS.renderNotificationBar(AdapterJS.TEXT.EXTENSION?AdapterJS.TEXT.EXTENSION.REQUIRE_REFRESH:AdapterJS.TEXT.REFRESH.REQUIRE_REFRESH,AdapterJS.TEXT.REFRESH.BUTTON,function(){window.open("javascript:location.reload()","_top")})}):a(e)}))},1)}else e(r,i,a)},AdapterJS.getUserMedia=window.getUserMedia=navigator.getUserMedia;else if("webkit"===AdapterJS.webrtcDetectedType){e=window.navigator.getUserMedia;var r=document.createElement("iframe");if(navigator.getUserMedia=function(i,a,o){if(n(i,a,o),i.video&&"object"==typeof i.video&&i.video.hasOwnProperty("mediaSource")){var s=t(i),d=["window","screen","tab","audio"];if(navigator.userAgent.toLowerCase().indexOf("android")>-1)return void((Array.isArray(s.video.mediaSource)?s.video.mediaSource.indexOf("screen")>-1:"screen"===s.video.mediaSource)?(s.video.mandatory=s.video.mandatory||{},s.video.mandatory.chromeMediaSource="screen",s.video.mandatory.maxHeight=window.screen.height,s.video.mandatory.maxWidth=window.screen.width,delete s.video.mediaSource,e(s,a,o)):o(new Error('GetUserMedia: Only "screen" are supported as mediaSource constraints for Android')));if(!("opera"===AdapterJS.webrtcDetectedBrowser?!!AdapterJS.extensionInfo.opera.extensionId:"chrome"===AdapterJS.webrtcDetectedBrowser))return void o(new Error("Current browser does not support screensharing"));if("string"==typeof s.video.mediaSource&&d.indexOf(s.video.mediaSource)>-1&&"audio"!==s.video.mediaSource)s.video.mediaSource=[s.video.mediaSource];else if(Array.isArray(s.video.mediaSource)){for(var c=0,l=[];c<d.length;){for(var p=0;p<s.video.mediaSource.length;)d[c]===s.video.mediaSource[p]&&l.push(s.video.mediaSource[p]),p++;c++}s.video.mediaSource=l}else s.video.mediaSource=[];if(s.video.mediaSource.indexOf("audio")>-1&&-1===s.video.mediaSource.indexOf("tab"))return void o(new Error('GetUserMedia: "audio" mediaSource must be provided with ["audio", "tab"]'));if(0===s.video.mediaSource.length)return void o(new Error('GetUserMedia: Only "screen", "window", "tab" are supported as mediaSource constraints'));s.video.mediaSource.indexOf("tab")>-1&&s.video.mediaSource.indexOf("audio")>-1&&!s.audio&&console.warn('Audio must be requested if "tab" and "audio" mediaSource constraints is requested');var u=function(t){t.success?(s.video.mandatory=s.video.mandatory||{},s.video.mandatory.chromeMediaSource="desktop",s.video.mandatory.maxWidth=window.screen.width>1920?window.screen.width:1920,s.video.mandatory.maxHeight=window.screen.height>1080?window.screen.height:1080,s.video.mandatory.chromeMediaSourceId=t.sourceId,Array.isArray(s.video.mediaSource)&&s.video.mediaSource.indexOf("tab")>-1&&s.video.mediaSource.indexOf("audio")>-1&&s.audio&&(s.audio="object"==typeof s.audio?s.audio:{},s.audio.mandatory=s.audio.mandatory||{},s.audio.mandatory.chromeMediaSource="desktop",s.audio.mandatory.chromeMediaSourceId=t.sourceId),delete s.video.mediaSource,e(s,a,o)):(t.extensionLink&&AdapterJS.renderNotificationBar(AdapterJS.TEXT.EXTENSION.REQUIRE_INSTALLATION_CHROME,AdapterJS.TEXT.EXTENSION.BUTTON_CHROME,function(e){window.open(t.extensionLink,"_blank"),e.target&&e.target.parentElement&&e.target.nextElementSibling&&e.target.nextElementSibling.click&&e.target.nextElementSibling.click(),AdapterJS.renderNotificationBar(AdapterJS.TEXT.EXTENSION?AdapterJS.TEXT.EXTENSION.REQUIRE_REFRESH:AdapterJS.TEXT.REFRESH.REQUIRE_REFRESH,AdapterJS.TEXT.REFRESH.BUTTON,function(){window.open("javascript:location.reload()","_top")})}),o(t.error))};if(AdapterJS.extensionInfo.chrome.iframeLink&&"opera"!==AdapterJS.webrtcDetectedBrowser)r.getSourceId(s.video.mediaSource,u);else{var f=AdapterJS.extensionInfo["opera"===AdapterJS.webrtcDetectedBrowser?"opera":"chrome"].extensionId,g=AdapterJS.extensionInfo["opera"===AdapterJS.webrtcDetectedBrowser?"opera":"chrome"].extensionLink,h=document.createElement("img");h.src="chrome-extension://"+f+"/icon.png",h.onload=function(){chrome.runtime.sendMessage(f,{type:"get-version"},function(e){e&&"object"==typeof e&&"send-version"===e.type?chrome.runtime.sendMessage(f,{type:"get-source",sources:s.video.mediaSource},function(e){u(e&&"object"==typeof e?"send-source-error"===e.type?{success:!1,error:new Error("Permission denied for screen retrieval")}:{success:!0,sourceId:e.sourceId}:{success:!1,error:new Error("Retrieval failed")})}):u({success:!1,error:new Error("Extension is disabled")})})},h.onerror=function(){u({success:!1,error:new Error("Extension not installed"),extensionLink:g})}}}else e(i,a,o)},AdapterJS.getUserMedia=window.getUserMedia=navigator.getUserMedia,navigator.mediaDevices.getUserMedia=function(e){return new Promise(function(t,n){try{window.getUserMedia(e,t,n)}catch(e){n(e)}})},"chrome"===AdapterJS.webrtcDetectedBrowser){var i={loaded:!1,error:!1};if(r)try{(document.body||document.documentElement).removeChild(r)}catch(e){}if(!AdapterJS.extensionInfo.chrome.iframeLink)return;r.onload=function(){i.loaded=!0},r.onerror=function(){i.error=!0},r.src=AdapterJS.extensionInfo.chrome.iframeLink,r.style.display="none";var a=function(e,t){window.addEventListener("message",function e(n){window.removeEventListener("message",e),t(n.data?"not-installed"===n.data.chromeExtensionStatus?{success:!1,error:new Error("Extension is not installed"),extensionLink:n.data.data||AdapterJS.extensionInfo.chrome.extensionLink}:"installed-disabled"===n.data.chromeExtensionStatus?{success:!1,error:new Error("Extension is disabled")}:"PermissionDeniedError"===n.data.chromeMediaSourceId?{success:!1,error:new Error("Permission denied for screen retrieval")}:n.data.chromeMediaSourceId&&"string"==typeof n.data.chromeMediaSourceId?{success:!0,sourceId:n.data.chromeMediaSourceId}:{success:!1,error:new Error("Failed retrieving selected screen")}:{success:!1,error:new Error("Failed retrieving response")})}),r.contentWindow.postMessage({captureSourceId:!0,sources:e,legacy:!0,extensionId:AdapterJS.extensionInfo.chrome.extensionId,extensionLink:AdapterJS.extensionInfo.chrome.extensionLink},"*")};r.getSourceId=function(e,t){if(i.error)t({success:!1,error:new Error("iframe is not loaded")});else if(i.loaded)a(e,t);else var n=0,r=setInterval(function(){i.loaded?(clearInterval(r),a(e,t)):50===n?(clearInterval(r),t({success:!1,error:new Error("iframe failed to load")})):n++},100)},(document.body||document.documentElement).appendChild(r)}}else"edge"===AdapterJS.webrtcDetectedBrowser?console.warn("Edge does not support screensharing feature in getUserMedia"):"AppleWebKit"===AdapterJS.webrtcDetectedType?console.warn("Safari does not support screensharing feature in getUserMedia"):"plugin"===AdapterJS.webrtcDetectedType&&(e=window.navigator.getUserMedia,navigator.getUserMedia=function(r,i,a){if(n(r,i,a),r.video&&"object"==typeof r.video&&r.video.hasOwnProperty("mediaSource")){var o=t(r);AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){if(AdapterJS.WebRTCPlugin.plugin.HasScreensharingFeature&&AdapterJS.WebRTCPlugin.plugin.isScreensharingAvailable){if(AdapterJS.WebRTCPlugin.plugin.screensharingKeys)if(Array.isArray(o.video.mediaSource)&&o.video.mediaSource.indexOf("screen")>-1&&o.video.mediaSource.indexOf("window")>-1||o.video.mediaSource===AdapterJS.WebRTCPlugin.plugin.screensharingKey||o.video.mediaSource===AdapterJS.WebRTCPlugin.plugin.screensharingKeys.screenOrWindow)o.video.mediaSource=AdapterJS.WebRTCPlugin.plugin.screensharingKeys.screenOrWindow;else if(Array.isArray(o.video.mediaSource)&&o.video.mediaSource.indexOf("screen")>-1||"screen"===o.video.mediaSource)o.video.mediaSource=AdapterJS.WebRTCPlugin.plugin.screensharingKeys.screen;else{if(!(Array.isArray(o.video.mediaSource)&&o.video.mediaSource.indexOf("window")>-1||"window"===o.video.mediaSource))return void a(new Error('GetUserMedia: Only "screen", "window", ["screen", "window"] are supported as mediaSource constraints'));o.video.mediaSource=AdapterJS.WebRTCPlugin.plugin.screensharingKeys.window}o.video.optional=o.video.optional||[],o.video.optional.push({sourceId:o.video.mediaSource}),e(o,i,a)}else a(new Error("Your version of the WebRTC plugin does not support screensharing"))})}else e(r,i,a)},AdapterJS.getUserMedia=getUserMedia=window.getUserMedia=navigator.getUserMedia,navigator.mediaDevices&&"undefined"!=typeof Promise&&(navigator.mediaDevices.getUserMedia=requestUserMedia))}},"function"!=typeof window.require&&AdapterJS._defineMediaSourcePolyfill(),function(e){"use strict";function t(){this._enableDataChannel=!0,this._dataChannels={},this._dataTransfers={},this._dataStreams={},this._peerCandidatesQueue={},this._peerEndOfCandidatesCounter={},this._gatheredCandidates={},this._filterCandidatesType={host:!1,srflx:!1,relay:!1},this._enableIceTrickle=!0,this._enableSTUN=!0,this._enableTURN=!0,this._usePublicSTUN=!1,this._retryCounters={},this._peerConnections={},this._peerStats={},this._peerBandwidth={},this._peerCustomConfigs={},this._TURNTransport="any",this._peerInformations={},this._user=null,this._userData="",this._peerPriorityWeight=0,this._autoIntroduce=!0,this._isPrivileged=!1,this._peerList=null,this._selectedRoom=null,this._roomLocked=!1,this._inRoom=!1,this._EVENTS={},this._onceEvents={},this._timestamp={socketMessage:null,shareScreen:null,refreshConnection:null,getUserMedia:null,lastRestart:null},this._throttlingTimeouts={shareScreen:1e4,refreshConnection:5e3,getUserMedia:0},this._throttlingShouldThrowError=!1,this._socketSession={},this._socketMessageQueue=[],this._socketMessageTimeout=null,this._socketPorts={"http:":[80,3e3],"https:":[443,3443]},this._channelOpen=!1,this._signalingServer=null,this._signalingServerProtocol=window.location.protocol,this._signalingServerPort=null,this._socket=null,this._socketTimeout=7e3,this._apiTimeout=4e3,this._socketUseXDR=!1,this._enableIceRestart=!1,this._hasMCU=!1,this._forceSSL=!0,this._forceTURNSSL=!1,this._forceTURN=!1,this._path=null,this._roomServer="//api.temasys.io",this._appKey=null,this._defaultRoom=null,this._roomStart=null,this._roomDuration=null,this._roomCredentials=null,this._readyState=0,this._key=null,this._appKeyOwner=null,this._room=null,this._peerMessagesStamps={},this._audioFallback=!1,this._streams={userMedia:null,screenshare:null},this._streamsDefaultSettings={userMedia:{audio:{stereo:!1},video:{resolution:{width:640,height:480},frameRate:50}},screenshare:{video:!0}},this._streamsMutedSettings={audioMuted:!1,videoMuted:!1},this._streamsBandwidthSettings={googleX:{},bAS:{}},this._streamsStoppedCbs={},this._streamsSession={},this._selectedAudioCodec="auto",this._selectedVideoCodec="auto",this._disableVideoFecCodecs=!1,this._disableComfortNoiseCodec=!1,this._disableREMB=!1,this._sdpSettings={connection:{audio:!0,video:!0,data:!0},direction:{audio:{send:!0,receive:!0},video:{send:!0,receive:!0}}},this._publishOnly=!1,this._parentId=null,this._recordings={},this._currentRecordingId=!1,this._recordingStartInterval=null,this._mcuUseRenegoRestart=!1,this._iceServer=null,this._socketServer=null,this._currentCodecSupport=null,this._sdpSessions={},this._voiceActivityDetection=!0,this._binaryChunkType=this.DATA_TRANSFER_DATA_TYPE.ARRAY_BUFFER,this._peerConnectionConfig={},this._codecParams={},this._priorityWeightScheme=this.PRIORITY_WEIGHT_SCHEME.AUTO,this._bandwidthAdjuster=null,this._peerConnStatus={},this._useEdgeWebRTC=!1,this._joinRoomManager={timestamp:0,socketsFn:[]}}Object.keys||(Object.keys=function(){var e=Object.prototype.hasOwnProperty,t=!{toString:null}.propertyIsEnumerable("toString"),n=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],r=n.length;return function(i){if("object"!=typeof i&&"function"!=typeof i||null===i)throw new TypeError("Object.keys called on non-object");var a=[];for(var o in i)e.call(i,o)&&a.push(o);if(t)for(var s=0;r>s;s++)e.call(i,n[s])&&a.push(n[s]);return a}}()),function(){function e(e){return 10>e?"0"+e:e}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+e(this.getUTCMonth()+1)+"-"+e(this.getUTCDate())+"T"+e(this.getUTCHours())+":"+e(this.getUTCMinutes())+":"+e(this.getUTCSeconds())+"."+(this.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}}(),"function"!=typeof Date.now&&(Date.now=function(){return(new Date).getTime()}),function(e,t){function n(e){var n=t[e];t[e]=function(e){return i(n(e))}}function r(t,n,r){return(r=this).attachEvent("on"+t,function(t){(t=t||e.event).preventDefault=t.preventDefault||function(){t.returnValue=!1},t.stopPropagation=t.stopPropagation||function(){t.cancelBubble=!0},n.call(r,t)})}function i(e,t){if(t=e.length)for(;t--;)e[t].addEventListener=r;else e.addEventListener=r;return e}e.addEventListener||(i([t,e]),"Element"in e?e.Element.prototype.addEventListener=r:(t.attachEvent("onreadystatechange",function(){i(t.all)}),n("getElementsByTagName"),n("getElementById"),n("createElement"),i(t.all)))}(window,document),function(){if("performance"in window==0&&(window.performance={}),Date.now=Date.now||function(){return(new Date).getTime()},"now"in window.performance==0){var e=Date.now();performance.timing&&performance.timing.navigationStart&&(e=performance.timing.navigationStart),window.performance.now=function(){return Date.now()-e}}}(),window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,Array.prototype.forEach||(Array.prototype.forEach=function(e){var t,n;if(null==this)throw new TypeError("this is null or not defined");var r=Object(this),i=r.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(t=arguments[1]),n=0;n<i;){var a;n in r&&(a=r[n],e.call(t,a,n,r)),n++}});var n=function(e){if(null===e||"object"!=typeof e)return e;var t=function(e){var t=e.constructor();for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t};if("object"==typeof e&&!Array.isArray(e))try{return JSON.parse(JSON.stringify(e))}catch(n){return t(e)}return t(e)};t.prototype.DATA_CHANNEL_STATE={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",ERROR:"error",CREATE_ERROR:"createError",BUFFERED_AMOUNT_LOW:"bufferedAmountLow",SEND_MESSAGE_ERROR:"sendMessageError"},t.prototype.DATA_CHANNEL_TYPE={MESSAGING:"messaging",DATA:"data"},t.prototype.DATA_CHANNEL_MESSAGE_ERROR={MESSAGE:"message",TRANSFER:"transfer"},t.prototype._createDataChannel=function(e,t,n,r){var i=this,a=(i._user&&i._user.sid?i._user.sid:"-")+"_"+e,o=r?i.DATA_CHANNEL_TYPE.MESSAGING:i.DATA_CHANNEL_TYPE.DATA,s=o===i.DATA_CHANNEL_TYPE.MESSAGING?"main":a;if(i._user)if(i._peerConnections[e]&&i._peerConnections[e].signalingState!==i.PEER_CONNECTION_STATE.CLOSED){if(t&&"object"==typeof t?a=t.label:"string"==typeof t&&(a=t,t=null),!t)try{t=i._peerConnections[e].createDataChannel(a,{reliable:!0,ordered:!0})}catch(n){return u.error([e,"RTCDataChannel",s,"Failed creating Datachannel ->"],n),void i._trigger("dataChannelState",i.DATA_CHANNEL_STATE.CREATE_ERROR,e,n,a,o,null,i._getDataChannelBuffer(t))}i._dataChannels[e]?i._dataChannels[e].main&&i._dataChannels[e].main.channel.label===a&&(s="main",o=i.DATA_CHANNEL_TYPE.MESSAGING):(s="main",o=i.DATA_CHANNEL_TYPE.MESSAGING,i._dataChannels[e]={},u.debug([e,"RTCDataChannel",s,"initializing main DataChannel"])),t.onerror=function(n){var r=n.error||n;u.error([e,"RTCDataChannel",s,"Datachannel has an exception ->"],r),i._trigger("dataChannelState",i.DATA_CHANNEL_STATE.ERROR,e,r,a,o,null,i._getDataChannelBuffer(t))},t.onbufferedamountlow=function(){u.debug([e,"RTCDataChannel",s,"Datachannel buffering data transfer low"]),i._trigger("dataChannelState",i.DATA_CHANNEL_STATE.BUFFERED_AMOUNT_LOW,e,null,a,o,null,i._getDataChannelBuffer(t))},t.onmessage=function(t){i._processDataChannelData(t.data,e,a,o)};var d=function(){u.debug([e,"RTCDataChannel",s,"Datachannel has opened"]),t.bufferedAmountLowThreshold=n||0,i._trigger("dataChannelState",i.DATA_CHANNEL_STATE.OPEN,e,null,a,o,null,i._getDataChannelBuffer(t))};t.readyState===i.DATA_CHANNEL_STATE.OPEN?setTimeout(d,1):(i._trigger("dataChannelState",t.readyState,e,null,a,o,null,i._getDataChannelBuffer(t)),t.onopen=d);var c=function(){u.debug([e,"RTCDataChannel",s,"Datachannel has closed"]),i._trigger("dataChannelState",i.DATA_CHANNEL_STATE.CLOSED,e,null,a,o,null,i._getDataChannelBuffer(t)),i._peerConnections[e]&&i._peerConnections[e].remoteDescription&&i._peerConnections[e].remoteDescription.sdp&&(-1===i._peerConnections[e].remoteDescription.sdp.indexOf("m=application")||i._peerConnections[e].remoteDescription.sdp.indexOf("m=application 0")>0)||o===i.DATA_CHANNEL_TYPE.MESSAGING&&setTimeout(function(){i._peerConnections[e]&&i._peerConnections[e].signalingState!==i.PEER_CONNECTION_STATE.CLOSED&&i._peerConnections[e].localDescription&&i._peerConnections[e].localDescription.type===i.HANDSHAKE_PROGRESS.OFFER&&(u.debug([e,"RTCDataChannel",s,"Reviving Datachannel connection"]),i._createDataChannel(e,a,n,!0))},100)};if("firefox"===AdapterJS.webrtcDetectedBrowser){var l=!1,p=0;t.onclose=function(){l||(l=!0,c())};var f=setInterval(function(){t.readyState===i.DATA_CHANNEL_STATE.CLOSED||l||5===p?(clearInterval(f),l||(l=!0,c())):t.readyState===i.DATA_CHANNEL_STATE.CLOSING&&p++},1e3)}else t.onclose=c;o===i.DATA_CHANNEL_TYPE.MESSAGING?i._dataChannels[e].main={channelName:a,channelType:o,transferId:null,streamId:null,channel:t}:i._dataChannels[e][a]={channelName:a,channelType:o,transferId:null,streamId:null,channel:t}}else u.error([e,"RTCDataChannel",s,"Aborting of creating or initializing Datachannel as Peer connection does not exists"]);else u.error([e,"RTCDataChannel",s,"Aborting of creating or initializing Datachannel as User does not have Room session"])},t.prototype._getDataChannelBuffer=function(e,t){if("object"==typeof e)return{bufferedAmountLow:"number"==typeof e.bufferedAmountLow?e.bufferedAmountLow:parseInt(e.bufferedAmountLow,10)||0,bufferedAmountLowThreshold:"number"==typeof e.bufferedAmountLowThreshold?e.bufferedAmountLowThreshold:parseInt(e.bufferedAmountLowThreshold,10)||0};if(!(this._dataChannels[e]&&this._dataChannels[e][t]&&this._dataChannels[e][t].channel))return{bufferedAmountLow:0,bufferedAmountLowThreshold:0};var n=this._dataChannels[e][t].channel;return{bufferedAmountLow:"number"==typeof n.bufferedAmountLow?n.bufferedAmountLow:parseInt(n.bufferedAmountLow,10)||0,bufferedAmountLowThreshold:"number"==typeof n.bufferedAmountLowThreshold?n.bufferedAmountLowThreshold:parseInt(n.bufferedAmountLowThreshold,10)||0}},t.prototype._sendMessageToDataChannel=function(e,t,n,r){var i=this;if(n&&n!==e||(n="main"),"object"==typeof t&&t||t&&"string"==typeof t)if(i._peerConnections[e]&&i._peerConnections[e].signalingState!==i.PEER_CONNECTION_STATE.CLOSED)if(i._dataChannels[e]&&i._dataChannels[e][n]){var a=i._dataChannels[e][n].channelName,o=i._dataChannels[e][n].channelType,s=i._dataChannels[e][n].channel.readyState,d="object"==typeof t&&t.type===i._DC_PROTOCOL_TYPE.MESSAGE?i.DATA_CHANNEL_MESSAGE_ERROR.MESSAGE:i.DATA_CHANNEL_MESSAGE_ERROR.TRANSFER;if(s!==i.DATA_CHANNEL_STATE.OPEN){var c='Failed sending message as Datachannel connection state is not opened. Current readyState is "'+s+'"';throw u.error([e,"RTCDataChannel",n,c+" ->"],t),i._trigger("dataChannelState",i.DATA_CHANNEL_STATE.SEND_MESSAGE_ERROR,e,new Error(c),a,o,d,i._getDataChannelBuffer(e,n)),new Error(c)}try{r||"object"!=typeof t?(u.debug([e,"RTCDataChannel",n,"Sending data with size ->"],t.size||t.length||t.byteLength),i._dataChannels[e][n].channel.send(t)):(u.debug([e,"RTCDataChannel",n,'Sending "'+t.type+'" protocol message ->'],t),i._dataChannels[e][n].channel.send(JSON.stringify(t)))}catch(s){throw u.error([e,"RTCDataChannel",n,"Failed sending "+(r||"object"!=typeof t?"data":'"'+t.type+'" protocol message')+" ->"],s),i._trigger("dataChannelState",i.DATA_CHANNEL_STATE.SEND_MESSAGE_ERROR,e,s,a,o,d,i._getDataChannelBuffer(e,n)),s}}else u.warn([e,"RTCDataChannel",n,"Dropping for sending message as Datachannel connection does not exists ->"],t);else u.warn([e,"RTCDataChannel",n,"Dropping for sending message as Peer connection does not exists or is closed ->"],t);else u.warn([e,"RTCDataChannel",n,"Dropping invalid data ->"],t)},t.prototype._closeDataChannel=function(e,t){var n=this;if(n._dataChannels[e]){var r=function(r){var i=n._dataChannels[e][r].channelName,a=n._dataChannels[e][r].channelType;n._dataChannels[e][r].readyState!==n.DATA_CHANNEL_STATE.CLOSED&&(u.debug([e,"RTCDataChannel",t,"Closing Datachannel"]),n._trigger("dataChannelState",n.DATA_CHANNEL_STATE.CLOSING,e,null,i,a,null,n._getDataChannelBuffer(e,r)),n._dataChannels[e][r].channel.close(),delete n._dataChannels[e][r])};if(t){if(!n._dataChannels[e][t])return void u.warn([e,"RTCDataChannel",t,"Aborting closing Datachannel as it does not exists"]);r(t)}else for(var i in n._dataChannels)n._dataChannels[e].hasOwnProperty(i)&&n._dataChannels[e][i]&&r(i)}else u.warn([e,"RTCDataChannel",t||null,"Aborting closing Datachannels as Peer connection does not have Datachannel sessions"])},t.prototype.DATA_TRANSFER_DATA_TYPE={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob",STRING:"string"},t.prototype._CHUNK_FILE_SIZE=49152,t.prototype._MOZ_CHUNK_FILE_SIZE=12288,t.prototype._BINARY_FILE_SIZE=65456,t.prototype._MOZ_BINARY_FILE_SIZE=16384,t.prototype._CHUNK_DATAURL_SIZE=1212,t.prototype._base64ToBlob=function(e){for(var t=atob(e),n=new ArrayBuffer(t.length),r=new Uint8Array(n),i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return new Blob([n])},t.prototype._blobToBase64=function(e,t){var n=new FileReader;n.onload=function(){var e=n.result.split(",")[1];t(e)},n.readAsDataURL(e)},t.prototype._blobToArrayBuffer=function(e,t){var n=new FileReader;n.onload=function(){t("plugin"===AdapterJS.webrtcDetectedType?new Int8Array(n.result):n.result)},n.readAsArrayBuffer(e)},t.prototype._chunkBlobData=function(e,t){var n=[],r=0,i=0,a=e.size;if(a>t){for(;a-1>i;)i=r+t,n.push(e.slice(r,i)),r+=t;a-(r+1)>0&&n.push(e.slice(r,a-1))}else n.push(e);return n},t.prototype._chunkDataURL=function(e,t){var n=e,r=[],i=0,a=0,o=e.size||e.length;if(o>t){for(;o-1>a;)a=i+t,r.push(n.slice(i,a)),i+=t;o-(i+1)>0&&chunksArray.push(n.slice(i,o-1))}else r.push(n);return r},t.prototype.DT_PROTOCOL_VERSION="0.1.3",t.prototype.DATA_TRANSFER_TYPE={UPLOAD:"upload",DOWNLOAD:"download"},t.prototype.DATA_TRANSFER_SESSION_TYPE={BLOB:"blob",DATA_URL:"dataURL"},t.prototype.DATA_TRANSFER_STATE={UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted",USER_REJECTED:"userRejected",USER_UPLOAD_REQUEST:"userRequest",START_ERROR:"startError"},t.prototype.DATA_STREAM_STATE={SENDING_STARTED:"sendStart",SENDING_STOPPED:"sendStop",RECEIVING_STARTED:"receiveStart",RECEIVING_STOPPED:"receiveStop",RECEIVED:"received",SENT:"sent",ERROR:"error",START_ERROR:"startError"},t.prototype._DC_PROTOCOL_TYPE={WRQ:"WRQ",ACK:"ACK",ERROR:"ERROR",CANCEL:"CANCEL",MESSAGE:"MESSAGE"},t.prototype.sendBlobData=function(e,t,n,r,i){this._startDataTransfer(e,t,n,r,i,"blob")},t.prototype.sendURLData=function(e,t,n,r){this._startDataTransfer(e,t,n,r,null,"data")},t.prototype.respondBlobRequest=t.prototype.acceptDataTransfer=function(e,t,n){var r=this;if("string"==typeof t||"string"==typeof e)if(r._dataChannels[e])if(r._dataTransfers[t]){var i="main";if(r._dataChannels[e][t]&&(i=t),n){u.debug([e,"RTCDataChannel",t,"Accepted data transfer and starting ..."]);var a=function(n,i,a,o,s){console.info(i,a,o,s),r._trigger("dataTransferState",r.DATA_TRANSFER_STATE.ERROR,t,e,r._getTransferInfo(t,e,!0,!1,!1),{transferType:r.DATA_TRANSFER_TYPE.DOWNLOAD,message:new Error("Data transfer terminated as Peer Datachannel connection closed abruptly.")})};r.once("dataChannelState",a,function(n,o,s,d,c){if(r._dataTransfers[t]&&r._dataTransfers[t].sessions[e])return o===e&&("main"===i?c===r.DATA_CHANNEL_STATE.MESSAGING:d===t)&&[r.DATA_CHANNEL_STATE.CLOSING,r.DATA_CHANNEL_STATE.CLOSED,r.DATA_CHANNEL_STATE.ERROR].indexOf(n)>-1;r.off("dataChannelState",a)}),r.once("dataTransferState",function(){a&&r.off("dataChannelState",a),delete r._dataTransfers[t],r._dataChannels[e]&&("main"===i&&r._dataChannels[e].main&&(r._dataChannels[e].main.transferId=null),i===t&&r._closeDataChannel(e,t))},function(n,i,a){return i===t&&a===e&&[r.DATA_TRANSFER_STATE.ERROR,r.DATA_TRANSFER_STATE.CANCEL,r.DATA_TRANSFER_STATE.DOWNLOAD_COMPLETED].indexOf(n)>-1}),r._sendMessageToDataChannel(e,{type:r._DC_PROTOCOL_TYPE.ACK,sender:r._user.sid,ackN:0},i),r._trigger("dataTransferState",r.DATA_TRANSFER_STATE.DOWNLOAD_STARTED,t,e,r._getTransferInfo(t,e,!0,!1,!1),null)}else u.warn([e,"RTCDataChannel",t,"Rejected data transfer and data transfer request has been aborted"]),r._sendMessageToDataChannel(e,{type:r._DC_PROTOCOL_TYPE.ACK,sender:r._user.sid,ackN:-1},i),"main"===i&&r._dataChannels[e].main&&(r._dataChannels[e].main.transferId=null),r._trigger("dataTransferState",r.DATA_TRANSFER_STATE.USER_REJECTED,t,e,r._getTransferInfo(t,e,!0,!1,!1),{message:new Error("Data transfer terminated as User has rejected data transfer request."),transferType:r.DATA_TRANSFER_TYPE.DOWNLOAD}),delete r._dataTransfers[t]}else u.error([e,"RTCDataChannel",t,"Aborting accept data transfer as invalid transfer ID is provided"]);else u.error([e,"RTCDataChannel",t,"Aborting accept data transfer as Peer does not have any Datachannel connections"]);else u.error([e,"RTCDataChannel",t,"Aborting accept data transfer as data transfer ID or peer ID is not provided"])},t.prototype.cancelBlobTransfer=t.prototype.cancelDataTransfer=function(e,t){var n=this;if(t&&"string"==typeof t)if(e&&"string"==typeof e)if(n._dataTransfers[t]){u.debug([e,"RTCDataChannel",t,"Canceling data transfer ..."]);var r=function(e,r){for(var i=0;i<e.length;i++)n._trigger("dataTransferState",n.DATA_TRANSFER_STATE.CANCEL,t,e[i],n._getTransferInfo(t,r,!1,!1,!1),{transferType:n._dataTransfers[t].direction,message:new Error("User cancelled download transfer")})};if(n._hasMCU&&n._dataTransfers[t].direction===n.DATA_TRANSFER_TYPE.UPLOAD){if(!n._dataChannels.MCU)return void u.error([e,"RTCDataChannel",t,"Aborting cancel data transfer as Peer does not have any Datachannel connections"]);u.warn([e,"RTCDataChannel",t,"Aborting all data transfers to Peers"]),Object.keys(n._dataTransfers[t].peers.main).length>0&&n._sendMessageToDataChannel("MCU",{type:n._DC_PROTOCOL_TYPE.CANCEL,sender:n._user.sid,content:"Peer cancelled download transfer",name:n._dataTransfers[t].name,ackN:0},"main"),Object.keys(n._dataTransfers[t].peers[t]).length>0&&n._sendMessageToDataChannel("MCU",{type:n._DC_PROTOCOL_TYPE.CANCEL,sender:n._user.sid,content:"Peer cancelled download transfer",name:n._dataTransfers[t].name,ackN:0},t),r(Object.keys(n._dataTransfers[t].peers.main).concat(Object.keys(n._dataTransfers[t].peers[t])))}else{var i="main";if(!n._dataChannels[e])return void u.error([e,"RTCDataChannel",t,"Aborting cancel data transfer as Peer does not have any Datachannel connections"]);n._dataChannels[e][t]&&(i=t),n._sendMessageToDataChannel(e,{type:n._DC_PROTOCOL_TYPE.CANCEL,sender:n._user.sid,content:"Peer cancelled download transfer",name:n._dataTransfers[t].name,ackN:0},i),r([e],e)}}else u.error([e,"RTCDataChannel",t,"Aborting cancel data transfer as data transfer session does not exists."]);else u.error([e,"RTCDataChannel",t,"Aborting cancel data transfer as peer ID is not provided"]);else u.error([e,"RTCDataChannel",t,"Aborting cancel data transfer as data transfer ID is not provided"])},t.prototype.sendP2PMessage=function(e,t){var n=Object.keys(this._dataChannels),r=!1;if(Array.isArray(t)?(n=t,r=!0):t&&"string"==typeof t&&(n=[t],r=!0),this._inRoom&&this._user&&this._user.sid)if(this._enableDataChannel){for(var i=0;i<n.length;i++){var a=n[i];this._dataChannels[a]?"MCU"===a?(n.splice(i,1),i--):this._hasMCU||(u.debug([a,"RTCDataChannel",null,"Sending "+(r?"private":"")+" P2P message to Peer"]),this._sendMessageToDataChannel(a,{type:this._DC_PROTOCOL_TYPE.MESSAGE,isPrivate:r,sender:this._user.sid,target:a,data:e},"main")):(u.error([a,"RTCDataChannel",null,"Dropping of sending message to Peer as Datachannel connection does not exists"]),n.splice(i,1),i--)}0===n.length&&u.warn("Currently there are no Peers to send P2P message to (unless the message is queued and there are Peer connected by then)."),this._hasMCU&&(u.debug(["MCU","RTCDataChannel",null,"Broadcasting "+(r?"private":"")+" P2P message to Peers"]),this._sendMessageToDataChannel("MCU",{type:this._DC_PROTOCOL_TYPE.MESSAGE,isPrivate:r,sender:this._user.sid,target:n,data:e},"main")),this._trigger("incomingMessage",{content:e,isPrivate:r,targetPeerId:t||null,listOfPeers:n,isDataChannel:!0,senderPeerId:this._user.sid},this._user.sid,this.getPeerInfo(),!0)}else u.error("Unable to send message as User does not have Datachannel enabled. ->",e);else u.error("Unable to send message as User is not in Room. ->",e)},t.prototype.startStreamingData=function(e,t){var r=this,i=Object.keys(r._dataChannels),a=!1,o="binary";Array.isArray(t)?(i=t,a=!0):t&&"string"==typeof t&&(i=[t],a=!0),Array.isArray(e)?(i=e,t=e,a=!0):e&&"string"==typeof e?(i=[e],t=e,a=!0):e&&"boolean"==typeof e&&(o="string");var s={chunk:null,chunkSize:0,chunkType:"string"===o?r.DATA_TRANSFER_DATA_TYPE.STRING:r._binaryChunkType,isPrivate:a,isStringStream:"string"===o,senderPeerId:r._user&&r._user.sid?r._user.sid:null};i.indexOf("MCU")>-1&&i.splice(i.indexOf("MCU"),1);var d=function(e){u.error(e)};if(!this._inRoom||!this._user||!this._user.sid)return d("Unable to start data streaming as User is not in Room.");if(!this._enableDataChannel)return d("Unable to start data streaming as User does not have Datachannel enabled.");if(0===i.length)return d("Unable to start data streaming as there are no Peers to start session with.");if(r._hasMCU)return d("Unable to start data streaming as this feature is current not supported by MCU yet.");if(!r._enableSimultaneousTransfers)return d("Unable to start data streaming as this feature requires simultaneous data transfers to be enabled");for(var c="stream_"+(r._user&&r._user.sid?r._user.sid:"-")+"_"+(new Date).getTime(),l=[],p=[],f={},g=0;g<i.length;g++){var h=i[g],m=null,_=((r._peerInformations[h]||{}).agent||{}).DTProtocolVersion||"",S=r._isLowerThanVersion(_,"0.1.2")||!r._enableSimultaneousTransfers?"main":c;if(r._dataChannels[h]&&r._dataChannels[h].main)if(!r._hasMCU||r._dataChannels.MCU&&r._dataChannels.MCU.main)if(r._isLowerThanVersion(_,"0.1.3"))m='Peer DTProtocolVersion does not support data streaming. (received: "'+_+'", expected: "0.1.3")';else if("main"===S){var v=r._hasMCU?r._dataChannels.MCU.main.transferId:r._dataChannels[h].main.transferId;r._dataChannels[h].main.streamId?m="Peer Datachannel currently has an active data transfer session.":r._hasMCU&&r._dataChannels.MCU.main.streamId?m="MCU Peer Datachannel currently has an active data transfer session.":r._dataTransfers[v]&&r._dataTransfers[v].sessionChunkType===o?m=(r._hasMCU?"MCU ":"")+"Peer Datachannel currently has an active "+o+" data transfer.":l.push(h)}else p.push(h);else m="MCU Datachannel connection does not exists";else m="Datachannel connection does not exists";m?(r._trigger("dataStreamState",r.DATA_STREAM_STATE.START_ERROR,c,h,s,new Error(m)),i.splice(g,1),g--):function(e,t){var i=!1;f[e]=t,r.once("dataStreamState",function(){},function(a,o,s,d){if(o===c&&s===e){d.chunk;if(delete n(d).chunk,a!==r.DATA_STREAM_STATE.SENDING_STARTED)return i&&[r.DATA_STREAM_STATE.ERROR,r.DATA_STREAM_STATE.SENDING_STOPPED].indexOf(a)>-1?(t===c&&r._closeDataChannel(e,c),r._dataStreams[c]&&r._dataStreams[c].sessions[e]&&(delete r._dataStreams[c].sessions[e],0===Object.keys(r._dataStreams[c].sessions).length&&delete r._dataStreams[c]),!0):void 0;i=!0}})}(h,S)}if(0!==i.length){r._dataStreams[c]={sessions:f,chunkType:"string"===o?r.DATA_TRANSFER_DATA_TYPE.STRING:r._binaryChunkType,sessionChunkType:o,isPrivate:a,isStringStream:"string"===o,senderPeerId:r._user&&r._user.sid?r._user.sid:null,isUpload:!0};var C=function(e,t,i){if(r.once("dataChannelState",function(){},function(n,a,o,d,l){if(!r._dataStreams[c])return!0;if(a===e&&("main"===t?d===r.DATA_CHANNEL_TYPE.MESSAGING:o===c&&d===r.DATA_CHANNEL_TYPE.DATA)&&[r.DATA_CHANNEL_STATE.ERROR,r.DATA_CHANNEL_STATE.CLOSED].indexOf(n)>-1){var p=new Error(l&&l.message?l.message:'Failed data transfer as datachannel state is "'+n+'".');if("MCU"===e)for(var u=0;u<i.length;u++)r._trigger("dataStreamState",r.DATA_STREAM_STATE.ERROR,c,i[u],s,p);else r._trigger("dataStreamState",r.DATA_STREAM_STATE.ERROR,c,e,s,p);return!0}}),!r._dataChannels[e][t]||r._dataChannels[e][t].channel.readyState!==r.DATA_CHANNEL_STATE.OPEN){var d=new Error("Failed starting data streaming session as channel is not opened.");if("MCU"===e)for(g=0;g<i.length;g++)r._trigger("dataStreamState",r.DATA_STREAM_STATE.START_ERROR,c,i[g],s,d);else r._trigger("dataStreamState",r.DATA_STREAM_STATE.START_ERROR,c,e,s,d)}r._sendMessageToDataChannel(e,{type:r._DC_PROTOCOL_TYPE.WRQ,transferId:c,name:c,size:0,originalSize:0,dataType:"fastBinaryStart",mimeType:null,chunkType:o,chunkSize:0,timeout:0,isPrivate:a,sender:r._user.sid,agent:AdapterJS.webrtcDetectedBrowser,version:AdapterJS.webrtcDetectedVersion,target:"MCU"===e?i:e},t),r._dataChannels[e][t].streamId=c;var l=n(s);if(delete l.chunk,"MCU"===e)for(var p=0;p<i.length;p++)r._trigger("dataStreamState",r.DATA_STREAM_STATE.SENDING_STARTED,c,i[p],s,null),r._trigger("incomingDataStreamStarted",c,i[p],l,!0);else r._trigger("dataStreamState",r.DATA_STREAM_STATE.SENDING_STARTED,c,e,s,null),r._trigger("incomingDataStreamStarted",c,e,l,!0)},T=function(e,t){r.once("dataChannelState",function(n,i,a){if(n!==r.DATA_CHANNEL_STATE.CREATE_ERROR)C(e,c,t);else if("MCU"===e)for(var o=0;o<t.length;o++)r._trigger("dataStreamState",r.DATA_STREAM_STATE.START_ERROR,c,t[o],s,a);else r._trigger("dataStreamState",r.DATA_STREAM_STATE.START_ERROR,c,e,s,a)},function(t,n,i,a,o){if(n===e&&a===c&&o===r.DATA_CHANNEL_TYPE.DATA)return[r.DATA_CHANNEL_STATE.CREATE_ERROR,r.DATA_CHANNEL_STATE.OPEN].indexOf(t)>-1}),r._createDataChannel(e,c,"string"===o?r._CHUNK_DATAURL_SIZE:"firefox"===AdapterJS.webrtcDetectedBrowser?r._MOZ_BINARY_FILE_SIZE:r._BINARY_FILE_SIZE)};if(p.length>0)if(r._hasMCU)T("MCU",p);else for(var y=0;y<p.length;y++)T(p[y],null);if(l.length>0)if(r._hasMCU)C("MCU","main",l);else for(var E=0;E<l.length;E++)C(l[E],"main",null)}else u.warn("There are no Peers to start data session with.")},t.prototype.streamData=function(e,t){var r=this;if(e&&"string"==typeof e)if(t&&"object"==typeof t&&(t instanceof Blob||t instanceof ArrayBuffer))if(r._inRoom&&r._user&&r._user.sid)if(r._dataStreams[e])if(r._dataStreams[e].isUpload)if("string"===r._dataStreams[e].sessionChunkType?"string"==typeof t:"object"==typeof t)if(r._hasMCU)u.error("Failed streaming data chunk as MCU does not support this feature yet.");else{var i=t instanceof ArrayBuffer?new Blob(t):t;if("string"===r._dataStreams[e].sessionChunkType?i.length>r._CHUNK_DATAURL_SIZE:i.length>r._BINARY_FILE_SIZE)u.error("Failed streaming data chunk as data chunk exceeds maximum chunk limit.");else{var a={chunk:i,chunkSize:i.size||i.length||i.byteLength,chunkType:"string"===r._dataStreams[e].sessionChunkType?r.DATA_TRANSFER_DATA_TYPE.STRING:r._binaryChunkType,isPrivate:r._dataStreams[e].sessionChunkType.isPrivate,isStringStream:"string"===r._dataStreams[e].sessionChunkType,senderPeerId:r._user&&r._user.sid?r._user.sid:null},o=[],s=[],d=function(i,o,s){var d=function(d){r._sendMessageToDataChannel(i,d,o,!0);var c=n(a);if(delete c.chunk,s)for(var l=0;l<s.length;l++)r._trigger("dataStreamState",r.DATA_STREAM_STATE.SENT,e,s[l],a,null),r._trigger("incomingDataStream",t,e,s[l],c,!0);else r._trigger("dataStreamState",r.DATA_STREAM_STATE.SENT,e,i,a,null),r._trigger("incomingDataStream",t,e,i,c,!0)};t instanceof Blob&&a.chunkType===r.DATA_TRANSFER_DATA_TYPE.ARRAY_BUFFER?r._blobToArrayBuffer(t,d):d(t instanceof Blob||a.chunkType!==r.DATA_TRANSFER_DATA_TYPE.BLOB?"plugin"===AdapterJS.webrtcDetectedType&&"string"!=typeof t?new Int8Array(t):t:new Blob([t]))};for(var c in r._dataStreams[e].sessions)if(r._dataStreams[e].sessions.hasOwnProperty(c)&&r._dataStreams[e].sessions[c]){var l=r._dataStreams[e].sessions[c];if(!r._dataChannels[r._hasMCU?"MCU":c]||!r._dataChannels[r._hasMCU?"MCU":c][l]||r._dataChannels[r._hasMCU?"MCU":c][l].channel.readyState!==r.DATA_CHANNEL_STATE.OPEN||r._dataChannels[r._hasMCU?"MCU":c][l].streamId!==e)return u.error([c,"RTCDataChannel",e,"Failed streaming data as it has not started or is ready."]),void r._trigger("dataStreamState",r.DATA_STREAM_STATE.ERROR,e,c,a,new Error("Streaming as it has not started or Datachannel connection is not open."));r._hasMCU?"main"===l?o.push(c):s.push(c):d(c,l)}r._hasMCU&&(o.length>0&&d(c,"main",o),s.length>0&&d(c,e,s))}}else u.error("Failed streaming data chunk as data chunk does not match expected data type.");else u.error("Failed streaming data chunk as session is not sending.");else u.error("Failed streaming data chunk as session does not exists.");else u.error("Failed streaming data chunk as User is not in the Room.");else u.error("Failed streaming data chunk as it is not provided.");else u.error("Failed streaming data chunk as stream session ID is not provided.")},t.prototype.stopStreamingData=function(e){var t=this;if(e&&"string"==typeof e)if(t._inRoom&&t._user&&t._user.sid)if(t._dataStreams[e])if(t._dataStreams[e].isUpload)if(t._hasMCU)u.error("Failed stopping data streaming session as MCU does not support this feature yet.");else{var r={chunk:null,chunkSize:0,chunkType:"string"===t._dataStreams[e].sessionChunkType?t.DATA_TRANSFER_DATA_TYPE.STRING:t._binaryChunkType,isPrivate:t._dataStreams[e].sessionChunkType.isPrivate,isStringStream:"string"===t._dataStreams[e].sessionChunkType,senderPeerId:t._user&&t._user.sid?t._user.sid:null},i=[],a=[],o=function(i,a,o){t._sendMessageToDataChannel(i,{type:t._DC_PROTOCOL_TYPE.WRQ,transferId:e,name:e,size:0,originalSize:0,dataType:"fastBinaryStop",mimeType:null,chunkType:t._dataStreams[e].sessionChunkType,chunkSize:0,timeout:0,isPrivate:t._dataStreams[e].isPrivate,sender:t._user.sid,agent:AdapterJS.webrtcDetectedBrowser,version:AdapterJS.webrtcDetectedVersion,target:o||i},a);var s=n(r);if(delete s.chunk,o)for(var d=0;d<o.length;d++)t._trigger("dataStreamState",t.DATA_STREAM_STATE.SENDING_STOPPED,e,o[d],r,null),t._trigger("incomingDataStreamStopped",e,o[d],s,!0);else t._trigger("dataStreamState",t.DATA_STREAM_STATE.SENDING_STOPPED,e,i,r,null),t._trigger("incomingDataStreamStopped",e,i,s,!0)};for(var s in t._dataStreams[e].sessions)if(t._dataStreams[e].sessions.hasOwnProperty(s)&&t._dataStreams[e].sessions[s]){var d=t._dataStreams[e].sessions[s];if(!t._dataChannels[t._hasMCU?"MCU":s]||!t._dataChannels[t._hasMCU?"MCU":s][d]||t._dataChannels[t._hasMCU?"MCU":s][d].channel.readyState!==t.DATA_CHANNEL_STATE.OPEN||t._dataChannels[t._hasMCU?"MCU":s][d].streamId!==e)return u.error([s,"RTCDataChannel",e,"Failed stopping data streaming session as channel is closed."]),void t._trigger("dataStreamState",t.DATA_STREAM_STATE.ERROR,e,s,r,new Error("Failed stopping data streaming session as Datachannel connection is not open or is active."));t._hasMCU?"main"===t._dataStreams[e].sessions[s]?i.push(s):a.push(s):o(s,d)}t._hasMCU&&(i.length>0&&o(s,"main",i),a.length>0&&o(s,e,a))}else u.error("Failed stopping data streaming session as it is not sending.");else u.error("Failed stopping data streaming session as it does not exists.");else u.error("Failed streaming data chunk as User is not in the Room.");else u.error("Failed streaming data chunk as stream session ID is not provided.")},t.prototype._startDataTransfer=function(e,t,r,i,a,o){var s=this,d=(s._user?s._user.sid:"")+"_"+(new Date).getTime(),c={},l=[],p=[],f=Object.keys(s._peerConnections),g="string",h={name:null,size:null,chunkSize:null,chunkType:null,dataType:null,mimeType:null,direction:s.DATA_TRANSFER_TYPE.UPLOAD,timeout:60,isPrivate:!1,percentage:0};"number"==typeof t?h.timeout=t:Array.isArray(t)?f=t:t&&"string"==typeof t?f=[t]:t&&"boolean"==typeof t?g="binary":"function"==typeof t&&(a=t),Array.isArray(r)?f=r:r&&"string"==typeof r?f=[r]:r&&"boolean"==typeof r?g="binary":"function"==typeof r&&(a=r),i&&"boolean"==typeof i?g="binary":"function"==typeof i&&(a=i),f.indexOf("MCU")>-1&&f.splice(f.indexOf("MCU"),1);var m=function(e){if(u.error(e),"function"==typeof a){var t={};if(0===f.length)t.self=new Error(e);else for(var n=0;n<f.length;n++)t[f[n]]=new Error(e);a({transferId:null,transferInfo:h,listOfPeers:f,transferErrors:t},null)}};if("blob"===o){s._hasMCU&&"binary"===g&&(u.warn("Binary data chunks transfer is not yet supported with MCU environment. Fallbacking to binary string data chunks transfer."),g="string");var _="string"===g?"firefox"===AdapterJS.webrtcDetectedBrowser?s._MOZ_CHUNK_FILE_SIZE:s._CHUNK_FILE_SIZE:"firefox"===AdapterJS.webrtcDetectedBrowser?s._MOZ_BINARY_FILE_SIZE:s._BINARY_FILE_SIZE;if(h.dataType=s.DATA_TRANSFER_SESSION_TYPE.BLOB,h.chunkSize="string"===g?4*Math.ceil(_/3):_,h.chunkType="binary"===g?s._binaryChunkType:s.DATA_TRANSFER_DATA_TYPE.BINARY_STRING,!(e&&"object"==typeof e&&e instanceof Blob))return void m("Provided data is not a Blob data");if(h.name=e.name||d,h.mimeType=e.type||null,e.size<1)return void m("Provided data is not a valid Blob data.");h.originalSize=e.size,h.size="string"===g?4*Math.ceil(e.size/3):e.size,p=s._chunkBlobData(e,_)}else{if(h.dataType=s.DATA_TRANSFER_SESSION_TYPE.DATA_URL,h.chunkSize=s._CHUNK_DATAURL_SIZE,h.chunkType=s.DATA_TRANSFER_DATA_TYPE.STRING,!e||"string"!=typeof e)return void m("Provided data is not a dataURL");h.originalSize=h.size=e.length||e.size,p=s._chunkDataURL(e,h.chunkSize)}if(s._user&&s._user.sid)if(s._enableDataChannel)if(0!==f.length){if(s._dataTransfers[d]=n(h),s._dataTransfers[d].peers={},s._dataTransfers[d].peers.main={},s._dataTransfers[d].peers[d]={},s._dataTransfers[d].sessions={},s._dataTransfers[d].chunks=p,s._dataTransfers[d].enforceBSPeers=[],s._dataTransfers[d].enforcedBSInfo={},s._dataTransfers[d].sessionType=o,s._dataTransfers[d].sessionChunkType=g,s._dataTransfers[d].senderPeerId=s._user.sid,"blob"===o&&"binary"===g){for(var S=0;S<f.length;S++){var v=((s._peerInformations[f[S]]||{}).agent||{}).DTProtocolVersion||"0.1.0";s._isLowerThanVersion(v,"0.1.3")&&s._dataTransfers[d].enforceBSPeers.push(f[S])}if(s._dataTransfers[d].enforceBSPeers.length>0){var C="firefox"===AdapterJS.webrtcDetectedBrowser?s._MOZ_CHUNK_FILE_SIZE:s._CHUNK_FILE_SIZE,T=s._chunkBlobData(new Blob(p),C);s._dataTransfers[d].enforceBSInfo={chunkSize:4*Math.ceil(C/3),chunkType:s.DATA_TRANSFER_DATA_TYPE.BINARY_STRING,size:4*Math.ceil(h.originalSize/3),chunks:T}}}for(var y=function(e,t){l.indexOf(e)>-1||(u.debug([e,"RTCDataChannel",d,"Data transfer result. Is errors present? ->"],t),l.push(e),t&&(c[e]=new Error(t)),f.length===l.length&&(u.log([null,"RTCDataChannel",d,"Data transfer request completed"]),"function"==typeof a&&(Object.keys(c).length>0?a({transferId:d,transferInfo:s._getTransferInfo(d,e,!1,!0,!1),transferErrors:c,listOfPeers:f},null):a(null,{transferId:d,transferInfo:s._getTransferInfo(d,e,!1,!0,!1),listOfPeers:f}))))},E=0;E<f.length;E++){var R=s._startDataTransferToPeer(d,f[E],y,null,null);"boolean"==typeof R&&(!0===R?s._dataTransfers[d].peers.main[f[E]]=!0:s._dataTransfers[d].peers[d][f[E]]=!0)}s._hasMCU&&(Object.keys(s._dataTransfers[d].peers.main).length>0&&s._startDataTransferToPeer(d,"MCU",y,"main",Object.keys(s._dataTransfers[d].peers.main)),Object.keys(s._dataTransfers[d].peers[d]).length>0&&s._startDataTransferToPeer(d,"MCU",y,d,Object.keys(s._dataTransfers[d].peers[d])))}else m("Unable to send any "+o.replace("data","dataURL")+" data. There are no Peers to start data transfer with");else m("Unable to send any "+o.replace("data","dataURL")+" data. Datachannel is disabled");else m("Unable to send any "+o.replace("data","dataURL")+" data. User is not in Room.")},t.prototype._startDataTransferToPeer=function(e,t,n,r,i){var a=this,o=null,s=null,d=function(e){for(var n=i||[t],r=0;r<n.length;r++)e(n[r])},c=function(n){var r="MCU"===t?n.replace(/Peer/g,"MCU Peer"):n;d(function(n){a._trigger("dataTransferState",a.DATA_TRANSFER_STATE.ERROR,e,n,a._getTransferInfo(e,t,!0,!0,!1),{message:new Error(r),transferType:a.DATA_TRANSFER_TYPE.UPLOAD})})},l=function(){var n=a._dataTransfers[e].size,o=a._dataTransfers[e].chunkSize,s=a._dataTransfers[e].sessionChunkType;a._dataTransfers[e].enforceBSPeers.indexOf(t)>-1&&(u.warn([t,"RTCDataChannel",e,"Binary data chunks transfer is not yet supported with Peer connecting from Android, iOS and C++ SDK. Fallbacking to binary string data chunks transfer."]),n=a._dataTransfers[e].enforceBSInfo.size,o=a._dataTransfers[e].enforceBSInfo.chunkSize,s="string"),a._sendMessageToDataChannel(t,{type:a._DC_PROTOCOL_TYPE.WRQ,transferId:e,name:a._dataTransfers[e].name,size:n,originalSize:a._dataTransfers[e].originalSize,dataType:a._dataTransfers[e].sessionType,mimeType:a._dataTransfers[e].mimeType,chunkType:s,chunkSize:o,timeout:a._dataTransfers[e].timeout,isPrivate:a._dataTransfers[e].isPrivate,sender:a._user.sid,agent:AdapterJS.webrtcDetectedBrowser,version:AdapterJS.webrtcDetectedVersion,target:i||t},r),d(function(n){a._trigger("incomingDataRequest",e,n,a._getTransferInfo(e,t,!1,!1,!1),!0),a._trigger("dataTransferState",a.DATA_TRANSFER_STATE.USER_UPLOAD_REQUEST,e,n,a._getTransferInfo(e,t,!0,!1,!1),null)})};if("MCU"!==t){var p=function(i,d,c,l,p){if(o&&a.off("peerConnectionState",o),s&&a.off("dataChannelState",s),r&&delete a._dataTransfers[e].peers[r][t],i===a.DATA_TRANSFER_STATE.UPLOAD_COMPLETED?n(t,null):n(t,p.message.message||p.message.toString()),a._hasMCU&&a._dataTransfers[e].direction===a.DATA_TRANSFER_TYPE.UPLOAD){if(0!==Object.keys(a._dataTransfers[e].peers.main).length||0!==Object.keys(a._dataTransfers[e].peers[e]).length)return;delete a._dataTransfers[e]}else delete a._dataTransfers[e].sessions[t],0===Object.keys(a._dataTransfers[e].sessions).length&&delete a._dataTransfers[e]};a.once("dataTransferState",p,function(n,r,i){return a._dataTransfers[e]&&(a._hasMCU?a._dataTransfers[e].peers.main[t]||a._dataTransfers[e].peers[e][t]:a._dataTransfers[e].sessions[t])?r===e&&i===t&&[a.DATA_TRANSFER_STATE.UPLOAD_COMPLETED,a.DATA_TRANSFER_STATE.ERROR,a.DATA_TRANSFER_STATE.CANCEL,a.DATA_TRANSFER_STATE.REJECTED].indexOf(n)>-1:(p&&a.off("dataTransferState",p),o&&a.off("peerConnectionState",o),void(s&&a.off("dataChannelState",s)))})}if(a._peerConnections[t])if(a._peerInformations[t])if(a._peerConnections[t].signalingState===a.PEER_CONNECTION_STATE.STABLE)if(a._dataTransfers[e])if(a._dataChannels[t]&&a._dataChannels[t].main)if(a._dataChannels[t].main.channel.readyState===a.DATA_CHANNEL_STATE.OPEN){var f=a._dataChannels[t].main.streamId;if(f&&"main"===r&&a._dataStreams[f]&&("string"===a._dataStreams[f].sessionChunkType&&("string"===a._dataTransfers[e].sessionChunkType||a._dataTransfers[e].enforceBSPeers.indexOf(t)>-1)||"binary"===a._dataStreams[f].sessionChunkType&&"binary"===a._dataStreams[f].sessionChunkType&&-1===a._dataTransfers[e].enforceBSPeers.indexOf(t)))c("Unable to start data transfer as Peer Datachannel currently has an active "+a._dataStreams[f].sessionChunkType+" data streaming session.");else{var g=(a._peerInformations[t].agent||{}).DTProtocolVersion||"0.1.0",h=a._isLowerThanVersion(g,"0.1.2")||!a._enableSimultaneousTransfers;if(!a._isLowerThanVersion(g,"0.1.2")||"data"!==a._dataTransfers[e].sessionType||"string"!==a._dataTransfers[e].sessionChunkType)return"MCU"!==t&&a._hasMCU?(r=h?"main":e,o=function(){c("Data transfer terminated as Peer connection is not stable.")},a.once("peerConnectionState",o,function(n,r){if(a._dataTransfers[e])return n!==a.PEER_CONNECTION_STATE.STABLE&&r===t;a.off("peerConnectionState",o)}),h):void(!h&&"main"!==r||!a._dataChannels[t].main.transferId?(a._dataTransfers[e].sessions[t]={timer:null,ackN:0},s=function(n,r,i){a._dataTransfers[e].sessions[t].ackN>=a._dataTransfers[e].chunks.length-1||c(i?i.message||i.toString():"Data transfer terminated as Peer Datachannel connection closed abruptly.")},a.once("dataChannelState",s,function(n,i,o,d,c){if(a._dataTransfers[e]&&a._dataTransfers[e].sessions[t])return i!==t||c===a.DATA_CHANNEL_TYPE.DATA&&d!==e?void 0:n===a.DATA_CHANNEL_STATE.OPEN&&c===a.DATA_CHANNEL_TYPE.DATA&&d===e?(a._dataChannels[t][r].transferId=e,l(),!1):[a.DATA_CHANNEL_STATE.CREATE_ERROR,a.DATA_CHANNEL_STATE.ERROR,a.DATA_CHANNEL_STATE.CLOSING,a.DATA_CHANNEL_STATE.CLOSED].indexOf(n)>-1;a.off("dataChannelState",s)}),h&&"MCU"!==t||"main"===r?(a._dataChannels[t].main.transferId=e,l()):(r=e,a._createDataChannel(t,e,"data"===a._dataTransfers[e].sessionType?a._CHUNK_DATAURL_SIZE:"string"===a._dataTransfers[e].sessionChunkType?"firefox"===AdapterJS.webrtcDetectedBrowser?16384:65546:"firefox"===AdapterJS.webrtcDetectedBrowser?a._MOZ_BINARY_FILE_SIZE:a._BINARY_FILE_SIZE))):c("Unable to start data transfer as Peer Datachannel has a data transfer in-progress."));c("Unable to start data transfer as Peer do not support DATA_URL type of data transfers")}}else c("Unable to start data transfer as Peer Datachannel connection is not opened.");else c("Unable to start data transfer as Peer Datachannel connection does not exists.");else c("Unable to start data transfer as data transfer session is not in order.");else c("Unable to start data transfer as Peer connection is not stable.");else c("Unable to start data transfer as Peer connection does not exists.");else c("Unable to start data transfer as Peer connection does not exists.")},t.prototype._getTransferInfo=function(e,t,n,r,i){if(!this._dataTransfers[e])return{};var a={name:this._dataTransfers[e].name,size:this._dataTransfers[e].size,dataType:this._dataTransfers[e].dataType||this.DATA_TRANSFER_SESSION_TYPE.BLOB,mimeType:this._dataTransfers[e].mimeType||null,chunkSize:this._dataTransfers[e].chunkSize,chunkType:this._dataTransfers[e].chunkType,timeout:this._dataTransfers[e].timeout,isPrivate:this._dataTransfers[e].isPrivate,direction:this._dataTransfers[e].direction};if(this._dataTransfers[e].originalSize?a.size=this._dataTransfers[e].originalSize:this._dataTransfers[e].chunkType===this.DATA_TRANSFER_DATA_TYPE.BINARY_STRING&&(a.size=Math.ceil(3*a.size/4)),!r){if(a.percentage=0,!this._dataTransfers[e].sessions[t])return n&&(a.data=null),a;if(this._dataTransfers[e].direction===this.DATA_TRANSFER_TYPE.DOWNLOAD)this._dataTransfers[e].sessions[t].receivedSize===this._dataTransfers[e].sessions[t].size?a.percentage=100:a.percentage=parseFloat((this._dataTransfers[e].sessions[t].receivedSize/this._dataTransfers[e].size*100).toFixed(2),10);else{var o=this._dataTransfers[e].enforceBSPeers.indexOf(t)>-1?this._dataTransfers[e].enforceBSInfo.chunks.length:this._dataTransfers[e].chunks.length;this._dataTransfers[e].sessions[t].ackN===o?a.percentage=100:a.percentage=parseFloat((this._dataTransfers[e].sessions[t].ackN/o*100).toFixed(2),10)}n&&("number"!=typeof i?100===a.percentage?a.data=this._getTransferData(e):a.data=null:(a.percentage=i,0===i&&(a.data=this._getTransferData(e))))}return a},t.prototype._getTransferData=function(e){if(!this._dataTransfers[e])return null;if(this._dataTransfers[e].dataType===this.DATA_TRANSFER_SESSION_TYPE.BLOB){var t={name:this._dataTransfers[e].name};return this._dataTransfers[e].mimeType&&(t.type=this._dataTransfers[e].mimeType),new Blob(this._dataTransfers[e].chunks,t)}return this._dataTransfers[e].chunks.join("")},t.prototype._handleDataTransferTimeoutForPeer=function(e,t,n){var r=this;r._dataTransfers[e]&&r._dataTransfers[e].sessions[t]?(u.debug([t,"RTCDataChannel",e,"Clearing data transfer timer for Peer."]),r._dataTransfers[e].sessions[t].timer&&clearTimeout(r._dataTransfers[e].sessions[t].timer),r._dataTransfers[e].sessions[t].timer=null,n&&(u.debug([t,"RTCDataChannel",e,"Setting data transfer timer for Peer."]),r._dataTransfers[e].sessions[t].timer=setTimeout(function(){if(r._dataTransfers[e]&&r._dataTransfers[e].sessions[t])if(r._user&&r._user.sid)if(r._dataChannels[t]){u.error([t,"RTCDataChannel",e,"Data transfer response has timed out."]);var n="Connection Timeout. Longer than "+r._dataTransfers[e].timeout+" seconds. Connection is abolished.";r._sendMessageToDataChannel(t,{type:r._DC_PROTOCOL_TYPE.ERROR,content:n,isUploadError:r._dataTransfers[e].direction===r.DATA_TRANSFER_TYPE.UPLOAD,sender:r._user.sid,name:r._dataTransfers[e].name},r._dataChannels[t][e]?e:"main"),function(n){if("MCU"===t){for(var i=[r._dataTransfers[e].peers.main,r._dataTransfers[e].peers[e]],a=0;a<i.length;a++)if(i[a])for(var o in i[a])i[a].hasOwnProperty(o)&&i[a][o]&&n(o)}else n(t)}(function(i){r._trigger("dataTransferState",r.DATA_TRANSFER_STATE.ERROR,e,t,r._getTransferInfo(e,t,!0,!1,!1),{transferType:r.DATA_TRANSFER_TYPE.DOWNLOAD,message:new Error(n)})})}else u.debug([t,"RTCDataChannel",e,"Datachannel connection does not exists. Ignoring expired timeout."]);else u.debug([t,"RTCDataChannel",e,"User is not in Room. Ignoring expired timeout."]);else u.debug([t,"RTCDataChannel",e,"Data transfer already ended for Peer. Ignoring expired timeout."])},1e3*r._dataTransfers[e].timeout))):u.debug([t,"RTCDataChannel",e,"Data transfer does not exists for Peer. Ignoring timeout."])},t.prototype._processDataChannelData=function(e,t,n,r){var i=this,a=r===i.DATA_CHANNEL_TYPE.MESSAGING?"main":n,o=i._dataChannels[t][a].transferId||null,s=i._dataChannels[t][a].streamId||null,d=!1;if(s&&i._dataStreams[s]&&(d="string"===i._dataStreams[s].sessionChunkType?"string"==typeof e:"object"==typeof e),i._peerConnections[t])if(i._dataChannels[t]&&i._dataChannels[t][a])if("string"==typeof e)try{var c=JSON.parse(e);if(d=!1,u.debug([t,"RTCDataChannel",a,'Received protocol "'+c.type+'" message ->'],c),[i._DC_PROTOCOL_TYPE.ACK,i._DC_PROTOCOL_TYPE.ERROR,i._DC_PROTOCOL_TYPE.CANCEL].indexOf(c.type)>-1&&!(o&&i._dataTransfers[o]&&i._dataTransfers[o].sessions[t]))return void u.warn([t,"RTCDataChannel",a,"Discarded protocol message as data transfer session is not present ->"],c);switch(c.type){case i._DC_PROTOCOL_TYPE.WRQ:if(o&&i._dataTransfers[o]&&i._dataTransfers[o].sessions[t])return u.warn([t,"RTCDataChannel",a,"Rejecting bidirectional data transfer request as it is currently not supported in the SDK ->"],c),void i._sendMessageToDataChannel(t,{type:i._DC_PROTOCOL_TYPE.ACK,ackN:-1,sender:i._user.sid},a);i._WRQProtocolHandler(t,c,a);break;case i._DC_PROTOCOL_TYPE.ACK:i._ACKProtocolHandler(t,c,a);break;case i._DC_PROTOCOL_TYPE.ERROR:i._ERRORProtocolHandler(t,c,a);break;case i._DC_PROTOCOL_TYPE.CANCEL:i._CANCELProtocolHandler(t,c,a);break;case i._DC_PROTOCOL_TYPE.MESSAGE:i._MESSAGEProtocolHandler(t,c,a);break;default:u.warn([t,"RTCDataChannel",a,'Discarded unknown "'+c.type+'" message ->'],c)}}catch(s){if(e.indexOf("{")>-1&&e.indexOf("}")>0)throw u.error([t,"RTCDataChannel",a,"Failed parsing protocol step data error ->"],{data:e,error:s}),i._trigger("dataChannelState",i.DATA_CHANNEL_STATE.ERROR,t,s,n,r,null,i._getDataChannelBuffer(t,a)),s;if(!(d||o&&i._dataTransfers[o]&&i._dataTransfers[o].sessions[t]))return void u.warn([t,"RTCDataChannel",a,"Discarded data chunk without session ->"],e);if(!d&&o&&i._dataTransfers[o].chunks[i._dataTransfers[o].sessions[t].ackN])return void u.warn([t,"RTCDataChannel",o,"Dropping data chunk "+(d?"":"@"+i._dataTransfers[o].sessions[t].ackN)+" as it has already been added ->"],e);i.DATA_TRANSFER_DATA_TYPE.BINARY_STRING;if(d||i._dataTransfers[o].dataType===i.DATA_TRANSFER_SESSION_TYPE.DATA_URL)u.debug([t,"RTCDataChannel",a,"Received string data chunk "+(d?"":"@"+i._dataTransfers[o].sessions[t].ackN)+" with size ->"],e.length||e.size),i._DATAProtocolHandler(t,e,i.DATA_TRANSFER_DATA_TYPE.STRING,e.length||e.size||0,a);else{var l=e.replace(/\s|\r|\n/g,"");u.debug([t,"RTCDataChannel",a,"Received binary string data chunk @"+i._dataTransfers[o].sessions[t].ackN+" with size ->"],l.length||l.size),i._DATAProtocolHandler(t,i._base64ToBlob(l),i.DATA_TRANSFER_DATA_TYPE.BINARY_STRING,l.length||l.size||0,a)}}else{if(!(d||o&&i._dataTransfers[o]&&i._dataTransfers[o].sessions[t]))return void u.warn([t,"RTCDataChannel",a,"Discarded data chunk without session ->"],e);if(!d&&o&&i._dataTransfers[o].chunks[i._dataTransfers[o].sessions[t].ackN])return void u.warn([t,"RTCDataChannel",o,"Dropping data chunk "+(d?"":"@"+i._dataTransfers[o].sessions[t].ackN)+" as it has already been added ->"],e);if(e instanceof Blob)u.debug([t,"RTCDataChannel",a,"Received blob data chunk "+(d?"":"@"+i._dataTransfers[o].sessions[t].ackN)+" with size ->"],e.size),i._DATAProtocolHandler(t,e,i.DATA_TRANSFER_DATA_TYPE.BLOB,e.size,a);else{var p=e,f=null;if(e.constructor&&"Array"===e.constructor.name&&(p=new Int8Array(e)),"IE"===AdapterJS.webrtcDetectedBrowser){if(window.BlobBuilder){var g=new BlobBuilder;g.append(e.constructor&&"ArrayBuffer"===e.constructor.name?p:new Uint8Array(p).buffer),f=g.getBlob()}}else f=new Blob([p]);u.debug([t,"RTCDataChannel",a,"Received arraybuffer data chunk "+(d?"":"@"+i._dataTransfers[o].sessions[t].ackN)+" with size ->"],f.size),i._DATAProtocolHandler(t,f,i.DATA_TRANSFER_DATA_TYPE.ARRAY_BUFFER,f.size,a)}}else u.warn([t,"RTCDataChannel",a,"Dropping data received from Peer as Datachannel connection is not present ->"],e);else u.warn([t,"RTCDataChannel",a,"Dropping data received from Peer as connection is not present ->"],e)},t.prototype._WRQProtocolHandler=function(e,t,n){var r=this,i="main"===n?t.transferId||null:n,a=t.sender||e;if(["fastBinaryStart","fastBinaryStop"].indexOf(t.dataType)>-1)if("fastBinaryStart"===t.dataType){i||(i="stream_"+e+"_"+(new Date).getTime()),r._dataStreams[i]={chunkSize:0,chunkType:"string"===t.chunkType?r.DATA_TRANSFER_DATA_TYPE.STRING:r._binaryChunkType,sessionChunkType:t.chunkType,isPrivate:!!t.isPrivate,isStringStream:"string"===t.chunkType,senderPeerId:a,isUpload:!1},r._dataChannels[e][n].streamId=i;r.once("dataChannelState",function(){},function(t,o,s,d,c){if(!r._dataStreams[i])return!0;if(o===e&&("main"===n?d===r.DATA_CHANNEL_TYPE.MESSAGING:s===i&&d===r.DATA_CHANNEL_TYPE.DATA)&&[r.DATA_CHANNEL_STATE.ERROR,r.DATA_CHANNEL_STATE.CLOSED].indexOf(t)>-1){var l=new Error(c&&c.message?c.message:'Failed data transfer as datachannel state is "'+t+'".');return r._trigger("dataStreamState",r.DATA_STREAM_STATE.ERROR,i,a,{chunk:null,chunkSize:0,chunkType:r._dataStreams[i].chunkType,isPrivate:r._dataStreams[i].isPrivate,isStringStream:"string"===r._dataStreams[i].sessionChunkType,senderPeerId:a},l),!0}}),r._trigger("dataStreamState",r.DATA_STREAM_STATE.RECEIVING_STARTED,i,a,{chunk:null,chunkSize:0,chunkType:r._dataStreams[i].chunkType,isPrivate:r._dataStreams[i].isPrivate,isStringStream:"string"===r._dataStreams[i].sessionChunkType,senderPeerId:a},null),r._trigger("incomingDataStreamStarted",i,a,{chunkSize:0,chunkType:r._dataStreams[i].chunkType,isPrivate:r._dataStreams[i].isPrivate,isStringStream:"string"===r._dataStreams[i].sessionChunkType,senderPeerId:a},!1)}else i=r._dataChannels[e][n].streamId,r._dataStreams[i]&&!r._dataStreams[i].isUpload&&(r._trigger("dataStreamState",r.DATA_STREAM_STATE.RECEIVING_STOPPED,i,a,{chunk:null,chunkSize:0,chunkType:r._dataStreams[i].chunkType,isPrivate:r._dataStreams[i].isPrivate,isStringStream:"string"===r._dataStreams[i].sessionChunkType,senderPeerId:a},null),r._trigger("incomingDataStreamStopped",i,a,{chunkSize:0,chunkType:r._dataStreams[i].chunkType,isPrivate:r._dataStreams[i].isPrivate,isStringStream:"string"===r._dataStreams[i].sessionChunkType,senderPeerId:a},!1),r._dataChannels[e][n].streamId=null,"main"!==n&&r._closeDataChannel(e,n),delete r._dataStreams[i]);else i||(i="transfer_"+e+"_"+(new Date).getTime()),r._dataTransfers[i]={name:t.name||i,size:t.size||0,chunkSize:t.chunkSize,originalSize:t.originalSize||0,timeout:t.timeout||60,isPrivate:!!t.isPrivate,senderPeerId:t.sender||e,dataType:r.DATA_TRANSFER_SESSION_TYPE.BLOB,mimeType:t.mimeType||null,chunkType:r.DATA_TRANSFER_DATA_TYPE.BINARY_STRING,direction:r.DATA_TRANSFER_TYPE.DOWNLOAD,chunks:[],sessions:{},sessionType:t.dataType||"blob",sessionChunkType:t.chunkType||"string"},"data"===r._dataTransfers[i].sessionType&&"string"===r._dataTransfers[i].sessionChunkType?(r._dataTransfers[i].dataType=r.DATA_TRANSFER_SESSION_TYPE.DATA_URL,r._dataTransfers[i].chunkType=r.DATA_TRANSFER_DATA_TYPE.STRING):"blob"===r._dataTransfers[i].sessionType&&"binary"===r._dataTransfers[i].sessionChunkType&&(r._dataTransfers[i].chunkType=r._binaryChunkType),r._dataChannels[e][n].transferId=i,r._dataTransfers[i].sessions[e]={timer:null,ackN:0,receivedSize:0},r._trigger("incomingDataRequest",i,a,r._getTransferInfo(i,e,!1,!1,!1),!1),r._trigger("dataTransferState",r.DATA_TRANSFER_STATE.UPLOAD_REQUEST,i,a,r._getTransferInfo(i,e,!0,!1,!1),null)},t.prototype._ACKProtocolHandler=function(e,t,n){var r=this,i=n,a=t.sender||e;"main"===n&&(i=r._dataChannels[e].main.transferId),r._handleDataTransferTimeoutForPeer(i,e,!1);var o=function(t){if("MCU"===e){if(!r._dataTransfers[i].peers[n])return void u.warn([e,"RTCDataChannel",n,"Dropping triggering of ACK event as Peers list does not exists"]);for(var o in r._dataTransfers[i].peers[n])r._dataTransfers[i].peers[n].hasOwnProperty(o)&&r._dataTransfers[i].peers[n][o]&&t(o)}else t(a)};if(t.ackN>-1){if(0===t.ackN)o(function(t){r._trigger("dataTransferState",r.DATA_TRANSFER_STATE.UPLOAD_STARTED,i,t,r._getTransferInfo(i,e,!0,!1,0),null)});else if(r._dataTransfers[i].enforceBSPeers.indexOf(e)>-1?t.ackN===r._dataTransfers[i].enforceBSInfo.chunks.length:t.ackN===r._dataTransfers[i].chunks.length)return r._dataTransfers[i].sessions[e].ackN=t.ackN,o(function(t){r._trigger("incomingData",r._getTransferData(i),i,t,r._getTransferInfo(i,e,!1,!1,!1),!0),r._trigger("dataTransferState",r.DATA_TRANSFER_STATE.UPLOAD_COMPLETED,i,t,r._getTransferInfo(i,e,!0,!1,100),null)}),void(r._dataChannels[e][n]&&(r._dataChannels[e][n].transferId=null,"main"!==n&&r._closeDataChannel(e,n)));var s=function(a){r._sendMessageToDataChannel(e,a,n,!0),t.ackN<r._dataTransfers[i].chunks.length&&o(function(t){r._trigger("dataTransferState",r.DATA_TRANSFER_STATE.UPLOADING,i,t,r._getTransferInfo(i,e,!0,!1,!1),null)}),r._handleDataTransferTimeoutForPeer(i,e,!0)};r._dataTransfers[i].sessions[e].ackN=t.ackN,r._dataTransfers[i].enforceBSPeers.indexOf(e)>-1?r._blobToBase64(r._dataTransfers[i].enforceBSInfo.chunks[t.ackN],s):r._dataTransfers[i].chunkType===r.DATA_TRANSFER_DATA_TYPE.BINARY_STRING?r._blobToBase64(r._dataTransfers[i].chunks[t.ackN],s):r._dataTransfers[i].chunkType===r.DATA_TRANSFER_DATA_TYPE.ARRAY_BUFFER?r._blobToArrayBuffer(r._dataTransfers[i].chunks[t.ackN],s):s(r._dataTransfers[i].chunks[t.ackN])}else r._trigger("dataTransferState",r.DATA_TRANSFER_STATE.REJECTED,i,a,r._getTransferInfo(i,e,!0,!1,!1),{message:new Error("Data transfer terminated as Peer has rejected data transfer request"),transferType:r.DATA_TRANSFER_TYPE.UPLOAD})},t.prototype._MESSAGEProtocolHandler=function(e,t,n){var r=t.sender||e;u.log([r,"RTCDataChannel",n,"Received P2P message from peer:"],t),this._trigger("incomingMessage",{content:t.data,isPrivate:t.isPrivate,isDataChannel:!0,targetPeerId:this._user.sid,senderPeerId:r},r,this.getPeerInfo(r),!1)},t.prototype._ERRORProtocolHandler=function(e,t,n){var r=this,i=n,a=t.sender||e;"main"===n&&(i=r._dataChannels[e].main.transferId),r._handleDataTransferTimeoutForPeer(i,e,!1);u.error([e,"RTCDataChannel",n,"Received an error from peer ->"],t),function(t){if("MCU"===e){if(!r._dataTransfers[i].peers[n])return void u.warn([e,"RTCDataChannel",n,"Dropping triggering of ERROR event as Peers list does not exists"]);for(var o in r._dataTransfers[i].peers[n])r._dataTransfers[i].peers[n].hasOwnProperty(o)&&r._dataTransfers[i].peers[n][o]&&t(o)}else t(a)}(function(e){r._trigger("dataTransferState",r.DATA_TRANSFER_STATE.ERROR,i,e,r._getTransferInfo(i,peerID,!0,!1,!1),{message:new Error(t.content),transferType:r._dataTransfers[i].direction})})},t.prototype._CANCELProtocolHandler=function(e,t,n){var r=this,i=n;"main"===n&&(i=r._dataChannels[e].main.transferId),r._handleDataTransferTimeoutForPeer(i,e,!1);u.error([e,"RTCDataChannel",n,"Received data transfer termination from peer ->"],t),function(t){if("MCU"===e){if(!r._dataTransfers[i].peers[n])return void u.warn([e,"RTCDataChannel",n,"Dropping triggering of CANCEL event as Peers list does not exists"]);for(var a in r._dataTransfers[i].peers[n])r._dataTransfers[i].peers[n].hasOwnProperty(a)&&r._dataTransfers[i].peers[n][a]&&t(a)}else t(e)}(function(n){r._trigger("dataTransferState",r.DATA_TRANSFER_STATE.CANCEL,i,n,r._getTransferInfo(i,e,!0,!1,!1),{message:new Error(t.content||"Peer has terminated data transfer."),transferType:r._dataTransfers[i].direction})})},t.prototype._DATAProtocolHandler=function(e,t,n,r,i){var a=this,o=i,s=e;if(a._dataChannels[e]&&a._dataChannels[e][i]){var d=a._dataChannels[e][i].streamId;if(d&&a._dataStreams[d]&&("string"==typeof t&&"string"===a._dataStreams[d].sessionChunkType||t instanceof Blob&&"binary"===a._dataStreams[d].sessionChunkType))return s=a._dataStreams[d].senderPeerId||e,a._trigger("dataStreamState",a.DATA_STREAM_STATE.RECEIVED,d,s,{chunk:t,chunkSize:r,chunkType:n,isPrivate:a._dataStreams[d].sessionChunkType.isPrivate,isStringStream:"string"===a._dataStreams[d].sessionChunkType,senderPeerId:s},null),void a._trigger("incomingDataStream",t,o,s,{chunkSize:r,chunkType:n,isPrivate:a._dataStreams[d].sessionChunkType.isPrivate,isStringStream:"string"===a._dataStreams[d].sessionChunkType,senderPeerId:s},!1);if("main"===i&&(o=a._dataChannels[e].main.transferId),a._dataTransfers[o].senderPeerId&&(s=a._dataTransfers[o].senderPeerId),a._handleDataTransferTimeoutForPeer(o,e,!1),a._dataTransfers[o].chunkType=n,a._dataTransfers[o].sessions[e].receivedSize+=r,a._dataTransfers[o].chunks[a._dataTransfers[o].sessions[e].ackN]=t,a._dataTransfers[o].sessions[e].receivedSize>=a._dataTransfers[o].size)return u.log([e,"RTCDataChannel",i,"Data transfer has been completed. Computed size ->"],a._dataTransfers[o].sessions[e].receivedSize),a._sendMessageToDataChannel(e,{type:a._DC_PROTOCOL_TYPE.ACK,sender:a._user.sid,ackN:a._dataTransfers[o].sessions[e].ackN+1},i),a._trigger("incomingData",a._getTransferData(o),o,s,a._getTransferInfo(o,e,!1,!1,!1),null),void a._trigger("dataTransferState",a.DATA_TRANSFER_STATE.DOWNLOAD_COMPLETED,o,s,a._getTransferInfo(o,e,!0,!1,!1),null);a._dataTransfers[o].sessions[e].ackN+=1,a._sendMessageToDataChannel(e,{type:a._DC_PROTOCOL_TYPE.ACK,sender:a._user.sid,ackN:a._dataTransfers[o].sessions[e].ackN},i),a._handleDataTransferTimeoutForPeer(o,e,!0),a._trigger("dataTransferState",a.DATA_TRANSFER_STATE.DOWNLOADING,o,s,a._getTransferInfo(o,e,!0,!1,!1),null)}},t.prototype.CANDIDATE_GENERATION_STATE={NEW:"new",GATHERING:"gathering",COMPLETED:"completed"},t.prototype.CANDIDATE_PROCESSING_STATE={RECEIVED:"received",DROPPED:"dropped",BUFFERED:"buffered",PROCESSING:"processing",PROCESS_SUCCESS:"processSuccess",PROCESS_ERROR:"processError"},t.prototype._onIceCandidate=function(e,t){var n=this,r=n._peerConnections[e];if(r)if(t.candidate){r.gathering||(u.log([e,"RTCIceCandidate",null,"ICE gathering has started."]),r.gathering=!0,r.gathered=!1,n._trigger("candidateGenerationState",n.CANDIDATE_GENERATION_STATE.GATHERING,e));var i=t.candidate.split(" ")[7];if(u.debug([e,"RTCIceCandidate",i,"Generated ICE candidate ->"],t),"endOfCandidates"===i||!(n._peerConnections[e]&&n._peerConnections[e].localDescription&&n._peerConnections[e].localDescription.sdp&&n._peerConnections[e].localDescription.sdp.indexOf("\r\na=mid:"+t.sdpMid+"\r\n")>-1))return void u.warn([e,"RTCIceCandidate",i,"Dropping of sending ICE candidate end-of-candidates signal or unused ICE candidates to prevent errors ->"],t);if(n._filterCandidatesType[i]){if(!n._hasMCU||!n._forceTURN)return void u.warn([e,"RTCIceCandidate",i,"Dropping of sending ICE candidate as it matches ICE candidate filtering flag ->"],t);u.warn([e,"RTCIceCandidate",i,"Not dropping of sending ICE candidate as TURN connections are enforced as MCU is present (and act as a TURN itself) so filtering of ICE candidate flags are not honoured ->"],t)}if(n._gatheredCandidates[e]||(n._gatheredCandidates[e]={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),n._gatheredCandidates[e].sending[i].push({sdpMid:t.sdpMid,sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate}),!n._enableIceTrickle)return void u.warn([e,"RTCIceCandidate",i,"Dropping of sending ICE candidate as trickle ICE is disabled ->"],t);u.debug([e,"RTCIceCandidate",i,"Sending ICE candidate ->"],t),n._sendChannelMessage({type:n._SIG_MESSAGE_TYPE.CANDIDATE,label:t.sdpMLineIndex,id:t.sdpMid,candidate:t.candidate,mid:n._user.sid,target:e,rid:n._room.id})}else{if(u.log([e,"RTCIceCandidate",null,"ICE gathering has completed."]),r.gathered)return;if(r.gathering=!1,r.gathered=!0,n._trigger("candidateGenerationState",n.CANDIDATE_GENERATION_STATE.COMPLETED,e),n._enableIceTrickle)n._gatheredCandidates[e]&&n._sendChannelMessage({type:n._SIG_MESSAGE_TYPE.END_OF_CANDIDATES,noOfExpectedCandidates:n._gatheredCandidates[e].sending.srflx.length+n._gatheredCandidates[e].sending.host.length+n._gatheredCandidates[e].sending.relay.length,mid:n._user.sid,target:e,rid:n._room.id});else{var a=n._peerConnections[e].localDescription;if(!(a&&a.type&&a.sdp))return void u.warn([e,"RTCSessionDescription",null,"Not sending any session description after ICE gathering completed as it is not present."]);n._sendChannelMessage({type:a.type,sdp:n._renderSDPOutput(e,a),mid:n._user.sid,userInfo:n._getUserInfo(e),target:e,rid:n._room.id})}}else u.warn([e,"RTCIceCandidate",null,"Ignoring of ICE candidate event as Peer connection does not exists ->"],t)},t.prototype._addIceCandidateToQueue=function(e,t,n){var r=n.candidate.split(" ")[7];u.debug([e,"RTCIceCandidate",t+":"+r,"Buffering ICE candidate."]),this._trigger("candidateProcessingState",this.CANDIDATE_PROCESSING_STATE.BUFFERED,e,t,r,{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex},null),this._peerCandidatesQueue[e]=this._peerCandidatesQueue[e]||[],this._peerCandidatesQueue[e].push([t,n])},t.prototype._addIceCandidateFromQueue=function(e){this._peerCandidatesQueue[e]=this._peerCandidatesQueue[e]||[];for(var t=0;t<this._peerCandidatesQueue[e].length;t++){var n=this._peerCandidatesQueue[e][t];if(n){var r=n[1].candidate.split(" ")[7];u.debug([e,"RTCIceCandidate",n[0]+":"+r,"Adding buffered ICE candidate."]),this._addIceCandidate(e,n[0],n[1])}else if(this._peerConnections[e]&&this._peerConnections[e].signalingState!==this.PEER_CONNECTION_STATE.CLOSED&&AdapterJS&&!this._isLowerThanVersion(AdapterJS.VERSION,"0.14.0"))try{this._peerConnections[e].addIceCandidate(null),u.debug([e,"RTCPeerConnection",null,"Signaling of end-of-candidates remote ICE gathering."])}catch(t){u.error([e,"RTCPeerConnection",null,"Failed signaling of end-of-candidates remote ICE gathering."])}}delete this._peerCandidatesQueue[e],this._signalingEndOfCandidates(e)},t.prototype._addIceCandidate=function(e,t,n){var r=this,i=n.candidate.split(" ")[7],a=function(a){u.error([e,"RTCIceCandidate",t+":"+i,"Failed adding ICE candidate ->"],a),r._trigger("candidateProcessingState",r.CANDIDATE_PROCESSING_STATE.PROCESS_ERROR,e,t,i,{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex},a)};if(u.debug([e,"RTCIceCandidate",t+":"+i,"Adding ICE candidate."]),r._trigger("candidateProcessingState",r.CANDIDATE_PROCESSING_STATE.PROCESSING,e,t,i,{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex},null),!(r._peerConnections[e]&&r._peerConnections[e].signalingState!==r.PEER_CONNECTION_STATE.CLOSED&&r._peerConnections[e].remoteDescription&&r._peerConnections[e].remoteDescription.sdp&&r._peerConnections[e].remoteDescription.sdp.indexOf("\r\na=mid:"+n.sdpMid+"\r\n")>-1))return u.warn([e,"RTCIceCandidate",t+":"+i,"Dropping ICE candidate as Peer connection does not exists or is closed"]),void r._trigger("candidateProcessingState",r.CANDIDATE_PROCESSING_STATE.DROPPED,e,t,i,{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex},new Error("Failed processing ICE candidate as Peer connection does not exists or is closed."));try{r._peerConnections[e].addIceCandidate(n,function(){u.log([e,"RTCIceCandidate",t+":"+i,"Added ICE candidate successfully."]),r._trigger("candidateProcessingState",r.CANDIDATE_PROCESSING_STATE.PROCESS_SUCCESS,e,t,i,{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex},null)},a)}catch(e){a(e)}},t.prototype.ICE_CONNECTION_STATE={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",TRICKLE_FAILED:"trickleFailed",DISCONNECTED:"disconnected"},t.prototype.TURN_TRANSPORT={UDP:"udp",TCP:"tcp",ANY:"any",NONE:"none",ALL:"all"},t.prototype._setIceServers=function(e){var t=this,n=null,r="stun",i={udp:[3478,19302,19303,19304],tcp:[80,443],both:[19305,19306,19307,19308]},a=[{urls:[]},{urls:[]}];return e.forEach(function(e){if(0===e.url.indexOf("stun:"))e.url.indexOf("temasys")>0?n=(e.url.split(":")[1]||"").split("?")[0]||null:a[0].urls.push(e.url);else if(0===e.url.indexOf("turn:")&&e.url.indexOf("@")>0&&e.credential&&!a[1].username&&!a[1].credential){var t=(e.url.split(":")[1]||"").split("@");n=(t[1]||"").split("?")[0],a[1].username=t[0],a[1].credential=e.credential,r="turn"}}),t._iceServer?a=[{urls:t._iceServer.urls,username:a[1].username,credential:a[1].credential}]:(n=n||"turn.temasys.io","edge"===AdapterJS.webrtcDetectedBrowser?(i.udp=[3478],i.tcp=[],i.both=[],r="turn"):t._forceTURNSSL?"firefox"===AdapterJS.webrtcDetectedBrowser&&AdapterJS.webrtcDetectedVersion<53?(i.udp=[],i.tcp=[443],i.both=[],r="turn"):(i.udp=[],r="turns"):"firefox"===AdapterJS.webrtcDetectedBrowser&&(i.udp=[3478],i.tcp=[443,80]),t._TURNTransport!==t.TURN_TRANSPORT.UDP||t._forceTURNSSL?t._TURNTransport===t.TURN_TRANSPORT.TCP?(i.tcp=i.tcp.concat(i.both),i.udp=[],i.both=[]):t._TURNTransport===t.TURN_TRANSPORT.NONE&&(i.tcp=[],i.udp=[]):(i.udp=i.udp.concat(i.both),i.tcp=[],i.both=[]),"stun"===r&&(i.tcp=[]),i.tcp.forEach(function(e){a[1].urls.push(r+":"+n+":"+e+"?transport=tcp")}),i.udp.forEach(function(e){a[1].urls.push(r+":"+n+":"+e+"?transport=udp")}),i.both.forEach(function(e){a[1].urls.push(r+":"+n+":"+e)})),t._usePublicSTUN||a.splice(0,1),u.log("Output iceServers configuration:",a),{iceServers:a}},t.prototype.PEER_CONNECTION_STATE={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",CLOSED:"closed"},t.prototype.GET_CONNECTION_STATUS_STATE={RETRIEVING:0,RETRIEVE_SUCCESS:1,RETRIEVE_ERROR:-1},t.prototype.SERVER_PEER_TYPE={MCU:"mcu"},t.prototype.BUNDLE_POLICY={MAX_COMPAT:"max-compat",BALANCED:"balanced",MAX_BUNDLE:"max-bundle",NONE:"none"},t.prototype.RTCP_MUX_POLICY={REQUIRE:"require",NEGOTIATE:"negotiate"},t.prototype.PEER_CERTIFICATE={RSA:"RSA",ECDSA:"ECDSA",AUTO:"AUTO"},t.prototype.refreshConnection=function(e,t,n,r){var i=this,a=Object.keys(i._peerConnections),o=!1,s={};Array.isArray(e)?a=e:"string"==typeof e?a=[e]:"boolean"==typeof e?o=e:e&&"object"==typeof e?s=e:"function"==typeof e&&(r=e),"boolean"==typeof t?o=t:t&&"object"==typeof t?s=t:"function"==typeof t&&(r=t),n&&"object"==typeof n?s=n:"function"==typeof n&&(r=n);var d=function(e){if(u.error(e),"function"==typeof r){var t={};if(0===a.length)t.self=new Error(e);else for(var n=0;n<a.length;n++)t[a[n]]=new Error(e);r({refreshErrors:listOfPeerRestartErrors,listOfPeers:a},null)}};0!==a.length||i._hasMCU&&!i._mcuUseRenegoRestart?"edge"!==AdapterJS.webrtcDetectedBrowser?i._throttle(function(e){e||!i._hasMCU||i._mcuUseRenegoRestart?i._refreshPeerConnection(a,o,s,r):i._throttlingShouldThrowError&&d("Unable to run as throttle interval has not reached ("+i._throttlingTimeouts.refreshConnection+"ms).")},"refreshConnection",i._throttlingTimeouts.refreshConnection):d("Edge browser currently does not support renegotiation."):d("There is currently no peer connections to restart")},t.prototype._refreshPeerConnection=function(e,t,n,r){var i=this,a=[],o="",s={},d={},c=function(n){return function(o){-1===a.indexOf(n)&&(o?(u.error([n,"RTCPeerConnection",null,"Failed restarting for peer"],o),s[n]=o):d[n]={iceRestart:!i._hasMCU&&i._peerInformations[n]&&i._peerInformations[n].config&&i._peerInformations[n].config.enableIceRestart&&i._enableIceRestart&&t,customSettings:i.getPeersCustomSettings()[n]||{}},a.push(n)),a.length===e.length&&"function"==typeof r&&(u.log([null,"PeerConnection",null,"Invoked all peers to restart. Firing callback"]),Object.keys(s).length>0?r({refreshErrors:s,listOfPeers:e,refreshSettings:d},null):r(null,{listOfPeers:e,refreshSettings:d}))}};if(i._hasMCU)i._restartMCUConnection(r,t,n);else{var l;for(l=0;l<e.length;l++){var p=e[l];Object.keys(i._peerConnections).indexOf(p)>-1?function(e,r){if(!i._peerConnections[e])return o="There is currently no existing peer connection made with the peer. Unable to restart connection",u.error([e,null,null,o]),void r(o);u.log([e,"PeerConnection",null,"Restarting peer connection"]),i._restartPeerConnection(e,t,n,r)}(p,c(p)):(o="Peer connection with peer does not exists. Unable to restart",u.error([p,"PeerConnection",null,o]),c(p)(o))}}},t.prototype.getConnectionStatus=function(e,t){var n=this,r=Object.keys(n._peerConnections),i={},a={};if(Array.isArray(e)?r=e:"string"==typeof e&&e?r=[e]:"function"==typeof e&&(t=e,e=void 0),0===r.length)return a.self=new Error("There is currently no peer connections to retrieve connection status"),u.error([null,"RTCStatsReport",null,"Retrieving request failure ->"],a.self),void("function"==typeof t&&t({listOfPeers:r,retrievalErrors:a,connectionStats:i},null));"edge"===AdapterJS.webrtcDetectedBrowser&&u.warn("Edge browser does not have well support for stats.");for(var o=[],s=function(e){-1===o.indexOf(e)&&o.push(e),o.length===r.length&&"function"==typeof t&&(Object.keys(a).length>0?t({listOfPeers:r,retrievalErrors:a,connectionStats:i},null):t(null,{listOfPeers:r,connectionStats:i}))},d=0;d<r.length;d++){var c=r[d];n._trigger("getConnectionStatusStateChange",n.GET_CONNECTION_STATUS_STATE.RETRIEVING,c,null,null),n._peerConnections.hasOwnProperty(c)&&n._peerConnections[c]?function(e){var t=function(t,r){return function(o,d){if(o)return u.error([e,"RTCStatsReport",null,"Retrieval failure ->"],error),a[e]=error,n._trigger("getConnectionStatusStateChange",n.GET_CONNECTION_STATUS_STATE.RETRIEVE_ERROR,e,null,error),s(e),void(t&&delete n._peerStats[e]);t?r():(i[e]=d,n._trigger("getConnectionStatusStateChange",n.GET_CONNECTION_STATUS_STATE.RETRIEVE_SUCCESS,e,i[e],null),s(e))}};if(!n._peerStats[e])return n._peerStats[e]={},u.debug([e,"RTCStatsReport",null,"Retrieving first report to tabulate results"]),void n._retrieveStats(e,t(!0,function(){n._retrieveStats(e,t())}),!0);n._retrieveStats(e,t())}(c):(a[c]=new Error("The peer connection object does not exists"),u.error([c,"RTCStatsReport",null,"Retrieval failure ->"],a[c]),n._trigger("getConnectionStatusStateChange",n.GET_CONNECTION_STATUS_STATE.RETRIEVE_ERROR,c,null,a[c]),s(c))}},t.prototype._retrieveStats=function(e,t,n,r){var i=this,a=i._peerConnections[e],o={raw:{},connection:{},audio:{sending:{},receiving:{}},video:{sending:{},receiving:{}},selectedCandidate:{local:{},remote:{},consentResponses:{},consentRequests:{},responses:{},requests:{}},certificate:{}};if(!i._peerStats[e]&&!r)return t(new Error("No stats initiated yet."));if(!a)return t(new Error("Peer connection is not initialised"));"edge"!==AdapterJS.webrtcDetectedBrowser&&"AppleWebKit"!==AdapterJS.webrtcDetectedType||u.warn("Current connection stats may not be complete as it is in beta"),o.connection.iceConnectionState=a.iceConnectionState,o.connection.iceGatheringState=a.iceGatheringState,o.connection.signalingState=a.signalingState,o.connection.remoteDescription={type:a.remoteDescription&&a.remoteDescription.type||"",sdp:a.remoteDescription&&a.remoteDescription.sdp||""},o.connection.localDescription={type:a.localDescription&&a.localDescription.type||"",sdp:a.localDescription&&a.localDescription.sdp||""},o.connection.candidates={sending:i._getSDPICECandidates(e,a.localDescription,n),receiving:i._getSDPICECandidates(e,a.remoteDescription,n)},o.connection.dataChannels={},o.connection.constraints=i._peerConnStatus[e]?i._peerConnStatus[e].constraints:null,o.connection.optional=i._peerConnStatus[e]?i._peerConnStatus[e].optional:null,o.connection.sdpConstraints=i._peerConnStatus[e]?i._peerConnStatus[e].sdpConstraints:null,o.audio.sending.codec=i._getSDPSelectedCodec(e,a.remoteDescription,"audio",n),o.video.sending.codec=i._getSDPSelectedCodec(e,a.remoteDescription,"video",n),o.audio.receiving.codec=i._getSDPSelectedCodec(e,a.localDescription,"audio",n),o.video.receiving.codec=i._getSDPSelectedCodec(e,a.localDescription,"video",n),o.certificate.local=i._getSDPFingerprint(e,a.localDescription,n),o.certificate.remote=i._getSDPFingerprint(e,a.remoteDescription,n);var s=i._getSDPMediaSSRC(e,a.remoteDescription,n);o.audio.receiving.ssrc=s.audio,o.video.receiving.ssrc=s.video;var d=i._getSDPMediaSSRC(e,a.localDescription,n);o.audio.sending.ssrc=d.audio,o.video.sending.ssrc=d.video,Object.keys(i._dataChannels[e]||{}).forEach(function(t){var n=i._dataChannels[e][t];o.connection.dataChannels[n.channel.label]={label:n.channel.label,readyState:n.channel.readyState,channelType:i.DATA_CHANNEL_TYPE["main"===t?"MESSAGING":"DATA"],currentTransferId:n.transferId||null,currentStreamId:n.streamId||null}});var c=function(e,t){if(0===t.indexOf("RTCCertificate_"))e.fingerprint===o.certificate.local.fingerprint?(o.certificate.local.derBase64=e.base64Certificate,o.certificate.local.fingerprintAlgorithm=e.fingerprintAlgorithm):e.fingerprint===o.certificate.remote.fingerprint&&(o.certificate.remote.derBase64=e.base64Certificate,o.certificate.remote.fingerprintAlgorithm=e.fingerprintAlgorithm);else if(0===t.indexOf("ssrc_")&&e.transportId){var n=o.raw[e.transportId]||{};o.certificate.srtpCipher=n.srtpCipher,o.certificate.dtlsCipher=n.dtlsCipher;var r=o.raw[n.localCertificateId||""]||{};o.certificate.local.fingerprint=r.googFingerprint,o.certificate.local.fingerprintAlgorithm=r.googFingerprintAlgorithm,o.certificate.local.derBase64=r.googDerBase64;var i=o.raw[n.remoteCertificateId||""]||{};o.certificate.remote.fingerprint=i.googFingerprint,o.certificate.remote.fingerprintAlgorithm=i.googFingerprintAlgorithm,o.certificate.remote.derBase64=i.googDerBase64}},l=function(t,n){if(0===n.indexOf("RTCIceCandidatePair_")){if("succeeded"!==t.state||o.selectedCandidate.nominated||t.prioirty<(o.selectedCandidate.priority||0))return;for(var s=r?i._peerBandwidth[e][n]:i._peerStats[e][n],d=a.localDescription&&a.localDescription.sdp&&a.localDescription.sdp.match(/a=candidate:.*\r\n/gi)||[],c=a.remoteDescription&&a.remoteDescription&&a.remoteDescription.sdp.match(/a=candidate:.*\r\n/gi)||[],l=function(e,t){return Math.pow(2,32)*Math.min(e,t)+2*Math.max(e,t)+(e>t?1:0)},p=function(e){return"relay"===e?"relayed":"host"===e?"local":"srflx"===e?"serverreflexive":e},u=0;u<d.length;u++)for(var f=d[u].split(" "),g=0;g<c.length;g++){var h=c[g].split(" ");if((t.writable?l(parseInt(f[3],10),parseInt(h[3],10)):l(parseInt(h[3],10),parseInt(f[3],10)))===t.priority){o.selectedCandidate.local.ipAddress=f[4],o.selectedCandidate.local.candidateType=f[7],o.selectedCandidate.local.portNumber=parseInt(f[5],10),o.selectedCandidate.local.transport=f[2],o.selectedCandidate.local.priority=parseInt(f[3],10),o.selectedCandidate.local.candidateType=p(f[7]),o.selectedCandidate.remote.ipAddress=h[4],o.selectedCandidate.remote.candidateType=h[7],o.selectedCandidate.remote.portNumber=parseInt(h[5],10),o.selectedCandidate.remote.transport=h[2],o.selectedCandidate.remote.priority=parseInt(h[3],10),o.selectedCandidate.remote.candidateType=p(h[7]);break}}o.selectedCandidate.writable=t.writable,o.selectedCandidate.readable=t.readable,o.selectedCandidate.priority=t.priority,o.selectedCandidate.nominated=t.nominated;m=parseInt(t.rtt||"0",10);o.selectedCandidate.totalRtt=m,o.selectedCandidate.rtt=i._parseConnectionStats(s,t,"rtt");_=parseInt(t.consentResponsesReceived||"0",10);o.selectedCandidate.consentResponses.totalReceived=_,o.selectedCandidate.consentResponses.received=i._parseConnectionStats(s,t,"consentResponsesReceived");S=parseInt(t.consentResponsesSent||"0",10);o.selectedCandidate.consentResponses.totalSent=S,o.selectedCandidate.consentResponses.sent=i._parseConnectionStats(s,t,"consentResponsesSent");v=parseInt(t.responsesReceived||"0",10);o.selectedCandidate.responses.totalReceived=v,o.selectedCandidate.responses.received=i._parseConnectionStats(s,t,"responsesReceived");C=parseInt(t.responsesSent||"0",10);o.selectedCandidate.responses.totalSent=C,o.selectedCandidate.responses.sent=i._parseConnectionStats(s,t,"responsesSent")}else if("googCandidatePair"===t.type){s=r?i._peerBandwidth[e][n]:i._peerStats[e][n];o.selectedCandidate.writable="true"===t.googWritable,o.selectedCandidate.readable="true"===t.googReadable;var m=parseInt(t.googRtt||"0",10);if(o.selectedCandidate.totalRtt=m,o.selectedCandidate.rtt=i._parseConnectionStats(s,t,"rtt"),t.consentResponsesReceived){var _=parseInt(t.consentResponsesReceived||"0",10);o.selectedCandidate.consentResponses.totalReceived=_,o.selectedCandidate.consentResponses.received=i._parseConnectionStats(s,t,"consentResponsesReceived")}if(t.consentResponsesSent){var S=parseInt(t.consentResponsesSent||"0",10);o.selectedCandidate.consentResponses.totalSent=S,o.selectedCandidate.consentResponses.sent=i._parseConnectionStats(s,t,"consentResponsesSent")}if(t.responsesReceived){var v=parseInt(t.responsesReceived||"0",10);o.selectedCandidate.responses.totalReceived=v,o.selectedCandidate.responses.received=i._parseConnectionStats(s,t,"responsesReceived")}if(t.responsesSent){var C=parseInt(t.responsesSent||"0",10);o.selectedCandidate.responses.totalSent=C,o.selectedCandidate.responses.sent=i._parseConnectionStats(s,t,"responsesSent")}T=o.raw[t.localCandidateId||""]||{};o.selectedCandidate.local.ipAddress=T.ipAddress,o.selectedCandidate.local.portNumber=parseInt(T.portNumber,10),o.selectedCandidate.local.priority=parseInt(T.priority,10),o.selectedCandidate.local.networkType=T.networkType,o.selectedCandidate.local.transport=T.transport,o.selectedCandidate.local.candidateType=T.candidateType;y=o.raw[t.remoteCandidateId||""]||{};o.selectedCandidate.remote.ipAddress=y.ipAddress,o.selectedCandidate.remote.portNumber=parseInt(y.portNumber,10),o.selectedCandidate.remote.priority=parseInt(y.priority,10),o.selectedCandidate.remote.transport=y.transport,o.selectedCandidate.remote.candidateType=y.candidateType}else if("candidatepair"===t.type&&"succeeded"===t.state&&t.nominated){o.selectedCandidate.writable=t.writable,o.selectedCandidate.readable=t.readable;var T=o.raw[t.localCandidateId||""];o.selectedCandidate.local.ipAddress=T.ipAddress,o.selectedCandidate.local.portNumber=T.portNumber,o.selectedCandidate.local.transport=T.transport,o.selectedCandidate.local.candidateType=T.candidateType,o.selectedCandidate.local.turnMediaTransport=T.mozLocalTransport;var y=o.raw[t.remoteCandidateId||""];o.selectedCandidate.remote.ipAddress=y.ipAddress,o.selectedCandidate.remote.portNumber=y.portNumber,o.selectedCandidate.remote.transport=y.transport,o.selectedCandidate.remote.candidateType=y.candidateType}},p=function(e,t){if(0===t.indexOf("ssrc_")){var n=t.indexOf("_send")>0?"sending":"receiving";e.codecImplementationName="unknown"===e.codecImplementationName?null:e.codecImplementationName,o[e.mediaType][n].codec.implementation=e.codecImplementationName||null,e.googCodecName="unknown"===e.googCodecName?null:e.googCodecName,o[e.mediaType][n].codec.name=e.googCodecName||o[e.mediaType][n].codec.name}},f=function(t,n){var s=r?i._peerBandwidth[e][n]:i._peerStats[e][n];if(0===n.indexOf("RTCInboundRTPAudioStream")){if(o.audio.receiving.fractionLost=t.fractionLost,o.audio.receiving.jitter=t.jitter,o.audio.receiving.totalBytes=t.bytesReceived,o.audio.receiving.bytes=i._parseConnectionStats(s,t,"bytesReceived"),o.audio.receiving.totalPackets=t.packetsReceived,o.audio.receiving.packets=i._parseConnectionStats(s,t,"packetsReceived"),o.audio.receiving.totalPacketsDiscarded=t.packetsDiscarded,o.audio.receiving.packetsDiscarded=i._parseConnectionStats(s,t,"packetsDiscarded"),o.audio.receiving.totalPacketsLost=t.packetsLost,o.audio.receiving.packetsLost=i._parseConnectionStats(s,t,"packetsLost"),o.audio.receiving.totalNacks=t.nackCount,o.audio.receiving.nacks=i._parseConnectionStats(s,t,"nackCount"),"function"!=typeof a.getReceivers)return}else if(0===n.indexOf("RTCMediaStreamTrack_remote_audio_"))o.audio.receiving.audioOutputLevel=t.audioLevel;else if(0===n.indexOf("RTCOutboundRTPAudioStream"))o.audio.sending.targetBitrate=t.targetBitrate||0,o.audio.sending.totalBytes=t.bytesSent,o.audio.sending.bytes=i._parseConnectionStats(s,t,"bytesSent"),o.audio.sending.totalPackets=t.packetsSent,o.audio.sending.packets=i._parseConnectionStats(s,t,"packetsSent"),o.audio.sending.totalNacks=t.nackCount,o.audio.sending.nacks=i._parseConnectionStats(s,t,"nackCount");else if("edge"===AdapterJS.webrtcDetectedBrowser&&"inboundrtp"===t.type&&"audio"===t.mediaType&&t.isRemote)o.audio.receiving.fractionLost=t.fractionLost,o.audio.receiving.jitter=t.jitter,o.audio.receiving.totalBytes=t.bytesReceived,o.audio.receiving.bytes=i._parseConnectionStats(s,t,"bytesReceived"),o.audio.receiving.totalPackets=t.packetsReceived,o.audio.receiving.packets=i._parseConnectionStats(s,t,"packetsReceived"),o.audio.receiving.totalPacketsLost=t.packetsLost,o.audio.receiving.packetsLost=i._parseConnectionStats(s,t,"packetsLost"),o.audio.receiving.totalNacks=t.nackCount,o.audio.receiving.nacks=i._parseConnectionStats(s,t,"nackCount");else if("edge"!==AdapterJS.webrtcDetectedBrowser||"outboundrtp"!==t.type||"audio"!==t.mediaType||t.isRemote){if(0===n.indexOf("ssrc_")&&"audio"===t.mediaType)if(n.indexOf("_recv")>0){o.audio.receiving.jitter=parseInt(t.googJitterReceived||"0",10),o.audio.receiving.jitterBufferMs=parseInt(t.googJitterBufferMs||"0",10),o.audio.receiving.currentDelayMs=parseInt(t.googCurrentDelayMs||"0",10);var d=parseInt(t.bytesReceived||"0",10);o.audio.receiving.totalBytes=d,o.audio.receiving.bytes=i._parseConnectionStats(s,t,"bytesReceived");var c=parseInt(t.packetsReceived||"0",10);o.audio.receiving.totalPackets=c,o.audio.receiving.packets=i._parseConnectionStats(s,t,"packetsReceived");var l=parseInt(t.packetsLost||"0",10);o.audio.receiving.totalPacketsLost=l,o.audio.receiving.packetsLost=i._parseConnectionStats(s,t,"packetsLost")}else{o.audio.sending.rtt=parseInt(t.googRtt||"0",10),o.audio.sending.audioInputLevel=parseInt(t.audioInputLevel||"0",10),o.audio.sending.echoReturnLoss=parseInt(t.googEchoCancellationReturnLoss||"0",10),o.audio.sending.echoReturnLossEnhancement=parseInt(t.googEchoCancellationReturnLossEnhancement||"0",10);var p=parseInt(t.bytesSent||"0",10);o.audio.sending.totalBytes=p,o.audio.sending.bytes=i._parseConnectionStats(s,t,"bytesSent");var u=parseInt(t.packetsSent||"0",10);o.audio.sending.totalPackets=u,o.audio.sending.packets=i._parseConnectionStats(s,t,"packetsSent")}else if(0===n.indexOf("inbound_rtp_audio"))o.audio.receiving.jitter=t.jitter||0,o.audio.receiving.totalBytes=t.bytesReceived,o.audio.receiving.bytes=i._parseConnectionStats(s,t,"bytesReceived"),o.audio.receiving.totalPackets=t.packetsReceived,o.audio.receiving.packets=i._parseConnectionStats(s,t,"packetsReceived"),o.audio.receiving.totalPacketsLost=t.packetsLost,o.audio.receiving.packetsLost=i._parseConnectionStats(s,t,"packetsLost"),o.audio.receiving.totalNacks=t.nackCount,o.audio.receiving.nacks=i._parseConnectionStats(s,t,"nackCount");else if(0===n.indexOf("outbound_rtp_audio")){o.audio.sending.totalBytes=t.bytesSent,o.audio.sending.bytes=i._parseConnectionStats(s,t,"bytesSent"),o.audio.sending.totalPackets=t.packetsSent,o.audio.sending.packets=i._parseConnectionStats(s,t,"packetsSent"),o.audio.sending.totalNacks=t.nackCount,o.audio.sending.nacks=i._parseConnectionStats(s,t,"nackCount");var f=o.raw[n.replace(/_rtp_/g,"_rtcp_")]||{};o.audio.sending.rtt=f.roundTripTime||0}}else{o.audio.sending.targetBitrate=t.targetBitrate,o.audio.sending.rtt=t.roundTripTime,o.audio.sending.totalBytes=t.bytesSent,o.audio.sending.bytes=i._parseConnectionStats(s,t,"bytesSent"),o.audio.sending.totalPackets=t.packetsSent,o.audio.sending.packets=i._parseConnectionStats(s,t,"packetsSent"),o.audio.sending.totalNacks=t.nackCount,o.audio.sending.nacks=i._parseConnectionStats(s,t,"nackCount");var g=o.raw[t.mediaTrackId||""]||{};o.audio.sending.audioInputLevel=g.audioLevel,o.audio.sending.echoReturnLoss=g.echoReturnLoss,o.audio.sending.echoReturnLossEnhancement=g.echoReturnLossEnhancement}},g=function(t,n){var a=r?i._peerBandwidth[e][n]:i._peerStats[e][n];if(0===n.indexOf("RTCInboundRTPVideoStream"))o.video.receiving.fractionLost=t.fractionLost,o.video.receiving.jitter=t.jitter,o.video.receiving.framesDecoded=t.framesDecoded,o.video.receiving.qpSum=t.qpSum,o.video.receiving.totalBytes=t.bytesReceived,o.video.receiving.bytes=i._parseConnectionStats(a,t,"bytesReceived"),o.video.receiving.totalPackets=t.packetsReceived,o.video.receiving.packets=i._parseConnectionStats(a,t,"packetsReceived"),o.video.receiving.totalPacketsDiscarded=t.packetsDiscarded,o.video.receiving.packetsDiscarded=i._parseConnectionStats(a,t,"packetsDiscarded"),o.video.receiving.totalPacketsLost=t.packetsLost,o.video.receiving.packetsLost=i._parseConnectionStats(a,t,"packetsLost"),o.video.receiving.totalNacks=t.nackCount,o.video.receiving.nacks=i._parseConnectionStats(a,t,"nackCount"),o.video.receiving.totalFirs=t.firCount,o.video.receiving.firs=i._parseConnectionStats(a,t,"firCount"),o.video.receiving.totalSlis=t.sliCount,o.video.receiving.slis=i._parseConnectionStats(a,t,"sliCount");else if(0===n.indexOf("RTCMediaStreamTrack_remote_video_"))o.video.receiving.frameHeight=t.frameHeight,o.video.receiving.frameWidth=t.frameWidth,o.video.receiving.framesCorrupted=t.framesCorrupted,o.video.receiving.framesPerSecond=t.framesPerSecond,o.video.receiving.framesDropped=t.framesDropped,o.video.receiving.totalFrames=t.framesReceived,o.video.receiving.frames=i._parseConnectionStats(a,t,"framesReceived");else if(0===n.indexOf("RTCOutboundRTPVideoStream"))o.video.sending.qpSum=t.qpSum,o.video.sending.targetBitrate=t.targetBitrate||0,o.video.sending.framesEncoded=t.framesEncoded||0,o.video.sending.totalBytes=t.bytesSent,o.video.sending.bytes=i._parseConnectionStats(a,t,"bytesSent"),o.video.sending.totalPackets=t.packetsSent,o.video.sending.packets=i._parseConnectionStats(a,t,"packetsSent"),o.video.sending.totalNacks=t.nackCount,o.video.sending.nacks=i._parseConnectionStats(a,t,"nackCount"),o.video.receiving.totalFirs=t.firCount,o.video.receiving.firs=i._parseConnectionStats(a,t,"firCount"),o.video.sending.totalSlis=t.sliCount,o.video.sending.slis=i._parseConnectionStats(a,t,"sliCount");else if("edge"===AdapterJS.webrtcDetectedBrowser&&"inboundrtp"===t.type&&"video"===t.mediaType&&t.isRemote){o.video.receiving.fractionLost=t.fractionLost,o.video.receiving.jitter=t.jitter,o.video.receiving.totalBytes=t.bytesReceived,o.video.receiving.bytes=i._parseConnectionStats(a,t,"bytesReceived"),o.video.receiving.totalPackets=t.packetsReceived,o.video.receiving.packets=i._parseConnectionStats(a,t,"packetsReceived"),o.video.receiving.totalPacketsLost=t.packetsLost,o.video.receiving.packetsLost=i._parseConnectionStats(a,t,"packetsLost"),o.video.receiving.totalNacks=t.nackCount,o.video.receiving.nacks=i._parseConnectionStats(a,t,"nackCount"),o.video.receiving.totalPlis=t.pliCount,o.video.receiving.plis=i._parseConnectionStats(a,t,"pliCount"),o.video.receiving.totalFirs=t.firCount,o.video.receiving.firs=i._parseConnectionStats(a,t,"firCount"),o.video.receiving.totalSlis=t.sliCount,o.video.receiving.slis=i._parseConnectionStats(a,t,"sliCount");v=o.raw[t.mediaTrackId||""]||{};o.video.receiving.framesCorrupted=v.framesCorrupted,o.video.receiving.framesDropped=v.framesDropped,o.video.receiving.framesDecoded=v.framesDecoded,o.video.receiving.totalFrames=v.framesReceived,o.video.receiving.frames=i._parseConnectionStats(a,v,"framesReceived")}else if("edge"!==AdapterJS.webrtcDetectedBrowser||"outboundrtp"!==t.type||"video"!==t.mediaType||t.isRemote){if(0===n.indexOf("ssrc_")&&"video"===t.mediaType)if(n.indexOf("_recv")>0){o.video.receiving.jitter=parseInt(t.googJitterReceived||"0",10),o.video.receiving.jitterBufferMs=parseInt(t.googJitterBufferMs||"0",10),o.video.receiving.currentDelayMs=parseInt(t.googCurrentDelayMs||"0",10),o.video.receiving.renderDelayMs=parseInt(t.googRenderDelayMs||"0",10),o.video.receiving.frameWidth=parseInt(t.googFrameWidthReceived||"0",10),o.video.receiving.frameHeight=parseInt(t.googFrameHeightReceived||"0",10),o.video.receiving.framesDecoded=parseInt(t.framesDecoded||"0",10),o.video.receiving.frameRateOutput=parseInt(t.googFrameRateOutput||"0",10),o.video.receiving.frameRateDecoded=parseInt(t.googFrameRateDecoded||"0",10),o.video.receiving.frameRateReceived=parseInt(t.googFrameRateReceived||"0",10),o.video.receiving.qpSum=parseInt(t.qpSum||"0",10);var s=parseInt(t.bytesReceived||"0",10);o.video.receiving.totalBytes=s,o.video.receiving.bytes=i._parseConnectionStats(a,t,"bytesReceived");var d=parseInt(t.packetsReceived||"0",10);o.video.receiving.totalPackets=d,o.video.receiving.packets=i._parseConnectionStats(a,t,"packetsReceived");var c=parseInt(t.packetsLost||"0",10);o.video.receiving.totalPacketsLost=c,o.video.receiving.packetsLost=i._parseConnectionStats(a,t,"packetsLost");var l=parseInt(t.googNacksSent||"0",10);o.video.receiving.totalNacks=l,o.video.receiving.nacks=i._parseConnectionStats(a,t,"googNacksSent");var p=parseInt(t.googPlisSent||"0",10);o.video.receiving.totalPlis=p,o.video.receiving.plis=i._parseConnectionStats(a,t,"googPlisSent");var u=parseInt(t.googFirsSent||"0",10);o.video.receiving.totalFirs=u,o.video.receiving.firs=i._parseConnectionStats(a,t,"googFirsSent")}else{o.video.sending.rtt=parseInt(t.googRtt||"0",10),o.video.sending.frameWidth=parseInt(t.googFrameWidthSent||"0",10),o.video.sending.frameHeight=parseInt(t.googFrameHeightSent||"0",10),o.video.sending.framesEncoded=parseInt(t.framesEncoded||"0",10),o.video.sending.frameRateInput=parseInt(t.googFrameRateInput||"0",10),o.video.sending.frameRateEncoded=parseInt(t.googFrameRateEncoded||"0",10),o.video.sending.frameRateSent=parseInt(t.googFrameRateSent||"0",10),o.video.sending.cpuLimitedResolution="true"===t.googCpuLimitedResolution,o.video.sending.bandwidthLimitedResolution="true"===t.googBandwidthLimitedResolution;var f=parseInt(t.bytesSent||"0",10);o.video.sending.totalBytes=f,o.video.sending.bytes=i._parseConnectionStats(a,t,"bytesSent");var g=parseInt(t.packetsSent||"0",10);o.video.sending.totalPackets=g,o.video.sending.packets=i._parseConnectionStats(a,t,"packetsSent");var h=parseInt(t.googNacksReceived||"0",10);o.video.sending.totalNacks=h,o.video.sending.nacks=i._parseConnectionStats(a,t,"googNacksReceived");var m=parseInt(t.googPlisReceived||"0",10);o.video.sending.totalPlis=m,o.video.sending.plis=i._parseConnectionStats(a,t,"googPlisReceived");var _=parseInt(t.googFirsReceived||"0",10);o.video.sending.totalFirs=_,o.video.sending.firs=i._parseConnectionStats(a,t,"googFirsReceived")}else if(0===n.indexOf("inbound_rtp_video"))o.video.receiving.jitter=t.jitter||0,o.video.receiving.framesDecoded=t.framesDecoded||0,o.video.receiving.frameRateMean=t.framerateMean||0,o.video.receiving.frameRateStdDev=t.framerateStdDev||0,o.video.receiving.totalBytes=t.bytesReceived,o.video.receiving.bytes=i._parseConnectionStats(a,t,"bytesReceived"),o.video.receiving.totalPackets=t.packetsReceived,o.video.receiving.packets=i._parseConnectionStats(a,t,"packetsReceived"),o.video.receiving.totalPacketsLost=t.packetsLost,o.video.receiving.packetsLost=i._parseConnectionStats(a,t,"packetsLost"),o.video.receiving.totalNacks=t.nackCount,o.video.receiving.nacks=i._parseConnectionStats(a,t,"nackCount"),o.video.receiving.totalPlis=t.pliCount,o.video.receiving.plis=i._parseConnectionStats(a,t,"pliCount"),o.video.receiving.totalFirs=t.firCount,o.video.receiving.firs=i._parseConnectionStats(a,t,"firCount");else if(0===n.indexOf("outbound_rtp_video")){o.video.sending.framesEncoded=t.framesEncoded||0,o.video.sending.frameRateMean=t.framerateMean||0,o.video.sending.frameRateStdDev=t.framerateStdDev||0,o.video.sending.framesDropped=t.droppedFrames||0,o.video.sending.totalBytes=t.bytesSent,o.video.sending.bytes=i._parseConnectionStats(a,t,"bytesSent"),o.video.sending.totalPackets=t.packetsSent,o.video.sending.packets=i._parseConnectionStats(a,t,"packetsSent"),o.video.sending.totalNacks=t.nackCount,o.video.sending.nacks=i._parseConnectionStats(a,t,"nackCount"),o.video.sending.totalPlis=t.pliCount,o.video.sending.plis=i._parseConnectionStats(a,t,"pliCount"),o.video.sending.totalFirs=t.firCount,o.video.sending.firs=i._parseConnectionStats(a,t,"firCount");var S=o.raw[n.replace(/_rtp_/g,"_rtcp_")]||{};o.video.sending.rtt=S.roundTripTime||0}}else{o.video.sending.targetBitrate=t.targetBitrate||0,o.video.sending.roundTripTime=t.roundTripTime||0,o.video.sending.totalBytes=t.bytesSent,o.video.sending.bytes=i._parseConnectionStats(a,t,"bytesSent"),o.video.sending.totalPackets=t.packetsSent,o.video.sending.packets=i._parseConnectionStats(a,t,"packetsSent"),o.video.sending.totalNacks=t.nackCount,o.video.sending.nacks=i._parseConnectionStats(a,t,"nackCount"),o.video.sending.totalFirs=t.firCount,o.video.sending.firs=i._parseConnectionStats(a,t,"firCount"),o.video.sending.totalPlis=t.pliCount,o.video.sending.plis=i._parseConnectionStats(a,t,"pliCount"),o.video.sending.totalSlis=t.sliCount,o.video.sending.slis=i._parseConnectionStats(a,t,"sliCount");var v=o.raw[t.mediaTrackId||""]||{};o.video.sending.frameHeight=v.frameHeight,o.video.sending.frameWidth=v.frameWidth,o.video.sending.framesPerSecond=v.framesPerSecond,o.video.sending.totalFrames=v.framesSent,o.video.sending.frames=i._parseConnectionStats(a,v,"framesSent")}},h=function(t,r){if(0===r.indexOf("ssrc_")&&"video"===t.mediaType){var i=parseInt(t.googCaptureStartNtpTimeMs||"0",10),s=a.getRemoteStreams()[0];if(!(i>0&&r.indexOf("_recv")>0&&s&&document&&"function"==typeof document.getElementsByTagName))return;try{var d=document.getElementsByTagName("plugin"===AdapterJS.webrtcDetectedType?"object":"video");"plugin"!==AdapterJS.webrtcDetectedType&&0===d.length&&(d=document.getElementsByTagName("audio"));for(var c=0;c<d.length;c++){var l=null;if("plugin"===AdapterJS.webrtcDetectedType){if(!(d[c].children&&"object"==typeof d[c].children&&"number"==typeof d[c].children.length&&d[c].children.length>0))break;for(var p=0;p<d[c].children.length;p++)if("streamId"===d[c].children[p].name){l=d[c].children[p].value||null;break}}else l=d[c].srcObject&&(d[c].srcObject.id||d[c].srcObject.label)||null;if(l&&l===(s.id||s.label)){o.video.receiving.e2eDelay=(new Date).getTime()+22089888e5-i-1e3*d[c].currentTime;break}}}catch(t){n||u.warn([e,"RTCStatsReport",null,"Failed retrieving e2e delay ->"],t)}}},m=function(n){"function"==typeof n.forEach?n.forEach(function(e,t){o.raw[t]=e}):o.raw=n;var s={remote:{},local:{}};"edge"===AdapterJS.webrtcDetectedBrowser&&(a.remoteStream&&a.remoteStream.getTracks().forEach(function(e){s.remote[e.id]=e.kind}),a.localStream&&a.localStream.getTracks().forEach(function(e){s.local[e.id]=e.kind})),Object.keys(o.raw).forEach(function(t){if(0!==t.indexOf("ssrc_")||o.raw[t].mediaType){if("edge"===AdapterJS.webrtcDetectedBrowser&&!o.raw[t].mediaType&&["inboundrtp","outboundrtp"].indexOf(o.raw[t].type)>-1){var n=o.raw[o.raw[t].mediaTrackId]||{};o.raw[t].mediaType=s[o.raw[t].isRemote?"remote":"local"][n.trackIdentifier]||""}}else o.raw[t].mediaType=o.raw[t].audioInputLevel||o.raw[t].audioOutputLevel?"audio":"video";c(o.raw[t],t),l(o.raw[t],t),p(o.raw[t],t),f(o.raw[t],t),g(o.raw[t],t),h(o.raw[t],t),r&&!i._peerBandwidth[e][t]?i._peerBandwidth[e][t]=o.raw[t]:r||i._peerStats[e][t]||(i._peerStats[e][t]=o.raw[t])}),o.audio.sending.bytes=o.audio.sending.bytes||0,o.audio.sending.packets=o.audio.sending.packets||0,o.audio.sending.totalBytes=o.audio.sending.totalBytes||0,o.audio.sending.totalPackets=o.audio.sending.totalPackets||0,o.video.sending.bytes=o.video.sending.bytes||0,o.video.sending.packets=o.video.sending.packets||0,o.video.sending.totalBytes=o.video.sending.totalBytes||0,o.video.sending.totalPackets=o.video.sending.totalPackets||0,o.audio.receiving.bytes=o.audio.receiving.bytes||0,o.audio.receiving.packets=o.audio.receiving.packets||0,o.audio.receiving.totalBytes=o.audio.receiving.totalBytes||0,o.audio.receiving.totalPackets=o.audio.receiving.totalPackets||0,o.video.receiving.bytes=o.video.receiving.bytes||0,o.video.receiving.packets=o.video.receiving.packets||0,o.video.receiving.totalBytes=o.video.receiving.totalBytes||0,o.video.receiving.totalPackets=o.video.receiving.totalPackets||0,t(null,o)},_=function(r){n||u.error([e,"RTCStatsReport",null,"Failed retrieving stats ->"],r),t(r,null)};if("function"!=typeof a.getStats)return _(new Error("getStats() API is not available."));"plugin"===AdapterJS.webrtcDetectedType?a.getStats(null,m,_):a.getStats(null).then(m).catch(_)},t.prototype._addPeer=function(e,t,n,r,i){var a=this;a._peerConnections[e]?u.error([e,null,null,"Connection to peer has already been made"]):(a._peerConnStatus[e]={connected:!1,init:!1},u.log([e,null,null,"Starting the connection to peer. Options provided:"],{peerBrowser:n,receiveOnly:r,enableDataChannel:a._enableDataChannel}),u.info("Adding peer",i),a._peerConnections[e]=a._createPeerConnection(e,!!i,t),a._peerConnections[e]?(a._peerConnStatus[e].init=!0,a._peerConnections[e].hasScreen=!!i):u.error([e,null,null,"Failed creating the connection to peer."]))},t.prototype._restartPeerConnection=function(e,t,n,r){var i=this;if(i._peerConnections[e]){var a=i._peerConnections[e],o=(i.getPeerInfo(e)||{}).agent||{};if(i._isLowerThanVersion(o.SMProtocolVersion||"","0.1.2")){var s=new Error("Failed restarting with other agents connecting from other SDKs as re-negotiation is not supported by other SDKs");return u.warn([e,"RTCPeerConnection",null,"Ignoring restart request as agent's SDK does not support it"],s),void("function"==typeof r&&(u.debug([e,"RTCPeerConnection",null,"Firing restart failure callback"]),r(s)))}if(a.signalingState===i.PEER_CONNECTION_STATE.STABLE&&i._peerConnections[e]){u.log([e,null,null,"Sending restart message to signaling server ->"],{iceRestart:t,options:n}),i._peerCustomConfigs[e]=i._peerCustomConfigs[e]||{},i._peerCustomConfigs[e].bandwidth=i._peerCustomConfigs[e].bandwidth||{},i._peerCustomConfigs[e].googleXBandwidth=i._peerCustomConfigs[e].googleXBandwidth||{},n.bandwidth&&"object"==typeof n.bandwidth&&("number"==typeof n.bandwidth.audio&&(i._peerCustomConfigs[e].bandwidth.audio=n.bandwidth.audio),"number"==typeof n.bandwidth.video&&(i._peerCustomConfigs[e].bandwidth.video=n.bandwidth.video),"number"==typeof n.bandwidth.data&&(i._peerCustomConfigs[e].bandwidth.data=n.bandwidth.data)),n.googleXBandwidth&&"object"==typeof n.googleXBandwidth&&("number"==typeof n.googleXBandwidth.min&&(i._peerCustomConfigs[e].googleXBandwidth.min=n.googleXBandwidth.min),"number"==typeof n.googleXBandwidth.max&&(i._peerCustomConfigs[e].googleXBandwidth.max=n.googleXBandwidth.max));var d={type:i._SIG_MESSAGE_TYPE.RESTART,mid:i._user.sid,rid:i._room.id,agent:AdapterJS.webrtcDetectedBrowser,version:(AdapterJS.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:i._getUserInfo(e),target:e,weight:i._peerPriorityWeight,receiveOnly:i.getPeerInfo().config.receiveOnly,enableIceTrickle:i._enableIceTrickle,enableDataChannel:i._enableDataChannel,enableIceRestart:i._enableIceRestart,doIceRestart:!0===t&&i._enableIceRestart&&i._peerInformations[e]&&i._peerInformations[e].config.enableIceRestart,isRestartResend:!1,temasysPluginVersion:AdapterJS.WebRTCPlugin.plugin?AdapterJS.WebRTCPlugin.plugin.VERSION:null,SMProtocolVersion:i.SM_PROTOCOL_VERSION,DTProtocolVersion:i.DT_PROTOCOL_VERSION};i._publishOnly&&(d.publishOnly={type:i._streams.screenshare&&i._streams.screenshare.stream?"screenshare":"video"}),i._parentId&&(d.parentId=i._parentId),i._peerEndOfCandidatesCounter[e]=i._peerEndOfCandidatesCounter[e]||{},i._peerEndOfCandidatesCounter[e].len=0,i._sendChannelMessage(d),i._trigger("peerRestart",e,i.getPeerInfo(e),!0,!0===t),"function"==typeof r&&(u.debug([e,"RTCPeerConnection",null,"Firing restart callback"]),r(null))}else if(a.signalingState===i.PEER_CONNECTION_STATE.HAVE_LOCAL_OFFER)if(a.localDescription&&a.localDescription.sdp)i._sendChannelMessage({type:a.localDescription.type,sdp:a.localDescription.sdp,mid:i._user.sid,target:e,rid:i._room.id,restart:!0});else{var c="Failed re-sending localDescription as there is no localDescription set to connection. There could be a handshaking step error";u.error([e,"RTCPeerConnection",null,c],{localDescription:a.localDescription,remoteDescription:a.remoteDescription}),"function"==typeof r&&(u.debug([e,"RTCPeerConnection",null,"Firing restart failure callback"]),r(new Error(c)))}else{var l="Failed restarting as peer connection state is "+a.signalingState;u.warn([e,"RTCPeerConnection",null,l]),"function"==typeof r&&(u.debug([e,"RTCPeerConnection",null,"Firing restart failure callback"]),r(new Error(l)))}}else u.error([e,null,null,"Peer does not have an existing connection. Unable to restart"])},t.prototype._removePeer=function(e){if(this._peerConnections[e]||this._peerInformations[e]){var t=n(this.getPeerInfo(e))||{userData:"",settings:{audio:!1,video:!1,data:!1},mediaStatus:{audioMuted:!0,videoMuted:!0},agent:{name:"unknown",version:0,os:"",pluginVersion:null},config:{enableDataChannel:!0,enableIceRestart:!1,enableIceTrickle:!0,priorityWeight:0,publishOnly:!1,receiveOnly:!0},parentId:null,room:n(this._selectedRoom)};"MCU"!==e?this._trigger("peerLeft",e,t,!1):(this._hasMCU=!1,u.log([e,null,null,"MCU has stopped listening and left"]),this._trigger("serverPeerLeft",e,this.SERVER_PEER_TYPE.MCU)),this._peerConnections[e]&&(this._peerConnections[e].signalingState!==this.PEER_CONNECTION_STATE.CLOSED&&(this._peerConnections[e].close(),"AppleWebKit"===AdapterJS.webrtcDetectedType&&(this._peerConnections[e].signalingStateClosed||(this._peerConnections[e].signalingStateClosed=!0,this._trigger("peerConnectionState",this.PEER_CONNECTION_STATE.CLOSED,e)),this._peerConnections[e].iceConnectionStateClosed||(this._peerConnections[e].iceConnectionStateClosed=!0,this._trigger("iceConnectionState",this.ICE_CONNECTION_STATE.CLOSED,e)))),"MCU"!==e&&this._handleEndedStreams(e),delete this._peerConnections[e]),this._peerInformations[e]&&delete this._peerInformations[e],this._peerMessagesStamps[e]&&delete this._peerMessagesStamps[e],this._streamsSession[e]&&delete this._streamsSession[e],this._peerEndOfCandidatesCounter[e]&&delete this._peerEndOfCandidatesCounter[e],this._peerCandidatesQueue[e]&&delete this._peerCandidatesQueue[e],this._sdpSessions[e]&&delete this._sdpSessions[e],this._peerStats[e]&&delete this._peerStats[e],this._peerBandwidth[e]&&delete this._peerBandwidth[e],this._gatheredCandidates[e]&&delete this._gatheredCandidates[e],this._peerCustomConfigs[e]&&delete this._peerCustomConfigs[e],this._peerConnStatus[e]&&delete this._peerConnStatus[e],this._dataChannels[e]&&this._closeDataChannel(e),u.log([e,"RTCPeerConnection",null,"Successfully removed peer"])}else u.debug([e,"RTCPeerConnection",null,"Dropping the hangup from Peer as not connected to Peer at all."])},t.prototype._createPeerConnection=function(e,t,r){var i,a=this;if(a._inRoom&&a._room&&a._room.connection&&a._room.connection.peerConfig&&Array.isArray(a._room.connection.peerConfig.iceServers)){var o={iceServers:a._room.connection.peerConfig.iceServers,iceTransportPolicy:a._filterCandidatesType.host&&a._filterCandidatesType.srflx&&!a._filterCandidatesType.relay?"relay":"all",bundlePolicy:a._peerConnectionConfig.bundlePolicy===a.BUNDLE_POLICY.NONE?a.BUNDLE_POLICY.BALANCED:a._peerConnectionConfig.bundlePolicy,rtcpMuxPolicy:a._peerConnectionConfig.rtcpMuxPolicy,iceCandidatePoolSize:a._peerConnectionConfig.iceCandidatePoolSize},s={optional:[{DtlsSrtpKeyAgreement:!0},{googIPv6:!0}]};r&&(o.certificates=[r]),a._peerConnStatus[e]&&(a._peerConnStatus[e].constraints=o,a._peerConnStatus[e].optional=s);try{u.debug([e,"RTCPeerConnection",null,"Creating peer connection ->"],{constraints:o,optional:s}),i=new(a._useEdgeWebRTC&&window.msRTCPeerConnection?window.msRTCPeerConnection:RTCPeerConnection)(o,s)}catch(t){return u.error([e,null,null,"Failed creating peer connection:"],t),a._trigger("handshakeProgress",a.HANDSHAKE_PROGRESS.ERROR,e,t),null}i.setOffer="",i.setAnswer="",i.hasStream=!1,i.hasScreen=!!t,i.hasMainChannel=!1,i.firefoxStreamId="",i.processingLocalSDP=!1,i.processingRemoteSDP=!1,i.gathered=!1,i.gathering=!1,i.localStream=null,i.localStreamId=null,i.remoteStream=null,i.remoteStreamId=null,i.iceConnectionStateClosed=!1,i.signalingStateClosed=!1,a._gatheredCandidates[e]={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}},a._streamsSession[e]=a._streamsSession[e]||{},a._peerEndOfCandidatesCounter[e]=a._peerEndOfCandidatesCounter[e]||{},a._sdpSessions[e]={local:{},remote:{}},a._peerBandwidth[e]={};var d=null;return i.ondatachannel=function(t){var n=t.channel||t;if(u.debug([e,"RTCDataChannel",n.label,"Received datachannel ->"],n),a._enableDataChannel&&a._peerInformations[e]&&a._peerInformations[e].config.enableDataChannel){a.DATA_CHANNEL_TYPE.DATA,n.label;i.hasMainChannel||(a.DATA_CHANNEL_TYPE.MESSAGING,"main",i.hasMainChannel=!0),a._createDataChannel(e,n)}else u.warn([e,"RTCDataChannel",n.label,"Not adding datachannel as enable datachannel is set to false"])},i.onaddstream=function(t){if(a._peerConnections[e]){var r=t.stream||t;if("MCU"!==e)if(a._sdpSettings.direction.audio.receive||a._sdpSettings.direction.video.receive){i.remoteStream=r,i.remoteStreamId=i.remoteStreamId||r.id||r.label;var o=n(a.getPeerInfo(e).settings);a._streamsSession[e][i.remoteStreamId]=o,0===r.getAudioTracks().length&&(a._streamsSession[e][i.remoteStreamId].audio=!1),0===r.getVideoTracks().length&&(a._streamsSession[e][i.remoteStreamId].video=!1),i.hasStream=!0,i.hasScreen=o.video&&"object"==typeof o.video&&o.video.screenshare,a._onRemoteStreamAdded(e,r,!!i.hasScreen)}else u.warn([e,"MediaStream",i.remoteStreamId,"Ignoring received empty remote stream ->"],r);else u.warn([e,"MediaStream",i.remoteStreamId,"Ignoring received remote stream from MCU ->"],r)}},i.onicecandidate=function(t){a._onIceCandidate(e,t.candidate||t)},i.oniceconnectionstatechange=function(t){var n=i.iceConnectionState;if(u.debug([e,"RTCIceConnectionState",null,"Ice connection state changed ->"],n),"edge"===AdapterJS.webrtcDetectedBrowser&&("connecting"===n?n=a.ICE_CONNECTION_STATE.CHECKING:"new"===n&&(n=a.ICE_CONNECTION_STATE.FAILED)),"AppleWebKit"!==AdapterJS.webrtcDetectedType||n!==a.ICE_CONNECTION_STATE.CLOSED){if(a._trigger("iceConnectionState",n,e),n===a.ICE_CONNECTION_STATE.FAILED&&a._enableIceTrickle&&a._trigger("iceConnectionState",a.ICE_CONNECTION_STATE.TRICKLE_FAILED,e),a._peerConnStatus[e]&&(a._peerConnStatus[e].connected=[a.ICE_CONNECTION_STATE.COMPLETED,a.ICE_CONNECTION_STATE.CONNECTED].indexOf(n)>-1),!a._hasMCU&&[a.ICE_CONNECTION_STATE.CONNECTED,a.ICE_CONNECTION_STATE.COMPLETED].indexOf(n)>-1&&a._bandwidthAdjuster&&!d&&"edge"!==AdapterJS.webrtcDetectedBrowser&&"edge"!==(((a._peerInformations[e]||{}).agent||{}).name||"edge")){var r=0,o=function(e){for(var t=0,n=0;n<e.length;n++)t+=e[n];return t/e.length};d={audio:{send:[],recv:[]},video:{send:[],recv:[]}};var s=setInterval(function(){a._peerConnections[e]&&a._peerConnections[e].signalingState!==a.PEER_CONNECTION_STATE.CLOSED&&a._bandwidthAdjuster&&a._peerBandwidth[e]?a._retrieveStats(e,function(t,n){if(a._peerConnections[e]&&a._peerConnections[e].signalingState!==a.PEER_CONNECTION_STATE.CLOSED&&a._bandwidthAdjuster){if(t?(d.audio.send.push(0),d.audio.recv.push(0),d.video.send.push(0),d.video.recv.push(0)):(d.audio.send.push(8*n.audio.sending.bytes),d.audio.recv.push(8*n.audio.receiving.bytes),d.video.send.push(8*n.video.sending.bytes),d.video.recv.push(8*n.video.receiving.bytes)),++r===a._bandwidthAdjuster.interval){r=0;var i=o(d.audio.send),c=o(d.video.send);a._bandwidthAdjuster.useUploadBwOnly||(i+=o(d.audio.recv),c+=o(d.video.recv),i/=2,c/=2),i=parseInt(i*(a._bandwidthAdjuster.limitAtPercentage/100)/1e3,10),c=parseInt(c*(a._bandwidthAdjuster.limitAtPercentage/100)/1e3,10),d={audio:{send:[],recv:[]},video:{send:[],recv:[]}},a.refreshConnection(e,{bandwidth:{audio:i,video:c}})}}else clearInterval(s)},!0,!0):clearInterval(s)},1e3)}}else setTimeout(function(){i.iceConnectionStateClosed||a._trigger("iceConnectionState",a.ICE_CONNECTION_STATE.CLOSED,e)},10)},i.onsignalingstatechange=function(){u.debug([e,"RTCSignalingState",null,"Peer connection state changed ->"],i.signalingState),"AppleWebKit"!==AdapterJS.webrtcDetectedType||i.signalingState!==a.PEER_CONNECTION_STATE.CLOSED?a._trigger("peerConnectionState",i.signalingState,e):setTimeout(function(){i.signalingStateClosed||a._trigger("peerConnectionState",a.PEER_CONNECTION_STATE.CLOSED,e)},10)},i.onicegatheringstatechange=function(){u.log([e,"RTCIceGatheringState",null,"Ice gathering state changed ->"],i.iceGatheringState),a._trigger("candidateGenerationState",i.iceGatheringState,e)},"firefox"===AdapterJS.webrtcDetectedBrowser&&(i.removeStream=function(e){for(var t=i.getSenders(),n=0;n<t.length;n++)for(var r=e.getTracks(),a=0;a<r.length;a++)r[a]===t[n].track&&i.removeTrack(t[n])}),i}},t.prototype._restartMCUConnection=function(e,t,r){var i=this,a=Object.keys(i._peerConnections),o={},s=function(e){var n={type:i._SIG_MESSAGE_TYPE.RESTART,mid:i._user.sid,rid:i._room.id,agent:AdapterJS.webrtcDetectedBrowser,version:(AdapterJS.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:i._getUserInfo(e),target:e,weight:i._peerPriorityWeight,receiveOnly:i.getPeerInfo().config.receiveOnly,enableIceTrickle:i._enableIceTrickle,enableDataChannel:i._enableDataChannel,enableIceRestart:i._enableIceRestart,doIceRestart:i._mcuUseRenegoRestart&&!0===t&&i._enableIceRestart&&i._peerInformations[e]&&i._peerInformations[e].config.enableIceRestart,isRestartResend:!1,temasysPluginVersion:AdapterJS.WebRTCPlugin.plugin?AdapterJS.WebRTCPlugin.plugin.VERSION:null,SMProtocolVersion:i.SM_PROTOCOL_VERSION,DTProtocolVersion:i.DT_PROTOCOL_VERSION};i._publishOnly&&(n.publishOnly={type:i._streams.screenshare&&i._streams.screenshare.stream?"screenshare":"video"}),i._parentId&&(n.parentId=i._parentId),u.log([e,"RTCPeerConnection",null,"Sending restart message to signaling server ->"],n),i._sendChannelMessage(n)};r.bandwidth&&"object"==typeof r.bandwidth&&("number"==typeof r.bandwidth.audio&&(i._streamsBandwidthSettings.bAS.audio=r.bandwidth.audio),"number"==typeof r.bandwidth.video&&(i._streamsBandwidthSettings.bAS.video=r.bandwidth.video),"number"==typeof r.bandwidth.data&&(i._streamsBandwidthSettings.bAS.data=r.bandwidth.data)),r.googleXBandwidth&&"object"==typeof r.googleXBandwidth&&("number"==typeof r.googleXBandwidth.min&&(i._streamsBandwidthSettings.googleX.min=r.googleXBandwidth.min),"number"==typeof r.googleXBandwidth.max&&(i._streamsBandwidthSettings.googleX.max=r.googleXBandwidth.max));for(var d=0;d<a.length;d++)if(i._peerConnections[a[d]])"MCU"!==a[d]&&(i._trigger("peerRestart",a[d],i.getPeerInfo(a[d]),!0,!1),i._mcuUseRenegoRestart||s(a[d]));else{var c="Peer connection with peer does not exists. Unable to restart";u.error([a[d],"PeerConnection",null,c]),o[a[d]]=new Error(c)}if(i._trigger("serverPeerRestart","MCU",i.SERVER_PEER_TYPE.MCU),i._mcuUseRenegoRestart)i._peerEndOfCandidatesCounter.MCU=i._peerEndOfCandidatesCounter.MCU||{},i._peerEndOfCandidatesCounter.MCU.len=0,s("MCU");else{i.once("peerJoined",function(t,n,r){u.log([null,"PeerConnection",null,"Invoked all peers to restart with MCU. Firing callback"]),"function"==typeof e&&(Object.keys(o).length>0?e({refreshErrors:o,listOfPeers:a},null):e(null,{listOfPeers:a}))},function(e,t,n){return n}),i.leaveRoom(!1,function(t,s){if(t){if("function"==typeof e){for(var d=0;d<a.length;d++)o[a[d]]=t;e({refreshErrors:o,listOfPeers:a},null)}}else i.joinRoom(i._selectedRoom,{bandwidth:r.bandwidth||{},googleXBandwidth:r.googleXBandwidth||{},sdpSettings:n(i._sdpSettings),voiceActivityDetection:i._voiceActivityDetection,publishOnly:!!i._publishOnly,parentId:i._parentId||null,autoBandwidthAdjustment:i._bandwidthAdjuster})})}},t.prototype._parseConnectionStats=function(e,t,n){var r=t.timestamp,i=e?e.timestamp||0:0,a=parseFloat(t[n]||"0",10),o=parseFloat(e?e[n]||"0":"0",10);return new Date(r).getTime()===new Date(i).getTime()?a:parseFloat(((a-o)/(r-i)*1e3).toFixed(3)||"0",10)},t.prototype._signalingEndOfCandidates=function(e){var t=this;if(t._peerEndOfCandidatesCounter[e]&&t._peerConnections[e].remoteDescription&&t._peerConnections[e].remoteDescription.sdp&&"number"==typeof t._peerEndOfCandidatesCounter[e].expectedLen&&t._peerEndOfCandidatesCounter[e].len>=t._peerEndOfCandidatesCounter[e].expectedLen&&(!t._peerCandidatesQueue[e]||0===t._peerCandidatesQueue[e].length)&&!t._peerEndOfCandidatesCounter[e].hasSet){u.debug([e,"RTCPeerConnection",null,"Signaling of end-of-candidates remote ICE gathering."]),t._peerEndOfCandidatesCounter[e].hasSet=!0;try{if("edge"===AdapterJS.webrtcDetectedBrowser){for(var n=-1,r=[],i=t._peerConnections[e].remoteDescription.sdp.split("\r\n"),a=!1,o=0;o<i.length;o++)if(0===i[o].indexOf("m="))a="0"===i[o].split(" ")[1],n++;else if(0===i[o].indexOf("a=mid:")&&!a){var s=i[o].split("a=mid:")[1]||"";if(s&&-1===r.indexOf(s)&&(r.push(s),t._addIceCandidate(e,"endofcan-"+(new Date).getTime(),new RTCIceCandidate({sdpMid:s,sdpMLineIndex:n,candidate:"candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates"})),t._peerConnectionConfig.bundlePolicy===t.BUNDLE_POLICY.MAX_BUNDLE))break}}else AdapterJS&&!t._isLowerThanVersion(AdapterJS.VERSION,"0.14.0")&&t._peerConnections[e].addIceCandidate(null);t._gatheredCandidates[e]&&t._trigger("candidatesGathered",e,{expected:t._peerEndOfCandidatesCounter[e].expectedLen||0,received:t._peerEndOfCandidatesCounter[e].len||0,processed:t._gatheredCandidates[e].receiving.srflx.length+t._gatheredCandidates[e].receiving.relay.length+t._gatheredCandidates[e].receiving.host.length})}catch(t){u.error([e,"RTCPeerConnection",null,"Failed signaling end-of-candidates ->"],t)}}},t.prototype.setUserData=function(e){var t=this,n="";void 0!==e&&null!==e&&(n=e),this._userData=n,t._inRoom?(u.log("Updated userData -> ",n),t._sendChannelMessage({type:t._SIG_MESSAGE_TYPE.UPDATE_USER,mid:t._user.sid,rid:t._room.id,userData:n,stamp:(new Date).getTime()}),t._trigger("peerUpdated",t._user.sid,t.getPeerInfo(),!0)):u.warn("User is not in the room. Broadcast of updated information will be dropped")},t.prototype.getUserData=function(e){if(e&&this._peerInformations[e]){var t=this._peerInformations[e].userData;return null!==t&&void 0===t||(t=""),t}return this._userData},t.prototype.getPeerInfo=function(e){var t=null;return"string"==typeof e&&"object"==typeof this._peerInformations[e]?((t=n(this._peerInformations[e])).room=n(this._selectedRoom),t.settings.bandwidth=t.settings.bandwidth||{},t.settings.googleXBandwidth=t.settings.googleXBandwidth||{},"boolean"==typeof t.settings.video||t.settings.video&&"object"==typeof t.settings.video||(t.settings.video=!1,t.mediaStatus.audioMuted=!0),"boolean"==typeof t.settings.audio||t.settings.audio&&"object"==typeof t.settings.audio||(t.settings.audio=!1,t.mediaStatus.audioMuted=!0),"boolean"!=typeof t.mediaStatus.audioMuted&&(t.mediaStatus.audioMuted=!0),"boolean"!=typeof t.mediaStatus.videoMuted&&(t.mediaStatus.videoMuted=!0),t.settings.maxBandwidth&&(t.settings.bandwidth=n(t.settings.maxBandwidth),delete t.settings.maxBandwidth),t.settings.video&&"object"==typeof t.settings.video&&t.settings.video.customSettings&&"object"==typeof t.settings.video.customSettings&&(t.settings.video.customSettings.frameRate&&(t.settings.video.frameRate=n(t.settings.video.customSettings.frameRate)),t.settings.video.customSettings.facingMode&&(t.settings.video.facingMode=n(t.settings.video.customSettings.facingMode)),t.settings.video.customSettings.width&&(t.settings.video.resolution=t.settings.video.resolution||{},t.settings.video.resolution.width=n(t.settings.video.customSettings.width)),t.settings.video.customSettings.height&&(t.settings.video.resolution=t.settings.video.resolution||{},t.settings.video.resolution.height=n(t.settings.video.customSettings.height)),t.settings.video.customSettings.facingMode&&(t.settings.video.facingMode=n(t.settings.video.customSettings.facingMode))),t.settings.audio&&"object"==typeof t.settings.audio&&(t.settings.audio.stereo=!0===t.settings.audio.stereo),null!==t.userData&&void 0!==t.userData||(t.userData=""),t.parentId=t.parentId||null,"MCU"===e?(t.config.receiveOnly=!0,t.config.publishOnly=!1):this._hasMCU&&(t.config.receiveOnly=!1,t.config.publishOnly=!0),this._sdpSettings.direction.audio.receive||(t.settings.audio=!1,t.mediaStatus.audioMuted=!0),this._sdpSettings.direction.video.receive||(t.settings.video=!1,t.mediaStatus.videoMuted=!0),this._sdpSettings.connection.audio||(t.settings.audio=!1,t.mediaStatus.audioMuted=!0),this._sdpSettings.connection.video||(t.settings.video=!1,t.mediaStatus.videoMuted=!0),t.settings.data=!!(this._dataChannels[e]&&this._dataChannels[e].main&&this._dataChannels[e].main.channel&&this._dataChannels[e].main.channel.readyState===this.DATA_CHANNEL_STATE.OPEN),t.connected=this._peerConnStatus[e]&&!!this._peerConnStatus[e].connected,t.init=this._peerConnStatus[e]&&!!this._peerConnStatus[e].init,this._sdpSessions[e]&&this._sdpSessions[e].remote&&this._sdpSessions[e].remote.connection&&"object"==typeof this._sdpSessions[e].remote.connection&&(this._sdpSessions[e].remote.connection.audio&&this._sdpSessions[e].remote.connection.audio.indexOf("send")>-1||(t.settings.audio=!1,t.mediaStatus.audioMuted=!0),this._sdpSessions[e].remote.connection.video&&this._sdpSessions[e].remote.connection.video.indexOf("send")>-1||(t.settings.video=!1,t.mediaStatus.videoMuted=!0),this._sdpSessions[e].remote.connection.data&&this._sdpSessions[e].remote.connection.data.indexOf("send")>-1||(t.settings.data=!1))):(null!==(t={userData:n(this._userData),settings:{audio:!1,video:!1},mediaStatus:n(this._streamsMutedSettings),agent:{name:AdapterJS.webrtcDetectedBrowser,version:AdapterJS.webrtcDetectedVersion,os:window.navigator.platform,pluginVersion:AdapterJS.WebRTCPlugin.plugin?AdapterJS.WebRTCPlugin.plugin.VERSION:null,SMProtocolVersion:this.SMProtocolVersion,DTProtocolVersion:this.DTProtocolVersion},room:n(this._selectedRoom),config:{enableDataChannel:this._enableDataChannel,enableIceTrickle:this._enableIceTrickle,enableIceRestart:this._enableIceRestart,priorityWeight:this._peerPriorityWeight,receiveOnly:!1,publishOnly:!!this._publishOnly},connected:null,init:null}).userData&&void 0!==t.userData||(t.userData=""),this._streams.screenshare?t.settings=n(this._streams.screenshare.settings):this._streams.userMedia&&(t.settings=n(this._streams.userMedia.settings)),t.settings.bandwidth=n(this._streamsBandwidthSettings.bAS),t.settings.googleXBandwidth=n(this._streamsBandwidthSettings.googleX),t.parentId=this._parentId?this._parentId:null,t.config.receiveOnly=!t.settings.video&&!t.settings.audio,t.settings.data=this._enableDataChannel&&this._sdpSettings.connection.data,t.settings.audio&&"object"==typeof t.settings.audio&&("boolean"==typeof this._codecParams.audio.opus.stereo&&(t.settings.audio.stereo=this._codecParams.audio.opus.stereo),"boolean"==typeof this._codecParams.audio.opus.usedtx&&(t.settings.audio.usedtx=this._codecParams.audio.opus.usedtx),"number"==typeof this._codecParams.audio.opus.maxplaybackrate&&(t.settings.audio.maxplaybackrate=this._codecParams.audio.opus.maxplaybackrate),"boolean"==typeof this._codecParams.audio.opus.useinbandfec&&(t.settings.audio.useinbandfec=this._codecParams.audio.opus.useinbandfec))),t.settings.audio||(t.mediaStatus.audioMuted=!0),t.settings.video||(t.mediaStatus.videoMuted=!0),t.settings.audio||t.settings.video||(t.config.receiveOnly=!0,t.config.publishOnly=!1),t},t.prototype.getPeersInRoom=function(){for(var e={},t=Object.keys(this._peerInformations),r=0;r<t.length;r++)e[t[r]]=n(this.getPeerInfo(t[r])),e[t[r]].isSelf=!1;return this._user&&this._user.sid&&(e[this._user.sid]=n(this.getPeerInfo()),e[this._user.sid].isSelf=!0),e},t.prototype.getPeersStream=function(){for(var e={},t=Object.keys(this._peerConnections),n=0;n<t.length;n++){var r=null,i=null;this._peerConnections[t[n]]&&this._peerConnections[t[n]].remoteDescription&&this._peerConnections[t[n]].remoteDescription.sdp&&(this._sdpSettings.direction.audio.receive||this._sdpSettings.direction.video.receive)&&(i=(r=this._peerConnections[t[n]].remoteStream)&&(this._peerConnections[t[n]].remoteStreamId||r.id||r.label)),e[t[n]]={streamId:i,stream:r,isSelf:!1}}if(this._user&&this._user.sid){var a=null;this._streams.screenshare&&this._streams.screenshare.stream?a=this._streams.screenshare.stream:this._streams.userMedia&&this._streams.userMedia.stream&&(a=this._streams.userMedia.stream),e[this._user.sid]={streamId:a?a.id||a.label||null:null,stream:a,isSelf:!0}}return e},t.prototype.getPeersDatachannels=function(){for(var e={},t=Object.keys(this._peerConnections),n=0;n<t.length;n++)if(e[t[n]]={},this._dataChannels[t[n]])for(var r in this._dataChannels[t[n]])if(this._dataChannels[t[n]].hasOwnProperty(r)&&this._dataChannels[t[n]][r]){var i=this._dataChannels[t[n]][r];e[t[n]][i.channelName]=this._getDataChannelBuffer(t[n],r),e[t[n]][i.channelName].channelName=i.channelName,e[t[n]][i.channelName].channelType=i.channelType,e[t[n]][i.channelName].channelProp=r,e[t[n]][i.channelName].currentTransferId=i.transferId,e[t[n]][i.channelName].currentStreamId=i.streamId,e[t[n]][i.channelName].readyState=i.channel?i.channel.readyState:self.DATA_CHANNEL_STATE.CREATE_ERROR}return e},t.prototype.getCurrentDataTransfers=function(){var e={};if(!this._user||!this._user.sid)return{};for(var t in this._dataTransfers)this._dataTransfers.hasOwnProperty(t)&&this._dataTransfers[t]&&(e[t]={transferInfo:this._getTransferInfo(t,this._user.sid,!0,!0,!0),isSelf:this._dataTransfers[t].senderPeerId===this._user.sid,peerId:this._dataTransfers[t].senderPeerId||this._user.sid});return e},t.prototype.getCurrentDataStreamsSession=function(){var e={};if(!this._user||!this._user.sid)return{};for(var t in this._dataStreams)this._dataStreams.hasOwnProperty(t)&&this._dataStreams[t]&&(e[t]={streamInfo:{chunkType:"string"===this._dataStreams[t].sessionChunkType?this.DATA_TRANSFER_DATA_TYPE.STRING:this.DATA_TRANSFER_DATA_TYPE.BLOB,isPrivate:this._dataStreams[t].isPrivate,isStringStream:"string"===this._dataStreams[t].sessionChunkType,senderPeerId:this._dataStreams[t].senderPeerId},isSelf:this._dataStreams[t].senderPeerId===this._user.sid,peerId:this._dataStreams[t].senderPeerId||this._user.sid});return e},t.prototype.getPeersCustomSettings=function(){var e=this,t={};for(var n in e._peerInformations)e._peerInformations.hasOwnProperty(n)&&e._peerInformations[n]&&(t[n]=e._getPeerCustomSettings(n));return t},t.prototype._getPeerCustomSettings=function(e){var t=this,r={settings:{audio:!1,video:!1,data:!1,bandwidth:n(t._streamsBandwidthSettings.bAS),googleXBandwidth:n(t._streamsBandwidthSettings.googleX)},mediaStatus:{audioMuted:!0,videoMuted:!0}},i=t._hasMCU?"MCU":e;if(!t._peerInformations[i])return r;if(t._peerConnections[i]&&t._peerConnections[i].signalingState!==t.PEER_CONNECTION_STATE.CLOSED){var a=t._peerConnections[e].localStream,o=t._peerConnections[e].localStreamId||a&&(a.id||a.label);if(r.settings.data=t._enableDataChannel&&t._peerInformations[e].config.enableDataChannel,a&&(t._streams.screenshare&&t._streams.screenshare.stream&&o===(t._streams.screenshare.stream.id||t._streams.screenshare.stream.label)?(r.settings.audio=n(t._streams.screenshare.settings.audio),r.settings.video=n(t._streams.screenshare.settings.video),r.mediaStatus=n(t._streamsMutedSettings)):t._streams.userMedia&&t._streams.userMedia.stream&&o===(t._streams.userMedia.stream.id||t._streams.userMedia.stream.label)&&(r.settings.audio=n(t._streams.userMedia.settings.audio),r.settings.video=n(t._streams.userMedia.settings.video),r.mediaStatus=n(t._streamsMutedSettings)),!("function"!=typeof t._peerConnections[e].getSenders||t._useEdgeWebRTC&&window.msRTCPeerConnection))){for(var s=t._peerConnections[e].getSenders(),d=!1,c=!1,l=0;l<s.length;l++)s[l]&&s[l].track&&s[l].track.kind&&("audio"===s[l].track.kind?d=!0:"video"===s[l].track.kind&&(c=!0));d||(r.settings.audio=!1,r.mediaStatus.audioMuted=!0),c||(r.settings.video=!1,r.mediaStatus.videoMuted=!0)}}return t._peerCustomConfigs[i]&&(t._peerCustomConfigs[i].bandwidth&&"object"==typeof t._peerCustomConfigs[i].bandwidth&&("number"==typeof t._peerCustomConfigs[i].bandwidth.audio&&(r.settings.bandwidth.audio=t._peerCustomConfigs[i].bandwidth.audio),"number"==typeof t._peerCustomConfigs[i].bandwidth.video&&(r.settings.bandwidth.video=t._peerCustomConfigs[i].bandwidth.video),"number"==typeof t._peerCustomConfigs[i].bandwidth.data&&(r.settings.bandwidth.data=t._peerCustomConfigs[i].bandwidth.data)),t._peerCustomConfigs[i].googleXBandwidth&&"object"==typeof t._peerCustomConfigs[i].googleXBandwidth&&("number"==typeof t._peerCustomConfigs[i].googleXBandwidth.min&&(r.settings.googleXBandwidth.min=t._peerCustomConfigs[i].googleXBandwidth.min),"number"==typeof t._peerCustomConfigs[i].googleXBandwidth.max&&(r.settings.googleXBandwidth.max=t._peerCustomConfigs[i].googleXBandwidth.max))),t._sdpSessions[i]&&t._sdpSessions[i].local&&t._sdpSessions[i].local.connection&&"object"==typeof t._sdpSessions[i].local.connection&&(t._sdpSessions[i].local.connection.audio&&t._sdpSessions[i].local.connection.audio.indexOf("send")>-1||(r.settings.audio=!1,r.mediaStatus.audioMuted=!0),t._sdpSessions[i].local.connection.video&&t._sdpSessions[i].local.connection.video.indexOf("send")>-1||(r.settings.video=!1,r.mediaStatus.videoMuted=!0),t._sdpSessions[i].local.connection.data&&t._sdpSessions[i].local.connection.data.indexOf("send")>-1||(r.settings.data=!1)),r},t.prototype._getUserInfo=function(e){var t=n(this.getPeerInfo()),r=e?this._getPeerCustomSettings(e):null;return r&&"object"==typeof r&&(t.settings=r.settings,t.mediaStatus=r.mediaStatus),t.settings.video&&"object"==typeof t.settings.video&&(t.settings.video.customSettings={},t.settings.video.frameRate&&"object"==typeof t.settings.video.frameRate&&(t.settings.video.customSettings.frameRate=n(t.settings.video.frameRate),t.settings.video.frameRate=-1),t.settings.video.facingMode&&"object"==typeof t.settings.video.facingMode&&(t.settings.video.customSettings.facingMode=n(t.settings.video.facingMode),t.settings.video.facingMode="-1"),t.settings.video.resolution&&"object"==typeof t.settings.video.resolution&&(t.settings.video.resolution.width&&"object"==typeof t.settings.video.resolution.width&&(t.settings.video.customSettings.width=n(t.settings.video.width),t.settings.video.resolution.width=-1),t.settings.video.resolution.height&&"object"==typeof t.settings.video.resolution.height&&(t.settings.video.customSettings.height=n(t.settings.video.height),t.settings.video.resolution.height=-1))),t.settings.bandwidth&&(t.settings.maxBandwidth=n(t.settings.bandwidth),delete t.settings.bandwidth),this._getSDPCommonSupports(e).video||(t.settings.video=!1,t.mediaStatus.videoMuted=!0),this._getSDPCommonSupports(e).audio||(t.settings.audio=!1,t.mediaStatus.audioMuted=!0),delete t.agent,delete t.room,delete t.config,delete t.parentId,delete t.settings.data,t},t.prototype.HANDSHAKE_PROGRESS={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ERROR:"error"},t.prototype._doOffer=function(e,t){var n=this,r=n._peerConnections[e];if(r)if(r.signalingState===n.PEER_CONNECTION_STATE.STABLE){var i={offerToReceiveAudio:!(!n._sdpSettings.connection.audio&&"MCU"!==e)&&n._getSDPCommonSupports(e).video,offerToReceiveVideo:!(!n._sdpSettings.connection.video&&"MCU"!==e)&&n._getSDPCommonSupports(e).audio,iceRestart:!!((n._peerInformations[e]||{}).config||{}).enableIceRestart&&t&&n._enableIceRestart,voiceActivityDetection:n._voiceActivityDetection};n._hasMCU&&"MCU"!==e||n._addLocalMediaStreams(e),n._enableDataChannel&&n._peerInformations[e]&&n._peerInformations[e].config.enableDataChannel&&(n._dataChannels[e]&&n._dataChannels[e].main||(n._createDataChannel(e),n._peerConnections[e].hasMainChannel=!0)),u.debug([e,null,null,"Creating offer with config:"],i),r.endOfCandidates=!1,n._peerConnStatus[e]&&(n._peerConnStatus[e].sdpConstraints=i);r.createOffer(function(t){u.debug([e,null,null,"Created offer"],t),n._setLocalAndSendMessage(e,t)},function(t){n._trigger("handshakeProgress",n.HANDSHAKE_PROGRESS.ERROR,e,t),u.error([e,null,null,"Failed creating an offer:"],t)},"plugin"===AdapterJS.webrtcDetectedType?{mandatory:{OfferToReceiveAudio:i.offerToReceiveAudio,OfferToReceiveVideo:i.offerToReceiveVideo,iceRestart:i.iceRestart,voiceActivityDetection:i.voiceActivityDetection}}:i)}else u.warn([e,"RTCSessionDescription","offer",'Dropping of creating of offer as signalingState is not "'+n.PEER_CONNECTION_STATE.STABLE+'" ->'],r.signalingState);else u.warn([e,"RTCSessionDescription","offer","Dropping of creating of offer as connection does not exists"])},t.prototype._doAnswer=function(e){var t=this;u.log([e,null,null,"Creating answer with config:"],t._room.connection.sdpConstraints);var n=t._peerConnections[e];if(n)if(n.signalingState===t.PEER_CONNECTION_STATE.HAVE_REMOTE_OFFER){var r="edge"===AdapterJS.webrtcDetectedBrowser?{offerToReceiveVideo:!(!t._sdpSettings.connection.audio&&"MCU"!==e)&&t._getSDPCommonSupports(e,n.remoteDescription).video,offerToReceiveAudio:!(!t._sdpSettings.connection.video&&"MCU"!==e)&&t._getSDPCommonSupports(e,n.remoteDescription).audio,voiceActivityDetection:t._voiceActivityDetection}:void 0;t._hasMCU&&"MCU"!==e||t._addLocalMediaStreams(e),t._peerConnStatus[e]&&(t._peerConnStatus[e].sdpConstraints=r);n.createAnswer(function(n){u.debug([e,null,null,"Created answer"],n),t._setLocalAndSendMessage(e,n)},function(n){u.error([e,null,null,"Failed creating an answer:"],n),t._trigger("handshakeProgress",t.HANDSHAKE_PROGRESS.ERROR,e,n)},r)}else u.warn([e,"RTCSessionDescription","answer",'Dropping of creating of answer as signalingState is not "'+t.PEER_CONNECTION_STATE.HAVE_REMOTE_OFFER+'" ->'],n.signalingState);else u.warn([e,"RTCSessionDescription","answer","Dropping of creating of answer as connection does not exists"])},t.prototype._setLocalAndSendMessage=function(e,t){var n=this,r=n._peerConnections[e];if(t&&t.sdp)if(r)if(t.type!==n.HANDSHAKE_PROGRESS.OFFER||r.signalingState===n.PEER_CONNECTION_STATE.STABLE)if(t.type!==n.HANDSHAKE_PROGRESS.ANSWER||r.signalingState===n.PEER_CONNECTION_STATE.HAVE_REMOTE_OFFER)if(r.processingLocalSDP)u.warn([e,"RTCSessionDescription",t.type,"Local session description will not be set as another is being processed ->"],t);else{r.processingLocalSDP=!0;var i={type:t.type,sdp:t.sdp};i.sdp=n._removeSDPFirefoxH264Pref(e,i),i.sdp=n._setSDPCodecParams(e,i),i.sdp=n._removeSDPUnknownAptRtx(e,i),i.sdp=n._removeSDPCodecs(e,i),i.sdp=n._handleSDPConnectionSettings(e,i,"local"),i.sdp=n._removeSDPREMBPackets(e,i),u.log([e,"RTCSessionDescription",i.type,"Local session description updated ->"],i.sdp);r.setLocalDescription(new RTCSessionDescription(i),function(){u.debug([e,"RTCSessionDescription",i.type,"Local session description has been set ->"],i),r.processingLocalSDP=!1,n._trigger("handshakeProgress",i.type,e),i.type===n.HANDSHAKE_PROGRESS.ANSWER?r.setAnswer="local":r.setOffer="local",n._enableIceTrickle||r.gathered?n._sendChannelMessage({type:i.type,sdp:n._renderSDPOutput(e,i),mid:n._user.sid,target:e,rid:n._room.id,userInfo:n._getUserInfo(e)}):u.log([e,"RTCSessionDescription",i.type,"Local session description sending is halted to complete ICE gathering."])},function(t){u.error([e,"RTCSessionDescription",i.type,"Local description failed setting ->"],t),r.processingLocalSDP=!1,n._trigger("handshakeProgress",n.HANDSHAKE_PROGRESS.ERROR,e,t)})}else u.warn([e,"RTCSessionDescription",t.type,'Local session description will not be set as signaling state is "'+r.signalingState+'" ->'],t);else u.warn([e,"RTCSessionDescription",t.type,'Local session description will not be set as signaling state is "'+r.signalingState+'" ->'],t);else u.warn([e,"RTCSessionDescription",t.type,"Local session description will not be set as connection does not exists ->"],t);else u.warn([e,"RTCSessionDescription",null,"Local session description is undefined ->"],t)},t.prototype.GET_PEERS_STATE={ENQUIRED:"enquired",RECEIVED:"received"},t.prototype.INTRODUCE_STATE={INTRODUCING:"introducing",ERROR:"error"},t.prototype.getPeers=function(e,t){var n=this;n._isPrivileged?n._appKey?("function"==typeof e&&(t=e,e=!1),n._sendChannelMessage({type:n._SIG_MESSAGE_TYPE.GET_PEERS,showAll:e||!1}),n._trigger("getPeersStateChange",n.GET_PEERS_STATE.ENQUIRED,n._user.sid,null),u.log("Enquired server for peers within the realm"),"function"==typeof t&&n.once("getPeersStateChange",function(e,n,r){t(null,r)},function(e,t,r){return e===n.GET_PEERS_STATE.RECEIVED})):u.warn("App key is not defined. Please authenticate again."):u.warn("Please upgrade your key to privileged to use this function")},t.prototype.introducePeer=function(e,t){var n=this;if(!n._isPrivileged)return u.warn("Please upgrade your key to privileged to use this function"),void n._trigger("introduceStateChange",n.INTRODUCE_STATE.ERROR,n._user.sid,e,t,"notPrivileged");n._sendChannelMessage({type:n._SIG_MESSAGE_TYPE.INTRODUCE,sendingPeerId:e,receivingPeerId:t}),n._trigger("introduceStateChange",n.INTRODUCE_STATE.INTRODUCING,n._user.sid,e,t,null),u.log("Introducing",e,"to",t)},t.prototype.SYSTEM_ACTION={WARNING:"warning",REJECT:"reject"},t.prototype.SYSTEM_ACTION_REASON={CREDENTIALS_EXPIRED:"oldTimeStamp",CREDENTIALS_ERROR:"credentialError",DUPLICATED_LOGIN:"duplicatedLogin",ROOM_NOT_STARTED:"notStart",EXPIRED:"expired",ROOM_LOCKED:"locked",FAST_MESSAGE:"fastmsg",ROOM_CLOSING:"toclose",ROOM_CLOSED:"roomclose",SERVER_ERROR:"serverError",KEY_ERROR:"keyFailed"},t.prototype.joinRoom=function(e,t,n){var r=this,i=r._defaultRoom,a=r._selectedRoom,o={},s=(new Date).getTime()+Math.floor(1e4*Math.random());r._joinRoomManager.timestamp=s,e&&"string"==typeof e?i=e:e&&"object"==typeof e?o=e:"function"==typeof e&&(n=e),t&&"object"==typeof t?o=t:"function"==typeof t&&(n=t);var d=function(e,t,r){u.error(e),"function"==typeof n&&n({room:t,errorCode:r||null,error:e instanceof Error?e:new Error(JSON.stringify(e))})},c=function(){r._joinRoomManager.timestamp===s?r._initSelectedRoom(i,function(e,t){e?d(e.error,r._selectedRoom,r._readyState):r._joinRoomManager.timestamp===s?r._waitForOpenChannel(o||{},s,function(e,t){if(e)d(e,r._selectedRoom,r._readyState);else if(r._joinRoomManager.timestamp===s){if("AppleWebKit"===AdapterJS.webrtcDetectedType){var a=r._streams.screenshare&&r._streams.screenshare.stream?r._streams.screenshare.stream:r._streams.userMedia&&r._streams.userMedia.stream?r._streams.userMedia.stream:null;a&&0!==a.getTracks().length?0===a.getAudioTracks().length?u.warn("Note that receiving audio streams may fail as safari 11 needs stream with audio and video tracks and not just with video tracks"):0===a.getVideoTracks().length&&u.warn("Note that receiving video streams may fail as safari 11 needs stream with audio and video tracks and not just with audio tracks"):u.warn("Note that receiving audio and video streams may fail as safari 11 needs stream with audio and video tracks")}if("function"==typeof n){var o=function(e,t,a){r.off("systemAction",c),r.off("channelClose",l),u.info([null,"Room",i,"Connected to Room ->"],t),n(null,{room:r._selectedRoom,peerId:e,peerInfo:t})},c=function(e,t){r.off("peerJoined",o),r.off("channelClose",l),u.error([null,"Room",i,"Failed connecting to Room ->"],t),d(new Error(t),r._selectedRoom,r._readyState)},l=function(){r.off("systemAction",c),r.off("peerJoined",o),u.error([null,"Room",i,"Failed connecting to Room due to abrupt disconnection."]),d(new Error("Channel closed abruptly before session was established"),r._selectedRoom,r._readyState)};r.once("peerJoined",o,function(e,t,n){return t.room===i&&n}),r.once("systemAction",c,function(e){return e===r.SYSTEM_ACTION.REJECT}),r.once("channelClose",l)}r._sendChannelMessage({type:r._SIG_MESSAGE_TYPE.JOIN_ROOM,uid:r._user.uid,cid:r._key,rid:r._room.id,userCred:r._user.token,timeStamp:r._user.timeStamp,apiOwner:r._appKeyOwner,roomCred:r._room.token,start:r._room.startDateTime,len:r._room.duration,isPrivileged:!0===r._isPrivileged,autoIntroduce:!1!==r._autoIntroduce,key:r._appKey})}else d("joinRoom() process did not complete",i)}):d("joinRoom() process did not complete",i)}):d("joinRoom() process did not complete",i)};if(null===e||["number","boolean"].indexOf(typeof e)>-1)d("Invalid room name is provided",e);else if(null===t||["number","boolean"].indexOf(typeof t)>-1)d("Invalid mediaOptions is provided",i);else{r._joinRoomManager.socketsFn.forEach(function(e){e(s)}),r._joinRoomManager.socketsFn=[];var l=!1===o.audio&&!1===o.video;r._inRoom?r.leaveRoom({userMedia:l},function(e,t){u.debug([null,"Room",a,"Leave Room callback result ->"],[e,t]),c()}):(l&&r.stopStream(),c())}},t.prototype.leaveRoom=function(e,t){var n=this,r=!0,i=!0,a=n._selectedRoom,o=n._user?n._user.sid:null,s=[],d=!n._inRoom;"boolean"==typeof e?!1===e&&(r=!1,i=!1):e&&"object"==typeof e?(r=!1!==e.userMedia,i=!1!==e.screenshare):"function"==typeof e&&(t=e);for(var c in n._peerInformations)n._peerInformations.hasOwnProperty(c)&&n._peerInformations[c]&&(s.push(c),n._removePeer(c));for(var l in n._peerConnections)n._peerConnections.hasOwnProperty(l)&&n._peerConnections[l]&&-1===s.indexOf(l)&&(s.push(l),n._removePeer(l));if(n._inRoom=!1,n._closeChannel(),d){var p="Unable to leave room as user is not in any room";return u.error([null,"Room",a,p]),void("function"==typeof t&&t(new Error(p),null))}n._stopStreams({userMedia:r,screenshare:i}),n._wait(function(){u.log([null,"Room",a,"User left the room"]),n._trigger("peerLeft",o,n.getPeerInfo(),!0),"function"==typeof t&&t(null,{peerId:o,previousRoom:a})},function(){return!n._channelOpen})},t.prototype.lockRoom=function(){this._user&&this._user.sid&&(u.log("Update to isRoomLocked status ->",!0),this._sendChannelMessage({type:this._SIG_MESSAGE_TYPE.ROOM_LOCK,mid:this._user.sid,rid:this._room.id,lock:!0}),this._roomLocked=!0,this._trigger("roomLock",!0,this._user.sid,this.getPeerInfo(),!0))},t.prototype.unlockRoom=function(){this._user&&this._user.sid&&(u.log("Update to isRoomLocked status ->",!1),this._sendChannelMessage({type:this._SIG_MESSAGE_TYPE.ROOM_LOCK,mid:this._user.sid,rid:this._room.id,lock:!1}),this._roomLocked=!1,this._trigger("roomLock",!1,this._user.sid,this.getPeerInfo(),!0))},t.prototype._waitForOpenChannel=function(e,t,n){var r=this;r._socketCurrentReconnectionAttempt=0,r._wait(function(){var i=function(){r.off("socketError",a),setTimeout(function(){if(e=e||{},r._userData=e.userData||r._userData||"",r._streamsBandwidthSettings={googleX:{},bAS:{}},r._publishOnly=!1,r._sdpSettings={connection:{audio:!0,video:!0,data:!0},direction:{audio:{send:!0,receive:!0},video:{send:!0,receive:!0}}},r._voiceActivityDetection="boolean"!=typeof e.voiceActivityDetection||e.voiceActivityDetection,r._peerConnectionConfig={bundlePolicy:r.BUNDLE_POLICY.BALANCED,rtcpMuxPolicy:r.RTCP_MUX_POLICY.REQUIRE,iceCandidatePoolSize:0,certificate:r.PEER_CERTIFICATE.AUTO},r._bandwidthAdjuster=null,e.bandwidth&&("number"==typeof e.bandwidth.audio&&(r._streamsBandwidthSettings.bAS.audio=e.bandwidth.audio),"number"==typeof e.bandwidth.video&&(r._streamsBandwidthSettings.bAS.video=e.bandwidth.video),"number"==typeof e.bandwidth.data&&(r._streamsBandwidthSettings.bAS.data=e.bandwidth.data)),e.googleXBandwidth&&("number"==typeof e.googleXBandwidth.min&&(r._streamsBandwidthSettings.googleX.min=e.googleXBandwidth.min),"number"==typeof e.googleXBandwidth.max&&(r._streamsBandwidthSettings.googleX.max=e.googleXBandwidth.max)),e.sdpSettings&&(e.sdpSettings.direction&&(e.sdpSettings.direction.audio&&(r._sdpSettings.direction.audio.receive="boolean"!=typeof e.sdpSettings.direction.audio.receive||e.sdpSettings.direction.audio.receive,r._sdpSettings.direction.audio.send="boolean"!=typeof e.sdpSettings.direction.audio.send||e.sdpSettings.direction.audio.send),e.sdpSettings.direction.video&&(r._sdpSettings.direction.video.receive="boolean"!=typeof e.sdpSettings.direction.video.receive||e.sdpSettings.direction.video.receive,r._sdpSettings.direction.video.send="boolean"!=typeof e.sdpSettings.direction.video.send||e.sdpSettings.direction.video.send)),e.sdpSettings.connection&&(r._sdpSettings.connection.audio="boolean"!=typeof e.sdpSettings.connection.audio||e.sdpSettings.connection.audio,r._sdpSettings.connection.video="boolean"!=typeof e.sdpSettings.connection.video||e.sdpSettings.connection.video,r._sdpSettings.connection.data="boolean"!=typeof e.sdpSettings.connection.data||e.sdpSettings.connection.data)),e.publishOnly&&(r._sdpSettings.direction.audio.send=!0,r._sdpSettings.direction.audio.receive=!1,r._sdpSettings.direction.video.send=!0,r._sdpSettings.direction.video.receive=!1,r._publishOnly=!0,"object"==typeof e.publishOnly&&e.publishOnly.parentId&&"string"==typeof e.publishOnly.parentId&&(r._parentId=e.publishOnly.parentId)),e.parentId&&(r._parentId=e.parentId),e.peerConnection&&"object"==typeof e.peerConnection){if("string"==typeof e.peerConnection.bundlePolicy)for(var t in r.BUNDLE_POLICY)r.BUNDLE_POLICY.hasOwnProperty(t)&&r.BUNDLE_POLICY[t]===e.peerConnection.bundlePolicy&&(r._peerConnectionConfig.bundlePolicy=e.peerConnection.bundlePolicy);if("string"==typeof e.peerConnection.rtcpMuxPolicy)for(var i in r.RTCP_MUX_POLICY)r.RTCP_MUX_POLICY.hasOwnProperty(i)&&r.RTCP_MUX_POLICY[i]===e.peerConnection.rtcpMuxPolicy&&(r._peerConnectionConfig.rtcpMuxPolicy=e.peerConnection.rtcpMuxPolicy);if("number"==typeof e.peerConnection.iceCandidatePoolSize&&e.peerConnection.iceCandidatePoolSize>0&&(r._peerConnectionConfig.iceCandidatePoolSize=e.peerConnection.iceCandidatePoolSize),"string"==typeof e.peerConnection.certificate)for(var a in r.PEER_CERTIFICATE)r.PEER_CERTIFICATE.hasOwnProperty(a)&&r.PEER_CERTIFICATE[a]===e.peerConnection.certificate&&(r._peerConnectionConfig.certificate=e.peerConnection.certificate)}if(e.autoBandwidthAdjustment&&(r._bandwidthAdjuster={interval:10,limitAtPercentage:100,useUploadBwOnly:!1},"object"==typeof e.autoBandwidthAdjustment&&("number"==typeof e.autoBandwidthAdjustment.interval&&e.autoBandwidthAdjustment.interval>=10&&(r._bandwidthAdjuster.interval=e.autoBandwidthAdjustment.interval),"number"==typeof e.autoBandwidthAdjustment.limitAtPercentage&&e.autoBandwidthAdjustment.limitAtPercentage>=0&&e.autoBandwidthAdjustment.limitAtPercentage<=100&&(r._bandwidthAdjuster.limitAtPercentage=e.autoBandwidthAdjustment.limitAtPercentage),"boolean"==typeof e.autoBandwidthAdjustment.useUploadBwOnly&&(r._bandwidthAdjuster.useUploadBwOnly=e.autoBandwidthAdjustment.useUploadBwOnly))),!0!==e.manualGetUserMedia)e.audio||e.video?r.getUserMedia({useExactConstraints:!!e.useExactConstraints,audio:e.audio,video:e.video},function(e,t){e?n(e,null):n(null,t)}):n(null,null);else{r._trigger("mediaAccessRequired");var o=0,s=!1;r._wait(function(){!0===s?r._onUserMediaError(new Error("Waiting for stream timeout"),!1,!1):n(null,r._streams.userMedia.stream)},function(){return o+=1,600===o?(s=!0,!0):!(!r._streams.userMedia||!r._streams.userMedia.stream)||void 0},50)}},1)},a=function(e,t){r.off("channelOpen",i),n(t)};r._channelOpen?i():(r.once("channelOpen",i),r.once("socketError",a,function(e){return e===r.SOCKET_ERROR.RECONNECTION_ABORTED}),r._openChannel(t))},function(){return r._readyState===r.READY_STATE_CHANGE.COMPLETED})},t.prototype.VERSION="0.6.26",t.prototype.READY_STATE_CHANGE={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},t.prototype.READY_STATE_CHANGE_ERROR={API_INVALID:4001,API_DOMAIN_NOT_MATCH:4002,API_CORS_DOMAIN_NOT_MATCH:4003,API_CREDENTIALS_INVALID:4004,API_CREDENTIALS_NOT_MATCH:4005,API_INVALID_PARENT_KEY:4006,API_NO_MEETING_RECORD_FOUND:4010,API_OVER_SEAT_LIMIT:4020,API_RETRIEVAL_FAILED:4021,API_WRONG_ACCESS_DOMAIN:5005,XML_HTTP_REQUEST_ERROR:-1,XML_HTTP_NO_REPONSE_ERROR:-2,NO_SOCKET_IO:1,NO_XMLHTTPREQUEST_SUPPORT:2,NO_WEBRTC_SUPPORT:3,NO_PATH:4,ADAPTER_NO_LOADED:7,PARSE_CODECS:8},t.prototype.REGIONAL_SERVER={APAC1:"",US1:""},t.prototype.PRIORITY_WEIGHT_SCHEME={ENFORCE_OFFERER:"enforceOfferer",ENFORCE_ANSWERER:"enforceAnswerer",AUTO:"auto"},t.prototype.generateUUID=function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:n&&15).toString(16)})},t.prototype.init=function(e,t){var n=this;if("function"==typeof e&&(t=e,e=void 0),!e){var r="No API key provided";return u.error(r),void("function"==typeof t&&t(r,null))}var i,a,o,s,d,c,l=n._roomServer,p=!0,f=!0,g=!0,h=!0,m=n.TURN_TRANSPORT.ANY,_=!1,S=!0,v=7e3,C=4e3,T=!1,y=n.AUDIO_CODEC.AUTO,E=n.VIDEO_CODEC.AUTO,R=!1,b=!1,A=!1,P=!1,w=!1,D={host:!1,srflx:!1,relay:!1},I={shareScreen:1e4,refreshConnection:5e3,getUserMedia:0},O=!1,k=!1,N=null,M=null,x={audio:{opus:{}},video:{h264:{},vp8:{},vp9:{}}},L=n.PRIORITY_WEIGHT_SCHEME.AUTO,U=!1,B=!0;if(u.log("Provided init options:",e),"string"==typeof e)o=i=e,a=i;else{if(i=e.appKey||e.apiKey,l="string"==typeof e.roomServer?e.roomServer:l,l=l.lastIndexOf("/")===l.length-1?l.substring(0,l.length-1):l,o="string"==typeof e.defaultRoom&&e.defaultRoom?e.defaultRoom:i,a=o,p="boolean"==typeof e.enableIceTrickle?e.enableIceTrickle:p,f="boolean"==typeof e.enableDataChannel?e.enableDataChannel:f,g="boolean"==typeof e.enableSTUNServer?e.enableSTUNServer:g,h="boolean"==typeof e.enableTURNServer?e.enableTURNServer:h,S="boolean"==typeof e.forceSSL?e.forceSSL:S,v="number"==typeof e.socketTimeout&&v<5e3&&v>0?e.socketTimeout:v,C="number"==typeof e.apiTimeout&&e.apiTimeout>0?e.apiTimeout:C,T="boolean"==typeof e.forceTURNSSL?e.forceTURNSSL:T,R="boolean"==typeof e.forceTURN?e.forceTURN:R,b="boolean"==typeof e.usePublicSTUN?e.usePublicSTUN:b,A="boolean"==typeof e.disableVideoFecCodecs?e.disableVideoFecCodecs:A,P="boolean"==typeof e.disableComfortNoiseCodec?e.disableComfortNoiseCodec:P,w="boolean"==typeof e.disableREMB?e.disableREMB:w,O="boolean"==typeof e.throttleShouldThrowError?e.throttleShouldThrowError:O,k="boolean"==typeof e.mcuUseRenegoRestart?e.mcuUseRenegoRestart:k,k="boolean"==typeof e.mcuUseRenegoRestart?e.mcuUseRenegoRestart:k,U="boolean"==typeof e.useEdgeWebRTC?e.useEdgeWebRTC:U,B="boolean"==typeof e.enableSimultaneousTransfers?e.enableSimultaneousTransfers:B,"object"==typeof e.filterCandidatesType&&e.filterCandidatesType&&(D.host="boolean"==typeof e.filterCandidatesType.host?e.filterCandidatesType.host:D.host,D.srflx="boolean"==typeof e.filterCandidatesType.srflx?e.filterCandidatesType.srflx:D.srflx,D.relay="boolean"==typeof e.filterCandidatesType.relay?e.filterCandidatesType.relay:D.relay),"object"==typeof e.throttleIntervals&&e.throttleIntervals&&(I.shareScreen="number"==typeof e.throttleIntervals.shareScreen?e.throttleIntervals.shareScreen:I.shareScreen,I.refreshConnection="number"==typeof e.throttleIntervals.refreshConnection?e.throttleIntervals.refreshConnection:I.refreshConnection,I.getUserMedia="number"==typeof e.throttleIntervals.getUserMedia?e.throttleIntervals.getUserMedia:I.getUserMedia),e.socketServer&&("string"==typeof e.socketServer?M=e.socketServer:"object"==typeof e.socketServer&&e.socketServer.url&&"string"==typeof e.socketServer.url&&(M={url:e.socketServer.url,ports:Array.isArray(e.socketServer.ports)&&e.socketServer.ports.length>0?e.socketServer.ports:[],protocol:e.socketServer.protocol&&"string"==typeof e.socketServer.protocol?e.socketServer.protocol:null})),e.iceServer&&(N="string"==typeof e.iceServer?{urls:[e.iceServer]}:Array.isArray(e.iceServer)&&e.iceServer.length>0&&e.iceServer[0]&&"string"==typeof e.iceServer[0]?{urls:e.iceServer}:null),"string"==typeof e.TURNServerTransport)for(var j in n.TURN_TRANSPORT)if(n.TURN_TRANSPORT.hasOwnProperty(j)&&n.TURN_TRANSPORT[j]===e.TURNServerTransport){m=e.TURNServerTransport;break}if(e.audioCodec&&("string"==typeof e.audioCodec&&e.audioCodec!==n.AUDIO_CODEC.AUTO||"object"==typeof e.audioCodec&&e.audioCodec.codec&&"string"==typeof e.audioCodec.codec&&e.audioCodec.codec!==n.AUDIO_CODEC.AUTO))for(var F in n.AUDIO_CODEC)if(n.AUDIO_CODEC.hasOwnProperty(F)){if("string"==typeof e.audioCodec&&n.AUDIO_CODEC[F]===e.audioCodec){y=e.audioCodec;break}if("object"==typeof e.audioCodec&&n.AUDIO_CODEC[F]===e.audioCodec.codec){y={codec:e.audioCodec.codec,samplingRate:"number"==typeof e.audioCodec.samplingRate&&e.audioCodec.samplingRate>0?e.audioCodec.samplingRate:null,channels:"number"==typeof e.audioCodec.channels&&e.audioCodec.channels>0?e.audioCodec.channels:null};break}}if(e.videoCodec&&("string"==typeof e.videoCodec&&e.videoCodec!==n.VIDEO_CODEC.AUTO||"object"==typeof e.videoCodec&&e.videoCodec.codec&&"string"==typeof e.videoCodec.codec&&e.videoCodec.codec!==n.VIDEO_CODEC.AUTO))for(var G in n.VIDEO_CODEC)if(n.VIDEO_CODEC.hasOwnProperty(G)){if("string"==typeof e.videoCodec&&n.VIDEO_CODEC[G]===e.videoCodec){E=e.videoCodec;break}if("object"==typeof e.videoCodec&&n.VIDEO_CODEC[G]===e.videoCodec.codec){E={codec:e.videoCodec.codec,samplingRate:"number"==typeof e.videoCodec.samplingRate&&e.videoCodec.samplingRate>0?e.videoCodec.samplingRate:null};break}}if("string"==typeof e.priorityWeightScheme)for(var J in n.PRIORITY_WEIGHT_SCHEME)if(n.PRIORITY_WEIGHT_SCHEME.hasOwnProperty(J)&&n.PRIORITY_WEIGHT_SCHEME[J]===e.priorityWeightScheme){L=e.priorityWeightScheme;break}e.codecParams&&"object"==typeof e.codecParams&&(e.codecParams.audio&&"object"==typeof e.codecParams.audio&&e.codecParams.audio.opus&&"object"==typeof e.codecParams.audio.opus&&(x.audio.opus={stereo:"boolean"==typeof e.codecParams.audio.opus.stereo?e.codecParams.audio.opus.stereo:null,"sprop-stereo":"boolean"==typeof e.codecParams.audio.opus["sprop-stereo"]?e.codecParams.audio.opus["sprop-stereo"]:null,usedtx:"boolean"==typeof e.codecParams.audio.opus.usedtx?e.codecParams.audio.opus.usedtx:null,useinbandfec:"boolean"==typeof e.codecParams.audio.opus.useinbandfec?e.codecParams.audio.opus.useinbandfec:null,maxplaybackrate:"number"==typeof e.codecParams.audio.opus.maxplaybackrate&&e.codecParams.audio.opus.maxplaybackrate>=8e3&&e.codecParams.audio.opus.maxplaybackrate<=48e3?e.codecParams.audio.opus.maxplaybackrate:null,minptime:"number"==typeof e.codecParams.audio.opus.minptime&&e.codecParams.audio.opus.minptime>=3?e.codecParams.audio.opus.minptime:null}),e.codecParams.video&&"object"==typeof e.codecParams.video&&(e.codecParams.video.h264&&"object"==typeof e.codecParams.video.h264&&(x.video.h264={profileLevelId:e.codecParams.video.h264.profileLevelId&&"string"==typeof e.codecParams.video.h264.profileLevelId?e.codecParams.video.h264.profileLevelId:null,levelAsymmetryAllowed:"boolean"==typeof e.codecParams.video.h264.levelAsymmetryAllowed?e.codecParams.video.h264.levelAsymmetryAllowed:null,packetizationMode:"boolean"==typeof e.codecParams.video.h264.packetizationMode?e.codecParams.video.h264.packetizationMode:null}),e.codecParams.video.vp8&&"object"==typeof e.codecParams.video.vp8&&(x.video.vp8={maxFs:"number"==typeof e.codecParams.video.vp8.maxFs?e.codecParams.video.vp8.maxFs:null,maxFr:"number"==typeof e.codecParams.video.vp8.maxFr?e.codecParams.video.vp8.maxFr:null}),e.codecParams.video.vp9&&"object"==typeof e.codecParams.video.vp9&&(x.video.vp9={maxFs:"number"==typeof e.codecParams.video.vp9.maxFs?e.codecParams.video.vp9.maxFs:null,maxFr:"number"==typeof e.codecParams.video.vp9.maxFr?e.codecParams.video.vp9.maxFr:null}))),_=e.audioFallback||_,e.credentials&&"string"==typeof e.credentials.credentials&&"number"==typeof e.credentials.duration&&"string"==typeof e.credentials.startDateTime&&(s=e.credentials.startDateTime,d=e.credentials.duration,c=e.credentials.credentials),!0===R&&(h=!0,g=!1,D.host=!0,D.srflx=!0,D.relay=!1)}if("edge"===AdapterJS.webrtcDetectedBrowser&&(T=!1,m=n.TURN_TRANSPORT.UDP,f=!1),n._appKey=i,n._roomServer=l,n._defaultRoom=o,n._selectedRoom=a,n._path=l+"/api/"+i+"/"+a,c&&s&&d&&(n._roomStart=s,n._roomDuration=d,n._roomCredentials=c,n._path+=c?"/"+s+"/"+d+"?&cred="+c:""),n._path+=(c?"&":"?")+"rand="+(new Date).toISOString(),n._enableIceTrickle=p,n._enableDataChannel=f,n._enableSTUN=g,n._enableTURN=h,n._TURNTransport=m,n._audioFallback=_,n._forceSSL=S,n._socketTimeout=v,n._apiTimeout=C,n._forceTURNSSL=T,n._selectedAudioCodec=y,n._selectedVideoCodec=E,n._forceTURN=R,n._usePublicSTUN=b,n._disableVideoFecCodecs=A,n._disableComfortNoiseCodec=P,n._filterCandidatesType=D,n._throttlingTimeouts=I,n._throttlingShouldThrowError=O,n._disableREMB=w,n._mcuUseRenegoRestart=k,n._iceServer=N,n._socketServer=M,n._codecParams=x,n._priorityWeightScheme=L,n._useEdgeWebRTC=U,n._enableSimultaneousTransfers=B,u.log("Init configuration:",{serverUrl:n._path,readyState:n._readyState,appKey:n._appKey,roomServer:n._roomServer,defaultRoom:n._defaultRoom,selectedRoom:n._selectedRoom,enableDataChannel:n._enableDataChannel,enableIceTrickle:n._enableIceTrickle,enableTURNServer:n._enableTURN,enableSTUNServer:n._enableSTUN,TURNTransport:n._TURNTransport,audioFallback:n._audioFallback,forceSSL:n._forceSSL,socketTimeout:n._socketTimeout,apiTimeout:n._apiTimeout,forceTURNSSL:n._forceTURNSSL,audioCodec:n._selectedAudioCodec,videoCodec:n._selectedVideoCodec,forceTURN:n._forceTURN,usePublicSTUN:n._usePublicSTUN,disableVideoFecCodecs:n._disableVideoFecCodecs,disableComfortNoiseCodec:n._disableComfortNoiseCodec,disableREMB:n._disableREMB,filterCandidatesType:n._filterCandidatesType,throttleIntervals:n._throttlingTimeouts,throttleShouldThrowError:n._throttlingShouldThrowError,mcuUseRenegoRestart:n._mcuUseRenegoRestart,iceServer:n._iceServer,socketServer:n._socketServer,codecParams:n._codecParams,priorityWeightScheme:n._priorityWeightScheme,useEdgeWebRTC:n._useEdgeWebRTC,enableSimultaneousTransfers:n._enableSimultaneousTransfers}),n._readyState=0,n._trigger("readyStateChange",n.READY_STATE_CHANGE.INIT,null,n._selectedRoom),"function"==typeof t){var H=!1,W=function(e,r){H||(e===n.READY_STATE_CHANGE.COMPLETED?(u.log([null,"Socket",null,"Firing callback. Ready state change has met provided state ->"],e),H=!0,n.off("readyStateChange",W),t(null,{serverUrl:n._path,readyState:n._readyState,appKey:n._appKey,roomServer:n._roomServer,defaultRoom:n._defaultRoom,selectedRoom:n._selectedRoom,enableDataChannel:n._enableDataChannel,enableIceTrickle:n._enableIceTrickle,enableTURNServer:n._enableTURN,enableSTUNServer:n._enableSTUN,TURNTransport:n._TURNTransport,audioFallback:n._audioFallback,forceSSL:n._forceSSL,socketTimeout:n._socketTimeout,apiTimeout:n._apiTimeout,forceTURNSSL:n._forceTURNSSL,audioCodec:n._selectedAudioCodec,videoCodec:n._selectedVideoCodec,forceTURN:n._forceTURN,usePublicSTUN:n._usePublicSTUN,disableVideoFecCodecs:n._disableVideoFecCodecs,disableComfortNoiseCodec:n._disableComfortNoiseCodec,disableREMB:n._disableREMB,filterCandidatesType:n._filterCandidatesType,throttleIntervals:n._throttlingTimeouts,throttleShouldThrowError:n._throttlingShouldThrowError,mcuUseRenegoRestart:n._mcuUseRenegoRestart,iceServer:n._iceServer,socketServer:n._socketServer,codecParams:n._codecParams,priorityWeightScheme:n._priorityWeightScheme,useEdgeWebRTC:n._useEdgeWebRTC,enableSimultaneousTransfers:n._enableSimultaneousTransfers})):e===n.READY_STATE_CHANGE.ERROR&&(u.log([null,"Socket",null,"Firing callback. Ready state change has met provided state ->"],e),u.debug([null,"Socket",null,"Ready state met failure"],r),H=!0,n.off("readyStateChange",W),t({error:r.content instanceof Error?r.content:new Error(JSON.stringify(r.content)),errorCode:r.errorCode,status:r.status},null)))};n.on("readyStateChange",W)}n._loadInfo()},t.prototype._requestServerInfo=function(e,t,n,r){var i=this,a=0;i._socketUseXDR="function"==typeof window.XDomainRequest||"object"==typeof window.XDomainRequest,t=i._forceSSL?"https:"+t:t,function o(){var s=new XMLHttpRequest,d=!1;i._socketUseXDR&&(u.debug([null,"XMLHttpRequest",e,"Using XDomainRequest for CORS authentication."]),(s=new XDomainRequest).setContentType=function(e){s.contentType=e}),s.onload=function(){if(!d){d=!0;var t=JSON.parse(s.responseText||s.response||"{}"),r=s.status||200;u.debug([null,"XMLHttpRequest",e,"Received sessions parameters ->"],t),n(r,t)}},s.onerror=function(t){d||(d=!0,u.error([null,"XMLHttpRequest",e,"Failed retrieving information with status ->"],s.status),i._readyState=-1,i._trigger("readyStateChange",i.READY_STATE_CHANGE.ERROR,{status:s.status||null,content:"Network error occurred. (Status: "+s.status+")",errorCode:i.READY_STATE_CHANGE_ERROR.XML_HTTP_REQUEST_ERROR},i._selectedRoom))},s.onprogress=function(){u.debug([null,"XMLHttpRequest",e,"Retrieving information and config from webserver ->"],{url:t,params:r})};try{s.open(e,t,!0),r?(s.setContentType("application/json;charset=UTF-8"),s.send(JSON.stringify(r))):s.send()}catch(e){return d=!0,i._readyState=-1,void i._trigger("readyStateChange",i.READY_STATE_CHANGE.ERROR,{status:s.status||null,content:"Failed starting XHR process.",errorCode:i.READY_STATE_CHANGE_ERROR.XML_HTTP_REQUEST_ERROR},i._selectedRoom)}setTimeout(function(){d||(d=!0,s.onload=null,s.onerror=null,s.onprogress=null,a<2?(a++,o()):(i._readyState=-1,i._trigger("readyStateChange",i.READY_STATE_CHANGE.ERROR,{status:s.status||null,content:"Response timed out from API server",errorCode:i.READY_STATE_CHANGE_ERROR.XML_HTTP_NO_REPONSE_ERROR},i._selectedRoom)))},i._apiTimeout)}()},t.prototype._parseInfo=function(e){u.log("Parsing parameter from server",e),e.pc_constraints||e.offer_constraints?(u.debug("Peer connection constraints:",e.pc_constraints),u.debug("Offer constraints:",e.offer_constraints),this._key=e.cid,this._appKeyOwner=e.apiOwner,this._signalingServer=e.ipSigserver,this._isPrivileged=e.isPrivileged,this._autoIntroduce=e.autoIntroduce,this._user={uid:e.username,token:e.userCred,timeStamp:e.timeStamp,streams:[],info:{}},this._room={id:e.room_key,token:e.roomCred,startDateTime:e.start,duration:e.len,connection:{peerConstraints:JSON.parse(e.pc_constraints),peerConfig:null,offerConstraints:JSON.parse(e.offer_constraints),sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},mediaConstraints:JSON.parse(e.media_constraints)}},this._socketPorts={"http:":Array.isArray(e.httpPortList)&&e.httpPortList.length>0?e.httpPortList:[80,3e3],"https:":Array.isArray(e.httpsPortList)&&e.httpsPortList.length>0?e.httpsPortList:[443,3443]},this._readyState=2,this._trigger("readyStateChange",this.READY_STATE_CHANGE.COMPLETED,null,this._selectedRoom),u.info("Parsed parameters from webserver. Ready for web-realtime communication")):this._trigger("readyStateChange",this.READY_STATE_CHANGE.ERROR,{status:200,content:e.info,errorCode:e.error},self._selectedRoom)},t.prototype._loadInfo=function(){var t=this;{if("function"==typeof(e.AdapterJS||window.AdapterJS||{}).webRTCReady)return e.io||window.io?window.XMLHttpRequest?t._path?void AdapterJS.webRTCReady(function(){if(t._enableIceRestart="firefox"!==AdapterJS.webrtcDetectedBrowser||AdapterJS.webrtcDetectedVersion>=48,t._binaryChunkType="firefox"===AdapterJS.webrtcDetectedBrowser?t.DATA_TRANSFER_DATA_TYPE.BLOB:t.DATA_TRANSFER_DATA_TYPE.ARRAY_BUFFER,!function(){try{var e=new window.RTCPeerConnection(null);return["object","function"].indexOf(typeof e.createOffer)>-1&&null!==e.createOffer}catch(e){return!1}}())return window.RTCPeerConnection&&"plugin"===AdapterJS.webrtcDetectedType?u.error("Plugin is not available. Please check plugin status."):u.error("WebRTC not supported. Please upgrade your browser"),t._readyState=-1,void t._trigger("readyStateChange",t.READY_STATE_CHANGE.ERROR,{status:null,content:"plugin"===AdapterJS.webrtcDetectedType&&window.RTCPeerConnection?"Plugin is not available":"WebRTC not available",errorCode:t.READY_STATE_CHANGE_ERROR.NO_WEBRTC_SUPPORT},t._selectedRoom);t._getCodecsSupport(function(e){return e?(u.error(e),t._readyState=-1,void t._trigger("readyStateChange",t.READY_STATE_CHANGE.ERROR,{status:null,content:e.message||e.toString(),errorCode:t.READY_STATE_CHANGE_ERROR.PARSE_CODECS},t._selectedRoom)):0===Object.keys(t._currentCodecSupport.audio).length&&0===Object.keys(t._currentCodecSupport.video).length?(u.error("No audio/video codecs available to start connection."),t._readyState=-1,void t._trigger("readyStateChange",t.READY_STATE_CHANGE.ERROR,{status:null,content:"No audio/video codecs available to start connection",errorCode:t.READY_STATE_CHANGE_ERROR.PARSE_CODECS},t._selectedRoom)):(t._readyState=1,t._trigger("readyStateChange",t.READY_STATE_CHANGE.LOADING,null,t._selectedRoom),void t._requestServerInfo("GET",t._path,function(e,n){if(200!==e){var r="XMLHttpRequest status not OK\nStatus was: "+e;return t._readyState=0,void t._trigger("readyStateChange",t.READY_STATE_CHANGE.ERROR,{status:e,content:n?n.info||r:r,errorCode:n.error||t.READY_STATE_CHANGE_ERROR.INVALID_XMLHTTPREQUEST_STATUS},t._selectedRoom)}t._parseInfo(n)}))})}):(u.error("Skylink is not initialised. Please call init() first"),t._readyState=-1,void t._trigger("readyStateChange",t.READY_STATE_CHANGE.ERROR,{status:null,content:"No API Path is found",errorCode:t.READY_STATE_CHANGE_ERROR.NO_PATH},t._selectedRoom)):(u.error("XMLHttpRequest not supported. Please upgrade your browser"),t._readyState=-1,void t._trigger("readyStateChange",t.READY_STATE_CHANGE.ERROR,{status:null,content:"XMLHttpRequest not available",errorCode:t.READY_STATE_CHANGE_ERROR.NO_XMLHTTPREQUEST_SUPPORT},t._selectedRoom)):(u.error("Socket.io not loaded. Please load socket.io"),t._readyState=-1,void t._trigger("readyStateChange",t.READY_STATE_CHANGE.ERROR,{status:null,content:"Socket.io not found",errorCode:t.READY_STATE_CHANGE_ERROR.NO_SOCKET_IO},t._selectedRoom));t._trigger("readyStateChange",t.READY_STATE_CHANGE.ERROR,{status:null,content:"AdapterJS dependency is not loaded or incorrect AdapterJS dependency is used",errorCode:t.READY_STATE_CHANGE_ERROR.ADAPTER_NO_LOADED},t._selectedRoom)}},t.prototype._initSelectedRoom=function(e,t){var n=this;if("function"!=typeof e&&void 0!==e){var r=n._defaultRoom,i={appKey:n._appKey,roomServer:n._roomServer,defaultRoom:e,enableDataChannel:n._enableDataChannel,enableIceTrickle:n._enableIceTrickle,enableTURNServer:n._enableTURN,enableSTUNServer:n._enableSTUN,TURNServerTransport:n._TURNTransport,audioFallback:n._audioFallback,forceSSL:n._forceSSL,socketTimeout:n._socketTimeout,apiTimeout:n._apiTimeout,forceTURNSSL:n._forceTURNSSL,audioCodec:n._selectedAudioCodec,videoCodec:n._selectedVideoCodec,forceTURN:n._forceTURN,usePublicSTUN:n._usePublicSTUN,disableVideoFecCodecs:n._disableVideoFecCodecs,disableComfortNoiseCodec:n._disableComfortNoiseCodec,disableREMB:n._disableREMB,filterCandidatesType:n._filterCandidatesType,throttleIntervals:n._throttlingTimeouts,throttleShouldThrowError:n._throttlingShouldThrowError,mcuUseRenegoRestart:n._mcuUseRenegoRestart,iceServer:n._iceServer?n._iceServer.urls:null,socketServer:n._socketServer?n._socketServer:null,codecParams:n._codecParams?n._codecParams:null,priorityWeightScheme:n._priorityWeightScheme?n._priorityWeightScheme:null,useEdgeWebRTC:n._useEdgeWebRTC,enableSimultaneousTransfers:n._enableSimultaneousTransfers};n._roomCredentials&&(i.credentials={credentials:n._roomCredentials,duration:n._roomDuration,startDateTime:n._roomStart}),n.init(i,function(e,i){n._defaultRoom=r,e?t(e,null):t(null,i)})}else u.error("Invalid room provided. Room:",e)},t.prototype.LOG_LEVEL={DEBUG:4,LOG:3,INFO:2,WARN:1,ERROR:0,NONE:-1};var r=["error","warn","info","log","debug"],i=0,a=!1,o=!1,s=!1,d=!1,c=[],l={getLogs:function(e){if(void 0===e)return c;for(var t=[],n=0;n<c.length;n++)c[n][1]===r[e]&&t.push(c[n]);return t},clearAllLogs:function(){c=[]},printAllLogs:function(){for(var e=0;e<c.length;e++){var t=c[e][0],n="undefined"!==console[c[e][1]]?c[e][1]:"log",r=c[e][2],i=c[e][3];void 0!==i?console[n](r,i,t):console[n](r,t)}}},p=function(e,t,n){var l="",p=new Date;if("object"==typeof t){if(l+=t[0]?" ["+t[0]+"] -":" -",l+=t[1]?" <<"+t[1]+">>":"",t[2])if(l+=" ","object"==typeof t[2])for(var u=0;u<t[2].length;u++)l+="("+t[2][u]+")";else l+="("+t[2]+")";l+=" "+t[3]}else l+=" - "+t;if(a&&o){var f=[p,r[e],l];void 0!==n&&f.push(n),c.push(f)}if(l="SkylinkJS"+(d?" :: "+p.toISOString():"")+l,i>=e)if(e=void 0===console[r[e]]?3:e,a&&s){void 0===console.trace&&e[3];void 0!==n?(console[r[e]](l,n),void 0!==console.trace&&console.trace("")):(console[r[e]](l),void 0!==console.trace&&console.trace(""))}else void 0!==n?console[r[e]](l,n):console[r[e]](l)},u={debug:function(e,t){p(4,e,t)},log:function(e,t){p(3,e,t)},info:function(e,t){p(2,e,t)},warn:function(e,t){p(1,e,t)},error:function(e,t){p(0,e,t)}};t.prototype.setLogLevel=function(e){for(var t in this.LOG_LEVEL)if(this.LOG_LEVEL[t]===e)return i=e,void u.log([null,"Log",t,"Log level exists. Level is set"]);u.error([null,"Log",t,"Log level does not exist. Level is not set"])},t.prototype.setDebugMode=function(e){e&&"object"==typeof e?(a=!0,s=!0===e.trace,o=!0===e.storeLogs,d=!0===e.printTimestamp):!0===e?(a=!0,s=!0,o=!0,d=!1):(a=!1,s=!1,o=!1,d=!1)};t.prototype.on=function(e,t){"function"==typeof t?(this._EVENTS[e]=this._EVENTS[e]||[],this._EVENTS[e].push(t),u.log([null,"Event",e,"Event is subscribed"])):u.error([null,"Event",e,"Provided parameter is not a function"])},t.prototype.once=function(e,t,n,r){"boolean"==typeof n&&(r=n,n=null),r=void 0!==r&&r,n="function"!=typeof n?function(){return!0}:n,"function"==typeof t?(this._onceEvents[e]=this._onceEvents[e]||[],this._onceEvents[e].push([t,n,r]),u.log([null,"Event",e,"Event is subscribed on condition"])):u.error([null,"Event",e,"Provided callback is not a function"])},t.prototype.off=function(e,t){if(e&&"string"==typeof e){if(void 0===t)return this._EVENTS[e]=[],this._onceEvents[e]=[],void u.log([null,"Event",e,"All events are unsubscribed"]);for(var n=this._EVENTS[e]||[],r=this._onceEvents[e]||[],i=0;i<n.length;i++)if(n[i]===t){u.log([null,"Event",e,"Event is unsubscribed"]),n.splice(i,1);break}if(void 0!==r)for(var a=0;a<r.length;a++)if(r[a][0]===t){u.log([null,"Event",e,"One-time Event is unsubscribed"]),r.splice(a,1);break}}else this._EVENTS={},this._onceEvents={}},t.prototype._trigger=function(e){var t=Array.prototype.slice.call(arguments),n=this._EVENTS[e],r=this._onceEvents[e]||null;if(t.shift(),n)for(var i=0;i<n.length;i++)try{if(u.log([null,"Event",e,"Event is fired"]),!1===n[i].apply(this,t))break}catch(t){throw u.error([null,"Event",e,"Exception occurred in event:"],t),t}if(r)for(var a=0;a<r.length;a++)if(!0===r[a][1].apply(this,t)){if(u.log([null,"Event",e,"Condition is met. Firing event"]),!1===r[a][0].apply(this,t))break;r[a]&&!r[a][2]&&(u.log([null,"Event",e,"Removing event after firing once"]),r.splice(a,1),a--)}else u.log([null,"Event",e,"Condition is still not met. Holding event from being fired"]);u.log([null,"Event",e,"Event is triggered"])},t.prototype._condition=function(e,t,n,r,i){if("boolean"==typeof r&&(i=r,r=null),"function"==typeof t&&"function"==typeof n){if(n())return u.log([null,"Event",e,"First condition is met. Firing callback"]),void t();u.log([null,"Event",e,"First condition is not met. Subscribing to event"]),this.once(e,t,r,i)}else u.error([null,"Event",e,"Provided callback or checkFirst is not a function"])},t.prototype._wait=function(e,t,n,r){if(r=void 0!==r&&r,"function"==typeof e&&"function"==typeof t){if(t())return u.log([null,"Event",null,"Condition is met. Firing callback"]),void e();u.log([null,"Event",null,"Condition is not met. Doing a check."]),n="number"==typeof n?n:50;var i=setInterval(function(){t()&&(u.log([null,"Event",null,"Condition is met after waiting. Firing callback"]),r||clearInterval(i),e())},n)}else"function"!=typeof e&&u.error([null,"Event",null,"Provided callback is not a function"]),"function"!=typeof t&&u.error([null,"Event",null,"Provided condition is not a function"])},t.prototype._throttle=function(e,t,n){var r=this,i=(new Date).getTime();r._timestamp[t]&&i-r._timestamp[t]<n?e(!1):(e(!0),r._timestamp[t]=i)},t.prototype.SOCKET_ERROR={CONNECTION_FAILED:0,RECONNECTION_FAILED:-1,CONNECTION_ABORTED:-2,RECONNECTION_ABORTED:-3,RECONNECTION_ATTEMPT:-4},t.prototype.SOCKET_FALLBACK={NON_FALLBACK:"nonfallback",FALLBACK_PORT:"fallbackPortNonSSL",FALLBACK_SSL_PORT:"fallbackPortSSL",LONG_POLLING:"fallbackLongPollingNonSSL",LONG_POLLING_SSL:"fallbackLongPollingSSL"},t.prototype._sendChannelMessage=function(e){var t=this;if(t._channelOpen&&t._user&&t._socket){t._user.sid&&!t._peerMessagesStamps[t._user.sid]&&(t._peerMessagesStamps[t._user.sid]={userData:0,audioMuted:0,videoMuted:0});var r=function(e){return e.type===t._SIG_MESSAGE_TYPE.UPDATE_USER?!!t._user.sid&&e.stamp>t._peerMessagesStamps[t._user.sid].userData:e.type===t._SIG_MESSAGE_TYPE.MUTE_VIDEO?!!t._user.sid&&e.stamp>t._peerMessagesStamps[t._user.sid].videoMuted:e.type!==t._SIG_MESSAGE_TYPE.MUTE_AUDIO||!!t._user.sid&&e.stamp>t._peerMessagesStamps[t._user.sid].audioMuted},i=function(e){e.type===t._SIG_MESSAGE_TYPE.UPDATE_USER?t._peerMessagesStamps[t._user.sid].userData=e.stamp:e.type===t._SIG_MESSAGE_TYPE.MUTE_VIDEO?t._peerMessagesStamps[t._user.sid].videoMuted=e.stamp:e.type===t._SIG_MESSAGE_TYPE.MUTE_AUDIO&&(t._peerMessagesStamps[t._user.sid].audioMuted=e.stamp)},a=function(){u.debug([null,"Socket",null,"Starting queue timeout"]),t._socketMessageTimeout=setTimeout(function(){if((new Date).getTime()-t._timestamp.socketMessage<=1e3)return u.debug([null,"Socket",null,"Restarting queue timeout"]),void a();d()},1e3-((new Date).getTime()-t._timestamp.socketMessage))},o=function(e){e.type===t._SIG_MESSAGE_TYPE.PUBLIC_MESSAGE&&t._trigger("incomingMessage",{content:e.data,isPrivate:!1,targetPeerId:null,listOfPeers:Object.keys(t._peerInformations),isDataChannel:!1,senderPeerId:t._user.sid},t._user.sid,t.getPeerInfo(),!0)},s=function(a){if(t._socketMessageTimeout=null,t._channelOpen&&t._user&&t._user.sid&&t._socket){for(var s=[],d={userData:0,audioMuted:0,videoMuted:0},c=0;c<a.length;c++)r(a[c])&&(a[c].type===t._SIG_MESSAGE_TYPE.UPDATE_USER&&a[c].stamp>t._peerMessagesStamps[t._user.sid].userData&&a[c].stamp>d.userData?d.userData=a[c].stamp:a[c].type===t._SIG_MESSAGE_TYPE.MUTE_AUDIO&&a[c].stamp>t._peerMessagesStamps[t._user.sid].audioMuted&&a[c].stamp>d.audioMuted?d.audioMuted=a[c].stamp:a[c].type===t._SIG_MESSAGE_TYPE.MUTE_VIDEO&&a[c].stamp>t._peerMessagesStamps[t._user.sid].videoMuted&&a[c].stamp>d.videoMuted&&(d.videoMuted=a[c].stamp));for(var l=0;l<a.length;l++)a[l].type===t._SIG_MESSAGE_TYPE.UPDATE_USER&&a[l].stamp<d.userData||a[l].type===t._SIG_MESSAGE_TYPE.MUTE_AUDIO&&a[l].stamp<d.audioMuted||a[l].type===t._SIG_MESSAGE_TYPE.MUTE_VIDEO&&a[l].stamp<d.videoMuted?(u.warn([e.target||"Server","Socket",a[l],"Dropping of outdated status message ->"],n(a[l])),a.splice(l,1),l--):s.push(JSON.stringify(a[l]));if(s.length>0){var p={type:t._SIG_MESSAGE_TYPE.GROUP,lists:s,mid:t._user.sid,rid:t._room.id};u.log([e.target||"Server","Socket",p.type,"Sending queued grouped message (max: 16 per group) ->"],n(p)),t._socket.send(JSON.stringify(p)),t._timestamp.socketMessage=(new Date).getTime();for(var f=0;f<a.length;f++)i(a[f]),o(a[f])}}else u.warn([e.target||"Server","Socket",null,"Dropping of group messages as Socket connection is not opened or is at incorrect step ->"],a)},d=function(){t._socketMessageQueue.length>0&&(t._socketMessageQueue.length<16?s(t._socketMessageQueue.splice(0,t._socketMessageQueue.length)):(s(t._socketMessageQueue.splice(0,16)),a()))};if(t._groupMessageList.indexOf(e.type)>-1)if(t._timestamp.socketMessage&&(new Date).getTime()-t._timestamp.socketMessage<=1e3)u.debug([e.target||"Server","Socket",e.type,"Queueing socket message to prevent message drop ->"],n(e)),t._socketMessageQueue.push(e),t._socketMessageTimeout||a();else{if(!r(e))return void u.warn([e.target||"Server","Socket",e.type,"Dropping of outdated status message ->"],n(e));t._socketMessageTimeout&&clearTimeout(t._socketMessageTimeout),u.log([e.target||"Server","Socket",e.type,"Sending message ->"],n(e)),t._socket.send(JSON.stringify(e)),i(e),o(e),t._timestamp.socketMessage=(new Date).getTime()}else u.log([e.target||"Server","Socket",e.type,"Sending message ->"],n(e)),t._socket.send(JSON.stringify(e)),e.type===t._SIG_MESSAGE_TYPE.BYE&&t._inRoom&&t._user&&t._user.sid&&e.mid===t._user.sid&&(t.leaveRoom(!1),t._trigger("sessionDisconnect",t._user.sid,t.getPeerInfo()))}else u.warn([e.target||"Server","Socket",e.type,"Dropping of message as Socket connection is not opened or is at incorrect step ->"],e)},t.prototype._createSocket=function(e,t){var r=this,i={forceNew:!0,reconnection:!0,timeout:r._socketTimeout,reconnectionAttempts:2,reconnectionDelayMax:5e3,reconnectionDelay:1e3,transports:["websocket"]},a=r._socketServer&&"object"==typeof r._socketServer&&Array.isArray(r._socketServer.ports)&&r._socketServer.ports.length>0?r._socketServer.ports:r._socketPorts[r._signalingServerProtocol],o=null;null===r._signalingServerPort?(r._signalingServerPort=a[0],o=r.SOCKET_FALLBACK.NON_FALLBACK):a.indexOf(r._signalingServerPort)===a.length-1||"string"==typeof r._socketServer?"WebSocket"===e?(e="Polling",r._signalingServerPort=a[0]):r._socketSession.finalAttempts++:r._signalingServerPort=a[a.indexOf(r._signalingServerPort)+1],"Polling"===e&&(i.reconnectionDelayMax=1e3,i.reconnectionAttempts=4,i.transports=["xhr-polling","jsonp-polling","polling"]);var s=r._signalingServerProtocol+"//"+r._signalingServer+":"+r._signalingServerPort+"?rand="+Date.now(),d=0;r._socketServer&&(s="string"==typeof r._socketServer?r._socketServer:(r._socketServer.protocol?r._socketServer.protocol:r._signalingServerProtocol)+"//"+r._socketServer.url+":"+r._signalingServerPort),r._socketSession.transportType=e,r._socketSession.socketOptions=i,r._socketSession.socketServer=s,null===o&&(o="http:"===r._signalingServerProtocol?"Polling"===e?r.SOCKET_FALLBACK.LONG_POLLING:r.SOCKET_FALLBACK.FALLBACK_PORT:"Polling"===e?r.SOCKET_FALLBACK.LONG_POLLING_SSL:r.SOCKET_FALLBACK.FALLBACK_SSL_PORT,r._socketSession.attempts++,r._trigger("socketError",r.SOCKET_ERROR.RECONNECTION_ATTEMPT,null,o,n(r._socketSession)),r._trigger("channelRetry",o,r._socketSession.attempts,n(r._socketSession))),r._socket&&r._closeChannel(),r._channelOpen=!1,u.log("Opening channel with signaling server url:",n(r._socketSession));var c=null;try{c=io.connect(s,i)}catch(e){return u.error("Failed creating socket connection object ->",e),o===r.SOCKET_FALLBACK.NON_FALLBACK?r._trigger("socketError",r.SOCKET_ERROR.CONNECTION_FAILED,e,o,n(r._socketSession)):r._trigger("socketError",r.SOCKET_ERROR.RECONNECTION_FAILED,e,o,n(r._socketSession)),void r._trigger("socketError",r.SOCKET_ERROR.RECONNECTION_ABORTED,new Error("Reconnection aborted as there no more available ports, transports and final attempts left."),o,n(r._socketSession))}c.on("reconnect_attempt",function(e){d++,r._socketSession.attempts++,r._trigger("channelRetry",o,r._socketSession.attempts,n(r._socketSession))}),c.on("reconnect_failed",function(){o===r.SOCKET_FALLBACK.NON_FALLBACK?r._trigger("socketError",r.SOCKET_ERROR.CONNECTION_FAILED,new Error('Failed connection with transport "'+e+'" and port '+r._signalingServerPort+"."),o,n(r._socketSession)):r._trigger("socketError",r.SOCKET_ERROR.RECONNECTION_FAILED,new Error('Failed reconnection with transport "'+e+'" and port '+r._signalingServerPort+"."),o,n(r._socketSession)),r._socketSession.finalAttempts<2?r._createSocket(e,t):r._trigger("socketError",r.SOCKET_ERROR.RECONNECTION_ABORTED,new Error("Reconnection aborted as there no more available ports, transports and final attempts left."),o,n(r._socketSession))}),c.on("connect",function(){r._channelOpen||(u.log([null,"Socket",null,"Channel opened"]),r._channelOpen=!0,r._trigger("channelOpen",n(r._socketSession)))}),c.on("reconnect",function(){r._channelOpen||(u.log([null,"Socket",null,"Channel opened"]),r._channelOpen=!0,r._trigger("channelOpen",n(r._socketSession)))}),c.on("error",function(e){if(e&&e.message.indexOf("xhr poll error")>-1)return u.error([null,"Socket",null,"XHR poll connection unstable. Disconnecting.. ->"],e),void r._closeChannel();u.error([null,"Socket",null,"Exception occurred ->"],e),r._trigger("channelError",e,n(r._socketSession))}),c.on("disconnect",function(){r._channelOpen&&(r._channelOpen=!1,r._trigger("channelClose",n(r._socketSession)),u.log([null,"Socket",null,"Channel closed"]),r._inRoom&&r._user&&r._user.sid&&(r.leaveRoom(!1),r._trigger("sessionDisconnect",r._user.sid,r.getPeerInfo())))}),c.on("message",function(e){var t=JSON.parse(e);if(u.log([null,"Socket",null,"Received message ->"],t),t.type===r._SIG_MESSAGE_TYPE.GROUP){u.debug("Bundle of "+t.lists.length+" messages");for(var i=0;i<t.lists.length;i++){var a=JSON.parse(t.lists[i]);r._processSigMessage(a),r._trigger("channelMessage",a,n(r._socketSession))}}else r._processSigMessage(t),r._trigger("channelMessage",t,n(r._socketSession))}),r._joinRoomManager.socketsFn.push(function(e){e!==t&&c.disconnect()}),r._socket=c},t.prototype._openChannel=function(e){var t=this;if(t._channelOpen)u.error([null,"Socket",null,"Unable to instantiate a new channel connection as there is already an ongoing channel connection"]);else if(t._readyState===t.READY_STATE_CHANGE.COMPLETED){t._forceSSL?t._signalingServerProtocol="https:":t._signalingServerProtocol=window.location.protocol;var n="WebSocket";window.WebSocket||(n="Polling"),t._socketSession.finalAttempts=0,t._socketSession.attempts=0,t._signalingServerPort=null,t._createSocket(n,e)}else u.error([null,"Socket",null,"Unable to instantiate a new channel connection as readyState is not ready"])},t.prototype._closeChannel=function(){this._socket&&(this._socket.removeAllListeners("connect_error"),this._socket.removeAllListeners("reconnect_attempt"),this._socket.removeAllListeners("reconnect_error"),this._socket.removeAllListeners("reconnect_failed"),this._socket.removeAllListeners("connect"),this._socket.removeAllListeners("reconnect"),this._socket.removeAllListeners("error"),this._socket.removeAllListeners("disconnect"),this._socket.removeAllListeners("message")),this._channelOpen&&(this._socket&&this._socket.disconnect(),u.log([null,"Socket",null,"Channel closed"]),this._channelOpen=!1,this._trigger("channelClose",n(this._socketSession)),this._inRoom&&this._user&&this._user.sid&&(this.leaveRoom(!1),this._trigger("sessionDisconnect",this._user.sid,this.getPeerInfo()))),this._socket=null},t.prototype.SM_PROTOCOL_VERSION="0.1.2.4",t.prototype._SIG_MESSAGE_TYPE={JOIN_ROOM:"joinRoom",IN_ROOM:"inRoom",ENTER:"enter",WELCOME:"welcome",RESTART:"restart",OFFER:"offer",ANSWER:"answer",CANDIDATE:"candidate",BYE:"bye",REDIRECT:"redirect",UPDATE_USER:"updateUserEvent",ROOM_LOCK:"roomLockEvent",MUTE_VIDEO:"muteVideoEvent",MUTE_AUDIO:"muteAudioEvent",PUBLIC_MESSAGE:"public",PRIVATE_MESSAGE:"private",STREAM:"stream",GROUP:"group",GET_PEERS:"getPeers",PEER_LIST:"peerList",INTRODUCE:"introduce",INTRODUCE_ERROR:"introduceError",APPROACH:"approach",START_RECORDING:"startRecordingRoom",STOP_RECORDING:"stopRecordingRoom",RECORDING:"recordingEvent",END_OF_CANDIDATES:"endOfCandidates"},t.prototype._groupMessageList=[t.prototype._SIG_MESSAGE_TYPE.STREAM,t.prototype._SIG_MESSAGE_TYPE.UPDATE_USER,t.prototype._SIG_MESSAGE_TYPE.MUTE_AUDIO,t.prototype._SIG_MESSAGE_TYPE.MUTE_VIDEO,t.prototype._SIG_MESSAGE_TYPE.PUBLIC_MESSAGE],t.prototype.sendMessage=function(e,t){var n=Object.keys(this._peerInformations),r=!1;if(Array.isArray(t)?(n=t,r=!0):t&&"string"==typeof t&&(n=[t],r=!0),this._inRoom&&this._socket&&this._user){for(var i=0;i<n.length;i++){var a=n[i];this._peerInformations[a]?"MCU"===a?(n.splice(i,1),i--):r&&(u.debug([a,"Socket",null,"Sending private message to Peer"]),this._sendChannelMessage({cid:this._key,data:e,mid:this._user.sid,rid:this._room.id,target:a,type:this._SIG_MESSAGE_TYPE.PRIVATE_MESSAGE})):(u.error([a,"Socket",null,"Dropping of sending message to Peer as Peer session does not exists"]),n.splice(i,1),i--)}0===n.length&&u.warn("Currently there are no Peers to send message to (unless the message is queued and there are Peer connected by then)."),r?this._trigger("incomingMessage",{content:e,isPrivate:r,targetPeerId:t||null,listOfPeers:n,isDataChannel:!1,senderPeerId:this._user.sid},this._user.sid,this.getPeerInfo(),!0):(u.debug([null,"Socket",null,"Broadcasting message to Peers"]),this._sendChannelMessage({cid:this._key,data:e,mid:this._user.sid,rid:this._room.id,type:this._SIG_MESSAGE_TYPE.PUBLIC_MESSAGE}))}else u.error("Unable to send message as User is not in Room. ->",e)},t.prototype.startRecording=function(e){var t=this;if(!t._hasMCU){var n="Unable to start recording as MCU is not connected";return u.error(n),void("function"==typeof e&&e(new Error(n),null))}if(t._currentRecordingId){return u.error("Unable to start recording as there is an existing recording in-progress"),void("function"==typeof e&&e(new Error("Unable to start recording as there is an existing recording in-progress"),null))}"function"==typeof e&&t.once("recordingState",function(t,n){e(null,n)},function(e){return e===t.RECORDING_STATE.START}),t._sendChannelMessage({type:t._SIG_MESSAGE_TYPE.START_RECORDING,rid:t._room.id,target:"MCU"}),u.debug(["MCU","Recording",null,"Starting recording"])},t.prototype.stopRecording=function(e,t){var n=this;if(!n._hasMCU){var r="Unable to stop recording as MCU is not connected";return u.error(r),void("function"==typeof e&&e(new Error(r),null))}if(!n._currentRecordingId){return u.error("Unable to stop recording as there is no recording in-progress"),void("function"==typeof e&&e(new Error("Unable to stop recording as there is no recording in-progress"),null))}if(n._recordingStartInterval){return u.error("Unable to stop recording as 4 seconds has not been recorded yet"),void("function"==typeof e&&e(new Error("Unable to stop recording as 4 seconds has not been recorded yet"),null))}if("function"==typeof e){var i=n._currentRecordingId;n.once("recordingState",function(n,r,i,a){if(t)return a?void e(a,null):void e(null,{link:i,recordingId:r});e(null,r)},function(e,r){if(i===r)return t?[n.RECORDING_STATE.LINK,n.RECORDING_STATE.ERROR].indexOf(e)>-1:e===n.RECORDING_STATE.STOP})}n._sendChannelMessage({type:n._SIG_MESSAGE_TYPE.STOP_RECORDING,rid:n._room.id,target:"MCU"}),u.debug(["MCU","Recording",null,"Stopping recording"])},t.prototype.getRecordings=function(){return n(this._recordings)},t.prototype._processSigMessage=function(e,t){var r=e.mid;if(r&&r!==this._user.sid||(r="Server"),u.debug([r,"Socket",e.type,"Received from peer ->"],n(e)),e.mid!==this._user.sid||e.type===this._SIG_MESSAGE_TYPE.REDIRECT||e.type===this._SIG_MESSAGE_TYPE.IN_ROOM)switch(e.type){case this._SIG_MESSAGE_TYPE.PUBLIC_MESSAGE:this._publicMessageHandler(e);break;case this._SIG_MESSAGE_TYPE.PRIVATE_MESSAGE:this._privateMessageHandler(e);break;case this._SIG_MESSAGE_TYPE.IN_ROOM:this._inRoomHandler(e);break;case this._SIG_MESSAGE_TYPE.ENTER:this._enterHandler(e);break;case this._SIG_MESSAGE_TYPE.WELCOME:this._welcomeHandler(e);break;case this._SIG_MESSAGE_TYPE.RESTART:this._restartHandler(e);break;case this._SIG_MESSAGE_TYPE.OFFER:this._offerHandler(e);break;case this._SIG_MESSAGE_TYPE.ANSWER:this._answerHandler(e);break;case this._SIG_MESSAGE_TYPE.CANDIDATE:this._candidateHandler(e);break;case this._SIG_MESSAGE_TYPE.BYE:this._byeHandler(e);break;case this._SIG_MESSAGE_TYPE.REDIRECT:this._redirectHandler(e);break;case this._SIG_MESSAGE_TYPE.UPDATE_USER:this._updateUserEventHandler(e);break;case this._SIG_MESSAGE_TYPE.MUTE_VIDEO:this._muteVideoEventHandler(e);break;case this._SIG_MESSAGE_TYPE.MUTE_AUDIO:this._muteAudioEventHandler(e);break;case this._SIG_MESSAGE_TYPE.STREAM:this._streamEventHandler(e);break;case this._SIG_MESSAGE_TYPE.ROOM_LOCK:this._roomLockEventHandler(e);break;case this._SIG_MESSAGE_TYPE.PEER_LIST:this._peerListEventHandler(e);break;case this._SIG_MESSAGE_TYPE.INTRODUCE_ERROR:this._introduceErrorEventHandler(e);break;case this._SIG_MESSAGE_TYPE.APPROACH:this._approachEventHandler(e);break;case this._SIG_MESSAGE_TYPE.RECORDING:this._recordingEventHandler(e);break;case this._SIG_MESSAGE_TYPE.END_OF_CANDIDATES:this._endOfCandidatesHandler(e);break;default:u.error([e.mid,"Socket",e.type,"Unsupported message ->"],n(e))}else u.debug([r,"Socket",e.type,"Ignoring message ->"],n(e))},t.prototype._peerListEventHandler=function(e){var t=this;t._peerList=e.result,u.log(["Server",null,e.type,"Received list of peers"],t._peerList),t._trigger("getPeersStateChange",t.GET_PEERS_STATE.RECEIVED,t._user.sid,t._peerList)},t.prototype._endOfCandidatesHandler=function(e){var t=this,n=e.mid;t._peerConnections[n]&&t._peerConnections[n].signalingState!==t.PEER_CONNECTION_STATE.CLOSED&&(t._peerEndOfCandidatesCounter[n].expectedLen=e.noOfExpectedCandidates||0,t._signalingEndOfCandidates(n))},t.prototype._introduceErrorEventHandler=function(e){var t=this;u.log(["Server",null,e.type,"Introduce failed. Reason: "+e.reason]),t._trigger("introduceStateChange",t.INTRODUCE_STATE.ERROR,t._user.sid,e.sendingPeerId,e.receivingPeerId,e.reason)},t.prototype._approachEventHandler=function(e){var t=this;u.log(["Server",null,e.type,"Approaching peer"],e.target),t._trigger("handshakeProgress",t.HANDSHAKE_PROGRESS.ENTER,t._user.sid);var n={type:t._SIG_MESSAGE_TYPE.ENTER,mid:t._user.sid,rid:t._room.id,agent:AdapterJS.webrtcDetectedBrowser,version:(AdapterJS.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:t._getUserInfo(),receiveOnly:t.getPeerInfo().config.receiveOnly,target:e.target,weight:t._peerPriorityWeight,temasysPluginVersion:AdapterJS.WebRTCPlugin.plugin?AdapterJS.WebRTCPlugin.plugin.VERSION:null,enableIceTrickle:t._enableIceTrickle,enableDataChannel:t._enableDataChannel,enableIceRestart:t._enableIceRestart,SMProtocolVersion:t.SM_PROTOCOL_VERSION,DTProtocolVersion:t.DT_PROTOCOL_VERSION};t._publishOnly&&(n.publishOnly={type:t._streams.screenshare&&t._streams.screenshare.stream?"screenshare":"video"}),t._parentId&&(n.parentId=t._parentId),t._sendChannelMessage(n)},t.prototype._redirectHandler=function(e){if(u.log(["Server",null,e.type,"System action warning:"],{message:e.info,reason:e.reason,action:e.action}),e.action===this.SYSTEM_ACTION.REJECT)for(var t in this._peerConnections)this._peerConnections.hasOwnProperty(t)&&this._removePeer(t);"toClose"===e.reason&&(e.reason="toclose"),this._trigger("systemAction",e.action,e.info,e.reason)},t.prototype._updateUserEventHandler=function(e){var t=e.mid;if(u.log([t,null,e.type,"Peer updated userData:"],e.userData),this._peerInformations[t]){if(this._peerMessagesStamps[t]&&"number"==typeof e.stamp){if(e.stamp<this._peerMessagesStamps[t].userData)return void u.warn([t,null,e.type,"Dropping outdated status ->"],e);this._peerMessagesStamps[t].userData=e.stamp}this._peerInformations[t].userData=e.userData||{},this._trigger("peerUpdated",t,this.getPeerInfo(t),!1)}else u.log([t,null,e.type,"Peer does not have any user information"])},t.prototype._roomLockEventHandler=function(e){var t=e.mid;u.log([t,e.type,"Room lock status:"],e.lock),this._trigger("roomLock",e.lock,t,this.getPeerInfo(t),!1)},t.prototype._muteAudioEventHandler=function(e){var t=e.mid;if(u.log([t,null,e.type,"Peer's audio muted:"],e.muted),this._peerInformations[t]){if(this._peerMessagesStamps[t]&&"number"==typeof e.stamp){if(e.stamp<this._peerMessagesStamps[t].audioMuted)return void u.warn([t,null,e.type,"Dropping outdated status ->"],e);this._peerMessagesStamps[t].audioMuted=e.stamp}this._peerInformations[t].mediaStatus.audioMuted=e.muted,this._trigger("streamMuted",t,this.getPeerInfo(t),!1,this._peerInformations[t].settings.video&&this._peerInformations[t].settings.video.screenshare),this._trigger("peerUpdated",t,this.getPeerInfo(t),!1)}else u.log([t,e.type,"Peer does not have any user information"])},t.prototype._muteVideoEventHandler=function(e){var t=e.mid;if(u.log([t,null,e.type,"Peer's video muted:"],e.muted),this._peerInformations[t]){if(this._peerMessagesStamps[t]&&"number"==typeof e.stamp){if(e.stamp<this._peerMessagesStamps[t].videoMuted)return void u.warn([t,null,e.type,"Dropping outdated status ->"],e);this._peerMessagesStamps[t].videoMuted=e.stamp}this._peerInformations[t].mediaStatus.videoMuted=e.muted,this._trigger("streamMuted",t,this.getPeerInfo(t),!1,this._peerInformations[t].settings.video&&this._peerInformations[t].settings.video.screenshare),this._trigger("peerUpdated",t,this.getPeerInfo(t),!1)}else u.log([t,null,e.type,"Peer does not have any user information"])},t.prototype._streamEventHandler=function(e){var t=e.mid;u.log([t,null,e.type,"Peer's stream status:"],e.status),this._peerInformations[t]&&e.streamId?(this._streamsSession[t]=this._streamsSession[t]||{},"ended"===e.status&&(e.settings&&"object"==typeof e.settings&&void 0===this._streamsSession[t][e.streamId]&&(this._streamsSession[t][e.streamId]={audio:e.settings.audio,video:e.settings.video}),this._handleEndedStreams(t,e.streamId))):u.log([t,null,e.type,"Peer does not have any user information"])},t.prototype._byeHandler=function(e){var t=e.mid;(this._user||{}).sid!==t?(u.log([t,null,e.type,"Peer has left the room"]),this._removePeer(t)):u.log([t,null,e.type,"Self has left the room"])},t.prototype._privateMessageHandler=function(e){var t=e.mid;u.log([t,null,e.type,"Received private message from peer:"],e.data),this._trigger("incomingMessage",{content:e.data,isPrivate:!0,targetPeerId:e.target,isDataChannel:!1,senderPeerId:t},t,this.getPeerInfo(t),!1)},t.prototype._publicMessageHandler=function(e){var t=e.mid;u.log([t,null,e.type,"Received public message from peer:"],e.data),this._trigger("incomingMessage",{content:e.data,isPrivate:!1,targetPeerId:null,isDataChannel:!1,senderPeerId:t},t,this.getPeerInfo(t),!1)},t.prototype._recordingEventHandler=function(e){var t=this;if(u.debug(["MCU","Recording",null,"Received recording message ->"],e),"on"===e.action)t._recordings[e.recordingId]||(u.debug(["MCU","Recording",e.recordingId,"Started recording"]),t._currentRecordingId=e.recordingId,t._recordings[e.recordingId]={active:!0,state:t.RECORDING_STATE.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,mixingDateTime:null,links:null,error:null},t._recordingStartInterval=setTimeout(function(){u.log(["MCU","Recording",e.recordingId,"4 seconds has been recorded. Recording can be stopped now"]),t._recordingStartInterval=null},4e3),t._trigger("recordingState",t.RECORDING_STATE.START,e.recordingId,null,null));else if("off"===e.action){if(!t._recordings[e.recordingId])return void u.error(["MCU","Recording",e.recordingId,'Received request of "off" but the session is empty']);t._currentRecordingId=null,t._recordingStartInterval&&(clearTimeout(t._recordingStartInterval),u.warn(["MCU","Recording",e.recordingId,"Recording stopped abruptly before 4 seconds"]),t._recordingStartInterval=null),u.debug(["MCU","Recording",e.recordingId,"Stopped recording"]),t._recordings[e.recordingId].active=!1,t._recordings[e.recordingId].state=t.RECORDING_STATE.STOP,t._recordings[e.recordingId].endedDateTime=(new Date).toISOString(),t._trigger("recordingState",t.RECORDING_STATE.STOP,e.recordingId,null,null)}else if("url"===e.action){if(!t._recordings[e.recordingId])return void u.error(["MCU","Recording",e.recordingId,"Received URL but the session is empty"]);var n={};if(Array.isArray(e.urls))for(var r=0;r<e.urls.length;r++)n[messages.urls[r].id||""]=messages.urls[r].url||"";else"string"==typeof e.url&&(n.mixin=e.url);t._recordings[e.recordingId].links=n,t._recordings[e.recordingId].state=t.RECORDING_STATE.LINK,t._recordings[e.recordingId].mixingDateTime=(new Date).toISOString(),t._trigger("recordingState",t.RECORDING_STATE.LINK,e.recordingId,n,null)}else{var i=new Error(e.error||"Unknown error");if(!t._recordings[e.recordingId])return void u.error(["MCU","Recording",e.recordingId,"Received error but the session is empty ->"],i);u.error(["MCU","Recording",e.recordingId,"Recording failure ->"],i),t._recordings[e.recordingId].state=t.RECORDING_STATE.ERROR,t._recordings[e.recordingId].error=i,t._recordings[e.recordingId].active&&(u.debug(["MCU","Recording",e.recordingId,"Stopped recording abruptly"]),t._recordings[e.recordingId].active=!1),t._trigger("recordingState",t.RECORDING_STATE.ERROR,e.recordingId,null,i)}},t.prototype._inRoomHandler=function(e){var t=this;u.log(["Server",null,e.type,"User is now in the room and functionalities are now available. Config received:"],e.pc_config),t._room.connection.peerConfig=t._setIceServers((e.pc_config||{}).iceServers||[]),t._inRoom=!0,t._user.sid=e.sid,t._peerPriorityWeight=e.tieBreaker+(t._priorityWeightScheme===t.PRIORITY_WEIGHT_SCHEME.AUTO?0:t._priorityWeightScheme===t.PRIORITY_WEIGHT_SCHEME.ENFORCE_OFFERER?2e15:-2e15),t._trigger("peerJoined",t._user.sid,t.getPeerInfo(),!0),t._trigger("handshakeProgress",t.HANDSHAKE_PROGRESS.ENTER,t._user.sid);var n=null;t._streams.screenshare&&t._streams.screenshare.stream?(n=t._streams.screenshare.stream.id||t._streams.screenshare.stream.label,t._trigger("incomingStream",t._user.sid,t._streams.screenshare.stream,!0,t.getPeerInfo(),!0,n)):t._streams.userMedia&&t._streams.userMedia.stream&&(n=t._streams.userMedia.stream.id||t._streams.userMedia.stream.label,t._trigger("incomingStream",t._user.sid,t._streams.userMedia.stream,!0,t.getPeerInfo(),!1,n));var r={type:t._SIG_MESSAGE_TYPE.ENTER,mid:t._user.sid,rid:t._room.id,agent:AdapterJS.webrtcDetectedBrowser,version:(AdapterJS.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:t._getUserInfo(),receiveOnly:t.getPeerInfo().config.receiveOnly,weight:t._peerPriorityWeight,temasysPluginVersion:AdapterJS.WebRTCPlugin.plugin?AdapterJS.WebRTCPlugin.plugin.VERSION:null,enableIceTrickle:t._enableIceTrickle,enableDataChannel:t._enableDataChannel,enableIceRestart:t._enableIceRestart,SMProtocolVersion:t.SM_PROTOCOL_VERSION,DTProtocolVersion:t.DT_PROTOCOL_VERSION};t._publishOnly&&(r.publishOnly={type:t._streams.screenshare&&t._streams.screenshare.stream?"screenshare":"video"}),t._parentId&&(r.parentId=t._parentId),t._sendChannelMessage(r)},t.prototype._enterHandler=function(e){var t=this,n=e.mid,r=!1,i=e.userInfo||{};if(i.settings=i.settings||{},i.mediaStatus=i.mediaStatus||{},i.config={enableIceTrickle:"boolean"!=typeof e.enableIceTrickle||e.enableIceTrickle,enableIceRestart:"boolean"==typeof e.enableIceRestart&&e.enableIceRestart,enableDataChannel:"boolean"!=typeof e.enableDataChannel||e.enableDataChannel,priorityWeight:"number"==typeof e.weight?e.weight:0,receiveOnly:!0===e.receiveOnly,publishOnly:!!e.publishOnly},i.parentId=e.parentId||null,i.agent={name:"string"==typeof e.agent&&e.agent?e.agent:"other",version:function(){if(!e.version||"string"!=typeof e.version)return 0;if(e.version.indexOf(".")>-1){var t=e.version.split(".");if(t.length>2){var n=t[0]||"0";return t.splice(0,1),parseFloat(n+"."+t.join("0"),10)}return parseFloat(e.version||"0",10)}return parseInt(e.version||"0",10)}(),os:"string"==typeof e.os&&e.os?e.os:"",pluginVersion:"string"==typeof e.temasysPluginVersion&&e.temasysPluginVersion?e.temasysPluginVersion:null,SMProtocolVersion:e.SMProtocolVersion&&"string"==typeof e.SMProtocolVersion?e.SMProtocolVersion:"0.1.1",DTProtocolVersion:e.DTProtocolVersion&&"string"==typeof e.DTProtocolVersion?e.DTProtocolVersion:t._hasMCU||"MCU"===n?"0.1.2":"0.1.0"},u.log([n,"RTCPeerConnection",null,'Peer "enter" received ->'],e),"MCU"!==n&&(t._parentId&&t._parentId===n||t._hasMCU&&t._publishOnly||e.parentId&&t._user&&t._user.sid&&e.parentId===t._user.sid))u.warn([n,"RTCPeerConnection",null,'Discarding "enter" for parentId or publishOnly case ->'],e);else{var a=function(a){if(!t._peerInformations[n]){r=!0,t._peerInformations[n]=i;var o=i.settings.video&&"object"==typeof i.settings.video&&!!i.settings.video.screenshare;t._addPeer(n,a||null,{agent:i.agent.name,version:i.agent.version,os:i.agent.os},e.receiveOnly,o),"MCU"===n?(u.info([n,"RTCPeerConnection",null,"MCU feature has been enabled"]),t._hasMCU=!0,t._trigger("serverPeerJoined",n,t.SERVER_PEER_TYPE.MCU)):t._trigger("peerJoined",n,t.getPeerInfo(n),!1),t._trigger("handshakeProgress",t.HANDSHAKE_PROGRESS.ENTER,n)}t._peerMessagesStamps[n]=t._peerMessagesStamps[n]||{userData:0,audioMuted:0,videoMuted:0};var s={type:t._SIG_MESSAGE_TYPE.WELCOME,mid:t._user.sid,rid:t._room.id,enableIceTrickle:t._enableIceTrickle,enableDataChannel:t._enableDataChannel,enableIceRestart:t._enableIceRestart,agent:AdapterJS.webrtcDetectedBrowser,version:(AdapterJS.webrtcDetectedVersion||0).toString(),receiveOnly:t.getPeerInfo().config.receiveOnly,os:window.navigator.platform,userInfo:t._getUserInfo(n),target:n,weight:t._peerPriorityWeight,temasysPluginVersion:AdapterJS.WebRTCPlugin.plugin?AdapterJS.WebRTCPlugin.plugin.VERSION:null,SMProtocolVersion:t.SM_PROTOCOL_VERSION,DTProtocolVersion:t.DT_PROTOCOL_VERSION};t._publishOnly&&(s.publishOnly={type:t._streams.screenshare&&t._streams.screenshare.stream?"screenshare":"video"}),t._parentId&&(s.parentId=t._parentId),t._sendChannelMessage(s),r&&t._trigger("handshakeProgress",t.HANDSHAKE_PROGRESS.WELCOME,n)};if(t._peerConnectionConfig.certificate!==t.PEER_CERTIFICATE.AUTO&&"function"==typeof RTCPeerConnection.generateCertificate){var o={};o=t._peerConnectionConfig.certificate===t.PEER_CERTIFICATE.ECDSA?{name:"ECDSA",namedCurve:"P-256"}:{name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},RTCPeerConnection.generateCertificate(o).then(function(e){a(e)},function(){a()})}else a()}},t.prototype._restartHandler=function(e){var t=this,n=e.mid,r=e.userInfo||{};if(r.settings=r.settings||{},r.mediaStatus=r.mediaStatus||{},r.config={enableIceTrickle:"boolean"!=typeof e.enableIceTrickle||e.enableIceTrickle,enableIceRestart:"boolean"==typeof e.enableIceRestart&&e.enableIceRestart,enableDataChannel:"boolean"!=typeof e.enableDataChannel||e.enableDataChannel,priorityWeight:"number"==typeof e.weight?e.weight:0,receiveOnly:!0===e.receiveOnly,publishOnly:!!e.publishOnly},r.parentId=e.parentId||null,r.agent={name:"string"==typeof e.agent&&e.agent?e.agent:"other",version:function(){if(!e.version||"string"!=typeof e.version)return 0;if(e.version.indexOf(".")>-1){var t=e.version.split(".");if(t.length>2){var n=t[0]||"0";return t.splice(0,1),parseFloat(n+"."+t.join("0"),10)}return parseFloat(e.version||"0",10)}return parseInt(e.version||"0",10)}(),os:"string"==typeof e.os&&e.os?e.os:"",pluginVersion:"string"==typeof e.temasysPluginVersion&&e.temasysPluginVersion?e.temasysPluginVersion:null,SMProtocolVersion:e.SMProtocolVersion&&"string"==typeof e.SMProtocolVersion?e.SMProtocolVersion:"0.1.1",DTProtocolVersion:e.DTProtocolVersion&&"string"==typeof e.DTProtocolVersion?e.DTProtocolVersion:t._hasMCU||"MCU"===n?"0.1.2":"0.1.0"},u.log([n,"RTCPeerConnection",null,'Peer "restart" received ->'],e),t._peerInformations[n])if("MCU"!==n&&(t._parentId&&t._parentId===n||t._hasMCU&&t._publishOnly||e.parentId&&t._user&&t._user.sid&&e.parentId===t._user.sid))u.warn([n,"RTCPeerConnection",null,'Discarding "restart" for parentId or publishOnly case ->'],e);else{if(t._hasMCU&&!t._mcuUseRenegoRestart)return u.warn([n,"RTCPeerConnection",null,"Dropping restart request as MCU does not support re-negotiation. Restart workaround is to re-join Room for Peer."]),void t._trigger("peerRestart",n,t.getPeerInfo(n),!1,!1);if(t._peerInformations[n]=r,t._peerMessagesStamps[n]=t._peerMessagesStamps[n]||{userData:0,audioMuted:0,videoMuted:0},t._peerEndOfCandidatesCounter[n]=t._peerEndOfCandidatesCounter[n]||{},t._peerEndOfCandidatesCounter[n].len=0,t._peerPriorityWeight>e.weight){if(u.debug([n,"RTCPeerConnection",null,"Re-negotiating new offer/answer."]),t._peerMessagesStamps[n].hasRestart)return void u.warn([n,"RTCPeerConnection",null,'Discarding extra "restart" received.']);t._peerMessagesStamps[n].hasRestart=!0,t._doOffer(n,!0===e.doIceRestart,{agent:r.agent.name,version:r.agent.version,os:r.agent.os},!0)}else{u.debug([n,"RTCPeerConnection",null,"Waiting for peer to start re-negotiation."]);var i={type:t._SIG_MESSAGE_TYPE.RESTART,mid:t._user.sid,rid:t._room.id,agent:AdapterJS.webrtcDetectedBrowser,version:(AdapterJS.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:t._getUserInfo(n),target:n,weight:t._peerPriorityWeight,enableIceTrickle:t._enableIceTrickle,enableDataChannel:t._enableDataChannel,enableIceRestart:t._enableIceRestart,doIceRestart:!0===e.doIceRestart,receiveOnly:t.getPeerInfo().config.receiveOnly,isRestartResend:!0,temasysPluginVersion:AdapterJS.WebRTCPlugin.plugin?AdapterJS.WebRTCPlugin.plugin.VERSION:null,SMProtocolVersion:t.SM_PROTOCOL_VERSION,DTProtocolVersion:t.DT_PROTOCOL_VERSION};t._publishOnly&&(i.publishOnly={type:t._streams.screenshare&&t._streams.screenshare.stream?"screenshare":"video"}),t._parentId&&(i.parentId=t._parentId),t._sendChannelMessage(i)}t._trigger("peerRestart",n,t.getPeerInfo(n),!1,!0===e.doIceRestart)}else u.error([n,"RTCPeerConnection",null,"Peer does not have an existing session. Ignoring restart process."])},t.prototype._welcomeHandler=function(e){var t=this,n=e.mid,r=!1,i=e.userInfo||{};if(i.settings=i.settings||{},i.mediaStatus=i.mediaStatus||{},i.config={enableIceTrickle:"boolean"!=typeof e.enableIceTrickle||e.enableIceTrickle,enableIceRestart:"boolean"==typeof e.enableIceRestart&&e.enableIceRestart,enableDataChannel:"boolean"!=typeof e.enableDataChannel||e.enableDataChannel,priorityWeight:"number"==typeof e.weight?e.weight:0,receiveOnly:!0===e.receiveOnly,publishOnly:!!e.publishOnly},i.parentId=e.parentId||null,i.agent={name:"string"==typeof e.agent&&e.agent?e.agent:"other",version:function(){if(!e.version||"string"!=typeof e.version)return 0;if(e.version.indexOf(".")>-1){var t=e.version.split(".");if(t.length>2){var n=t[0]||"0";return t.splice(0,1),parseFloat(n+"."+t.join("0"),10)}return parseFloat(e.version||"0",10)}return parseInt(e.version||"0",10)}(),os:"string"==typeof e.os&&e.os?e.os:"",pluginVersion:"string"==typeof e.temasysPluginVersion&&e.temasysPluginVersion?e.temasysPluginVersion:null,SMProtocolVersion:e.SMProtocolVersion&&"string"==typeof e.SMProtocolVersion?e.SMProtocolVersion:"0.1.1",DTProtocolVersion:e.DTProtocolVersion&&"string"==typeof e.DTProtocolVersion?e.DTProtocolVersion:t._hasMCU||"MCU"===n?"0.1.2":"0.1.0"},u.log([n,"RTCPeerConnection",null,'Peer "welcome" received ->'],e),"MCU"!==n&&(t._parentId&&t._parentId===n||t._hasMCU&&t._publishOnly||e.parentId&&t._user&&t._user.sid&&e.parentId===t._user.sid))u.warn([n,"RTCPeerConnection",null,'Discarding "welcome" for parentId or publishOnly case ->'],e);else{var a=function(a){if(!t._peerInformations[n]){r=!0,t._peerInformations[n]=i;var o=i.settings.video&&"object"==typeof i.settings.video&&!!i.settings.video.screenshare;t._addPeer(n,a||null,{agent:i.agent.name,version:i.agent.version,os:i.agent.os},e.receiveOnly,o),"MCU"===n?(u.info([n,"RTCPeerConnection",null,"MCU feature has been enabled"]),t._hasMCU=!0,t._trigger("serverPeerJoined",n,t.SERVER_PEER_TYPE.MCU)):t._trigger("peerJoined",n,t.getPeerInfo(n),!1),t._trigger("handshakeProgress",t.HANDSHAKE_PROGRESS.ENTER,n),t._trigger("handshakeProgress",t.HANDSHAKE_PROGRESS.WELCOME,n)}if(t._peerMessagesStamps[n]=t._peerMessagesStamps[n]||{userData:0,audioMuted:0,videoMuted:0,hasWelcome:!1},t._hasMCU||t._peerPriorityWeight>e.weight){if(t._peerMessagesStamps[n].hasWelcome)return void u.warn([n,"RTCPeerConnection",null,'Discarding extra "welcome" received.']);u.debug([n,"RTCPeerConnection",null,"Starting negotiation"]),t._peerMessagesStamps[n].hasWelcome=!0,t._doOffer(n,!1,{agent:i.agent.name,version:i.agent.version,os:i.agent.os},!0)}else{u.debug([n,"RTCPeerConnection",null,"Waiting for peer to start negotiation."]);var s={type:t._SIG_MESSAGE_TYPE.WELCOME,mid:t._user.sid,rid:t._room.id,enableIceTrickle:t._enableIceTrickle,enableDataChannel:t._enableDataChannel,enableIceRestart:t._enableIceRestart,receiveOnly:t.getPeerInfo().config.receiveOnly,agent:AdapterJS.webrtcDetectedBrowser,version:(AdapterJS.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:t._getUserInfo(n),target:n,weight:t._peerPriorityWeight,temasysPluginVersion:AdapterJS.WebRTCPlugin.plugin?AdapterJS.WebRTCPlugin.plugin.VERSION:null,SMProtocolVersion:t.SM_PROTOCOL_VERSION,DTProtocolVersion:t.DT_PROTOCOL_VERSION};t._publishOnly&&(s.publishOnly={type:t._streams.screenshare&&t._streams.screenshare.stream?"screenshare":"video"}),t._parentId&&(s.parentId=t._parentId),t._sendChannelMessage(s)}};if(t._peerConnectionConfig.certificate!==t.PEER_CERTIFICATE.AUTO&&"function"==typeof RTCPeerConnection.generateCertificate){var o={};o=t._peerConnectionConfig.certificate===t.PEER_CERTIFICATE.ECDSA?{name:"ECDSA",namedCurve:"P-256"}:{name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},RTCPeerConnection.generateCertificate(o).then(function(e){a(e)},function(){a()})}else a()}},t.prototype._offerHandler=function(e){var t=this,r=e.mid,i=t._peerConnections[r];if(i){if(e.userInfo&&"object"==typeof e.userInfo){var a=e.userInfo||{};t._peerInformations[r].settings=a.settings||{},t._peerInformations[r].mediaStatus=a.mediaStatus||{},t._peerInformations[r].userData=a.userData}u.log([r,null,e.type,"Received offer from peer. Session description:"],n(e));var o={type:"offer",sdp:t._hasMCU?e.sdp.replace(/\r\n/g,"\n").split("\n").join("\r\n"):e.sdp};if(u.log([r,"RTCSessionDescription",e.type,"Session description object created"],o),o.sdp=t._removeSDPFilteredCandidates(r,o),o.sdp=t._setSDPCodec(r,o),o.sdp=t._setSDPBitrate(r,o),o.sdp=t._setSDPCodecParams(r,o),o.sdp=t._removeSDPCodecs(r,o),o.sdp=t._removeSDPREMBPackets(r,o),o.sdp=t._handleSDPConnectionSettings(r,o,"remote"),o.sdp=t._removeSDPUnknownAptRtx(r,o),u.log([r,"RTCSessionDescription",e.type,"Updated remote offer ->"],o.sdp),i.signalingState===t.PEER_CONNECTION_STATE.STABLE)if(i.processingRemoteSDP)u.warn([r,"RTCSessionDescription","offer","Dropping of setting local offer as there is another sessionDescription being processed ->"],o);else{i.processingRemoteSDP=!0,e.userInfo&&t._trigger("peerUpdated",r,t.getPeerInfo(r),!1),t._parseSDPMediaStreamIDs(r,o);i.setRemoteDescription(new RTCSessionDescription(o),function(){u.debug([r,"RTCSessionDescription",e.type,"Remote description set"]),i.setOffer="remote",i.processingRemoteSDP=!1,t._trigger("handshakeProgress",t.HANDSHAKE_PROGRESS.OFFER,r),t._addIceCandidateFromQueue(r),t._doAnswer(r)},function(n){t._trigger("handshakeProgress",t.HANDSHAKE_PROGRESS.ERROR,r,n),i.processingRemoteSDP=!1,u.error([r,null,e.type,"Failed setting remote description:"],{error:n,state:i.signalingState,offer:o})})}else u.warn([r,null,e.type,'Peer connection state is not in "stable" state for re-negotiation. Dropping message.'],{signalingState:i.signalingState,isRestart:!!e.resend})}else u.error([r,null,e.type,"Peer connection object not found. Unable to setRemoteDescription for offer"])},t.prototype._candidateHandler=function(e){var t=e.mid;if(e.candidate||e.id){var n="can-"+(new Date).getTime(),r=e.candidate.split(" ")[7]||"",i=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate,sdpMid:e.id});if(u.debug([t,"RTCIceCandidate",n+":"+r,"Received ICE candidate ->"],i),this._peerEndOfCandidatesCounter[t]=this._peerEndOfCandidatesCounter[t]||{},this._peerEndOfCandidatesCounter[t].len=this._peerEndOfCandidatesCounter[t].len||0,this._peerEndOfCandidatesCounter[t].hasSet=!1,this._peerEndOfCandidatesCounter[t].len++,this._trigger("candidateProcessingState",this.CANDIDATE_PROCESSING_STATE.RECEIVED,t,n,r,{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex},null),!this._peerConnections[t]||this._peerConnections[t].signalingState===this.PEER_CONNECTION_STATE.CLOSED)return u.warn([t,"RTCIceCandidate",n+":"+r,"Dropping ICE candidate as Peer connection does not exists or is closed"]),this._trigger("candidateProcessingState",this.CANDIDATE_PROCESSING_STATE.DROPPED,t,n,r,{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex},new Error("Failed processing ICE candidate as Peer connection does not exists or is closed.")),void this._signalingEndOfCandidates(t);if(this._filterCandidatesType[r]){if(!this._hasMCU||!this._forceTURN)return u.warn([t,"RTCIceCandidate",n+":"+r,"Dropping received ICE candidate as it matches ICE candidate filtering flag ->"],i),this._trigger("candidateProcessingState",this.CANDIDATE_PROCESSING_STATE.DROPPED,t,n,r,{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex},new Error("Dropping of processing ICE candidate as it matches ICE candidate filtering flag.")),void this._signalingEndOfCandidates(t);u.warn([t,"RTCIceCandidate",n+":"+r,"Not dropping received ICE candidate as TURN connections are enforced as MCU is present (and act as a TURN itself) so filtering of ICE candidate flags are not honoured ->"],i)}this._peerConnections[t].remoteDescription&&this._peerConnections[t].remoteDescription.sdp&&this._peerConnections[t].localDescription&&this._peerConnections[t].localDescription.sdp?this._addIceCandidate(t,n,i):this._addIceCandidateToQueue(t,n,i),this._signalingEndOfCandidates(t),this._gatheredCandidates[t]||(this._gatheredCandidates[t]={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),this._gatheredCandidates[t].receiving[r].push({sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,candidate:i.candidate})}else u.warn([t,"RTCIceCandidate",null,"Received invalid ICE candidate message ->"],e)},t.prototype._answerHandler=function(e){var t=this,r=e.mid;u.log([r,null,e.type,"Received answer from peer. Session description:"],n(e));var i=t._peerConnections[r];if(i){if(e.userInfo&&"object"==typeof e.userInfo){var a=e.userInfo||{};t._peerInformations[r].settings=a.settings||{},t._peerInformations[r].mediaStatus=a.mediaStatus||{},t._peerInformations[r].userData=a.userData}var o={type:"answer",sdp:t._hasMCU?e.sdp.replace(/\r\n/g,"\n").split("\n").join("\r\n"):e.sdp};if(u.log([r,"RTCSessionDescription",e.type,"Session description object created"],o),o.sdp=t._removeSDPFilteredCandidates(r,o),o.sdp=t._setSDPCodec(r,o),o.sdp=t._setSDPBitrate(r,o),o.sdp=t._setSDPCodecParams(r,o),o.sdp=t._removeSDPCodecs(r,o),o.sdp=t._removeSDPREMBPackets(r,o),o.sdp=t._handleSDPConnectionSettings(r,o,"remote"),o.sdp=t._removeSDPUnknownAptRtx(r,o),u.log([r,"RTCSessionDescription",e.type,"Updated remote answer ->"],o.sdp),i.signalingState===t.PEER_CONNECTION_STATE.HAVE_LOCAL_OFFER)if(i.processingRemoteSDP)u.warn([r,"RTCSessionDescription","answer","Dropping of setting local answer as there is another sessionDescription being processed ->"],o);else{i.processingRemoteSDP=!0,e.userInfo&&t._trigger("peerUpdated",r,t.getPeerInfo(r),!1),t._parseSDPMediaStreamIDs(r,o);i.setRemoteDescription(new RTCSessionDescription(o),function(){u.debug([r,null,e.type,"Remote description set"]),i.setAnswer="remote",i.processingRemoteSDP=!1,t._trigger("handshakeProgress",t.HANDSHAKE_PROGRESS.ANSWER,r),t._addIceCandidateFromQueue(r),t._peerMessagesStamps[r]&&(t._peerMessagesStamps[r].hasRestart=!1),t._dataChannels[r]&&(-1===i.remoteDescription.sdp.indexOf("m=application")||i.remoteDescription.sdp.indexOf("m=application 0")>0)&&(u.warn([r,"RTCPeerConnection",null,"Closing all datachannels as they were rejected."]),t._closeDataChannel(r))},function(n){t._trigger("handshakeProgress",t.HANDSHAKE_PROGRESS.ERROR,r,n),i.processingRemoteSDP=!1,u.error([r,null,e.type,"Failed setting remote description:"],{error:n,state:i.signalingState,answer:o})})}else u.warn([r,null,e.type,'Peer connection state is not in "have-local-offer" state for re-negotiation. Dropping message.'],{signalingState:i.signalingState,isRestart:!!e.restart})}else u.error([r,null,e.type,"Peer connection object not found. Unable to setRemoteDescription for answer"])},t.prototype._isLowerThanVersion=function(e,t){for(var n=(e||"").split("."),r=(t||"").split("."),i=0;i<r.length;i++)if(parseInt(n[i]||"0",10)<parseInt(r[i]||"0",10))return!0;return!1},t.prototype.VIDEO_CODEC={AUTO:"auto",VP8:"VP8",H264:"H264",VP9:"VP9"},t.prototype.AUDIO_CODEC={AUTO:"auto",ISAC:"ISAC",OPUS:"opus",ILBC:"ILBC",G722:"G722",PCMU:"PCMU",PCMA:"PCMA"},t.prototype.MEDIA_SOURCE={SCREEN:"screen",WINDOW:"window",TAB:"tab",TAB_AUDIO:"audio",APPLICATION:"application",BROWSER:"browser",CAMERA:"camera"},t.prototype.VIDEO_RESOLUTION={QQVGA:{width:160,height:120},HQVGA:{width:240,height:160},QVGA:{width:320,height:240},WQVGA:{width:384,height:240},HVGA:{width:480,height:320},VGA:{width:640,height:480},WVGA:{width:768,height:480},FWVGA:{width:854,height:480},SVGA:{width:800,height:600},DVGA:{width:960,height:640},WSVGA:{width:1024,height:576},HD:{width:1280,height:720},HDPLUS:{width:1600,height:900},FHD:{width:1920,height:1080},QHD:{width:2560,height:1440},WQXGAPLUS:{width:3200,height:1800},UHD:{width:3840,height:2160},UHDPLUS:{width:5120,height:2880},FUHD:{width:7680,height:4320},QUHD:{width:15360,height:8640}},t.prototype.MEDIA_ACCESS_FALLBACK_STATE={FALLBACKING:0,FALLBACKED:1,ERROR:-1},t.prototype.RECORDING_STATE={START:0,STOP:1,LINK:2,ERROR:-1},t.prototype.getUserMedia=function(e,t){var n=this;if("function"==typeof e)t=e,e={audio:!0,video:!0};else if("object"!=typeof e||null===e){if(void 0!==e){return u.error("Please provide a valid options",e),void("function"==typeof t&&t(new Error("Please provide a valid options"),null))}e={audio:!0,video:!0}}else if(!e.audio&&!e.video){return u.error("Please select audio or video",e),void("function"==typeof t&&t(new Error("Please select audio or video"),null))}n._throttle(function(r){if(r){if("function"==typeof t){var i=function(e){n.off("mediaAccessError",a),t(null,e)},a=function(e){n.off("mediaAccessSuccess",i),t(e,null)};n.once("mediaAccessSuccess",i,function(e,t){return!t}),n.once("mediaAccessError",a,function(e,t){return!t})}var o=n._parseStreamSettings(e),s=function(e){o.mutedSettings.shouldAudioMuted&&(n._streamsMutedSettings.audioMuted=!0),o.mutedSettings.shouldVideoMuted&&(n._streamsMutedSettings.videoMuted=!0),n._onStreamAccessSuccess(e,o,!1,!1)},d=function(e){n._onStreamAccessError(e,o,!1,!1)};try{if("function"!=typeof(AdapterJS||{}).webRTCReady)return d(new Error("Failed to call getUserMedia() as AdapterJS is not yet loaded!"));AdapterJS.webRTCReady(function(){navigator.getUserMedia(o.getUserMediaSettings,s,d)})}catch(e){d(e)}}else if(n._throttlingShouldThrowError){var c="Unable to run as throttle interval has not reached ("+n._throttlingTimeouts.getUserMedia+"ms).";u.error(c),"function"==typeof t&&t(new Error(c),null)}},"getUserMedia",n._throttlingTimeouts.getUserMedia)},t.prototype.sendStream=function(e,t){var n=this,r=function(e){if(n._inRoom)n._streams.screenshare||(n._trigger("incomingStream",n._user.sid,e,!0,n.getPeerInfo(),!1,e.id||e.label),n._trigger("peerUpdated",n._user.sid,n.getPeerInfo(),!0)),Object.keys(n._peerConnections).length>0||n._hasMCU?n._refreshPeerConnection(Object.keys(n._peerConnections),!1,{},function(n,r){if(n)return u.error("Failed refreshing connections for sendStream() ->",n),void("function"==typeof t&&t(new Error("Failed refreshing connections."),null));"function"==typeof t&&t(null,e)}):"function"==typeof t&&t(null,e);else{u.error("Unable to send stream as user is not in the Room.",e),"function"==typeof t&&t(new Error("Unable to send stream as user is not in the Room."),null)}};if(!("object"==typeof e&&null!==e||AdapterJS&&AdapterJS.WebRTCPlugin&&AdapterJS.WebRTCPlugin.plugin&&["function","object"].indexOf(typeof e)>-1)){return u.error("Provided stream settings is invalid",e),void("function"==typeof t&&t(new Error("Provided stream settings is invalid"),null))}if(!n._inRoom){var i="Unable to send stream as user is not in the Room.";return u.error(i,e),void("function"==typeof t&&t(new Error(i),null))}if("edge"===AdapterJS.webrtcDetectedBrowser){return u.error("Edge browser currently does not support renegotiation.",e),void("function"==typeof t&&t(new Error("Edge browser currently does not support renegotiation."),null))}if("function"==typeof e.getAudioTracks||"function"==typeof e.getVideoTracks){var a=function(e){for(var t=0;t<e.length;t++)if(!(e[t].ended||"string"==typeof e[t].readyState&&"live"!==e[t].readyState))return!0;return!1};if(!a(e.getAudioTracks())&&!a(e.getVideoTracks())){var o="Provided stream object does not have audio or video tracks.";return u.error(o,e),void("function"==typeof t&&t(new Error(o),null))}n._onStreamAccessSuccess(e,{settings:{audio:!0,video:!0},getUserMediaSettings:{audio:!0,video:!0}},!1,!1),r(e)}else n.getUserMedia(e,function(e,n){e?"function"==typeof t&&t(e,null):r(n)})},t.prototype.stopStream=function(){this._streams.userMedia&&this._stopStreams({userMedia:!0})},t.prototype.muteStream=function(e){var t=this;if("object"==typeof e)if(t._streams.userMedia&&t._streams.userMedia.stream||t._streams.screenshare&&t._streams.screenshare.stream){var n="boolean"!=typeof e.audioMuted||e.audioMuted,r="boolean"!=typeof e.videoMuted||e.videoMuted,i=!1,a=!1;if(t._streamsMutedSettings.audioMuted!==n&&(t._streamsMutedSettings.audioMuted=n,i=!0),t._streamsMutedSettings.videoMuted!==r&&(t._streamsMutedSettings.videoMuted=r,a=!0),a||i){var o=t._muteStreams();a&&t._inRoom&&t._sendChannelMessage({type:t._SIG_MESSAGE_TYPE.MUTE_VIDEO,mid:t._user.sid,rid:t._room.id,muted:t._streamsMutedSettings.videoMuted,stamp:(new Date).getTime()}),i&&t._inRoom&&setTimeout(function(){t._sendChannelMessage({type:t._SIG_MESSAGE_TYPE.MUTE_AUDIO,mid:t._user.sid,rid:t._room.id,muted:t._streamsMutedSettings.audioMuted,stamp:(new Date).getTime()})},a?1050:0),(o.hasVideo&&a||o.hasAudio&&i)&&(t._trigger("localMediaMuted",{audioMuted:!o.hasAudio||t._streamsMutedSettings.audioMuted,videoMuted:!o.hasVideo||t._streamsMutedSettings.videoMuted}),t._inRoom&&(t._trigger("streamMuted",t._user.sid,t.getPeerInfo(),!0,t._streams.screenshare&&t._streams.screenshare.stream),t._trigger("peerUpdated",t._user.sid,t.getPeerInfo(),!0)))}}else u.warn("No streams are available to mute / unmute!");else u.error("Provided settings is not an object")},t.prototype.enableAudio=function(){this.muteStream({audioMuted:!1,videoMuted:this._streamsMutedSettings.videoMuted})},t.prototype.disableAudio=function(){this.muteStream({audioMuted:!0,videoMuted:this._streamsMutedSettings.videoMuted})},t.prototype.enableVideo=function(){this.muteStream({videoMuted:!1,audioMuted:this._streamsMutedSettings.audioMuted})},t.prototype.disableVideo=function(){this.muteStream({videoMuted:!0,audioMuted:this._streamsMutedSettings.audioMuted})},t.prototype.shareScreen=function(e,t,n){var r=this,i=!1,a=[r.MEDIA_SOURCE.SCREEN],o=function(e){for(var t in r.MEDIA_SOURCE)if(r.MEDIA_SOURCE.hasOwnProperty(t)&&r.MEDIA_SOURCE[t]===e)return!0;return!1};if(e&&"string"==typeof e)o(e)&&(a=[e]);else if(Array.isArray(e)){for(var s=[],d=0;d<e.length;d++)o(e[d])&&s.push(e[d]);s.length>0&&(a=s)}else e&&"object"==typeof e?i={usedtx:"boolean"==typeof e.usedtx?e.usedtx:null,useinbandfec:"boolean"==typeof e.useinbandfec?e.useinbandfec:null,stereo:!0===e.stereo,echoCancellation:!1!==e.echoCancellation,deviceId:e.deviceId}:!0===e?i=!0===e&&{usedtx:null,useinbandfec:null,stereo:!1,echoCancellation:!0,deviceId:null}:"function"==typeof e&&(n=e,e=!1);if(t&&"string"==typeof t)o(t)&&(a=[t]);else if(Array.isArray(t)){for(var c=[],d=0;d<t.length;d++)o(t[d])&&c.push(t[d]);c.length>0&&(a=c)}else"function"==typeof t&&(n=t);a.indexOf("audio")>-1&&-1===a.indexOf("tab")&&(a.splice(a.indexOf("audio"),1),0===a.length&&(a=[r.MEDIA_SOURCE.SCREEN])),r._throttle(function(e){if(e){var t={settings:{audio:i,video:{screenshare:!0,exactConstraints:!1}},getUserMediaSettings:{audio:!1,video:{mediaSource:a}}},o=function(e){r.off("mediaAccessError",s),r._inRoom?(r._trigger("incomingStream",r._user.sid,e,!0,r.getPeerInfo(),!0,e.id||e.label),r._trigger("peerUpdated",r._user.sid,r.getPeerInfo(),!0),Object.keys(r._peerConnections).length>0||r._hasMCU?r._refreshPeerConnection(Object.keys(r._peerConnections),!1,{},function(t,r){if(t)return u.error("Failed refreshing connections for shareScreen() ->",t),void("function"==typeof n&&n(new Error("Failed refreshing connections."),null));"function"==typeof n&&n(null,e)}):"function"==typeof n&&n(null,e)):"function"==typeof n&&n(null,e)},s=function(e){r.off("mediaAccessSuccess",o),"function"==typeof n&&n(e,null)};r.once("mediaAccessSuccess",o,function(e,t){return t}),r.once("mediaAccessError",s,function(e,t){return t});var d=!!i&&{echoCancellation:i.echoCancellation};try{var c=!1;i&&("firefox"===AdapterJS.webrtcDetectedBrowser?(c=!0,t.getUserMediaSettings.audio=d):a.indexOf("audio")>-1&&a.indexOf("tab")>-1&&(c=!0,t.getUserMediaSettings.audio={}));var l=function(e){if(!c&&i){t.getUserMediaSettings.audio=d;navigator.getUserMedia({audio:d},function(n){try{n.addTrack(e.getVideoTracks()[0]),r.once("mediaAccessSuccess",function(){r._streams.screenshare.streamClone=e},function(e,t){return t}),r._onStreamAccessSuccess(n,t,!0,!1)}catch(n){u.error("Failed retrieving audio stream for screensharing stream",n),r._onStreamAccessSuccess(e,t,!0,!1)}},function(n){u.error("Failed retrieving audio stream for screensharing stream",n),r._onStreamAccessSuccess(e,t,!0,!1)})}else r._onStreamAccessSuccess(e,t,!0,!1)},p=function(e){r._onStreamAccessError(e,t,!0,!1)};if("function"!=typeof(AdapterJS||{}).webRTCReady)return p(new Error("Failed to call getUserMedia() as AdapterJS is not yet loaded!"));AdapterJS.webRTCReady(function(){navigator.getUserMedia(t.getUserMediaSettings,l,p)})}catch(e){r._onStreamAccessError(e,t,!0,!1)}}else if(r._throttlingShouldThrowError){var f="Unable to run as throttle interval has not reached ("+r._throttlingTimeouts.shareScreen+"ms).";u.error(f),"function"==typeof n&&n(new Error(f),null)}},"shareScreen",r._throttlingTimeouts.shareScreen)},t.prototype.stopScreen=function(){this._streams.screenshare&&(this._stopStreams({screenshare:!0}),this._inRoom&&(this._streams.userMedia&&this._streams.userMedia.stream&&(this._trigger("incomingStream",this._user.sid,this._streams.userMedia.stream,!0,this.getPeerInfo(),!1,this._streams.userMedia.stream.id||this._streams.userMedia.stream.label),this._trigger("peerUpdated",this._user.sid,this.getPeerInfo(),!0)),this._refreshPeerConnection(Object.keys(this._peerConnections),{},!1)))},t.prototype._muteStreams=function(){var e=this,t=!1,n=!1,r=function(r){for(var i=r.getAudioTracks(),a=r.getVideoTracks(),o=0;o<i.length;o++)i[o].enabled=!e._streamsMutedSettings.audioMuted,n=!0;for(var s=0;s<a.length;s++)a[s].enabled=!e._streamsMutedSettings.videoMuted,t=!0};if(e._streams.userMedia&&e._streams.userMedia.stream&&r(e._streams.userMedia.stream),e._streams.screenshare&&e._streams.screenshare.stream&&r(e._streams.screenshare.stream),e._streams.screenshare&&e._streams.screenshare.streamClone&&r(e._streams.screenshare.streamClone),"edge"===AdapterJS.webrtcDetectedBrowser)for(var i in e._peerConnections)if(e._peerConnections.hasOwnProperty(i)&&e._peerConnections[i])for(var a=e._peerConnections[i].getLocalStreams(),o=0;o<a.length;o++)r(a[o]);return u.debug("Updated Streams muted status ->",e._streamsMutedSettings),{hasVideo:t,hasAudio:n}},t.prototype._stopStreams=function(e){var t=this,n=function(e){var n=e.id||e.label;u.debug([null,"MediaStream",n,"Stopping Stream ->"],e);try{for(var r=e.getAudioTracks(),i=e.getVideoTracks(),a=0;a<r.length;a++)r[a].stop();for(var o=0;o<i.length;o++)i[o].stop()}catch(t){e.stop()}t._streamsStoppedCbs[n]&&(t._streamsStoppedCbs[n](),delete t._streamsStoppedCbs[n])},r=!1,i=!1,a=!1;"object"==typeof e&&(r=!0===e.userMedia,i=!0===e.screenshare),r&&t._streams.userMedia&&(t._streams.userMedia.stream&&n(t._streams.userMedia.stream),t._streams.userMedia=null,a=!0),i&&t._streams.screenshare&&(t._streams.screenshare.streamClone&&n(t._streams.screenshare.streamClone),t._streams.screenshare.stream&&n(t._streams.screenshare.stream),t._streams.screenshare=null,a=!0),t._inRoom&&a&&t._trigger("peerUpdated",t._user.sid,t.getPeerInfo(),!0),u.log("Stopping Streams with settings ->",e)},t.prototype._parseStreamSettings=function(e){var t={settings:{audio:!1,video:!1},mutedSettings:{shouldAudioMuted:!1,shouldVideoMuted:!1},getUserMediaSettings:{audio:!1,video:!1}};return e.audio&&(t.settings.audio={stereo:!1,exactConstraints:!!e.useExactConstraints,echoCancellation:!0},t.getUserMediaSettings.audio={echoCancellation:!0},"object"==typeof e.audio&&("boolean"==typeof e.audio.stereo&&(t.settings.audio.stereo=e.audio.stereo),"boolean"==typeof e.audio.useinbandfec&&(t.settings.audio.useinbandfec=e.audio.useinbandfec),"boolean"==typeof e.audio.usedtx&&(t.settings.audio.usedtx=e.audio.usedtx),"number"==typeof e.audio.maxplaybackrate&&e.audio.maxplaybackrate>=8e3&&e.audio.maxplaybackrate<=48e3&&(t.settings.audio.maxplaybackrate=e.audio.maxplaybackrate),"boolean"==typeof e.audio.mute&&(t.mutedSettings.shouldAudioMuted=e.audio.mute),"edge"!==AdapterJS.webrtcDetectedBrowser&&("boolean"==typeof e.audio.echoCancellation&&(t.settings.audio.echoCancellation=e.audio.echoCancellation,t.getUserMediaSettings.audio.echoCancellation=e.audio.echoCancellation),Array.isArray(e.audio.optional)&&(t.settings.audio.optional=n(e.audio.optional),t.getUserMediaSettings.audio.optional=n(e.audio.optional)),e.audio.deviceId&&"string"==typeof e.audio.deviceId&&"firefox"!==AdapterJS.webrtcDetectedBrowser&&(t.settings.audio.deviceId=e.audio.deviceId,t.getUserMediaSettings.audio.deviceId=e.useExactConstraints?{exact:e.audio.deviceId}:{ideal:e.audio.deviceId}))),"edge"===AdapterJS.webrtcDetectedBrowser&&(t.getUserMediaSettings.audio=!0)),e.video&&(t.settings.video={resolution:n(this.VIDEO_RESOLUTION.VGA),screenshare:!1,exactConstraints:!!e.useExactConstraints},t.getUserMediaSettings.video={},"object"==typeof e.video?("boolean"==typeof e.video.mute&&(t.mutedSettings.shouldVideoMuted=e.video.mute),Array.isArray(e.video.optional)&&(t.settings.video.optional=n(e.video.optional),t.getUserMediaSettings.video.optional=n(e.video.optional)),e.video.deviceId&&"string"==typeof e.video.deviceId&&"firefox"!==AdapterJS.webrtcDetectedBrowser&&(t.settings.video.deviceId=e.video.deviceId,t.getUserMediaSettings.video.deviceId=e.useExactConstraints?{exact:e.video.deviceId}:{ideal:e.video.deviceId}),e.video.resolution&&"object"==typeof e.video.resolution&&((e.video.resolution.width&&"object"==typeof e.video.resolution.width||"number"==typeof e.video.resolution.width)&&(t.settings.video.resolution.width=e.video.resolution.width),(e.video.resolution.height&&"object"==typeof e.video.resolution.height||"number"==typeof e.video.resolution.height)&&(t.settings.video.resolution.height=e.video.resolution.height)),t.getUserMediaSettings.video.width="object"==typeof t.settings.video.resolution.width?t.settings.video.resolution.width:e.useExactConstraints?{exact:t.settings.video.resolution.width}:{max:t.settings.video.resolution.width},t.getUserMediaSettings.video.height="object"==typeof t.settings.video.resolution.height?t.settings.video.resolution.height:e.useExactConstraints?{exact:t.settings.video.resolution.height}:{max:t.settings.video.resolution.height},(e.video.frameRate&&"object"==typeof e.video.frameRate||"number"==typeof e.video.frameRate&&"plugin"!==AdapterJS.webrtcDetectedType)&&(t.settings.video.frameRate=e.video.frameRate,t.getUserMediaSettings.video.frameRate="object"==typeof t.settings.video.frameRate?t.settings.video.frameRate:e.useExactConstraints?{exact:t.settings.video.frameRate}:{max:t.settings.video.frameRate}),e.video.facingMode&&["string","object"].indexOf(typeof e.video.facingMode)>-1&&"plugin"===AdapterJS.webrtcDetectedType&&(t.settings.video.facingMode=e.video.facingMode,t.getUserMediaSettings.video.facingMode="object"==typeof t.settings.video.facingMode?t.settings.video.facingMode:e.useExactConstraints?{exact:t.settings.video.facingMode}:{max:t.settings.video.facingMode})):t.getUserMediaSettings.video={width:e.useExactConstraints?{exact:t.settings.video.resolution.width}:{max:t.settings.video.resolution.width},height:e.useExactConstraints?{exact:t.settings.video.resolution.height}:{max:t.settings.video.resolution.height}},"edge"===AdapterJS.webrtcDetectedBrowser&&(t.settings.video={screenshare:!1,exactConstraints:!!e.useExactConstraints},t.getUserMediaSettings.video=!0)),t},t.prototype._onStreamAccessSuccess=function(e,t,n,r){var i=this,a=e.id||e.label,o=!1;if(u.log([null,"MediaStream",a,"Has access to stream ->"],e),!n&&i._streams.userMedia?i._stopStreams({userMedia:!0,screenshare:!1}):n&&i._streams.screenshare&&i._stopStreams({userMedia:!1,screenshare:!0}),i._streamsStoppedCbs[a]=function(){u.log([null,"MediaStream",a,"Stream has ended"]),o=!0,i._trigger("mediaAccessStopped",!!n,!!r,a),i._inRoom&&(u.debug([null,"MediaStream",a,"Sending Stream ended status to Peers"]),i._sendChannelMessage({type:i._SIG_MESSAGE_TYPE.STREAM,mid:i._user.sid,rid:i._room.id,cid:i._key,streamId:a,settings:t.settings,status:"ended"}),i._trigger("streamEnded",i._user.sid,i.getPeerInfo(),!0,!!n,a),n&&i._streams.screenshare&&i._streams.screenshare.stream&&(i._streams.screenshare.stream.id||i._streams.screenshare.stream.label)===a?i._streams.screenshare=null:!n&&i._streams.userMedia&&i._streams.userMedia.stream&&(i._streams.userMedia.stream.id||i._streams.userMedia.stream.label)===a&&(i._streams.userMedia=null))},["chrome","opera"].indexOf(AdapterJS.webrtcDetectedBrowser)>-1?(e.oninactive=function(){i._streamsStoppedCbs[a]&&(i._streamsStoppedCbs[a](),delete i._streamsStoppedCbs[a])},n&&e.getVideoTracks().length>0&&(e.getVideoTracks()[0].onended=function(){setTimeout(function(){!o&&i._inRoom&&i.stopScreen()},350)})):"firefox"===AdapterJS.webrtcDetectedBrowser?e.endedInterval=setInterval(function(){void 0===e.recordedTime&&(e.recordedTime=0),e.recordedTime===e.currentTime?(clearInterval(e.endedInterval),i._streamsStoppedCbs[a]&&(i._streamsStoppedCbs[a](),delete i._streamsStoppedCbs[a])):e.recordedTime=e.currentTime},1e3):e.onended=function(){i._streamsStoppedCbs[a]&&(i._streamsStoppedCbs[a](),delete i._streamsStoppedCbs[a])},t.settings.audio&&0===e.getAudioTracks().length||t.settings.video&&0===e.getVideoTracks().length){var s="Expected audio tracks length with "+(t.settings.audio?"1":"0")+" and video tracks length with "+(t.settings.video?"1":"0")+" but received audio tracks length with "+e.getAudioTracks().length+" and video tracks length with "+e.getVideoTracks().length;u.warn([null,"MediaStream",a,s]);var d=!!t.settings.audio,c=!!t.settings.video;t.settings.audio&&0===e.getAudioTracks().length&&(t.settings.audio=!1),t.settings.video&&0===e.getVideoTracks().length&&(t.settings.video=!1),i._trigger("mediaAccessFallback",{error:new Error(s),diff:{video:{expected:c?1:0,received:e.getVideoTracks().length},audio:{expected:d?1:0,received:e.getAudioTracks().length}}},i.MEDIA_ACCESS_FALLBACK_STATE.FALLBACKED,!!n,!!r,a)}i._streams[n?"screenshare":"userMedia"]={stream:e,settings:t.settings,constraints:t.getUserMediaSettings},i._muteStreams(),i._trigger("mediaAccessSuccess",e,!!n,!!r,a)},t.prototype._onStreamAccessError=function(e,t,n){var r=this;if(!n&&t.settings.audio&&t.settings.video&&r._audioFallback){u.debug("Fallbacking to retrieve audio only Stream"),r._trigger("mediaAccessFallback",{error:e,diff:null},r.MEDIA_ACCESS_FALLBACK_STATE.FALLBACKING,!1,!0);navigator.getUserMedia({audio:!0},function(e){r._onStreamAccessSuccess(e,t,!1,!0)},function(e){u.error("Failed fallbacking to retrieve audio only Stream ->",e),r._trigger("mediaAccessError",e,!1,!0),r._trigger("mediaAccessFallback",{error:e,diff:null},r.MEDIA_ACCESS_FALLBACK_STATE.ERROR,!1,!0)})}else u.error("Failed retrieving "+(n?"screensharing":"camera")+" Stream ->",e),r._trigger("mediaAccessError",e,!!n,!1)},t.prototype._onRemoteStreamAdded=function(e,t,n){var r=this,i=r._peerConnections[e]&&r._peerConnections[e].remoteStreamId||t.id||t.label;r._peerInformations[e]?(u.log([e,"MediaStream",i,"Received remote stream ->"],t),n&&u.log([e,"MediaStream",i,"Peer is having a screensharing session with user"]),r._trigger("incomingStream",e,t,!1,r.getPeerInfo(e),n,i),r._trigger("peerUpdated",e,r.getPeerInfo(e),!1)):u.warn([e,"MediaStream",i,"Received remote stream when peer is not connected. Ignoring stream ->"],t)},t.prototype._addLocalMediaStreams=function(e){var t=this;try{u.log([e,null,null,"Adding local stream"]);var n=t._peerConnections[e];if(n){var r=!(!t._sdpSettings.connection.audio&&"MCU"!==e)&&t._getSDPCommonSupports(e,n.remoteDescription).video,i=!(!t._sdpSettings.connection.video&&"MCU"!==e)&&t._getSDPCommonSupports(e,n.remoteDescription).audio;if(n.signalingState!==t.PEER_CONNECTION_STATE.CLOSED){var a=function(e){if(!e||(!n.localStreamId||e.id!==n.localStreamId)){if("edge"!==AdapterJS.webrtcDetectedBrowser||t._useEdgeWebRTC&&window.msRTCPeerConnection?n.getLocalStreams().forEach(function(e){n.removeStream(e)}):n.getSenders().forEach(function(e){n.removeTrack(e)}),!r&&!i)return;e&&("edge"!==AdapterJS.webrtcDetectedBrowser||t._useEdgeWebRTC&&window.msRTCPeerConnection?n.addStream(e):e.getTracks().forEach(function(t){"audio"===t.kind&&!r||"video"===t.kind&&!i||n.addTrack(t,e)}),n.localStreamId=e.id||e.label,n.localStream=e)}};t._streams.screenshare&&t._streams.screenshare.stream?(u.debug([e,"MediaStream",null,"Sending screen"],t._streams.screenshare.stream),a(t._streams.screenshare.stream)):t._streams.userMedia&&t._streams.userMedia.stream?(u.debug([e,"MediaStream",null,"Sending stream"],t._streams.userMedia.stream),a(t._streams.userMedia.stream)):(u.warn([e,"MediaStream",null,"No media to send. Will be only receiving"]),a(null))}else u.warn([e,"MediaStream",null,"Not adding any stream as signalingState is closed"])}else u.warn([e,"MediaStream",t._mediaStream,"Not adding stream as peerconnection object does not exists"])}catch(t){(t.message||"").indexOf("already added")>-1?u.warn([e,null,null,"Not re-adding stream as LocalMediaStream is already added"],t):u.error([e,null,null,"Failed adding local stream"],t)}},t.prototype._handleEndedStreams=function(e,t){var r=this;r._streamsSession[e]=r._streamsSession[e]||{};var i=function(t){if(r._streamsSession[e][t]){var i=n(r.getPeerInfo(e));i.settings.audio=n(r._streamsSession[e][t].audio),i.settings.video=n(r._streamsSession[e][t].video);var a=i.settings.video&&"object"==typeof i.settings.video&&!!i.settings.video.screenshare;r._streamsSession[e][t]=!1,r._trigger("streamEnded",e,i,!1,a,t)}};if(t)i(t);else if(r._peerConnections[e])for(var a in r._streamsSession[e])r._streamsSession[e].hasOwnProperty(a)&&r._streamsSession[e][a]&&i(a)},t.prototype._setSDPCodecParams=function(e,t){var n=this,r=function(e,n,r,i){var a=t.sdp.match(new RegExp("m="+e+" .*\r\n","gi"));if(Array.isArray(a)&&a.length>0){var o=t.sdp.match(new RegExp("a=rtpmap:.* "+n+"/"+(r?r+("audio"===e?"[/]*.*":".*"):".*")+"\r\n","gi"));if(Array.isArray(o)&&o.length>0)for(var s=0;s<o.length;s++){var d=(o[s].split("a=rtpmap:")[1]||"").split(" ")[0];if(d){var c=t.sdp.match(new RegExp("a=fmtp:"+d+" .*\r\n","gi")),l="a=fmtp:"+d+" ",p=[];if(Array.isArray(c)&&c.length>0){for(var u=(c[0].split("a=fmtp:"+d+" ")[1]||"").replace(/ /g,"").replace(/\r\n/g,"").split(";"),f=0;f<u.length;f++)if(u[f]){var g=u[f].split("=");i.hasOwnProperty(g[0])?l+="boolean"==typeof i[g[0]]?i[g[0]]?g[0]+"=1;":"":g[0]+"="+i[g[0]]+";":l+=u[f]+";",p.push(g[0])}t.sdp=t.sdp.replace(c[0],"")}for(var h in i)i.hasOwnProperty(h)&&-1===p.indexOf(h)&&(l+="boolean"==typeof i[h]?i[h]?h+"=1;":"":h+"="+i[h]+";",p.push(h));l!=="a=fmtp:"+d+" "&&(t.sdp=t.sdp.replace(o[s],o[s]+l+"\r\n"))}}}};return r("audio",n.AUDIO_CODEC.OPUS,48e3,function(){var e={},t=n._streams.screenshare?n._streams.screenshare.settings.audio:n._streams.userMedia?n._streams.userMedia.settings.audio:{};return t=t&&"object"==typeof t?t:{},"boolean"==typeof n._codecParams.audio.opus.stereo?e.stereo=n._codecParams.audio.opus.stereo:"boolean"==typeof t.stereo&&(e.stereo=t.stereo),"boolean"==typeof n._codecParams.audio.opus["sprop-stereo"]?e["sprop-stereo"]=n._codecParams.audio.opus["sprop-stereo"]:"boolean"==typeof t.stereo&&(e["sprop-stereo"]=t.stereo),"boolean"==typeof n._codecParams.audio.opus.usedtx?e.usedtx=n._codecParams.audio.opus.usedtx:"boolean"==typeof t.usedtx&&(e.usedtx=t.usedtx),"boolean"==typeof n._codecParams.audio.opus.useinbandfec?e.useinbandfec=n._codecParams.audio.opus.useinbandfec:"boolean"==typeof t.useinbandfec&&(e.useinbandfec=t.useinbandfec),"number"==typeof n._codecParams.audio.opus.maxplaybackrate?e.maxplaybackrate=n._codecParams.audio.opus.maxplaybackrate:"number"==typeof t.maxplaybackrate&&(e.maxplaybackrate=t.maxplaybackrate),"number"==typeof n._codecParams.audio.opus.minptime?e.minptime=n._codecParams.audio.opus.minptime:"number"==typeof t.minptime&&(e.minptime=t.minptime),e}()),r("video",n.VIDEO_CODEC.VP8,null,function(){var e={};return"number"==typeof n._codecParams.video.vp8.maxFr&&(e["max-fr"]=n._codecParams.video.vp8.maxFr),"number"==typeof n._codecParams.video.vp8.maxFs&&(e["max-fs"]=n._codecParams.video.vp8.maxFs),e}()),r("video",n.VIDEO_CODEC.VP9,null,function(){var e={};return"number"==typeof n._codecParams.video.vp9.maxFr&&(e["max-fr"]=n._codecParams.video.vp9.maxFr),"number"==typeof n._codecParams.video.vp9.maxFs&&(e["max-fs"]=n._codecParams.video.vp9.maxFs),e}()),r("video",n.VIDEO_CODEC.H264,null,function(){var e={};return"string"==typeof n._codecParams.video.h264.levelAsymmetryAllowed&&(e["profile-level-id"]=n._codecParams.video.h264.profileLevelId),"boolean"==typeof n._codecParams.video.h264.levelAsymmetryAllowed&&(e["level-asymmetry-allowed"]=n._codecParams.video.h264.levelAsymmetryAllowed),"boolean"==typeof n._codecParams.video.h264.packetizationMode&&(e["packetization-mode"]=n._codecParams.video.h264.packetizationMode),e}()),t.sdp},t.prototype._setSDPBitrate=function(e,t){var n=t.sdp.split("\r\n"),r=function(r,i){var a=r,o=-1,s=-1;"data"===r&&(a="application");for(var d=0;d<n.length;d++)if(0===n[d].indexOf("m="+a))o=d;else if(o>0){if(0===n[d].indexOf("m="))break;0===n[d].indexOf("c=")?s=d:0!==n[d].indexOf("b=AS:")&&0!==n[d].indexOf("b:TIAS:")||(n.splice(d,1),d--)}"number"==typeof i&&i>0?-1!==s?(u.info([e,"RTCSessionDesription",t.type,'Limiting maximum sending "'+r+'" bandwidth ->'],i),n.splice(s+1,0,"firefox"===window.webrtcDetectedBrowser?"b=TIAS:"+(1e3*i*(window.webrtcDetectedVersion>52&&window.webrtcDetectedVersion<55?1e3:1)).toFixed(0):"b=AS:"+i)):u.error([e,"RTCSessionDesription",t.type,'Failed setting "'+r+'" bandwidth as c-line is missing.']):u.warn([e,"RTCSessionDesription",t.type,'Not limiting "'+r+'" bandwidth'])},i=this._streamsBandwidthSettings.bAS.audio,a=this._streamsBandwidthSettings.bAS.video,o=this._streamsBandwidthSettings.bAS.data,s=this._streamsBandwidthSettings.googleX.min,d=this._streamsBandwidthSettings.googleX.max;if(this._peerCustomConfigs[e]&&(this._peerCustomConfigs[e].bandwidth&&"object"==typeof this._peerCustomConfigs[e].bandwidth&&("number"==typeof this._peerCustomConfigs[e].bandwidth.audio&&(i=this._peerCustomConfigs[e].bandwidth.audio),"number"==typeof this._peerCustomConfigs[e].bandwidth.video&&(a=this._peerCustomConfigs[e].bandwidth.video),"number"==typeof this._peerCustomConfigs[e].bandwidth.data&&(o=this._peerCustomConfigs[e].bandwidth.data)),this._peerCustomConfigs[e].googleXBandwidth&&"object"==typeof this._peerCustomConfigs[e].googleXBandwidth&&("number"==typeof this._peerCustomConfigs[e].googleXBandwidth.min&&(s=this._peerCustomConfigs[e].googleXBandwidth.min),"number"==typeof this._peerCustomConfigs[e].googleXBandwidth.max&&(d=this._peerCustomConfigs[e].googleXBandwidth.max))),r("audio",i),r("video",a),r("data",o),"number"==typeof s||"number"==typeof d){for(var c=null,l=-1,p=-1,f=0;f<n.length;f++)if(0===n[f].indexOf("m=video"))c=n[f].split(" ")[3];else if(c){if(0===n[f].indexOf("m="))break;if(0===n[f].indexOf("a=rtpmap:"+c+" "))l=f;else if(0===n[f].indexOf("a=fmtp:"+c+" ")){n[f]=n[f].replace(/x-google-(min|max)-bitrate=[0-9]*[;]*/gi,""),p=f;break}}if(l>-1){var g="";"number"==typeof s&&(g+="x-google-min-bitrate="+s+";"),"number"==typeof d&&(g+="x-google-max-bitrate="+d+";"),u.info([e,"RTCSessionDesription",t.type,"Limiting x-google-bitrate ->"],g),p>-1?n[p]+=(n[p].split(" ")[1]?";":"")+g:n.splice(l+1,0,"a=fmtp:"+c+" "+g)}}return n.join("\r\n")},t.prototype._setSDPCodec=function(e,t,n){var r=this,i=function(n,i){var a="object"==typeof i?i.codec:i,o="object"==typeof i?i.samplingRate:null,s="object"==typeof i?i.channels:null;if(a!==r["audio"===n?"AUDIO_CODEC":"VIDEO_CODEC"].AUTO){var d=t.sdp.match(new RegExp("m="+n+" .*\r\n","gi"));if(Array.isArray(d)&&d.length>0){var c=function(r,i,c){if(Array.isArray(r)&&r.length>0){i||(o=null),c||(s=null),u.info([e,"RTCSessionDesription",t.type,'Preferring "'+a+'" (samplingRate: '+(o||"n/a")+", channels: "+(s||"n/a")+') for "'+n+'" streaming.']);var l=d[0],p=l.replace("\r\n","").split(" ");l=p[0]+" "+p[1]+" "+p[2]+" ",p.splice(0,3);for(var f=0;f<r.length;f++){var g=(r[f].split("a=rtpmap:")[1]||"").split(" ");g.length<2||(l+=g[0]+" ")}for(var h=0;h<p.length;h++)l.indexOf(" "+p[h])>0?(p.splice(h,1),h--):t.sdp.match(new RegExp("a=rtpmap:"+p[h]+" "+a+"/.*\r\n","gi"))&&(l+=p[h]+" ",p.splice(h,1),h--);return l+=p.join(" ")+"\r\n",t.sdp=t.sdp.replace(d[0],l),!0}};if(o){if("audio"===n&&s&&c(t.sdp.match(new RegExp("a=rtpmap:.* "+a+"/"+o+(1===s?"[/1]*":"/"+s)+"\r\n","gi")),!0,!0))return;if(c(t.sdp.match(new RegExp("a=rtpmap:.* "+a+"/"+o+"[/]*.*\r\n","gi")),!0))return}"audio"===n&&s&&c(t.sdp.match(new RegExp("a=rtpmap:.* "+a+"/.*/"+s+"\r\n","gi")),!1,!0)||c(t.sdp.match(new RegExp("a=rtpmap:.* "+a+"/.*\r\n","gi")))}else u.error([e,"RTCSessionDesription",t.type,'Not preferring any codec for "'+n+'" streaming as m= line is not found.'])}else u.warn([e,"RTCSessionDesription",t.type,'Not preferring any codec for "'+n+'" streaming. Using browser selection.'])};return i("audio",n?n.audio:r._selectedAudioCodec),i("video",n?n.video:r._selectedVideoCodec),t.sdp},t.prototype._removeSDPFirefoxH264Pref=function(e,t){return u.info([e,"RTCSessionDesription",t.type,"Removing Firefox experimental H264 flag to ensure interopability reliability"]),t.sdp.replace(/a=fmtp:0 profile-level-id=0x42e00c;packetization-mode=1\r\n/g,"")},t.prototype._removeSDPUnknownAptRtx=function(e,t){t.sdp.split("\r\n");for(var n=t.sdp.split("m="),r=0;r<n.length;r++)n[r]=function(e){return(e.match(/a=rtpmap:.*\ rtx\/.*\r\n/gi)||[]).forEach(function(t){var n=(t.split("a=rtpmap:")[1]||"").split(" ")[0]||"",r=(e.match(new RegExp("a=fmtp:"+n+" .*\r\n","gi"))||[])[0];if(r){var i=(r.split(" apt=")[1]||"").replace(/\r\n/gi,"");e.match(new RegExp("a=rtpmap:"+i+" .*\r\n","gi"))||(e=e.replace(new RegExp(t,"g"),""),e=e.replace(new RegExp(r,"g"),""))}else e=e.replace(new RegExp(t,"g"),"")}),e}(n[r]),n[r]=function(e){return(e.match(/a=(fmtp|rtcp-fb):.*\ rtx\/.*\r\n/gi)||[]).forEach(function(t){var n=(t.split("a="+(t.indexOf("rtcp")>0?"rtcp-fb":"fmtp"))[1]||"").split(" ")[0]||"";e.match(new RegExp("a=rtpmap:"+n+" .*\r\n","gi"))||(e=e.replace(new RegExp(t,"g"),""))}),e}(n[r]);return n.join("m=")},t.prototype._removeSDPCodecs=function(e,t){var n=this.getPeerInfo().settings.audio,r=function(n,r){var i=t.sdp.match(new RegExp("a=rtpmap:(\\d*)\\ "+r+".*","gi"));if(Array.isArray(i)&&i.length>0)for(var a=0;a<i.length;a++){var o=i[a].split(" ")[0].split(":")[1];u.info([e,"RTCSessionDesription",t.type,'Removing "'+r+'" payload ->'],o),t.sdp=t.sdp.replace(new RegExp("a=rtpmap:"+o+"\\ .*\\r\\n","g"),""),t.sdp=t.sdp.replace(new RegExp("a=fmtp:"+o+"\\ .*\\r\\n","g"),""),t.sdp=t.sdp.replace(new RegExp("a=rtpmap:\\d+ rtx\\/\\d+\\r\\na=fmtp:\\d+ apt="+o+"\\r\\n","g"),"");for(var s=t.sdp.split("\r\n"),d=0;d<s.length;d++)if(0===s[d].indexOf("m="+n)){var c=s[d].split(" ");c.indexOf(o)>=3&&c.splice(c.indexOf(o),1),s[d]=c.join(" ");break}t.sdp=s.join("\r\n")}else u.warn([e,"RTCSessionDesription",t.type,'Not removing "'+r+'" as it does not exists.'])};return this._disableVideoFecCodecs&&(this._hasMCU?u.warn([e,"RTCSessionDesription",t.type,'Not removing "ulpfec" or "red" codecs as connected to MCU to prevent connectivity issues.']):(r("video","red"),r("video","ulpfec"))),this._disableComfortNoiseCodec&&n&&"object"==typeof n&&n.stereo&&r("audio","CN"),"edge"===window.webrtcDetectedBrowser&&"edge"!==(((this._peerInformations[e]||{}).agent||{}).name||"unknown").name&&(t.sdp=t.sdp.replace(/a=rtcp-fb:.*\ x-message\ .*\r\n/gi,"")),t.sdp},t.prototype._removeSDPREMBPackets=function(e,t){return this._disableREMB?(u.info([e,"RTCSessionDesription",t.type,"Removing REMB packets."]),t.sdp.replace(/a=rtcp-fb:\d+ goog-remb\r\n/g,"")):t.sdp},t.prototype._getSDPSelectedCodec=function(e,t,n,r){var i={name:null,implementation:null,clockRate:null,channels:null,payloadType:null,params:null};return t&&t.sdp?(t.sdp.split("m=").forEach(function(e,t){if(0!==t&&0===e.indexOf(n+" ")){var r=(e.split("\r\n")[0]||"").split(" ");r.splice(0,3);for(var a=0;a<r.length;a++){var o=e.match(new RegExp("a=rtpmap:"+r[a]+".*\r\n","gi"));if(o){var s=((o[0]||"").replace(/\r\n/g,"").split(" ")[1]||"").split("/");if(!(["red","ulpfec","telephone-event","cn","rtx"].indexOf(s[0].toLowerCase())>-1)){i.name=s[0],i.clockRate=parseInt(s[1],10)||0,i.channels=parseInt(s[2]||"1",10)||1,i.payloadType=parseInt(r[a],10),i.params="",(e.match(new RegExp("a=fmtp:"+r[a]+".*\r\n","gi"))||[]).forEach(function(e){i.params+=e.replace(new RegExp("a=fmtp:"+r[a],"gi"),"").replace(/\ /g,"").replace(/\r\n/g,"")});break}}}}}),r||u.debug([e,"RTCSessionDesription",t.type,'Parsing session description "'+n+'" codecs ->'],i),i):i},t.prototype._removeSDPFilteredCandidates=function(e,t){return"MCU"===e&&t.type===this.HANDSHAKE_PROGRESS.ANSWER&&"firefox"===window.webrtcDetectedBrowser&&(t.sdp=t.sdp.replace(/ generation 0/g,""),t.sdp=t.sdp.replace(/ udp /g," UDP ")),this._forceTURN&&this._hasMCU?(u.warn([e,"RTCSessionDesription",t.type,"Not filtering ICE candidates as TURN connections are enforced as MCU is present (and act as a TURN itself) so filtering of ICE candidate flags are not honoured"]),t.sdp):(this._filterCandidatesType.host&&(u.info([e,"RTCSessionDesription",t.type,'Removing "host" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*host.*\r\n/g,"")),this._filterCandidatesType.srflx&&(u.info([e,"RTCSessionDesription",t.type,'Removing "srflx" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*srflx.*\r\n/g,"")),this._filterCandidatesType.relay&&(u.info([e,"RTCSessionDesription",t.type,'Removing "relay" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*relay.*\r\n/g,"")),t.sdp)},t.prototype._getCodecsSupport=function(e){var t=this;if(t._currentCodecSupport)e(null);else{if(t._currentCodecSupport={audio:{},video:{}},"AppleWebKit"===AdapterJS.webrtcDetectedType)return t._currentCodecSupport.audio={opus:["48000/2"]},t._currentCodecSupport.video={h264:["48000"]},e(null);try{if("edge"===window.webrtcDetectedBrowser){for(var n=RTCRtpSender.getCapabilities().codecs,r=0;r<n.length;r++)if(["audio","video"].indexOf(n[r].kind)>-1&&n[r].name){var i=n[r].name.toLowerCase();t._currentCodecSupport[n[r].kind][i]=n[r].clockRate+(n[r].numChannels>1?"/"+n[r].numChannels:"")}e(null)}else{var a=new RTCPeerConnection(null),o="plugin"!==AdapterJS.webrtcDetectedType?{offerToReceiveAudio:!0,offerToReceiveVideo:!0}:{mandatory:{OfferToReceiveVideo:!0,OfferToReceiveAudio:!0}};try{var s=a.createDataChannel("test");t._binaryChunkType=s.binaryType||t._binaryChunkType,t._binaryChunkType=t._binaryChunkType.toLowerCase().indexOf("array")>-1?t.DATA_TRANSFER_DATA_TYPE.ARRAY_BUFFER:t._binaryChunkType;for(var d in t.DATA_TRANSFER_DATA_TYPE)if(t.DATA_TRANSFER_DATA_TYPE.hasOwnProperty(d)&&t._binaryChunkType.toLowerCase()===t.DATA_TRANSFER_DATA_TYPE[d].toLowerCase()){t._binaryChunkType=t.DATA_TRANSFER_DATA_TYPE[d];break}}catch(e){}a.createOffer(function(n){t._currentCodecSupport=t._getSDPCodecsSupport(null,n),e(null)},function(t){e(t)},o)}}catch(t){e(t)}}},t.prototype._handleSDPConnectionSettings=function(e,t,r){var i=this;if(!i._sdpSessions[e])return t.sdp;var a=t.sdp;"remote"!==r||i.getPeerInfo(e).config.enableIceTrickle||(a=a.replace(/a=end-of-candidates\r\n/g,""));var o=a.split("\r\n"),s=((i._peerInformations[e]||{}).agent||{}).name||"",d=(i._peerInformations[e],""),c=-1,l=[],p=-1,f=n(i._sdpSettings);if("MCU"===e&&(f.connection.audio=!0,f.connection.video=!0,f.connection.data=!0),i._hasMCU){var g=n(i.getPeerInfo(e)).settings||{};f.direction.audio.receive="MCU"!==e&&!!g.audio,f.direction.audio.send="MCU"===e,f.direction.video.receive="MCU"!==e&&!!g.video,f.direction.video.send="MCU"===e}if("remote"===r){var h=i._getSDPCommonSupports(e,t);h.audio||(f.connection.audio=!1),h.video||(f.connection.video=!1)}i._sdpSessions[e][r].mLines=[],i._sdpSessions[e][r].bundleLine="",i._sdpSessions[e][r].connection={audio:null,video:null,data:null};for(var m=0;m<o.length;m++){if(0===o[m].indexOf("a=group:BUNDLE"))i._sdpSessions[e][r].bundleLine=o[m],c=m;else if(0===o[m].indexOf("m=")&&(d=(o[m].split("m=")[1]||"").split(" ")[0]||"",d="application"===d?"data":d,p++,i._sdpSessions[e][r].mLines[p]=o[m],!f.connection[d])){if(u.log([e,"RTCSessionDesription",t.type,"Removing rejected m="+d+" line ->"],o[m]),i._peerConnectionConfig.bundlePolicy===i.BUNDLE_POLICY.MAX_BUNDLE&&c>-1&&0===p&&("remote"===r?t.type===this.HANDSHAKE_PROGRESS.OFFER:t.type===this.HANDSHAKE_PROGRESS.ANSWER)){u.warn([e,"RTCSessionDesription",t.type,"Not removing rejected m="+d+" line ->"],o[m]),f.connection[d]=!0,["audio","video"].indexOf(d)>-1&&(f.direction[d].send=!1,f.direction[d].receive=!1);continue}if("edge"===window.webrtcDetectedBrowser){o.splice(m,1),m--;continue}if("remote"===r||t.type===this.HANDSHAKE_PROGRESS.ANSWER){var _=o[m].split(" ");_[1]=0,o[m]=_.join(" ");continue}}if("remote"!==r||0!==o[m].indexOf("a=candidate:")||i.getPeerInfo(e).config.enableIceTrickle||o[m+1]&&(0===o[m+1].indexOf("a=candidate:")||0===o[m+1].indexOf("a=end-of-candidates"))||(u.info([e,"RTCSessionDesription",t.type,"Appending end-of-candidates signal for non-trickle ICE connection."]),o.splice(m+1,0,"a=end-of-candidates"),m++),d)if(f.connection[d]){if(0===o[m].indexOf("a=mid:"))l.push(o[m].split("a=mid:")[1]||"");else if(d&&["a=sendrecv","a=sendonly","a=recvonly"].indexOf(o[m])>-1){if(-1===["audio","video"].indexOf(d)){i._sdpSessions[e][r].connection.data=o[m];continue}if("local"===r)f.direction[d].send&&!f.direction[d].receive?o[m]=o[m].indexOf("send")>-1?"a=sendonly":"a=inactive":!f.direction[d].send&&f.direction[d].receive?o[m]=o[m].indexOf("recv")>-1?"a=recvonly":"a=inactive":f.direction[d].send||f.direction[d].receive||(o[m]="a=inactive"),i._hasMCU||"firefox"===window.webrtcDetectedBrowser||"firefox"!==s||t.type!==i.HANDSHAKE_PROGRESS.OFFER||"a=recvonly"!==o[m]||(u.warn([e,"RTCSessionDesription",t.type,"Overriding any original settings to receive only to send and receive to resolve chrome BUNDLE errors."]),o[m]="a=sendrecv",f.direction[d].send=!0,f.direction[d].receive=!0);else if(t.type===i.HANDSHAKE_PROGRESS.ANSWER){var S=i._sdpSessions[e].local.connection[d];"a=sendonly"===S?o[m]=-1===["a=inactive","a=recvonly"].indexOf(o[m])?"a=sendonly"===o[m]?"a=inactive":"a=recvonly":o[m]:"a=recvonly"===S?o[m]=-1===["a=inactive","a=sendonly"].indexOf(o[m])?"a=recvonly"===o[m]?"a=inactive":"a=sendonly":o[m]:"a=inactive"===S&&(o[m]="a=inactive")}i._sdpSessions[e][r].connection[d]=o[m]}}else o.splice(m,1),m--;(o[m]||"").replace(/\n|\r|\s|\ /gi,"")||(o.splice(m,1),m--)}return c>-1&&(i._peerConnectionConfig.bundlePolicy===i.BUNDLE_POLICY.MAX_BUNDLE?o[c]="a=group:BUNDLE "+l.join(" "):i._peerConnectionConfig.bundlePolicy===i.BUNDLE_POLICY.NONE&&o.splice(c,1)),"edge"!==window.webrtcDetectedBrowser&&(o[o.length-1].replace(/\n|\r|\s/gi,"")?o.push(""):o[o.length-1]=""),u.info([e,"RTCSessionDesription",t.type,"Handling connection lines and direction ->"],f),o.join("\r\n")},t.prototype._getSDPFingerprint=function(e,t,n){var r={fingerprint:null,fingerprintAlgorithm:null,derBase64:null};if(!t||!t.sdp)return r;for(var i=t.sdp.split("\r\n"),a=0;a<i.length;a++)if(0===i[a].indexOf("a=fingerprint")){var o=i[a].replace("a=fingerprint:","").split(" ");r.fingerprint=o[1],r.fingerprintAlgorithm=o[0];break}return n||u.debug([e,"RTCSessionDesription",t.type,"Parsing session description fingerprint ->"],r),r},t.prototype._renderSDPOutput=function(e,t){var n=this,r=null,i=null;if(t&&t.sdp){if(!n._peerConnections[e])return t.sdp;n._peerConnections[e].localStream&&(r=n._peerConnections[e].localStream,i=n._peerConnections[e].localStreamId||n._peerConnections[e].localStream.id);var a=(n._enableIceTrickle?t.sdp:t.sdp.replace(/a=end-of-candidates\r\n/g,"")).split("\r\n");n._peerInformations[e];if(r)for(var o="",s=0;s<a.length;s++)if(0===a[s].indexOf("m="))o=(a[s].split("m=")[1]||"").split(" ")[0]||"",o=-1===["audio","video"].indexOf(o)?"":o;else if(o)if(0===a[s].indexOf("a=msid:")){var d=a[s].split(" ");d[0]="a=msid:"+i,a[s]=d.join(" ")}else if(0===a[s].indexOf("a=ssrc:")){var c=null;if(a[s].indexOf(" msid:")>0?c=a[s].split(" msid:"):a[s].indexOf(" mslabel:")>0&&(c=a[s].split(" mslabel:")),c){var l=(c[1]||"").split(" ");l[0]=i,c[1]=l.join(" "),a[s].indexOf(" msid:")>0?a[s]=c.join(" msid:"):a[s].indexOf(" mslabel:")>0&&(a[s]=c.join(" mslabel:"))}}if(!n._enableIceTrickle){u.info([e,"RTCSessionDesription",t.type,"Appending end-of-candidates signal for non-trickle ICE connection."]);for(var p=0;p<a.length;p++)0===a[p].indexOf("a=candidate:")&&(a[p+1]&&(0===a[p+1].indexOf("a=candidate:")||0===a[p+1].indexOf("a=end-of-candidates"))||(a.splice(p+1,0,"a=end-of-candidates"),p++))}if(t.type===this.HANDSHAKE_PROGRESS.ANSWER&&this._sdpSessions[e]){for(var f=-1,g=0;g<a.length;g++)if(0===a[g].indexOf("a=group:BUNDLE")&&this._sdpSessions[e].remote.bundleLine&&this._peerConnectionConfig.bundlePolicy===this.BUNDLE_POLICY.MAX_BUNDLE)a[g]=this._sdpSessions[e].remote.bundleLine;else if(0===a[g].indexOf("m=")){f++;var h=a[g].split(" "),m=(this._sdpSessions[e].remote.mLines[f]||"").split(" ");h[0]&&m[0]&&h[0]!==m[0]&&(m[1]=0,u.info([e,"RTCSessionDesription",t.type,"Appending middle rejected m= line ->"],m.join(" ")),a.splice(g,0,m.join(" ")),g++,f++)}for(;this._sdpSessions[e].remote.mLines[f+1];){f++;var _=a.length;a[_-1].replace(/\s/gi,"")||(_-=1);var S=(this._sdpSessions[e].remote.mLines[f]||"").split(" ");S[1]=0,u.info([e,"RTCSessionDesription",t.type,"Appending later rejected m= line ->"],S.join(" ")),a.splice(_,0,S.join(" "))}}return"edge"!==window.webrtcDetectedBrowser||t.type!==this.HANDSHAKE_PROGRESS.OFFER||a[a.length-1].replace(/\s/gi,"")||(u.info([e,"RTCSessionDesription",t.type,"Removing last empty space for Edge browsers"]),a.splice(a.length-1,1)),u.info([e,"RTCSessionDescription",t.type,"Formatted output ->"],a.join("\r\n")),a.join("\r\n")}},t.prototype._parseSDPMediaStreamIDs=function(e,t){if(this._peerConnections[e])if(t&&t.sdp){for(var n=t.sdp.split("\r\n"),r=null,i=0;i<n.length;i++){if(0===n[i].indexOf("a=msid:")){r=(n[i].split("a=msid:")[1]||"").split(" ")[0];break}if(0===n[i].indexOf("a=ssrc:")&&n[i].indexOf(" msid:")>0){r=(n[i].split(" msid:")[1]||"").split(" ")[0];break}}r?r!==this._peerConnections[e].remoteStreamId?(u.info([e,"RTCSessionDesription",t.type,"New remote stream is sent ->"],r),this._peerConnections[e].remoteStreamId=r):u.info([e,"RTCSessionDesription",t.type,"Same remote stream is sent ->"],r):(u.info([e,"RTCSessionDesription",t.type,"No remote stream is sent."]),this._peerConnections[e].remoteStreamId=null)}else this._peerConnections[e].remoteStreamId=null},t.prototype._getSDPICECandidates=function(e,t,n){var r={host:[],srflx:[],relay:[]};return t&&t.sdp?(t.sdp.split("m=").forEach(function(e,t){if(0!==t){var n=((e.match(/a=mid:.*\r\n/gi)||[])[0]||"").replace(/a=mid:/gi,"").replace(/\r\n/,""),i=t-1;(e.match(/a=candidate:.*\r\n/gi)||[]).forEach(function(e){var t=(e.split(" ")[7]||"host").replace(/\r\n/g,"");r[t]=r[t]||[],r[t].push(new RTCIceCandidate({sdpMid:n,sdpMLineIndex:i,candidate:(e.split("a=")[1]||"").replace(/\r\n/g,"")}))})}}),n||u.debug([e,"RTCSessionDesription",t.type,"Parsing session description ICE candidates ->"],r),r):r},t.prototype._getSDPMediaSSRC=function(e,t,n){var r={audio:0,video:0};return t&&t.sdp?(t.sdp.split("m=").forEach(function(e,t){if(0!==t){var n=e.split(" ")[0]||"",i=(e.match(/a=ssrc:.*\r\n/)||[])[0];"number"==typeof r[n]&&i&&(r[n]=parseInt((i.split("a=ssrc:")[1]||"").split(" ")[0],10)||0)}}),n||u.debug([e,"RTCSessionDesription",t.type,"Parsing session description media SSRCs ->"],r),r):r},t.prototype._getSDPCodecsSupport=function(e,t){var n={audio:{},video:{}};if(!t||!t.sdp)return n;for(var r=t.sdp.split("\r\n"),i="",a=0;a<r.length;a++)if(0!==r[a].indexOf("m=")){if(0===r[a].indexOf("a=rtpmap:")){var o=(r[a].split(" ")[1]||"").split("/"),s=(o[0]||"").toLowerCase(),d=o[1]+(o[2]?"/"+o[2]:"");if(["ulpfec","red","telephone-event","cn","rtx"].indexOf(s)>-1)continue;n[i][s]=n[i][s]||[],-1===n[i][s].indexOf(d)&&n[i][s].push(d)}}else if(i=(r[a].split("m=")[1]||"").split(" ")[0],-1===["audio","video"].indexOf(i))break;return u.info([e||null,"RTCSessionDescription",t.type,"Parsed codecs support ->"],n),n},t.prototype._getSDPCommonSupports=function(e,t){var n=this,r={audio:!1,video:!1};if(!e||!t||!t.sdp){if(r.video=!(!n._currentCodecSupport.video.h264&&!n._currentCodecSupport.video.vp8),r.audio=!!n._currentCodecSupport.audio.opus,e){var i=((n._peerInformations[e]||{}).agent||{}).name||"";AdapterJS.webrtcDetectedBrowser===i&&(r.video=Object.keys(n._currentCodecSupport.video).length>0,r.audio=Object.keys(n._currentCodecSupport.audio).length>0)}return r}var a=n._getSDPCodecsSupport(e,t),o=n._currentCodecSupport;for(var s in o.audio)if(o.audio.hasOwnProperty(s)&&o.audio[s]&&a.audio[s]){r.audio=!0;break}for(var d in o.video)if(o.video.hasOwnProperty(d)&&o.video[d]&&a.video[d]){r.video=!0;break}return r},"undefined"!=typeof exports?module.exports={Skylink:t,SkylinkLogs:l}:e?(e.Skylink=t,e.SkylinkLogs=l):window&&(window.Skylink=t,window.SkylinkLogs=l)}(this);
}
exports.fun=fun;